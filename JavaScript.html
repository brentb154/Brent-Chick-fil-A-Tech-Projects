<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>
// Load Google Charts
google.charts.load('current', {'packages':['corechart', 'bar']});

// ============================================================================
// STATE
// ============================================================================
const AppState = {
  settings: null,
  sizeConfig: null,
  currentTab: 'dashboard',
  uploadedData: { ch: null, dbu: null },
  processedData: null,
  historyData: [],
  periods: [],
  employees: [],
  alerts: []
};

const CONFIG = {
  MODERATE_THRESHOLD: 5,
  HIGH_THRESHOLD: 10,
  WEEKLY_HOURS: 40
};

// ============================================================================
// INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
  // Check if we're using the new MainApp structure (has sidebar)
  // If so, skip the old tab-based initialization - MainAppJS handles it
  const isMainApp = document.querySelector('.main-app-container') !== null;
  
  if (!isMainApp) {
    // Old Index.html mode - run legacy initialization
    initApp();
  }
  // If MainApp mode, do nothing here - MainAppJS.html handles initialization
});

function initApp() {
  showLoading(true);
  
  // Load settings first, then initialize UI
  google.script.run
    .withSuccessHandler(function(settings) {
      // Handle null/undefined settings gracefully
      const s = settings || {};
      AppState.settings = s;
      CONFIG.MODERATE_THRESHOLD = s.moderateThreshold || 5;
      CONFIG.HIGH_THRESHOLD = s.highThreshold || 10;
      
      setupEventListeners();
      loadDashboardData();
      
      // Load payroll calendar widget (Chunk 15)
      if (typeof loadPayrollCalendar === 'function') {
        loadPayrollCalendar();
      }
    })
    .withFailureHandler(function(error) {
      console.error('Failed to load settings:', error);
      AppState.settings = {};
      setupEventListeners();
      showLoading(false);
      showToast('Failed to load settings', 'error');
    })
    .getSettings();
}

function setupEventListeners() {
  // Tab navigation
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
  });
  
  // Upload cards - now handled dynamically by initUploadTab()
  // Legacy setup is no longer needed here
  
  // Process button
  document.getElementById('processBtn')?.addEventListener('click', processUploadedData);
  
  // Save button
  document.getElementById('saveBtn')?.addEventListener('click', saveToHistory);
  
  // Period selector
  document.getElementById('periodSelect')?.addEventListener('change', loadPeriodData);
  
  // Employee search
  document.getElementById('employeeSearch')?.addEventListener('input', debounce(searchEmployees, 300));
  document.getElementById('employeeSelect')?.addEventListener('change', loadEmployeeHistory);
  
  // Trend time range
  document.getElementById('trendRange')?.addEventListener('change', loadTrendData);
  
  // Settings form
  document.getElementById('settingsForm')?.addEventListener('submit', saveSettings);
  
  // Clear data button
  document.getElementById('clearDataBtn')?.addEventListener('click', clearUploadedData);
  
  // Dashboard trend range selector
  var trendSelect = document.getElementById('dashboardTrendRange');
  if (trendSelect) {
    trendSelect.addEventListener('change', function() {
      console.log('Trend range changed to:', this.value);
      loadDashboardTrend(this.value);
    });
  }
}

function setupUploadCard(cardId, inputId, location) {
  const card = document.getElementById(cardId);
  const input = document.getElementById(inputId);
  if (!card || !input) return;
  
  card.addEventListener('click', (e) => { if (e.target !== input) input.click(); });
  card.addEventListener('dragover', (e) => { e.preventDefault(); card.classList.add('dragover'); });
  card.addEventListener('dragleave', () => card.classList.remove('dragover'));
  card.addEventListener('drop', (e) => {
    e.preventDefault();
    card.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0], location);
  });
  input.addEventListener('change', (e) => {
    if (e.target.files[0]) handleFileUpload(e.target.files[0], location);
    input.value = '';
  });
}

// ============================================================================
// TAB NAVIGATION
// ============================================================================
function switchTab(tabId) {
  AppState.currentTab = tabId;
  
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + tabId));
  
  // Load data for specific tabs
  if (tabId === 'dashboard') {
    loadDashboardData();
    if (typeof loadPayrollCalendar === 'function') loadPayrollCalendar();
  }
  else if (tabId === 'history') loadHistoryData();
  else if (tabId === 'employee') loadEmployeeList();
  else if (tabId === 'trends') loadTrendData();
  else if (tabId === 'uniforms') loadUniformsTab();
  else if (tabId === 'settings') { loadSettingsData(); loadSizeConfiguration(); }
}

// ============================================================================
// DASHBOARD
// ============================================================================
function loadDashboardData() {
  showLoading(true);
  
  // Load periods first
  google.script.run
    .withSuccessHandler(function(periods) {
      console.log('Periods loaded:', periods);
      AppState.periods = periods || [];
      updatePeriodSelectors();
      
      // Then load alerts
      google.script.run
        .withSuccessHandler(function(alerts) {
          console.log('Alerts loaded:', alerts);
          AppState.alerts = alerts || [];
          renderDashboardAlerts(alerts);
          
          // Then load trends with default timeframe
          loadDashboardTrend('3m');
        })
        .withFailureHandler(function(error) {
          console.error('Alerts error:', error);
          AppState.alerts = [];
        })
        .getAlerts();
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      console.error('Periods error:', error);
      AppState.periods = [];
    })
    .getPayPeriods();
}

function renderDashboardStats(trends) {
  if (!trends || !trends.success) {
    document.getElementById('dashTotalOT').textContent = '0:00';
    document.getElementById('dashTotalCost').textContent = '$0';
    document.getElementById('dashEmployees').textContent = '0';
    document.getElementById('dashAlerts').textContent = '0';
    return;
  }
  
  const latest = trends.periodData?.[trends.periodData.length - 1];
  document.getElementById('dashTotalOT').textContent = formatHours(latest?.totalOT || 0);
  document.getElementById('dashTotalCost').textContent = '$' + (latest?.totalCost?.toFixed(0) || '0');
  document.getElementById('dashEmployees').textContent = latest?.employeeCount || '0';
  document.getElementById('dashAlerts').textContent = AppState.alerts.length || '0';
}

function renderDashboardAlerts(alerts) {
  const container = document.getElementById('alertsContainer');
  if (!container) return;
  
  if (!alerts || alerts.length === 0) {
    container.innerHTML = '<div class="empty-state"><span class="material-icons-round">check_circle</span><h3>No Alerts</h3><p>Everything looks good!</p></div>';
    document.getElementById('dashAlerts').textContent = '0';
    return;
  }
  
  // Store alerts for detail view
  AppState.alerts = alerts;
  document.getElementById('dashAlerts').textContent = alerts.length;
  
  container.innerHTML = alerts.map((a, index) => {
    // Build the details content based on alert type
    var detailsLeft = '';
    var detailsRight = '';
    
    switch(a.type) {
      case 'consecutive_high':
        detailsLeft = '<p><strong>Employee:</strong> ' + a.employeeName + '</p><p><strong>Consecutive Periods:</strong> ' + a.value + '</p>';
        detailsRight = 'This employee has had 10+ hours of overtime for ' + a.value + ' pay periods in a row. Consider reviewing their workload or schedule to prevent burnout.';
        break;
        
      case 'period_increase':
        detailsLeft = '<p><strong>Increase:</strong> ' + a.value + '%</p><p><strong>Comparison:</strong> Current vs Previous Period</p>';
        detailsRight = 'Total overtime hours across all employees increased significantly compared to the last pay period. This could indicate scheduling gaps, increased customer demand, or staffing shortages.';
        break;
        
      case 'new_high_ot':
        var empList = (a.employees || []).map(function(e) { return '<li>' + e + '</li>'; }).join('');
        detailsLeft = '<p><strong>Employees (' + a.value + '):</strong></p><ul>' + empList + '</ul>';
        detailsRight = 'These employees now have "Really High" overtime (10+ hours in the pay period) but did NOT have high OT in the previous period. This is a new development worth monitoring.';
        break;
        
      case 'multi_increase':
        detailsLeft = '<p><strong>Current:</strong> ' + a.value + ' employees</p><p><strong>Trend:</strong> 50%+ increase from last period</p>';
        detailsRight = 'More employees are working shifts at both locations compared to last period. This could indicate coverage issues at one location or intentional cross-training.';
        break;
        
      case 'high_ot_count':
        detailsLeft = '<p><strong>Count:</strong> ' + a.value + ' employees</p><p><strong>Threshold:</strong> 10+ OT hours each</p>';
        detailsRight = 'Multiple employees have "Really High" overtime this period. When many people are working excessive OT, it often signals understaffing or poor schedule distribution.';
        break;
        
      default:
        detailsLeft = '<p>' + a.message + '</p>';
        detailsRight = 'Review this alert and take appropriate action.';
    }
    
    return '<div class="alert-accordion" id="alert-' + index + '">' +
      '<div class="alert-header ' + a.severity + '" onclick="toggleAlert(' + index + ')">' +
        '<span class="material-icons-round alert-icon">' + (a.severity === 'high' ? 'error' : a.severity === 'warning' ? 'warning' : 'info') + '</span>' +
        '<div class="alert-summary">' +
          '<h4>' + a.title + '</h4>' +
          '<p>' + a.message + '</p>' +
        '</div>' +
        '<span class="material-icons-round alert-toggle">expand_more</span>' +
      '</div>' +
      '<div class="alert-details">' +
        '<div class="alert-details-left">' + detailsLeft + '</div>' +
        '<div class="alert-details-right">' +
          '<h5><span class="material-icons-round">lightbulb</span> What This Means</h5>' +
          '<p>' + detailsRight + '</p>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

/**
 * Toggle accordion alert expansion
 */
function toggleAlert(index) {
  var accordion = document.getElementById('alert-' + index);
  if (!accordion) return;
  
  var isOpen = accordion.classList.contains('open');
  
  // Close all other accordions
  document.querySelectorAll('.alert-accordion.open').forEach(function(el) {
    el.classList.remove('open');
  });
  
  // Toggle this one
  if (!isOpen) {
    accordion.classList.add('open');
  }
}

/**
 * Load dashboard trend data for a specific time range
 */
function loadDashboardTrend(range) {
  console.log('loadDashboardTrend called with range:', range);
  
  // Show loading state in chart
  var chartContainer = document.getElementById('dashboardChart');
  if (chartContainer) {
    chartContainer.innerHTML = '<div class="empty-state"><span class="material-icons-round">hourglass_empty</span><p>Loading ' + range + ' data...</p></div>';
  }
  
  google.script.run
    .withSuccessHandler(function(trends) {
      showLoading(false);
      console.log('Trends loaded for range ' + range + ':', trends);
      console.log('Period data count:', trends && trends.periodData ? trends.periodData.length : 0);
      
      if (trends && trends.success) {
        renderDashboardStats(trends);
        renderDashboardChart(trends);
      } else {
        console.log('No trend data or trends failed:', trends);
        renderDashboardStats(null);
        if (chartContainer) {
          chartContainer.innerHTML = '<div class="empty-state"><span class="material-icons-round">show_chart</span><h3>No Data</h3><p>Upload some data to see trends</p></div>';
        }
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      console.error('Trends error:', error);
      renderDashboardStats(null);
      if (chartContainer) {
        chartContainer.innerHTML = '<div class="empty-state"><span class="material-icons-round">error</span><h3>Error</h3><p>Could not load trend data</p></div>';
      }
    })
    .getTrendData(range);
}

function renderDashboardChart(trends) {
  if (!trends || !trends.success || !trends.periodData || !trends.periodData.length) return;
  
  var chartData = trends.periodData;
  console.log('Rendering chart with', chartData.length, 'periods');
  
  // Use setOnLoadCallback only if charts not yet loaded, otherwise draw directly
  var drawChart = function() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Period');
    data.addColumn('number', 'OT Hours');
    data.addColumn('number', 'Cost');
    
    // Show ALL periods from the filtered data
    for (var i = 0; i < chartData.length; i++) {
      var p = chartData[i];
      var date = new Date(p.periodEnd);
      var label = (date.getMonth() + 1) + '/' + date.getDate();
      data.addRow([label, p.totalOT, p.totalCost]);
    }
    
    var options = {
      legend: { position: 'bottom' },
      colors: ['#E51636', '#6366F1'],
      chartArea: { width: '80%', height: '70%' },
      vAxes: { 0: { title: 'OT Hours' }, 1: { title: 'Cost ($)' } },
      series: { 0: { targetAxisIndex: 0 }, 1: { targetAxisIndex: 1 } },
      hAxis: { 
        slantedText: chartData.length > 10,
        slantedTextAngle: 45,
        textStyle: { fontSize: chartData.length > 15 ? 10 : 12 }
      }
    };
    
    var container = document.getElementById('dashboardChart');
    if (container) {
      var chart = new google.visualization.LineChart(container);
      chart.draw(data, options);
    }
  };
  
  // Check if Google Charts is loaded
  if (google.visualization && google.visualization.LineChart) {
    drawChart();
  } else {
    google.charts.setOnLoadCallback(drawChart);
  }
}

// ============================================================================
// UPLOAD & PROCESS
// ============================================================================
function handleFileUpload(file, location) {
  if (!file.name.toLowerCase().endsWith('.csv')) {
    showToast('Please upload a CSV file', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const result = parseCSV(e.target.result, location);
    if (result.success) {
      if (location === 'Cockrell Hill DTO') {
        AppState.uploadedData.ch = result;
        updateUploadCard('uploadCH', file.name, result.employeeCount);
      } else {
        AppState.uploadedData.dbu = result;
        updateUploadCard('uploadDBU', file.name, result.employeeCount);
      }
      showToast(`Loaded ${result.employeeCount} employees from ${location}`, 'success');
      updateProcessButton();
    } else {
      showToast(result.error, 'error');
    }
  };
  reader.readAsText(file);
}

function updateUploadCard(cardId, fileName, count) {
  const card = document.getElementById(cardId);
  if (!card) return;
  card.classList.add('has-file');
  card.querySelector('h3').textContent = fileName;
  card.querySelector('p').textContent = `${count} employees loaded`;
}

function resetUploadCard(cardId, title, desc) {
  const card = document.getElementById(cardId);
  if (!card) return;
  card.classList.remove('has-file');
  card.querySelector('h3').textContent = title;
  card.querySelector('p').textContent = desc;
}

function updateProcessButton() {
  const btn = document.getElementById('processBtn');
  if (!btn) return;
  
  // Check if any location has data (works with dynamic locations)
  let hasAnyData = false;
  if (AppState.uploadedData) {
    for (var key in AppState.uploadedData) {
      if (AppState.uploadedData[key]) {
        hasAnyData = true;
        break;
      }
    }
  }
  btn.disabled = !hasAnyData;
}

function processUploadedData() {
  // Check if any location has data (works with dynamic locations)
  let hasAnyData = false;
  let uploadedDataArray = [];
  
  if (AppState.uploadedData) {
    for (var key in AppState.uploadedData) {
      if (AppState.uploadedData[key]) {
        hasAnyData = true;
        uploadedDataArray.push(AppState.uploadedData[key]);
      }
    }
  }
  
  if (!hasAnyData) {
    showToast('Please upload at least one CSV file', 'error');
    return;
  }
  
  // Show processing indicator
  showLoading(true);
  showToast('Processing data... Please wait.', 'info');
  
  // Disable process button during processing
  const processBtn = document.getElementById('processBtn');
  if (processBtn) processBtn.disabled = true;
  
  // Use setTimeout to allow UI to update before heavy processing
  setTimeout(() => {
    try {
      // Pass data for dynamic locations - processOTData can handle array or legacy format
      const processed = processOTDataDynamic(uploadedDataArray);
      AppState.processedData = processed;
      
      renderProcessedResults(processed);
      document.getElementById('resultsSection')?.classList.remove('hidden');
      
      // Show save button (now next to analyze button)
      const saveBtn = document.getElementById('saveBtn');
      if (saveBtn) {
        saveBtn.classList.remove('hidden');
        // Update button text for bulk uploads
        if (processed.allPeriods && processed.allPeriods.length > 1) {
          saveBtn.innerHTML = '<span class="material-icons-round">save</span> Save All ' + processed.allPeriods.length + ' Periods';
        } else {
          saveBtn.innerHTML = '<span class="material-icons-round">save</span> Save to History';
        }
      }
      
      // Scroll to results
      document.getElementById('resultsSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
    } catch (error) {
      console.error('Processing error:', error);
      showToast('Error processing data: ' + error.message, 'error');
    } finally {
      showLoading(false);
      if (processBtn) processBtn.disabled = false;
    }
  }, 100);
}

function renderProcessedResults(data) {
  // Check if this is a bulk upload (multiple periods)
  const isBulk = data.allPeriods && data.allPeriods.length > 1;
  
  if (isBulk) {
    // Show bulk upload stats
    document.getElementById('procEmployees').textContent = data.stats.totalRecordsAllPeriods;
    document.getElementById('procMulti').textContent = data.stats.periodsDetected + ' periods';
    document.getElementById('procTotalOT').textContent = formatHours(data.stats.totalOTAllPeriods);
    document.getElementById('procHighOT').textContent = data.allPeriods.reduce((s, p) => s + p.stats.highOTCount, 0);
    
    // Update period display to show range
    const firstPeriod = data.allPeriods[0];
    const lastPeriod = data.allPeriods[data.allPeriods.length - 1];
    document.getElementById('procPeriod').textContent = 
      `${data.stats.periodsDetected} periods: ${formatDate(firstPeriod.periodEnd)} - ${formatDate(lastPeriod.periodEnd)}`;
    
    // Show bulk info alert
    showToast(`Detected ${data.stats.periodsDetected} pay periods with ${data.stats.totalRecordsAllPeriods} total records!`, 'success');
  } else {
    // Single period - normal display
    document.getElementById('procEmployees').textContent = data.allEmployees.length;
    document.getElementById('procMulti').textContent = data.multiLocation.length;
    document.getElementById('procTotalOT').textContent = formatHours(data.stats.totalOT);
    document.getElementById('procHighOT').textContent = data.stats.highOTCount;
    document.getElementById('procPeriod').textContent = formatDate(data.periodEnd);
  }
  
  // Render tables (show latest period data)
  renderMultiTable(data.multiLocation);
  renderAllTable(data.allEmployees);
}

function renderMultiTable(employees) {
  const tbody = document.getElementById('multiTableBody');
  if (!tbody) return;
  
  // Helper to determine pay-out location (where they have more hours)
  function getPayoutLocation(emp) {
    if ((emp.chHours || 0) > (emp.dbuHours || 0)) {
      return { loc: 'CH', icon: 'üìç CH', transferFrom: 'DBU', transferHours: emp.dbuHours || 0 };
    } else {
      return { loc: 'DBU', icon: 'üìç DBU', transferFrom: 'CH', transferHours: emp.chHours || 0 };
    }
  }
  
  if (employees.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No multi-location employees found</td></tr>';
    return;
  }
  
  tbody.innerHTML = employees.map(function(e) {
    var payout = getPayoutLocation(e);
    return '<tr class="highlight">' +
      '<td class="name">' + e.employeeName + ' <span class="payout-badge ' + payout.loc.toLowerCase() + '">' + payout.icon + '</span></td>' +
      '<td class="numeric">' + formatHours(e.chHours) + '</td>' +
      '<td class="numeric">' + formatHours(e.dbuHours) + '</td>' +
      '<td class="numeric font-bold">' + formatHours(e.totalHours) + '</td>' +
      '<td class="numeric">' + formatHours(e.regularHours) + '</td>' +
      '<td class="numeric font-bold ' + (e.totalOT > 0 ? 'text-danger' : '') + '">' + formatHours(e.totalOT) + '</td>' +
      '<td><span class="flag ' + e.flag.toLowerCase().replace(' ', '-') + '">' + e.flag + '</span></td>' +
    '</tr>';
  }).join('');
  
  // Store processed data for export
  AppState.multiLocationWithPayout = employees.map(function(e) {
    var payout = getPayoutLocation(e);
    return {
      employeeName: e.employeeName,
      payoutLocation: payout.loc === 'CH' ? 'Cockrell Hill DTO' : 'DBU',
      chHours: e.chHours || 0,
      dbuHours: e.dbuHours || 0,
      transferredHours: payout.transferHours,
      transferDirection: payout.transferFrom + ' ‚Üí ' + payout.loc,
      totalHours: e.totalHours,
      totalOT: e.totalOT
    };
  });
  
  // Show export buttons if there are multi-location employees
  var csvBtn = document.getElementById('exportTransferCSV');
  var pdfBtn = document.getElementById('exportTransferPDF');
  if (csvBtn) csvBtn.style.display = employees.length > 0 ? 'inline-flex' : 'none';
  if (pdfBtn) pdfBtn.style.display = employees.length > 0 ? 'inline-flex' : 'none';
}

/**
 * Export time transfer data as CSV or PDF
 */
function exportTimeTransfer(format) {
  var data = AppState.multiLocationWithPayout;
  if (!data || data.length === 0) {
    showToast('No multi-location data to export', 'error');
    return;
  }
  
  var periodEnd = AppState.processedData ? AppState.processedData.periodEnd : 'Unknown';
  var periodStr = periodEnd ? formatDate(periodEnd) : 'Current Period';
  
  if (format === 'csv') {
    // Build CSV content
    var headers = ['Employee Name', 'Pay-out Location', 'CH Hours', 'DBU Hours', 'Transferred Hours', 'Transfer Direction', 'Total Hours', 'Total OT'];
    var csvContent = headers.join(',') + '\n';
    
    data.forEach(function(row) {
      csvContent += [
        '"' + row.employeeName + '"',
        '"' + row.payoutLocation + '"',
        formatHours(row.chHours),
        formatHours(row.dbuHours),
        formatHours(row.transferredHours),
        '"' + row.transferDirection + '"',
        formatHours(row.totalHours),
        formatHours(row.totalOT)
      ].join(',') + '\n';
    });
    
    // Calculate totals
    var totalTransferred = data.reduce(function(sum, r) { return sum + r.transferredHours; }, 0);
    var toChHours = data.filter(function(r) { return r.payoutLocation === 'Cockrell Hill DTO'; })
                        .reduce(function(sum, r) { return sum + r.transferredHours; }, 0);
    var toDbuHours = data.filter(function(r) { return r.payoutLocation === 'DBU'; })
                         .reduce(function(sum, r) { return sum + r.transferredHours; }, 0);
    
    csvContent += '\n';
    csvContent += '"TOTALS",,,,,,\n';
    csvContent += '"Total Employees",' + data.length + ',,,,,\n';
    csvContent += '"Hours Transferred to CH",,' + formatHours(toChHours) + ',,,,\n';
    csvContent += '"Hours Transferred to DBU",,,' + formatHours(toDbuHours) + ',,,\n';
    csvContent += '"Total Hours Transferred",,,,' + formatHours(totalTransferred) + ',,\n';
    
    // Download
    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Time_Transfer_' + periodStr.replace(/[^a-zA-Z0-9]/g, '_') + '.csv';
    link.click();
    
    showToast('CSV exported successfully', 'success');
    
  } else if (format === 'pdf') {
    // Generate PDF via server
    showLoading(true);
    
    google.script.run
      .withSuccessHandler(function(result) {
        showLoading(false);
        if (result.success) {
          // Open PDF in new tab
          window.open(result.url, '_blank');
          showToast('PDF generated successfully', 'success');
        } else {
          showToast('Error generating PDF: ' + result.error, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showToast('Error generating PDF: ' + error.message, 'error');
      })
      .generateTimeTransferPDF(data, periodStr);
  }
}

// ============================================================================
// ALL EMPLOYEES TABLE SORTING
// ============================================================================

// Track current sort state for All Employees table
let allTableSort = { column: null, direction: 'asc' };

/**
 * Sort the All Employees table by column
 * @param {string} column - 'name', 'location', or 'hours'
 */
function sortAllTable(column) {
  // Toggle direction if same column, otherwise start ascending
  if (allTableSort.column === column) {
    allTableSort.direction = allTableSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    allTableSort.column = column;
    allTableSort.direction = 'asc';
  }
  
  // Get current employee data
  const employees = AppState.processedData?.allEmployees;
  if (!employees || employees.length === 0) return;
  
  // Sort the array (create a copy to avoid mutating original)
  const sorted = [...employees].sort((a, b) => {
    let valA, valB;
    
    switch (column) {
      case 'name':
        valA = (a.employeeName || '').toLowerCase();
        valB = (b.employeeName || '').toLowerCase();
        break;
      case 'location':
        valA = (a.location || '').toLowerCase();
        valB = (b.location || '').toLowerCase();
        break;
      case 'hours':
        valA = a.totalHours || 0;
        valB = b.totalHours || 0;
        break;
      default:
        return 0;
    }
    
    // Compare values
    if (valA < valB) return allTableSort.direction === 'asc' ? -1 : 1;
    if (valA > valB) return allTableSort.direction === 'asc' ? 1 : -1;
    return 0;
  });
  
  // Re-render table with sorted data
  renderAllTable(sorted);
  
  // Update sort icons to show current state
  updateSortIcons();
}

/**
 * Update visual sort indicators (arrows)
 */
function updateSortIcons() {
  // Clear all icons first
  ['name', 'location', 'hours'].forEach(col => {
    const icon = document.getElementById('sort-icon-' + col);
    if (icon) {
      icon.textContent = '';
      icon.closest('th')?.classList.remove('sort-active');
    }
  });
  
  // Set active icon with arrow
  if (allTableSort.column) {
    const activeIcon = document.getElementById('sort-icon-' + allTableSort.column);
    if (activeIcon) {
      activeIcon.textContent = allTableSort.direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
      activeIcon.closest('th')?.classList.add('sort-active');
    }
  }
}

/**
 * Reset sort state (called when new data is loaded)
 */
function resetAllTableSort() {
  allTableSort = { column: null, direction: 'asc' };
  updateSortIcons();
}

// ============================================================================

function renderAllTable(employees) {
  const tbody = document.getElementById('allTableBody');
  if (!tbody) return;
  
  if (employees.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No employees found</td></tr>';
    return;
  }
  
  tbody.innerHTML = employees.map((e, index) => `
    <tr class="employee-row ${e.location === 'Multi' ? 'highlight' : ''}" onclick="toggleEmployeeDetails(${index})" style="cursor: pointer;">
      <td class="name">
        <span class="expand-icon material-icons-round" id="expand-icon-${index}">chevron_right</span>
        ${e.employeeName} ${e.location === 'Multi' ? '<span class="multi-badge">Multi</span>' : ''}
      </td>
      <td>${e.location}</td>
      <td class="numeric">${formatHours(e.totalHours)}</td>
      <td class="numeric font-bold ${e.totalOT > 0 ? 'text-danger' : ''}">${formatHours(e.totalOT)}</td>
      <td class="numeric">$${(e.totalOT * (AppState.settings?.hourlyWage || 16.5) * 1.5).toFixed(2)}</td>
      <td><span class="flag ${e.flag.toLowerCase().replace(' ', '-')}">${e.flag}</span></td>
    </tr>
    <tr class="employee-details-row" id="details-row-${index}" style="display: none;">
      <td colspan="6" class="employee-details-cell">
        ${renderDailyBreakdown(e)}
      </td>
    </tr>
  `).join('');
  
  // Store employees data for toggle access
  window.allTableEmployees = employees;
}

/**
 * Toggle employee details accordion
 */
function toggleEmployeeDetails(index) {
  const detailsRow = document.getElementById('details-row-' + index);
  const expandIcon = document.getElementById('expand-icon-' + index);
  
  if (!detailsRow || !expandIcon) return;
  
  const isExpanded = detailsRow.style.display !== 'none';
  
  if (isExpanded) {
    detailsRow.style.display = 'none';
    expandIcon.textContent = 'chevron_right';
    expandIcon.classList.remove('expanded');
  } else {
    detailsRow.style.display = 'table-row';
    expandIcon.textContent = 'expand_more';
    expandIcon.classList.add('expanded');
  }
}

/**
 * Render daily hours breakdown for an employee
 */
function renderDailyBreakdown(employee) {
  // Safety check - if no week data, show message
  if (!employee.week1Start || !employee.week1End || !employee.week2Start || !employee.week2End) {
    return '<div class="daily-breakdown"><p style="padding: 12px; color: var(--gray-500);">Daily breakdown not available</p></div>';
  }
  
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  
  // Get all dates for each week
  function getDatesInRange(startStr, endStr) {
    const dates = [];
    try {
      const start = new Date(startStr + 'T00:00:00');
      const end = new Date(endStr + 'T00:00:00');
      const current = new Date(start);
      
      // Safety: limit to 14 days max
      let count = 0;
      while (current <= end && count < 14) {
        dates.push(current.toISOString().split('T')[0]);
        current.setDate(current.getDate() + 1);
        count++;
      }
    } catch (e) {
      console.error('Error getting date range:', e);
    }
    return dates;
  }
  
  function formatDateShort(dateStr) {
    const parts = dateStr.split('-');
    const date = new Date(parts[0], parts[1] - 1, parts[2]);
    return `${dayNames[date.getDay()]} ${parseInt(parts[1])}/${parseInt(parts[2])}`;
  }
  
  function formatWeekRange(startStr, endStr) {
    const startParts = startStr.split('-');
    const endParts = endStr.split('-');
    const startDate = new Date(startParts[0], startParts[1] - 1, startParts[2]);
    const endDate = new Date(endParts[0], endParts[1] - 1, endParts[2]);
    return `${monthNames[startDate.getMonth()]} ${startDate.getDate()} - ${monthNames[endDate.getMonth()]} ${endDate.getDate()}`;
  }
  
  // Combine CH and DBU daily hours
  const allDailyHours = {};
  
  // Add CH hours
  if (employee.chDailyHours) {
    Object.entries(employee.chDailyHours).forEach(([date, hours]) => {
      if (!allDailyHours[date]) allDailyHours[date] = { ch: 0, dbu: 0 };
      allDailyHours[date].ch = hours;
    });
  }
  
  // Add DBU hours
  if (employee.dbuDailyHours) {
    Object.entries(employee.dbuDailyHours).forEach(([date, hours]) => {
      if (!allDailyHours[date]) allDailyHours[date] = { ch: 0, dbu: 0 };
      allDailyHours[date].dbu = hours;
    });
  }
  
  const isMulti = employee.location === 'Multi';
  const week1Dates = getDatesInRange(employee.week1Start, employee.week1End);
  const week2Dates = getDatesInRange(employee.week2Start, employee.week2End);
  
  function renderWeek(dates, weekNum, weekHours, weekOT) {
    const startDate = dates[0];
    const endDate = dates[dates.length - 1];
    
    let html = `
      <div class="week-breakdown">
        <div class="week-header">
          <span class="week-label">Week ${weekNum}</span>
          <span class="week-dates">${formatWeekRange(startDate, endDate)}</span>
          <span class="week-total">${formatHours(weekHours)} hrs${weekOT > 0 ? ` <span class="week-ot">(+${formatHours(weekOT)} OT)</span>` : ''}</span>
        </div>
        <div class="days-grid">
    `;
    
    dates.forEach(dateStr => {
      const dayData = allDailyHours[dateStr] || { ch: 0, dbu: 0 };
      const totalForDay = dayData.ch + dayData.dbu;
      const hasHours = totalForDay > 0;
      
      html += `
        <div class="day-cell ${hasHours ? 'has-hours' : 'no-hours'}">
          <div class="day-name">${formatDateShort(dateStr)}</div>
          <div class="day-hours">${hasHours ? formatHours(totalForDay) : '-'}</div>
          ${isMulti && hasHours ? `
            <div class="day-breakdown">
              ${dayData.ch > 0 ? `<span class="loc-ch">CH: ${formatHours(dayData.ch)}</span>` : ''}
              ${dayData.dbu > 0 ? `<span class="loc-dbu">DBU: ${formatHours(dayData.dbu)}</span>` : ''}
            </div>
          ` : ''}
        </div>
      `;
    });
    
    html += '</div></div>';
    return html;
  }
  
  return `
    <div class="daily-breakdown">
      ${renderWeek(week1Dates, 1, employee.week1Hours, employee.week1OT)}
      ${renderWeek(week2Dates, 2, employee.week2Hours, employee.week2OT)}
    </div>
  `;
}

function saveToHistory() {
  if (!AppState.processedData) {
    showToast('No data to save', 'error');
    return;
  }
  
  // Check if this is a bulk upload
  const isBulk = AppState.processedData.allPeriods && AppState.processedData.allPeriods.length > 1;
  
  if (isBulk) {
    // Bulk save - save all periods
    saveBulkPeriods(false);
  } else {
    // Single period save
    saveSinglePeriod(false);
  }
}

function saveSinglePeriod(overwrite) {
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast(result.message, 'success');
        clearUploadedData();
        loadDashboardData();
      } else if (result.error === 'duplicate') {
        if (confirm(result.message)) {
          saveSinglePeriod(true);
        }
      } else {
        showToast(result.error || 'Failed to save', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Failed to save: ' + error.message, 'error');
    })
    .saveOTData(AppState.processedData.allEmployees, AppState.processedData.periodEnd, overwrite);
}

function saveBulkPeriods(overwrite) {
  const periods = AppState.processedData.allPeriods;
  const totalPeriods = periods.length;
  let savedCount = 0;
  let errorCount = 0;
  
  showLoading(true);
  showToast(`Saving ${totalPeriods} pay periods... This may take a moment.`, 'info');
  
  // Save periods sequentially to avoid overwhelming the server
  function saveNextPeriod(index) {
    if (index >= periods.length) {
      // All done
      showLoading(false);
      if (errorCount === 0) {
        showToast(`Successfully saved all ${savedCount} pay periods!`, 'success');
        clearUploadedData();
        loadDashboardData();
      } else {
        showToast(`Saved ${savedCount} periods, ${errorCount} had errors`, 'warning');
        loadDashboardData();
      }
      return;
    }
    
    const period = periods[index];
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success || result.error === 'duplicate') {
          savedCount++;
        } else {
          errorCount++;
          console.error('Error saving period', period.periodEnd, result.error);
        }
        
        // Update progress
        const progress = Math.round(((index + 1) / totalPeriods) * 100);
        console.log(`Progress: ${progress}% (${index + 1}/${totalPeriods})`);
        
        // Save next period
        setTimeout(() => saveNextPeriod(index + 1), 100); // Small delay to prevent overwhelming
      })
      .withFailureHandler(function(error) {
        errorCount++;
        console.error('Failed to save period', period.periodEnd, error);
        setTimeout(() => saveNextPeriod(index + 1), 100);
      })
      .saveOTData(period.employees, period.periodEnd, overwrite);
  }
  
  // Start saving
  saveNextPeriod(0);
}

function saveWithOverwrite() {
  const isBulk = AppState.processedData.allPeriods && AppState.processedData.allPeriods.length > 1;
  if (isBulk) {
    saveBulkPeriods(true);
  } else {
    saveSinglePeriod(true);
  }
}

function clearUploadedData() {
  // Clear uploaded data for all dynamic locations
  if (AppState.locations && AppState.locations.length > 0) {
    AppState.uploadedData = {};
    AppState.locations.forEach(function(loc) {
      AppState.uploadedData[loc.id] = null;
      resetUploadCard('upload_' + loc.id, loc.name, 'Drop CSV or click to upload');
    });
  } else {
    // Fallback for legacy
  AppState.uploadedData = { ch: null, dbu: null };
  resetUploadCard('uploadCH', 'Cockrell Hill DTO', 'Drop CSV or click to upload');
  resetUploadCard('uploadDBU', 'DBU', 'Drop CSV or click to upload');
  }
  AppState.processedData = null;
  updateProcessButton();
  
  document.getElementById('resultsSection')?.classList.add('hidden');
  
  // Hide save button
  const saveBtn = document.getElementById('saveBtn');
  if (saveBtn) {
    saveBtn.classList.add('hidden');
  }
}

// ============================================================================
// HISTORY BROWSER
// ============================================================================
function loadHistoryData() {
  updatePeriodSelectors();
  const select = document.getElementById('periodSelect');
  if (select && select.value) {
    loadPeriodData();
  }
}

function updatePeriodSelectors() {
  const select = document.getElementById('periodSelect');
  if (!select || AppState.periods.length === 0) return;
  
  select.innerHTML = '<option value="">Select a pay period...</option>' +
    AppState.periods.map(p => `<option value="${new Date(p).toISOString()}">${formatDate(p)}</option>`).join('');
}

function loadPeriodData() {
  const select = document.getElementById('periodSelect');
  if (!select || !select.value) {
    console.log('No period selected');
    return;
  }
  
  console.log('Loading period data for:', select.value);
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      console.log('Period data result:', result);
      if (result && result.success) {
        renderPeriodData(result);
      } else {
        showToast(result?.error || 'No data found', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      console.error('Failed to load period data:', error);
      showToast('Failed to load period data: ' + (error?.message || error), 'error');
    })
    .getPeriodData(select.value);
}

function renderPeriodData(data) {
  document.getElementById('histEmployees').textContent = data.stats.employeeCount;
  document.getElementById('histTotalOT').textContent = formatHours(data.stats.totalOT);
  document.getElementById('histTotalCost').textContent = '$' + data.stats.totalCost.toFixed(2);
  document.getElementById('histHighOT').textContent = data.stats.highOTCount;
  
  document.getElementById('historyStats')?.classList.remove('hidden');
  
  const tbody = document.getElementById('historyTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = data.employees.map(e => `
    <tr ${e.isMultiLocation ? 'class="highlight"' : ''}>
      <td class="name">${e.employeeName} ${e.isMultiLocation ? '<span class="multi-badge">Multi</span>' : ''}</td>
      <td>${e.location}</td>
      <td class="numeric">${formatHours(e.chHours || 0)}</td>
      <td class="numeric">${formatHours(e.dbuHours || 0)}</td>
      <td class="numeric font-bold">${formatHours(e.totalHours)}</td>
      <td class="numeric font-bold ${e.totalOT > 0 ? 'text-danger' : ''}">${formatHours(e.totalOT)}</td>
      <td class="numeric">$${e.otCost.toFixed(2)}</td>
      <td><span class="flag ${e.flag.toLowerCase().replace(' ', '-')}">${e.flag}</span></td>
    </tr>
  `).join('');
}

// ============================================================================
// EMPLOYEE LOOKUP
// ============================================================================
function loadEmployeeList() {
  google.script.run
    .withSuccessHandler(function(names) {
      AppState.employees = names || [];
      const datalist = document.getElementById('employeeList');
      if (datalist) {
        datalist.innerHTML = names.map(n => `<option value="${n}">`).join('');
      }
    })
    .withFailureHandler(console.error)
    .getAllEmployeeNames();
}

function searchEmployees() {
  const input = document.getElementById('employeeSearch');
  if (!input || !input.value) return;
  loadEmployeeData(input.value);
}

function loadEmployeeHistory() {
  const select = document.getElementById('employeeSelect');
  if (select && select.value) loadEmployeeData(select.value);
}

function loadEmployeeData(name) {
  console.log('Loading employee data for:', name);
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      console.log('Employee data result:', result);
      if (result && result.success && result.stats) {
        // Full employee data with stats
        renderEmployeeData(result);
      } else if (result && result.partialMatches) {
        // No exact match, show suggestions
        showPartialMatches(result.partialMatches);
      } else {
        showToast(result?.error || 'Employee not found', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      console.error('Failed to load employee data:', error);
      showToast('Failed to load employee data', 'error');
    })
    .getEmployeeHistory(name);
}

function renderEmployeeData(data) {
  document.getElementById('empName').textContent = data.employeeName;
  document.getElementById('empPeriods').textContent = data.stats.periodsWorked;
  document.getElementById('empTotalOT').textContent = formatHours(data.stats.totalOT);
  document.getElementById('empAvgOT').textContent = formatHours(data.stats.avgOTPerPeriod);
  document.getElementById('empCost').textContent = '$' + data.stats.totalCost.toFixed(2);
  document.getElementById('empMulti').textContent = data.stats.multiLocationPeriods;
  
  document.getElementById('employeeStats')?.classList.remove('hidden');
  
  // Render alerts
  const alertsDiv = document.getElementById('empAlerts');
  if (alertsDiv) {
    alertsDiv.innerHTML = data.alerts.length > 0 
      ? data.alerts.map(a => `<div class="alert-item warning"><span class="material-icons-round">warning</span><div class="alert-content"><p>${a}</p></div></div>`).join('')
      : '';
  }
  
  // Render chart
  renderEmployeeChart(data.records);
  
  // Render table
  const tbody = document.getElementById('empTableBody');
  if (tbody) {
    tbody.innerHTML = data.records.map(r => `
      <tr ${r.isMultiLocation ? 'class="highlight"' : ''}>
        <td>${formatDate(r.periodEnd)}</td>
        <td>${r.location}</td>
        <td class="numeric">${formatHours(r.totalHours)}</td>
        <td class="numeric font-bold ${r.totalOT > 0 ? 'text-danger' : ''}">${formatHours(r.totalOT)}</td>
        <td class="numeric">$${r.otCost.toFixed(2)}</td>
        <td><span class="flag ${r.flag.toLowerCase().replace(' ', '-')}">${r.flag}</span></td>
      </tr>
    `).join('');
  }
}

function renderEmployeeChart(records) {
  google.charts.setOnLoadCallback(() => {
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Period');
    data.addColumn('number', 'OT Hours');
    
    records.slice().reverse().slice(-12).forEach(r => {
      data.addRow([formatDate(r.periodEnd), r.totalOT]);
    });
    
    const options = {
      legend: { position: 'none' },
      colors: ['#E51636'],
      chartArea: { width: '85%', height: '75%' },
      vAxis: { title: 'OT Hours', minValue: 0 }
    };
    
    const chart = new google.visualization.ColumnChart(document.getElementById('employeeChart'));
    chart.draw(data, options);
  });
}

// ============================================================================
// TRENDS
// ============================================================================
function loadTrendData() {
  const range = document.getElementById('trendRange')?.value || '6m';
  console.log('Loading trend data for range:', range);
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      console.log('Trend data result:', result);
      if (result && result.success) {
        renderTrendData(result);
      } else {
        showToast(result?.error || 'No trend data available', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      console.error('Failed to load trend data:', error);
      showToast('Failed to load trend data', 'error');
    })
    .getTrendData(range);
}

function renderTrendData(data) {
  // Stats
  document.getElementById('trendPeriods').textContent = data.totals.periodsCount;
  document.getElementById('trendEmployees').textContent = data.totals.uniqueEmployees;
  document.getElementById('trendTotalOT').textContent = formatHours(data.totals.totalOT);
  document.getElementById('trendTotalCost').textContent = '$' + data.totals.totalCost.toFixed(0);
  
  document.getElementById('trendsStats')?.classList.remove('hidden');
  
  // OT Over Time Chart
  renderOTTrendChart(data.periodData);
  
  // Top Employees Chart
  renderTopEmployeesChart(data.topEmployees);
  
  // Top employees table
  renderTopEmployeesTable(data.topEmployees);
  
  // Populate month selector for transfers
  if (data.monthlyData) {
    populateMonthSelector(data.monthlyData);
  }
}

function renderOTTrendChart(periodData) {
  google.charts.setOnLoadCallback(() => {
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Period');
    data.addColumn('number', 'OT Hours');
    data.addColumn('number', 'Employees');
    
    periodData.forEach(p => {
      const d = new Date(p.periodEnd);
      data.addRow([(d.getMonth()+1) + '/' + d.getDate(), p.totalOT, p.employeeCount]);
    });
    
    const options = {
      legend: { position: 'bottom' },
      colors: ['#E51636', '#6366F1'],
      chartArea: { width: '85%', height: '65%' },
      vAxes: { 0: { title: 'OT Hours' }, 1: { title: 'Employees' } },
      series: { 0: { targetAxisIndex: 0 }, 1: { targetAxisIndex: 1, type: 'line' } }
    };
    
    const chart = new google.visualization.ComboChart(document.getElementById('otTrendChart'));
    chart.draw(data, options);
  });
}

function renderTopEmployeesChart(employees) {
  google.charts.setOnLoadCallback(() => {
    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Employee');
    data.addColumn('number', 'Total OT');
    
    employees.slice(0, 10).forEach(e => {
      data.addRow([e.employeeName.split(' ')[0], e.totalOT]);
    });
    
    const options = {
      legend: { position: 'none' },
      colors: ['#E51636'],
      chartArea: { width: '70%', height: '80%' },
      hAxis: { title: 'Total OT Hours' }
    };
    
    const chart = new google.visualization.BarChart(document.getElementById('topEmployeesChart'));
    chart.draw(data, options);
  });
}

function renderTopEmployeesTable(employees) {
  const tbody = document.getElementById('topEmployeesBody');
  if (!tbody) return;
  
  tbody.innerHTML = employees.slice(0, 15).map((e, i) => `
    <tr>
      <td class="font-bold">${i + 1}</td>
      <td class="name">${e.employeeName}</td>
      <td class="numeric">${e.periods}</td>
      <td class="numeric font-bold text-danger">${formatHours(e.totalOT)}</td>
      <td class="numeric">$${e.totalCost.toFixed(2)}</td>
      <td class="numeric">${formatHours(e.avgOT)}</td>
    </tr>
  `).join('');
}

// ============================================================================
// MONTHLY TIME TRANSFERS
// ============================================================================

/**
 * Populate the month selector dropdown based on available data
 */
function populateMonthSelector(monthlyData) {
  var select = document.getElementById('transferMonthSelect');
  if (!select || !monthlyData) return;
  
  // Store for later use
  AppState.monthlyData = monthlyData;
  
  // Build month options (newest first)
  var months = monthlyData.slice().sort(function(a, b) {
    return b.month.localeCompare(a.month);
  });
  
  select.innerHTML = '<option value="">Select Month...</option>' +
    months.map(function(m) {
      var parts = m.month.split('-');
      var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
      var label = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      return '<option value="' + m.month + '">' + label + '</option>';
    }).join('');
}

/**
 * Load monthly transfer data for selected month
 */
function loadMonthlyTransfers() {
  var select = document.getElementById('transferMonthSelect');
  var month = select ? select.value : '';
  
  if (!month) {
    // Reset to empty state
    document.getElementById('transferCount').textContent = '--';
    document.getElementById('transferToCH').textContent = '--';
    document.getElementById('transferToDBU').textContent = '--';
    document.getElementById('transferTotal').textContent = '--';
    document.getElementById('transferTableBody').innerHTML = 
      '<tr><td colspan="6"><div class="empty-state"><span class="material-icons-round">info</span><p>Select a month to view transfer details</p></div></td></tr>';
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result && result.success) {
        renderMonthlyTransfers(result);
      } else {
        showToast(result?.error || 'No transfer data found', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error loading transfer data: ' + error.message, 'error');
    })
    .getMonthlyTransferData(month);
}

/**
 * Render monthly transfer data
 */
function renderMonthlyTransfers(data) {
  // Update summary stats
  document.getElementById('transferCount').textContent = data.employees.length;
  document.getElementById('transferToCH').textContent = formatHours(data.toCH);
  document.getElementById('transferToDBU').textContent = formatHours(data.toDBU);
  
  // Show net transfer with direction indicator
  // netDirection shows who RECEIVED more transfers, so they owe the other location
  // e.g., if DBU received more, DBU owes CH, so display "DBU ‚Üí CH"
  var netDisplay = formatHours(data.totalTransferred);
  if (data.netDirection && data.netDirection !== 'EVEN') {
    var owesTo = data.netDirection === 'DBU' ? 'CH' : 'DBU';
    netDisplay += ' (' + data.netDirection + ' ‚Üí ' + owesTo + ')';
  }
  document.getElementById('transferTotal').textContent = netDisplay;
  
  // Update table
  var tbody = document.getElementById('transferTableBody');
  if (!tbody) return;
  
  if (data.employees.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><span class="material-icons-round">check_circle</span><p>No multi-location employees this month</p></div></td></tr>';
    return;
  }
  
  tbody.innerHTML = data.employees.map(function(e) {
    var payoutLoc = (e.chHours > e.dbuHours) ? 'Cockrell Hill DTO' : 'DBU';
    var payoutShort = (e.chHours > e.dbuHours) ? 'CH' : 'DBU';
    var transferFrom = (e.chHours > e.dbuHours) ? 'DBU' : 'CH';
    var transferred = (e.chHours > e.dbuHours) ? e.dbuHours : e.chHours;
    
    return '<tr>' +
      '<td class="name">' + e.employeeName + ' <span class="payout-badge ' + payoutShort.toLowerCase() + '">üìç ' + payoutShort + '</span></td>' +
      '<td>' + payoutLoc + '</td>' +
      '<td class="numeric">' + formatHours(e.chHours) + '</td>' +
      '<td class="numeric">' + formatHours(e.dbuHours) + '</td>' +
      '<td class="numeric font-bold">' + formatHours(transferred) + '</td>' +
      '<td>' + transferFrom + ' ‚Üí ' + payoutShort + '</td>' +
    '</tr>';
  }).join('');
}

// ============================================================================
// SETTINGS
// ============================================================================
function loadSettingsData() {
  if (!AppState.settings) return;
  
  document.getElementById('settingWage').value = AppState.settings.hourlyWage || 16.5;
  document.getElementById('settingMultiplier').value = AppState.settings.otMultiplier || 1.5;
  document.getElementById('settingModerate').value = AppState.settings.moderateThreshold || 5;
  document.getElementById('settingHigh').value = AppState.settings.highThreshold || 10;
  document.getElementById('settingLoc1').value = AppState.settings.location1Name || 'Cockrell Hill DTO';
  document.getElementById('settingLoc2').value = AppState.settings.location2Name || 'DBU';
}

function saveSettings(e) {
  e.preventDefault();
  
  const newSettings = {
    hourlyWage: parseFloat(document.getElementById('settingWage').value) || 16.5,
    otMultiplier: parseFloat(document.getElementById('settingMultiplier').value) || 1.5,
    moderateThreshold: parseFloat(document.getElementById('settingModerate').value) || 5,
    highThreshold: parseFloat(document.getElementById('settingHigh').value) || 10,
    location1Name: document.getElementById('settingLoc1').value || 'Cockrell Hill DTO',
    location2Name: document.getElementById('settingLoc2').value || 'DBU'
  };
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        AppState.settings = newSettings;
        CONFIG.MODERATE_THRESHOLD = newSettings.moderateThreshold;
        CONFIG.HIGH_THRESHOLD = newSettings.highThreshold;
        showToast('Settings saved successfully', 'success');
      } else {
        showToast(result.error || 'Failed to save settings', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Failed to save settings', 'error');
    })
    .updateSettings(newSettings);
}

// ============================================================================
// PDF EXPORT
// ============================================================================
function exportPeriodPDF() {
  const periodEnd = document.getElementById('periodSelect')?.value;
  if (!periodEnd) {
    showToast('Please select a period first', 'error');
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        window.open(result.url, '_blank');
        showToast('PDF generated successfully', 'success');
      } else {
        showToast(result.error || 'Failed to generate PDF', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Failed to generate PDF', 'error');
    })
    .generatePDFReport('period', { periodEnd: periodEnd });
}

function exportEmployeePDF() {
  const name = document.getElementById('empName')?.textContent;
  if (!name) {
    showToast('Please select an employee first', 'error');
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        window.open(result.url, '_blank');
      } else {
        showToast(result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Failed to generate PDF', 'error');
    })
    .generatePDFReport('employee', { employeeName: name });
}

function exportTrendsPDF() {
  const range = document.getElementById('trendRange')?.value || '6m';
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        window.open(result.url, '_blank');
      } else {
        showToast(result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Failed to generate PDF', 'error');
    })
    .generatePDFReport('trends', { timeRange: range });
}

// ============================================================================
// CSV PARSING (Client-side)
// ============================================================================
function parseCSV(content, location) {
  try {
    const lines = content.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) return { success: false, error: 'CSV file is empty' };
    
    const headers = parseCSVLine(lines[0]).map(h => h.toUpperCase().replace(/"/g, ''));
    const nameCol = headers.findIndex(h => h === 'FULL_NAME' || h.includes('NAME'));
    const startCol = headers.findIndex(h => h === 'START_TIME' || h === 'DATE' || h.includes('START'));
    const lengthCol = headers.findIndex(h => h === 'PUNCH_LENGTH' || h === 'HOURS' || h.includes('LENGTH'));
    const typeCol = headers.findIndex(h => h === 'PUNCH_TYPE');
    // NEW: Find EMPLOYEE_NUMBER column
    const empNumCol = headers.findIndex(h => h === 'EMPLOYEE_NUMBER' || h === 'EMPLOYEE_NUM' || h === 'EMP_NUMBER');
    
    if (nameCol === -1) return { success: false, error: 'Name column not found' };
    if (startCol === -1) return { success: false, error: 'Date column not found' };
    if (lengthCol === -1) return { success: false, error: 'Hours column not found' };
    
    const employees = {};
    let latestDate = null;
    
    for (let i = 1; i < lines.length; i++) {
      const row = parseCSVLine(lines[i]);
      if (row.length <= Math.max(nameCol, startCol, lengthCol)) continue;
      
      // Note: Removed 'B' type filter - CFA Home uses 'B' for departments, not breaks
      // If you need to filter actual breaks, check for PUNCH_TYPE === 'BREAK' explicitly
      
      const rawName = row[nameCol]?.replace(/"/g, '').trim();
      if (!rawName) continue;
      
      const name = normalizeName(rawName);
      const matchKey = name.toLowerCase().replace(/\s+/g, ' ');
      const dateStr = row[startCol]?.replace(/"/g, '').trim();
      const hoursRaw = row[lengthCol]?.replace(/"/g, '').trim() || '0';
      const hours = parseHoursValue(hoursRaw);
      
      // NEW: Extract employee number if column exists
      const employeeNumber = empNumCol !== -1 ? (row[empNumCol]?.replace(/"/g, '').trim() || '') : '';
      
      const date = parseDate(dateStr);
      if (!date) continue;
      
      if (!latestDate || date > latestDate) latestDate = new Date(date);
      
      const dateKey = date.toISOString().split('T')[0];
      
      if (!employees[matchKey]) {
        employees[matchKey] = { 
          displayName: name, 
          employeeId: employeeNumber,  // NEW: Store employee ID
          dailyHours: {} 
        };
      } else if (employeeNumber && !employees[matchKey].employeeId) {
        // Update employeeId if we find it in a later row
        employees[matchKey].employeeId = employeeNumber;
      }
      
      if (!employees[matchKey].dailyHours[dateKey]) {
        employees[matchKey].dailyHours[dateKey] = 0;
      }
      employees[matchKey].dailyHours[dateKey] += hours;
    }
    
    return {
      success: true,
      employeeData: employees,
      latestDate: latestDate,
      employeeCount: Object.keys(employees).length,
      location: location
    };
  } catch (e) {
    return { success: false, error: e.message };
  }
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') inQuotes = !inQuotes;
    else if (c === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
    else current += c;
  }
  result.push(current.trim());
  return result;
}

function normalizeName(name) {
  if (name.includes(',')) {
    const parts = name.split(',').map(p => p.trim());
    if (parts.length >= 2) return `${parts[1]} ${parts[0]}`;
  }
  return name;
}

function parseDate(str) {
  let match = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (match) return new Date(+match[1], +match[2]-1, +match[3]);
  match = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
  if (match) {
    let y = +match[3]; if (y < 100) y += 2000;
    return new Date(y, +match[1]-1, +match[2]);
  }
  return null;
}

/**
 * Parses hours value from CSV - handles multiple formats robustly:
 * - Decimal: "29.84" or "29,84" -> 29.84
 * - HH:MM: "29:50" -> 29.833...
 * - HH:MM:SS: "29:50:24" -> 29.84
 * - H:MM:SS: "5:30:00" -> 5.5
 * - Negative values: "-2:30" -> -2.5
 * - With whitespace: " 29:50 " -> 29.833...
 * @param {string} value - The hours value from CSV
 * @returns {number} Hours as decimal (rounded to 4 decimal places)
 */
function parseHoursValue(value) {
  if (value === null || value === undefined || value === '') return 0;
  
  // Convert to string and clean
  value = String(value).trim();
  if (value === '' || value === '-') return 0;
  
  // Check for negative values
  let isNegative = false;
  if (value.startsWith('-')) {
    isNegative = true;
    value = value.substring(1).trim();
  }
  
  let result = 0;
  
  // Check if it contains colons (time format: H:MM, HH:MM, H:MM:SS, HH:MM:SS)
  if (value.includes(':')) {
    const parts = value.split(':');
    
    // Parse hours (first part)
    const hours = parseInt(parts[0]) || 0;
    
    // Parse minutes (second part) - handle decimal minutes too
    let minutes = 0;
    if (parts.length >= 2 && parts[1]) {
      minutes = parseFloat(parts[1]) || 0;
    }
    
    // Parse seconds (third part if exists)
    let seconds = 0;
    if (parts.length >= 3 && parts[2]) {
      seconds = parseFloat(parts[2]) || 0;
    }
    
    // Convert to decimal hours
    result = hours + (minutes / 60) + (seconds / 3600);
  } else {
    // Handle decimal format - support both period and comma as decimal separator
    value = value.replace(',', '.');
    result = parseFloat(value) || 0;
  }
  
  // Apply negative sign if needed
  if (isNegative) {
    result = -result;
  }
  
  // Round to 4 decimal places to avoid floating point issues
  return Math.round(result * 10000) / 10000;
}

/**
 * Process OT data from dynamic number of locations
 * Converts array of location data to format compatible with processOTData
 * @param {Array} uploadedDataArray - Array of parsed CSV data objects from each location
 */
function processOTDataDynamic(uploadedDataArray) {
  if (!uploadedDataArray || uploadedDataArray.length === 0) {
    return { allEmployees: [], multiLocation: [], allPeriods: [], stats: { totalEmployees: 0, multiCount: 0, totalOT: 0, highOTCount: 0, periodsDetected: 0 } };
  }
  
  // If 1-2 locations, use legacy processOTData for compatibility
  if (uploadedDataArray.length === 1) {
    return processOTData(uploadedDataArray[0], null);
  }
  if (uploadedDataArray.length === 2) {
    return processOTData(uploadedDataArray[0], uploadedDataArray[1]);
  }
  
  // For 3+ locations, we need to merge all data into a combined format
  // First, collect data from location 1 and 2
  var combinedData1 = uploadedDataArray[0];
  var combinedData2 = uploadedDataArray[1];
  
  // Process first two locations
  var result = processOTData(combinedData1, combinedData2);
  
  // For additional locations (3+), merge their employee data into the result
  for (var i = 2; i < uploadedDataArray.length; i++) {
    var additionalData = uploadedDataArray[i];
    if (additionalData && additionalData.employeeData) {
      result = mergeAdditionalLocationData(result, additionalData);
    }
  }
  
  return result;
}

/**
 * Merge additional location data into existing processed results
 * Used when there are more than 2 locations
 */
function mergeAdditionalLocationData(existingResult, additionalData) {
  // This is a simplified merge - adds hours from additional location
  // For full support of 3+ locations, the processOTData function would need refactoring
  // For now, additional locations are treated as a secondary location for OT calculation
  
  var locationName = additionalData.location || 'Location ' + (existingResult.locationCount || 3);
  
  // Add additional location hours to existing employees or create new ones
  for (var matchKey in additionalData.employeeData) {
    var empData = additionalData.employeeData[matchKey];
    
    // Find existing employee in allEmployees
    var existingEmp = existingResult.allEmployees.find(function(e) {
      return e.matchKey === matchKey;
    });
    
    if (existingEmp) {
      // Add hours from this location
      var additionalHours = 0;
      for (var dateKey in empData.dailyHours) {
        additionalHours += empData.dailyHours[dateKey] || 0;
      }
      existingEmp.totalHours = (existingEmp.totalHours || 0) + additionalHours;
      // Recalculate OT
      existingEmp.regular = Math.min(existingEmp.totalHours, 80);
      existingEmp.ot = Math.max(existingEmp.totalHours - 80, 0);
      // Update multi-location flag
      if (additionalHours > 0) {
        existingEmp.isMultiLocation = true;
      }
    } else {
      // New employee from additional location
      var totalHours = 0;
      for (var dk in empData.dailyHours) {
        totalHours += empData.dailyHours[dk] || 0;
      }
      existingResult.allEmployees.push({
        name: empData.displayName,
        matchKey: matchKey,
        location: locationName,
        totalHours: totalHours,
        regular: Math.min(totalHours, 80),
        ot: Math.max(totalHours - 80, 0),
        isMultiLocation: false
      });
    }
  }
  
  // Update stats
  existingResult.stats.totalEmployees = existingResult.allEmployees.length;
  existingResult.stats.multiCount = existingResult.allEmployees.filter(function(e) { return e.isMultiLocation; }).length;
  existingResult.stats.totalOT = existingResult.allEmployees.reduce(function(sum, e) { return sum + (e.ot || 0); }, 0);
  
  existingResult.locationCount = (existingResult.locationCount || 2) + 1;
  
  return existingResult;
}

/**
 * Process OT data - handles MULTIPLE pay periods for bulk uploads
 * Automatically detects all pay periods in the data
 */
function processOTData(chData, dbuData) {
  // Collect all dates from both datasets
  const allDates = new Set();
  
  if (chData && chData.employeeData) {
    for (const emp of Object.values(chData.employeeData)) {
      for (const dateStr of Object.keys(emp.dailyHours)) {
        allDates.add(dateStr);
      }
    }
  }
  
  if (dbuData && dbuData.employeeData) {
    for (const emp of Object.values(dbuData.employeeData)) {
      for (const dateStr of Object.keys(emp.dailyHours)) {
        allDates.add(dateStr);
      }
    }
  }
  
  if (allDates.size === 0) {
    return { allEmployees: [], multiLocation: [], allPeriods: [], stats: { totalEmployees: 0, multiCount: 0, totalOT: 0, highOTCount: 0, periodsDetected: 0 } };
  }
  
  // Convert to sorted date array
  const sortedDates = Array.from(allDates)
    .map(function(d) { var parts = d.split('-').map(Number); return new Date(parts[0], parts[1]-1, parts[2]); })
    .sort(function(a,b) { return a - b; });
  
  var earliestDate = sortedDates[0];
  var latestDate = sortedDates[sortedDates.length - 1];
  
  console.log('Date range:', earliestDate.toDateString(), 'to', latestDate.toDateString());
  console.log('Total unique dates:', allDates.size);
  
  // Calculate pay period based on settings payroll date
  // This ensures alignment with the Payroll Processing view
  var payPeriods = [];
  
  try {
    // Get next payroll date from settings (stored in AppState)
    // The pay period ends on the Saturday before the payroll date
    var nextPayrollDate = null;
    
    if (AppState.settings && AppState.settings.nextPayrollDate) {
      // Parse the settings date (format: YYYY-MM-DD or similar)
      var pDateStr = AppState.settings.nextPayrollDate;
      if (typeof pDateStr === 'string') {
        var pParts = pDateStr.split(/[-\/]/);
        if (pParts.length >= 3) {
          nextPayrollDate = new Date(parseInt(pParts[0]), parseInt(pParts[1]) - 1, parseInt(pParts[2]));
        }
      } else if (pDateStr instanceof Date) {
        nextPayrollDate = pDateStr;
      }
    }
    
    // If no valid payroll date, calculate from latest data date
    if (!nextPayrollDate || isNaN(nextPayrollDate.getTime())) {
      console.log('No valid payroll date in settings, calculating from data');
      // Find the Saturday on or after the latest date, then add days to next payroll
      var pe = new Date(latestDate);
      var dow = pe.getDay();
      if (dow !== 6) pe.setDate(pe.getDate() + (6 - dow)); // Move to Saturday
      pe.setDate(pe.getDate() + 5); // Move to following Thursday (typical payroll day)
      nextPayrollDate = pe;
    }
    
    console.log('Using payroll date:', nextPayrollDate.toDateString());
    
    // Calculate the pay period end (Saturday before payroll)
    // Pay period runs Sunday-Saturday, payroll is processed the following week
    var periodEnd = new Date(nextPayrollDate);
    periodEnd.setHours(0, 0, 0, 0);
    
    // Move back to the previous Saturday (day 6)
    var payDow = periodEnd.getDay();
    // Calculate days to go back to reach Saturday
    // Sun=0 -> back 1, Mon=1 -> back 2, Tue=2 -> back 3, Wed=3 -> back 4, Thu=4 -> back 5, Fri=5 -> back 6, Sat=6 -> back 7
    var daysToSaturday = payDow === 6 ? 7 : payDow + 1;
    periodEnd.setDate(periodEnd.getDate() - daysToSaturday);
    
    // Now create pay periods going backwards to cover all data
    var MAX_PERIODS = 26; // 6 months back max
    var currentPeriodEnd = new Date(periodEnd);
    
    // First, go forward if needed to ensure we capture latest data
    while (currentPeriodEnd < latestDate) {
    currentPeriodEnd.setDate(currentPeriodEnd.getDate() + 14);
    }
    
    // Now generate periods backwards from that point
    while (currentPeriodEnd >= earliestDate && payPeriods.length < MAX_PERIODS) {
      var pEnd = new Date(currentPeriodEnd);
      pEnd.setHours(0, 0, 0, 0);
      
      var pStart = new Date(pEnd);
      pStart.setDate(pStart.getDate() - 13);
      
      // Week 1: First 7 days (Sunday-Saturday)
      var w1Start = new Date(pStart);
      var w1End = new Date(pStart);
      w1End.setDate(w1End.getDate() + 6);
      
      // Week 2: Last 7 days (Sunday-Saturday)
      var w2Start = new Date(w1End);
      w2Start.setDate(w2Start.getDate() + 1);
      
      // Only add if there's data in this period
      var hasDataInPeriod = sortedDates.some(function(d) {
        return d >= pStart && d <= pEnd;
      });
      
      if (hasDataInPeriod) {
        payPeriods.unshift({
          periodEnd: pEnd,
          periodStart: pStart,
          week1Start: w1Start,
          week1End: w1End,
          week2Start: w2Start,
          week2End: pEnd
        });
      }
      
      currentPeriodEnd.setDate(currentPeriodEnd.getDate() - 14);
  }
  
  console.log('Pay periods detected:', payPeriods.length);
    if (payPeriods.length > 0) {
      console.log('Current period:', payPeriods[payPeriods.length - 1].week1Start.toDateString(), 'to', payPeriods[payPeriods.length - 1].periodEnd.toDateString());
    }
  } catch (periodError) {
    console.error('Error calculating pay periods:', periodError);
    // Fallback: create a single period from the data range
    var fallbackEnd = new Date(latestDate);
    var fallbackDow = fallbackEnd.getDay();
    if (fallbackDow !== 6) fallbackEnd.setDate(fallbackEnd.getDate() + (6 - fallbackDow));
    
    var fallbackStart = new Date(fallbackEnd);
    fallbackStart.setDate(fallbackStart.getDate() - 13);
    
    var fw1End = new Date(fallbackStart);
    fw1End.setDate(fw1End.getDate() + 6);
    
    payPeriods = [{
      periodEnd: fallbackEnd,
      periodStart: fallbackStart,
      week1Start: fallbackStart,
      week1End: fw1End,
      week2Start: new Date(fw1End.getTime() + 86400000),
      week2End: fallbackEnd
    }];
  }
  
  // Helper functions
  function getFlag(ot) {
    if (ot >= CONFIG.HIGH_THRESHOLD) return 'Really High';
    if (ot >= CONFIG.MODERATE_THRESHOLD) return 'Moderate';
    return 'Normal';
  }
  
  function getHoursInPeriod(dailyHours, period) {
    var w1 = 0, w2 = 0;
    var entries = Object.entries(dailyHours);
    for (var i = 0; i < entries.length; i++) {
      var d = entries[i][0];
      var h = entries[i][1];
      var parts = d.split('-').map(Number);
      var date = new Date(parts[0], parts[1]-1, parts[2]);
      if (date >= period.week1Start && date <= period.week1End) w1 += h;
      else if (date >= period.week2Start && date <= period.week2End) w2 += h;
    }
    return { week1: w1, week2: w2, total: w1 + w2 };
  }
  
  // Helper to filter daily hours to only include dates within the period
  function filterDailyHoursForPeriod(dailyHours, period) {
    var filtered = {};
    var entries = Object.entries(dailyHours);
    for (var i = 0; i < entries.length; i++) {
      var d = entries[i][0];
      var h = entries[i][1];
      var parts = d.split('-').map(Number);
      var date = new Date(parts[0], parts[1]-1, parts[2]);
      if (date >= period.week1Start && date <= period.week2End) {
        filtered[d] = h;
      }
    }
    return filtered;
  }
  
  // Process each pay period
  var allPeriodResults = [];
  var chKeys = chData ? Object.keys(chData.employeeData) : [];
  var dbuKeys = dbuData ? Object.keys(dbuData.employeeData) : [];
  var multiKeys = chKeys.filter(function(k) { return dbuKeys.includes(k); });
  
  for (var p = 0; p < payPeriods.length; p++) {
    var period = payPeriods[p];
    var periodEmployees = [];
    
    // Process multi-location employees
    for (var m = 0; m < multiKeys.length; m++) {
      var k = multiKeys[m];
      var ch = chData.employeeData[k];
      var dbu = dbuData.employeeData[k];
      var chHours = getHoursInPeriod(ch.dailyHours, period);
      var dbuHours = getHoursInPeriod(dbu.dailyHours, period);
      
      // Skip if no hours in this period
      if (chHours.total === 0 && dbuHours.total === 0) continue;
      
      var totalHours = chHours.total + dbuHours.total;
      var w1 = chHours.week1 + dbuHours.week1;
      var w2 = chHours.week2 + dbuHours.week2;
      var w1OT = Math.max(0, w1 - 40);
      var w2OT = Math.max(0, w2 - 40);
      var totalOT = w1OT + w2OT;
      
          periodEmployees.push({
            employeeName: ch.displayName,
            matchKey: k,
            location: 'Multi',
            chHours: +chHours.total.toFixed(2),
            dbuHours: +dbuHours.total.toFixed(2),
            totalHours: +totalHours.toFixed(2),
            regularHours: +Math.min(totalHours, 80).toFixed(2),
            week1Hours: +w1.toFixed(2),
            week2Hours: +w2.toFixed(2),
            week1OT: +w1OT.toFixed(2),
            week2OT: +w2OT.toFixed(2),
            totalOT: +totalOT.toFixed(2),
            flag: getFlag(totalOT),
            employeeId: ch.employeeId || dbu.employeeId || '',
            // Daily hours breakdown for accordion view
            chDailyHours: filterDailyHoursForPeriod(ch.dailyHours, period),
            dbuDailyHours: filterDailyHoursForPeriod(dbu.dailyHours, period),
            // Period dates for week grouping
            week1Start: period.week1Start.toISOString().split('T')[0],
            week1End: period.week1End.toISOString().split('T')[0],
            week2Start: period.week2Start.toISOString().split('T')[0],
            week2End: period.week2End.toISOString().split('T')[0]
          });
    }
    
    // Process CH-only employees
    if (chData) {
      for (var ci = 0; ci < chKeys.length; ci++) {
        var ck = chKeys[ci];
        if (multiKeys.includes(ck)) continue;
        var emp = chData.employeeData[ck];
        var hours = getHoursInPeriod(emp.dailyHours, period);
        if (hours.total === 0) continue;
        
        var cw1OT = Math.max(0, hours.week1 - 40);
        var cw2OT = Math.max(0, hours.week2 - 40);
        var ctotalOT = cw1OT + cw2OT;
        
        periodEmployees.push({
          employeeName: emp.displayName,
          matchKey: ck,
          location: 'Cockrell Hill DTO',
          chHours: +hours.total.toFixed(2),
          dbuHours: 0,
          totalHours: +hours.total.toFixed(2),
          regularHours: +Math.min(hours.total, 80).toFixed(2),
          week1Hours: +hours.week1.toFixed(2),
          week2Hours: +hours.week2.toFixed(2),
          week1OT: +cw1OT.toFixed(2),
          week2OT: +cw2OT.toFixed(2),
          totalOT: +ctotalOT.toFixed(2),
          flag: getFlag(ctotalOT),
          employeeId: emp.employeeId || '',
          // Daily hours breakdown for accordion view
          chDailyHours: filterDailyHoursForPeriod(emp.dailyHours, period),
          dbuDailyHours: {},
          // Period dates for week grouping
          week1Start: period.week1Start.toISOString().split('T')[0],
          week1End: period.week1End.toISOString().split('T')[0],
          week2Start: period.week2Start.toISOString().split('T')[0],
          week2End: period.week2End.toISOString().split('T')[0]
        });
      }
    }
    
    // Process DBU-only employees
    if (dbuData) {
      for (var di = 0; di < dbuKeys.length; di++) {
        var dk = dbuKeys[di];
        if (multiKeys.includes(dk)) continue;
        var demp = dbuData.employeeData[dk];
        var dhours = getHoursInPeriod(demp.dailyHours, period);
        if (dhours.total === 0) continue;
        
        var dw1OT = Math.max(0, dhours.week1 - 40);
        var dw2OT = Math.max(0, dhours.week2 - 40);
        var dtotalOT = dw1OT + dw2OT;
        
        periodEmployees.push({
          employeeName: demp.displayName,
          matchKey: dk,
          location: 'DBU',
          chHours: 0,
          dbuHours: +dhours.total.toFixed(2),
          totalHours: +dhours.total.toFixed(2),
          regularHours: +Math.min(dhours.total, 80).toFixed(2),
          week1Hours: +dhours.week1.toFixed(2),
          week2Hours: +dhours.week2.toFixed(2),
          week1OT: +dw1OT.toFixed(2),
          week2OT: +dw2OT.toFixed(2),
          totalOT: +dtotalOT.toFixed(2),
          flag: getFlag(dtotalOT),
          employeeId: demp.employeeId || '',
          // Daily hours breakdown for accordion view
          chDailyHours: {},
          dbuDailyHours: filterDailyHoursForPeriod(demp.dailyHours, period),
          // Period dates for week grouping
          week1Start: period.week1Start.toISOString().split('T')[0],
          week1End: period.week1End.toISOString().split('T')[0],
          week2Start: period.week2Start.toISOString().split('T')[0],
          week2End: period.week2End.toISOString().split('T')[0]
        });
      }
    }
    
    // Only include periods with employees
    if (periodEmployees.length > 0) {
      periodEmployees.sort(function(a,b) { return b.totalOT - a.totalOT; });
      
      var periodTotalOT = 0;
      for (var t = 0; t < periodEmployees.length; t++) {
        periodTotalOT += periodEmployees[t].totalOT;
      }
      
      var periodMulti = periodEmployees.filter(function(e) { return e.location === 'Multi'; });
      var highCount = periodEmployees.filter(function(e) { return e.flag === 'Really High'; }).length;
      
      allPeriodResults.push({
        periodEnd: period.periodEnd.toISOString(),
        periodStart: period.periodStart.toISOString(),
        employees: periodEmployees,
        multiLocation: periodMulti,
        stats: {
          totalEmployees: periodEmployees.length,
          multiCount: periodMulti.length,
          totalOT: +periodTotalOT.toFixed(2),
          highOTCount: highCount
        }
      });
    }
  }
  
  console.log('Periods with data:', allPeriodResults.length);
  
  // For backwards compatibility, also return flattened data for the most recent period
  var latestPeriod = allPeriodResults[allPeriodResults.length - 1] || { employees: [], multiLocation: [], stats: {} };
  
  // Aggregate stats across ALL periods
  var totalEmployeesAllPeriods = 0;
  var totalOTAllPeriods = 0;
  for (var r = 0; r < allPeriodResults.length; r++) {
    totalEmployeesAllPeriods += allPeriodResults[r].employees.length;
    totalOTAllPeriods += allPeriodResults[r].stats.totalOT;
  }
  
  return {
    // Latest period data (for display)
    periodEnd: latestPeriod.periodEnd,
    periodStart: latestPeriod.periodStart,
    multiLocation: latestPeriod.multiLocation || [],
    allEmployees: latestPeriod.employees || [],
    
    // ALL periods (for bulk saving)
    allPeriods: allPeriodResults,
    
    // Stats
    stats: {
      totalEmployees: (latestPeriod.stats && latestPeriod.stats.totalEmployees) || 0,
      multiCount: (latestPeriod.stats && latestPeriod.stats.multiCount) || 0,
      totalOT: (latestPeriod.stats && latestPeriod.stats.totalOT) || 0,
      highOTCount: (latestPeriod.stats && latestPeriod.stats.highOTCount) || 0,
      // Bulk stats
      periodsDetected: allPeriodResults.length,
      totalRecordsAllPeriods: totalEmployeesAllPeriods,
      totalOTAllPeriods: +totalOTAllPeriods.toFixed(2)
    }
  };
}

// ============================================================================
// UTILITIES
// ============================================================================

/**
 * Converts decimal hours to HH:MM format
 * Example: 30.5 -> "30:30", 8.25 -> "8:15", 6.75 -> "6:45"
 * @param {number} decimalHours - Hours in decimal format
 * @returns {string} Hours in HH:MM format
 */
function formatHours(decimalHours) {
  if (decimalHours === 0 || decimalHours === null || decimalHours === undefined) {
    return '0:00';
  }
  const hours = Math.floor(Math.abs(decimalHours));
  const minutes = Math.round((Math.abs(decimalHours) - hours) * 60);
  const sign = decimalHours < 0 ? '-' : '';
  return `${sign}${hours}:${minutes.toString().padStart(2, '0')}`;
}

function formatDate(d) {
  // Add time component to avoid UTC timezone shift issues
  // '2024-12-26' alone is parsed as UTC, adding 'T12:00:00' makes it local noon
  const dateStr = typeof d === 'string' && !d.includes('T') ? d + 'T12:00:00' : d;
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function showLoading(show) {
  const el = document.getElementById('loadingOverlay');
  if (el) el.classList.toggle('hidden', !show);
}

function showToast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  if (!container) return;
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span class="material-icons-round">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span><span>${msg}</span>`;
  container.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
}

function debounce(fn, delay) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), delay);
  };
}

// ============================================================================
// UNIFORM MANAGEMENT
// ============================================================================

// Uniform state
const UniformState = {
  catalog: [],
  categories: [],
  orderItems: [],
  paymentPlan: 1,
  paydays: [],
  orders: [],
  deductions: []
};

/**
 * Initializes the Uniforms tab when it's opened
 */
function loadUniformsTab() {
  showLoading(true);
  
  // Load size configuration for pants/shorts (async, doesn't block)
  if (!AppState.sizeConfig) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success && result.config) {
          AppState.sizeConfig = result.config;
        }
      })
      .getSizeConfiguration();
  }
  
  // Load catalog items
  google.script.run
    .withSuccessHandler(function(items) {
      UniformState.catalog = items || [];
      UniformState.categories = [...new Set(items.map(i => i.category))].sort();
      populateCategoryDropdown();
      populateItemDropdown();
      loadCatalogTable();
      
      // Load employees for dropdown
      loadUniformEmployees();
      
      // Load paydays
      loadPaydays();
      
      // Load orders
      loadUniformOrders();
      
      showLoading(false);
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error loading catalog: ' + error.message, 'error');
    })
    .getCatalogItems(true);
}

/**
 * Loads active employees into the employee dropdown
 * Uses getAllEmployeeNames which only returns employees who worked in the last 4 pay periods
 */
function loadUniformEmployees() {
  google.script.run
    .withSuccessHandler(function(employees) {
      const select = document.getElementById('uniformEmployee');
      if (!select) return;
      
      select.innerHTML = '<option value="">Select an employee...</option>';
      
      // employees is now an array of objects with fullName, matchKey, location
      (employees || []).forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.matchKey || emp.fullName.toLowerCase().replace(/\s+/g, ' ');
        option.textContent = emp.fullName;
        option.dataset.name = emp.fullName;
        option.dataset.location = emp.location || '';
        select.appendChild(option);
      });
      
      // Add "New Employee" option at the end
      const newOption = document.createElement('option');
      newOption.value = '__new__';
      newOption.textContent = '‚ûï New Employee (Not in list)';
      select.appendChild(newOption);
    })
    .withFailureHandler(console.error)
    .getAllEmployeesForUniform();
}

// ============================================================================
// NEW EMPLOYEE CREATION FLOW (with Safeguards)
// ============================================================================

// State for new employee creation
const NewEmployeeState = {
  searchResults: [],
  selectedEmployee: null,
  isNewEmployee: false,
  newEmployeeName: '',
  normalizedName: '',
  matchKey: '',
  similarWarnings: [],
  spellingVerified: false,
  passcodeVerified: false
};

/**
 * Normalizes a name - same logic as backend
 */
function normalizeNameClient(name) {
  if (!name) return '';
  
  let normalized = name.trim();
  
  // Convert "Last, First" to "First Last"
  if (normalized.includes(',')) {
    const parts = normalized.split(',').map(p => p.trim());
    if (parts.length >= 2) {
      normalized = parts[1] + ' ' + parts[0];
    }
  }
  
  // Collapse multiple spaces
  normalized = normalized.replace(/\s+/g, ' ');
  
  // Proper case
  normalized = normalized.split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
  
  return normalized;
}

/**
 * Handle employee dropdown change
 */
function handleEmployeeSelectChange() {
  const select = document.getElementById('uniformEmployee');
  const panel = document.getElementById('newEmployeePanel');
  
  if (select.value === '__new__') {
    // Show the new employee panel
    panel.style.display = 'block';
    resetNewEmployeeState();
    document.getElementById('employeeSearchInput').focus();
    NewEmployeeState.isNewEmployee = true;
  } else {
    // Hide panel, use selected employee
    panel.style.display = 'none';
    NewEmployeeState.isNewEmployee = false;
    NewEmployeeState.selectedEmployee = select.value;
    
    // Auto-fill location if available
    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption && selectedOption.dataset.location) {
      const locationSelect = document.getElementById('uniformLocation');
      const locationValue = selectedOption.dataset.location;
      // Try to match location
      for (let opt of locationSelect.options) {
        if (opt.value === locationValue || opt.textContent === locationValue) {
          locationSelect.value = opt.value;
          break;
        }
      }
    }
  }
  
  updateOrderTotals();
}

/**
 * Handle search input with debounce
 */
let employeeSearchTimer = null;
function handleEmployeeSearch() {
  const input = document.getElementById('employeeSearchInput');
  const query = input.value.trim();
  
  clearTimeout(employeeSearchTimer);
  
  if (query.length < 2) {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('createNewOption').style.display = 'none';
    return;
  }
  
  employeeSearchTimer = setTimeout(function() {
    performEmployeeSearch(query);
  }, 300);
}

/**
 * Perform fuzzy employee search
 */
function performEmployeeSearch(query) {
  google.script.run
    .withSuccessHandler(function(results) {
      renderSearchResults(results, query);
    })
    .withFailureHandler(function(error) {
      console.error('Search error:', error);
      showToast('Search error: ' + error.message, 'error');
    })
    .searchEmployeesFuzzy(query);
}

/**
 * Render search results
 */
function renderSearchResults(results, query) {
  const container = document.getElementById('searchResults');
  const createNew = document.getElementById('createNewOption');
  
  NewEmployeeState.searchResults = results;
  
  if (results.exact.length === 0 && results.similar.length === 0) {
    container.innerHTML = 
      '<div class="search-result-empty">' +
        '<span class="material-icons-round">person_off</span>' +
        '<p>No employees found matching "' + query + '"</p>' +
      '</div>';
    container.style.display = 'block';
    createNew.style.display = 'block';
    return;
  }
  
  let html = '';
  
  // Exact/partial matches
  if (results.exact.length > 0) {
    html += '<div class="result-section-header">Matches Found</div>';
    results.exact.forEach(function(emp) {
      html += 
        '<div class="search-result-item" onclick="selectSearchResult(\'' + 
          emp.matchKey.replace(/'/g, "\\'") + '\', \'' + 
          emp.fullName.replace(/'/g, "\\'") + '\')">' +
          '<div>' +
            '<strong>' + emp.fullName + '</strong>' +
            '<span class="result-location">' + (emp.location || '') + '</span>' +
          '</div>' +
          '<span class="material-icons-round" style="color: var(--gray-400);">chevron_right</span>' +
        '</div>';
    });
  }
  
  // Similar matches (fuzzy)
  if (results.similar.length > 0) {
    html += '<div class="result-section-header">Similar Names</div>';
    results.similar.forEach(function(emp) {
      html += 
        '<div class="search-result-item" onclick="selectSearchResult(\'' + 
          emp.matchKey.replace(/'/g, "\\'") + '\', \'' + 
          emp.fullName.replace(/'/g, "\\'") + '\')">' +
          '<div>' +
            '<strong>' + emp.fullName + '</strong>' +
            '<span class="result-location">' + (emp.location || '') + '</span>' +
            '<span class="similarity-badge">' + emp.similarity + '% match</span>' +
          '</div>' +
          '<span class="material-icons-round" style="color: var(--gray-400);">chevron_right</span>' +
        '</div>';
    });
  }
  
  container.innerHTML = html;
  container.style.display = 'block';
  createNew.style.display = 'block';
}

/**
 * User selected an existing employee from search
 */
function selectSearchResult(matchKey, fullName) {
  const select = document.getElementById('uniformEmployee');
  
  // Check if option exists
  let found = false;
  for (let i = 0; i < select.options.length; i++) {
    if (select.options[i].value === matchKey) {
      select.selectedIndex = i;
      found = true;
      break;
    }
  }
  
  // If not found, add temporarily
  if (!found) {
    const newOption = document.createElement('option');
    newOption.value = matchKey;
    newOption.textContent = fullName;
    // Insert before "__new__" option
    const newEmpOption = select.querySelector('option[value="__new__"]');
    select.insertBefore(newOption, newEmpOption);
    select.value = matchKey;
  }
  
  // Hide panel and reset state
  document.getElementById('newEmployeePanel').style.display = 'none';
  NewEmployeeState.isNewEmployee = false;
  NewEmployeeState.selectedEmployee = matchKey;
  
  showToast('Selected: ' + fullName, 'success');
  updateOrderTotals();
}

/**
 * User confirms employee not in list - proceed to name entry
 */
function handleConfirmNotInList() {
  const checked = document.getElementById('confirmNotInList').checked;
  const nameStep = document.getElementById('nameStep');
  
  if (checked) {
    nameStep.style.display = 'block';
    document.getElementById('newEmployeeName').focus();
  } else {
    nameStep.style.display = 'none';
    document.getElementById('confirmStep').style.display = 'none';
    NewEmployeeState.spellingVerified = false;
  }
}

/**
 * Handle new employee name input - show live preview
 */
function handleNewNameInput() {
  const input = document.getElementById('newEmployeeName');
  const name = input.value.trim();
  const preview = document.getElementById('namePreview');
  const previewText = document.getElementById('normalizedNamePreview');
  const confirmStep = document.getElementById('confirmStep');
  
  if (name.length < 2) {
    preview.style.display = 'none';
    confirmStep.style.display = 'none';
    NewEmployeeState.spellingVerified = false;
    document.getElementById('spellingVerified').checked = false;
    return;
  }
  
  // Normalize the name (same as backend)
  const normalized = normalizeNameClient(name);
  const matchKey = normalized.toLowerCase().replace(/\s+/g, ' ');
  
  NewEmployeeState.newEmployeeName = name;
  NewEmployeeState.normalizedName = normalized;
  NewEmployeeState.matchKey = matchKey;
  
  previewText.textContent = normalized;
  preview.style.display = 'block';
  
  // Check for similar names (prevent duplicates)
  checkForSimilarNames(normalized);
}

/**
 * Check if similar names exist before allowing creation
 */
function checkForSimilarNames(normalizedName) {
  google.script.run
    .withSuccessHandler(function(results) {
      renderSimilarWarning(results);
      
      const confirmStep = document.getElementById('confirmStep');
      
      // If exact match found, don't allow creation
      if (results.exactMatch) {
        confirmStep.style.display = 'none';
        showToast('This employee already exists! Select them from the list above.', 'warning');
      } else {
        confirmStep.style.display = 'block';
      }
    })
    .withFailureHandler(function(error) {
      console.error('Similar check error:', error);
      document.getElementById('confirmStep').style.display = 'block';
    })
    .searchEmployeesFuzzy(normalizedName);
}

/**
 * Render similar name warning if matches found
 */
function renderSimilarWarning(results) {
  const container = document.getElementById('similarNameWarning');
  
  NewEmployeeState.similarWarnings = results.similar || [];
  
  if (results.similar && results.similar.length > 0) {
    let html = '<h4><span class="material-icons-round" style="font-size: 18px;">warning</span> Similar names found:</h4><ul>';
    
    results.similar.forEach(function(emp) {
      html += 
        '<li>' +
          '<strong>' + emp.fullName + '</strong> (' + emp.similarity + '% similar) ' +
          '<button type="button" class="btn btn-outline btn-sm" ' +
            'onclick="selectSearchResult(\'' + emp.matchKey.replace(/'/g, "\\'") + 
            '\', \'' + emp.fullName.replace(/'/g, "\\'") + '\')">' +
            'Use this instead' +
          '</button>' +
        '</li>';
    });
    
    html += '</ul><p style="margin-top: 10px; font-size: 0.85rem;">' +
      'If "' + NewEmployeeState.normalizedName + '" is truly a different person, continue below.' +
      '</p>';
    
    container.innerHTML = html;
    container.style.display = 'block';
  } else {
    container.style.display = 'none';
  }
}

/**
 * Handle spelling verification checkbox
 */
function handleSpellingVerified() {
  NewEmployeeState.spellingVerified = document.getElementById('spellingVerified').checked;
  
  // Show passcode step when spelling is verified
  const passcodeStep = document.getElementById('passcodeStep');
  if (passcodeStep) {
    passcodeStep.style.display = NewEmployeeState.spellingVerified ? 'block' : 'none';
  }
  
  // Reset passcode verification if spelling is unchecked
  if (!NewEmployeeState.spellingVerified) {
    NewEmployeeState.passcodeVerified = false;
    const successMsg = document.getElementById('newEmployeePasscodeSuccess');
    if (successMsg) successMsg.style.display = 'none';
  }
  
  updateOrderTotals();
}

/**
 * Verify manager passcode for new employee creation
 */
function verifyNewEmployeePasscode() {
  const input = document.getElementById('newEmployeePasscode');
  const errorEl = document.getElementById('newEmployeePasscodeError');
  const successEl = document.getElementById('newEmployeePasscodeSuccess');
  const code = input.value.trim();
  
  if (!code) {
    errorEl.textContent = 'Please enter a passcode';
    errorEl.style.display = 'block';
    successEl.style.display = 'none';
    return;
  }
  
  // Validate against backend
  google.script.run
    .withSuccessHandler(function(isValid) {
      if (isValid) {
        NewEmployeeState.passcodeVerified = true;
        errorEl.style.display = 'none';
        successEl.style.display = 'flex';
        input.disabled = true;
        updateOrderTotals();
        showToast('Manager authorization verified!', 'success');
      } else {
        NewEmployeeState.passcodeVerified = false;
        errorEl.textContent = 'Incorrect passcode';
        errorEl.style.display = 'block';
        successEl.style.display = 'none';
        input.value = '';
        input.focus();
      }
    })
    .withFailureHandler(function(error) {
      errorEl.textContent = 'Error verifying: ' + error.message;
      errorEl.style.display = 'block';
      successEl.style.display = 'none';
    })
    .validateManagerPasscode(code);
}

/**
 * Cancel new employee creation
 */
function cancelNewEmployee() {
  const select = document.getElementById('uniformEmployee');
  select.value = '';
  document.getElementById('newEmployeePanel').style.display = 'none';
  resetNewEmployeeState();
  updateOrderTotals();
}

/**
 * Reset new employee state
 */
function resetNewEmployeeState() {
  NewEmployeeState.searchResults = [];
  NewEmployeeState.selectedEmployee = null;
  NewEmployeeState.isNewEmployee = false;
  NewEmployeeState.newEmployeeName = '';
  NewEmployeeState.normalizedName = '';
  NewEmployeeState.matchKey = '';
  NewEmployeeState.similarWarnings = [];
  NewEmployeeState.spellingVerified = false;
  
  // Reset UI elements
  const searchInput = document.getElementById('employeeSearchInput');
  if (searchInput) searchInput.value = '';
  
  const searchResults = document.getElementById('searchResults');
  if (searchResults) searchResults.style.display = 'none';
  
  const createNew = document.getElementById('createNewOption');
  if (createNew) createNew.style.display = 'none';
  
  const confirmNotInList = document.getElementById('confirmNotInList');
  if (confirmNotInList) confirmNotInList.checked = false;
  
  const nameStep = document.getElementById('nameStep');
  if (nameStep) nameStep.style.display = 'none';
  
  const newEmpName = document.getElementById('newEmployeeName');
  if (newEmpName) newEmpName.value = '';
  
  const namePreview = document.getElementById('namePreview');
  if (namePreview) namePreview.style.display = 'none';
  
  const similarWarning = document.getElementById('similarNameWarning');
  if (similarWarning) similarWarning.style.display = 'none';
  
  const confirmStep = document.getElementById('confirmStep');
  if (confirmStep) confirmStep.style.display = 'none';
  
  const spellingVerified = document.getElementById('spellingVerified');
  if (spellingVerified) spellingVerified.checked = false;
  
  // Reset passcode step
  NewEmployeeState.passcodeVerified = false;
  
  const passcodeStep = document.getElementById('passcodeStep');
  if (passcodeStep) passcodeStep.style.display = 'none';
  
  const passcodeInput = document.getElementById('newEmployeePasscode');
  if (passcodeInput) {
    passcodeInput.value = '';
    passcodeInput.disabled = false;
  }
  
  const passcodeError = document.getElementById('newEmployeePasscodeError');
  if (passcodeError) passcodeError.style.display = 'none';
  
  const passcodeSuccess = document.getElementById('newEmployeePasscodeSuccess');
  if (passcodeSuccess) passcodeSuccess.style.display = 'none';
}

/**
 * Get employee data for order submission
 */
function getEmployeeDataForOrder() {
  if (NewEmployeeState.isNewEmployee && NewEmployeeState.spellingVerified && NewEmployeeState.passcodeVerified) {
    return {
      isNewEmployee: true,
      employeeName: NewEmployeeState.normalizedName,
      matchKey: NewEmployeeState.matchKey,
      similarWarnings: NewEmployeeState.similarWarnings.map(w => w.fullName)
    };
  } else if (NewEmployeeState.isNewEmployee) {
    // New employee flow started but not complete
    return null;
  } else {
    const select = document.getElementById('uniformEmployee');
    if (!select || !select.value || select.value === '__new__') {
      return null;
    }
    return {
      isNewEmployee: false,
      employeeName: select.options[select.selectedIndex].textContent,
      matchKey: select.value,
      similarWarnings: []
    };
  }
}

/**
 * Loads paydays into dropdowns (includes historical and future dates)
 */
function loadPaydays() {
  google.script.run
    .withSuccessHandler(function(paydays) {
      UniformState.paydays = paydays || [];
      
      // Find the most recent payday (on or before today) for default selection
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let defaultPaydayIndex = 0;
      
      for (let i = paydays.length - 1; i >= 0; i--) {
        const payday = new Date(paydays[i] + 'T12:00:00');
        if (payday <= today) {
          defaultPaydayIndex = i;
          break;
        }
      }
      
      const selects = ['uniformFirstDeduction', 'deductionPayday'];
      selects.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;
        
        select.innerHTML = '<option value="">Select payday...</option>';
        paydays.forEach((date, index) => {
          const option = document.createElement('option');
          option.value = date;
          
          // Format with day of week for clarity
          const d = new Date(date + 'T12:00:00');
          const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
          option.textContent = `${dayName}, ${formatDate(date)}`;
          
          // Mark current period
          if (index === defaultPaydayIndex) {
            option.textContent += ' (Current)';
          }
          
          select.appendChild(option);
        });
        
        // Auto-select the current period for deductionPayday dropdown only
        if (id === 'deductionPayday' && paydays.length > 0) {
          select.value = paydays[defaultPaydayIndex];
        }
      });
    })
    .withFailureHandler(console.error)
    .getUpcomingPaydays(8, 26); // 8 future paydays, 26 historical (~1 year)
}

/**
 * Populates the category dropdown
 */
function populateCategoryDropdown() {
  const select = document.getElementById('uniformCategory');
  if (!select) return;
  
  select.innerHTML = '<option value="">All Categories</option>';
  UniformState.categories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
}

/**
 * Populates the item dropdown based on selected category
 */
function populateItemDropdown() {
  const categorySelect = document.getElementById('uniformCategory');
  const itemSelect = document.getElementById('uniformItem');
  if (!itemSelect) return;
  
  const category = categorySelect ? categorySelect.value : '';
  let items = UniformState.catalog;
  
  if (category) {
    items = items.filter(i => i.category === category);
  }
  
  itemSelect.innerHTML = '<option value="">Select an item...</option>';
  items.forEach(item => {
    const option = document.createElement('option');
    option.value = item.itemId;
    option.textContent = `${item.itemName} - $${item.price.toFixed(2)}`;
    option.dataset.name = item.itemName;
    option.dataset.price = item.price;
    option.dataset.sizes = item.availableSizes.join(',');
    itemSelect.appendChild(option);
  });
  
  // Reset size dropdown
  updateSizeOptions();
}

/**
 * Filters catalog by category
 */
function filterCatalogByCategory() {
  populateItemDropdown();
}

/**
 * Updates size options based on selected item
 */
function updateSizeOptions() {
  const itemSelect = document.getElementById('uniformItem');
  const sizeSelect = document.getElementById('uniformSize');
  const inseamGroup = document.getElementById('inseamGroup');
  const genderGroup = document.getElementById('genderGroup');
  const genderSelect = document.getElementById('uniformGender');
  const sizeLabel = document.getElementById('sizeLabel');
  const inseamSelect = document.getElementById('uniformInseam');
  
  if (!itemSelect || !sizeSelect) return;
  
  const selectedOption = itemSelect.options[itemSelect.selectedIndex];
  const sizes = selectedOption && selectedOption.dataset.sizes ? selectedOption.dataset.sizes.split(',') : [];
  const itemName = selectedOption && selectedOption.dataset.name ? selectedOption.dataset.name : '';
  
  // Check if this is pants - needs gender and inseam
  const isPants = itemName === 'Pants';
  // Shorts just need inseam, not gender
  const isShorts = itemName === 'Shorts';
  const needsInseam = isPants || isShorts;
  
  // Show/hide gender dropdown (only for pants)
  if (genderGroup) {
    genderGroup.style.display = isPants ? 'block' : 'none';
  }
  
  // Reset gender selection
  if (genderSelect) {
    genderSelect.value = '';
  }
  
  // Show/hide inseam dropdown
  if (inseamGroup) {
    inseamGroup.style.display = needsInseam ? 'block' : 'none';
  }
  
  // Update size label for pants/shorts
  if (sizeLabel) {
    sizeLabel.textContent = needsInseam ? 'Waist' : 'Size';
  }
  
  // Reset inseam selection
  if (inseamSelect) {
    inseamSelect.innerHTML = '<option value="">Inseam...</option>';
  }
  
  // For pants, don't populate sizes until gender is selected
  if (isPants) {
    sizeSelect.innerHTML = '<option value="">Select gender first...</option>';
  } else {
    sizeSelect.innerHTML = '<option value="">Size...</option>';
    sizes.forEach(size => {
      const option = document.createElement('option');
      option.value = size.trim();
      option.textContent = size.trim();
      sizeSelect.appendChild(option);
    });
    
    // For shorts, populate default inseam
    if (isShorts && inseamSelect) {
      inseamSelect.innerHTML = '<option value="">Inseam...</option>';
      ['30', '32', '34'].forEach(inseam => {
        const opt = document.createElement('option');
        opt.value = inseam;
        opt.textContent = inseam + '"';
        inseamSelect.appendChild(opt);
      });
    }
  }
}

/**
 * Updates waist and inseam options based on gender selection (for pants only)
 * Uses per-item overrides if available, otherwise uses global settings
 */
function updatePantsSizes() {
  const genderSelect = document.getElementById('uniformGender');
  const sizeSelect = document.getElementById('uniformSize');
  const inseamSelect = document.getElementById('uniformInseam');
  const itemSelect = document.getElementById('uniformItem');
  
  if (!genderSelect || !sizeSelect) return;
  
  const gender = genderSelect.value;
  
  // Check if selected item has custom waist/inseam overrides
  let itemWaistSizes = null;
  let itemInseamSizes = null;
  
  if (itemSelect && itemSelect.value && UniformState.catalog) {
    const selectedItem = UniformState.catalog.find(i => i.itemId === itemSelect.value);
    if (selectedItem) {
      if (selectedItem.waistSizes && selectedItem.waistSizes.length > 0) {
        itemWaistSizes = selectedItem.waistSizes;
      }
      if (selectedItem.inseamSizes && selectedItem.inseamSizes.length > 0) {
        itemInseamSizes = selectedItem.inseamSizes;
      }
    }
  }
  
  // Get sizes from settings or use defaults
  const sizeConfig = AppState.sizeConfig || {};
  const pantsConfig = {
    male: {
      waist: itemWaistSizes || sizeConfig.pants_male_waist || ['28', '30', '32', '34', '36', '38', '40', '42', '44', '46', '48', '50', '52', '54', '56', '58', '60'],
      inseam: itemInseamSizes || sizeConfig.pants_male_inseam || ['28', '30', '32', '34', '36']
    },
    female: {
      waist: itemWaistSizes || sizeConfig.pants_female_waist || ['00', '0', '2', '4', '6', '8', '10', '12', '14', '16', '18', '20', '22', '24', '26', '28', '30', '32', '34', '36'],
      inseam: itemInseamSizes || sizeConfig.pants_female_inseam || ['29', '31', '33', '35']
    }
  };
  
  if (!gender || !pantsConfig[gender]) {
    sizeSelect.innerHTML = '<option value="">Select gender first...</option>';
    if (inseamSelect) inseamSelect.innerHTML = '<option value="">Inseam...</option>';
    return;
  }
  
  const config = pantsConfig[gender];
  
  // Populate waist sizes
  sizeSelect.innerHTML = '<option value="">Waist...</option>';
  config.waist.forEach(size => {
    const option = document.createElement('option');
    option.value = size;
    option.textContent = size;
    sizeSelect.appendChild(option);
  });
  
  // Populate inseam options
  if (inseamSelect) {
    inseamSelect.innerHTML = '<option value="">Inseam...</option>';
    config.inseam.forEach(inseam => {
      const option = document.createElement('option');
      option.value = inseam;
      option.textContent = inseam + '"';
      inseamSelect.appendChild(option);
    });
  }
}

/**
 * Adds an item to the current order
 */
function addItemToOrder() {
  const itemSelect = document.getElementById('uniformItem');
  const sizeSelect = document.getElementById('uniformSize');
  const inseamSelect = document.getElementById('uniformInseam');
  const inseamGroup = document.getElementById('inseamGroup');
  const genderSelect = document.getElementById('uniformGender');
  const genderGroup = document.getElementById('genderGroup');
  const qtyInput = document.getElementById('uniformQty');
  
  if (!itemSelect.value) {
    showToast('Please select an item', 'error');
    return;
  }
  
  const selectedOption = itemSelect.options[itemSelect.selectedIndex];
  const itemName = selectedOption.dataset.name;
  
  // Check if gender is required (pants only)
  const isPants = itemName === 'Pants';
  if (isPants && genderGroup && genderGroup.style.display !== 'none') {
    if (!genderSelect || !genderSelect.value) {
      showToast('Please select a gender', 'error');
      return;
    }
  }
  
  if (!sizeSelect.value || sizeSelect.value === 'Select gender first...') {
    showToast('Please select a size', 'error');
    return;
  }
  
  // Check if inseam is required (pants or shorts)
  const needsInseam = isPants || itemName === 'Shorts';
  if (needsInseam && inseamGroup && inseamGroup.style.display !== 'none') {
    if (!inseamSelect || !inseamSelect.value) {
      showToast('Please select an inseam', 'error');
      return;
    }
  }
  
  // Combine waist + inseam for pants/shorts
  let sizeDisplay = sizeSelect.value;
  if (needsInseam && inseamSelect && inseamSelect.value) {
    sizeDisplay = sizeSelect.value + 'x' + inseamSelect.value;
  }
  
  // For pants, add gender prefix
  let displayName = itemName;
  if (isPants && genderSelect && genderSelect.value) {
    displayName = (genderSelect.value === 'male' ? 'Male' : 'Female') + ' ' + itemName;
  }
  
  // Check if this is a replacement (free item)
  const replacementCheckbox = document.getElementById('uniformReplacement');
  const isReplacement = replacementCheckbox ? replacementCheckbox.checked : false;
  const effectivePrice = isReplacement ? 0 : (parseFloat(selectedOption.dataset.price) || 0);
  
  const item = {
    itemId: itemSelect.value,
    itemName: displayName,
    size: sizeDisplay,
    quantity: parseInt(qtyInput.value) || 1,
    unitPrice: effectivePrice,
    isReplacement: isReplacement
  };
  item.lineTotal = item.quantity * item.unitPrice;
  
  UniformState.orderItems.push(item);
  renderOrderItems();
  updateOrderTotals();
  
  // Reset selections
  itemSelect.value = '';
  sizeSelect.innerHTML = '<option value="">Size...</option>';
  if (inseamSelect) inseamSelect.innerHTML = '<option value="">Inseam...</option>';
  if (inseamGroup) inseamGroup.style.display = 'none';
  if (genderSelect) genderSelect.value = '';
  if (genderGroup) genderGroup.style.display = 'none';
  qtyInput.value = '1';
  if (replacementCheckbox) replacementCheckbox.checked = false;
  
  // Reset size label
  const sizeLabel = document.getElementById('sizeLabel');
  if (sizeLabel) sizeLabel.textContent = 'Size';
  
  showToast(isReplacement ? 'Replacement item added (free)' : 'Item added to order', 'success');
}

/**
 * Removes an item from the current order
 */
function removeOrderItem(index) {
  UniformState.orderItems.splice(index, 1);
  renderOrderItems();
  updateOrderTotals();
}

/**
 * Renders the order items table
 */
function renderOrderItems() {
  const tbody = document.getElementById('orderItemsBody');
  if (!tbody) return;
  
  if (UniformState.orderItems.length === 0) {
    tbody.innerHTML = `
      <tr id="emptyOrderRow">
        <td colspan="6" class="text-center" style="color: var(--gray-500); padding: 20px;">
          No items added yet. Select items above to build the order.
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = UniformState.orderItems.map((item, index) => `
    <tr>
      <td>${item.itemName}${item.isReplacement ? '<span class="badge-replacement">REPLACEMENT</span>' : ''}</td>
      <td>${item.size}</td>
      <td class="numeric">${item.quantity}</td>
      <td class="numeric">${item.isReplacement ? '<span style="color: var(--success);">FREE</span>' : '$' + item.unitPrice.toFixed(2)}</td>
      <td class="numeric">${item.isReplacement ? '$0.00' : '$' + item.lineTotal.toFixed(2)}</td>
      <td>
        <button class="btn btn-outline btn-sm" onclick="removeOrderItem(${index})" title="Remove">
          <span class="material-icons-round" style="font-size: 16px;">delete</span>
        </button>
      </td>
    </tr>
  `).join('');
}

/**
 * Updates order totals and per-paycheck amount
 */
function updateOrderTotals() {
  const total = UniformState.orderItems.reduce((sum, item) => sum + item.lineTotal, 0);
  const perPaycheck = total / UniformState.paymentPlan;
  
  const orderTotalEl = document.getElementById('orderTotal');
  const perPaycheckEl = document.getElementById('perPaycheckAmount');
  
  if (orderTotalEl) orderTotalEl.textContent = '$' + total.toFixed(2);
  if (perPaycheckEl) perPaycheckEl.textContent = '$' + perPaycheck.toFixed(2);
  
  // Enable/disable submit button
  // Note: First Deduction Date is NOT required - orders start as "Pending"
  // and deduction date is set automatically when marked as received
  const submitBtn = document.getElementById('submitOrderBtn');
  const employeeSelect = document.getElementById('uniformEmployee');
  const locationSelect = document.getElementById('uniformLocation');
  
  const hasItems = UniformState.orderItems.length > 0;
  const hasEmployee = employeeSelect && employeeSelect.value;
  const hasLocation = locationSelect && locationSelect.value;
  
  if (submitBtn) {
    submitBtn.disabled = !(hasItems && hasEmployee && hasLocation);
  }
  
  // Update order status preview
  updateDeductionPreview();
  
  // Check if order value is unusually high (Chunk 10)
  checkOrderValueWarning(total);
}

/**
 * Load average order value for selected location (Chunk 10)
 */
function loadLocationAverage() {
  const locationSelect = document.getElementById('uniformLocation');
  const smartInfoEl = document.getElementById('orderSmartInfo');
  const avgTextEl = document.getElementById('avgOrderText');
  
  if (!locationSelect || !smartInfoEl) return;
  
  const location = locationSelect.value;
  
  if (!location) {
    smartInfoEl.style.display = 'none';
    UniformState.locationAverage = null;
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.hasData) {
        UniformState.locationAverage = result.average;
        if (avgTextEl) {
          avgTextEl.textContent = 'Average order at ' + result.location + ': $' + result.average.toFixed(2) + ' (' + result.count + ' orders)';
        }
        smartInfoEl.style.display = 'block';
        
        // Re-check warning with current total
        const total = UniformState.orderItems.reduce((sum, item) => sum + item.lineTotal, 0);
        checkOrderValueWarning(total);
      } else {
        smartInfoEl.style.display = 'none';
        UniformState.locationAverage = null;
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error loading average:', error);
      smartInfoEl.style.display = 'none';
    })
    .getLocationOrderAverage(location);
}

/**
 * Check if order value is unusually high (Chunk 10)
 */
function checkOrderValueWarning(total) {
  const warningEl = document.getElementById('orderValueWarning');
  if (!warningEl) return;
  
  const average = UniformState.locationAverage;
  
  // Show warning if order is 3x or more than average
  if (average && average > 0 && total > 0 && total >= average * 3) {
    const multiplier = (total / average).toFixed(1);
    warningEl.innerHTML = '<span class="material-icons-round">warning</span><span>This order ($' + total.toFixed(2) + ') is ' + multiplier + 'x the average - please verify</span>';
    warningEl.style.display = 'flex';
  } else {
    warningEl.style.display = 'none';
  }
}

/**
 * Selects a payment plan
 */
function selectPaymentPlan(plan) {
  UniformState.paymentPlan = plan;
  
  // Update button states
  document.querySelectorAll('.payment-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.plan) === plan);
  });
  
  updateOrderTotals();
  updateDeductionPreview();
}

/**
 * Submits the uniform order
 * Orders are created with status "Pending" - no first deduction date needed
 * Deduction date is auto-set when order is marked as received
 */
function submitUniformOrder() {
  const employeeSelect = document.getElementById('uniformEmployee');
  const locationSelect = document.getElementById('uniformLocation');
  const notesInput = document.getElementById('uniformNotes');
  
  // Get employee data (handles both existing and new employees)
  const employeeData = getEmployeeDataForOrder();
  
  // Validate employee selection
  if (!employeeData) {
    if (NewEmployeeState.isNewEmployee && !NewEmployeeState.spellingVerified) {
      showToast('Please verify the spelling is correct before submitting', 'error');
    } else if (NewEmployeeState.isNewEmployee && !NewEmployeeState.passcodeVerified) {
      showToast('Please enter the manager passcode to create a new employee', 'error');
    } else {
    showToast('Please select an employee', 'error');
    }
    return;
  }
  
  if (!locationSelect || !locationSelect.value) {
    showToast('Please select a location', 'error');
    return;
  }
  
  if (UniformState.orderItems.length === 0) {
    showToast('Please add at least one item', 'error');
    return;
  }
  
  const orderData = {
    employeeId: employeeData.matchKey, // Match key (lowercase name)
    employeeName: employeeData.employeeName,
    location: locationSelect.value,
    items: UniformState.orderItems.map(item => ({
      itemId: item.itemId,
      itemName: item.itemName,
      size: item.size,
      quantity: item.quantity,
      unitPrice: item.unitPrice,
      isReplacement: item.isReplacement || false
    })),
    paymentPlan: UniformState.paymentPlan,
    // No firstDeductionDate - will be set when marked as received
    notes: notesInput ? notesInput.value : '',
    // New employee creation flag
    isNewEmployee: employeeData.isNewEmployee,
    similarWarnings: employeeData.similarWarnings
  };
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        // Show appropriate message based on whether new employee was created
        if (orderData.isNewEmployee) {
          showToast(`Order ${result.orderId} created for new employee "${orderData.employeeName}"! They've been added to the system.`, 'success');
        } else {
        showToast(`Order ${result.orderId} created! Status: Pending - mark as received when items arrive`, 'success');
        }
        
        // Reset form
        UniformState.orderItems = [];
        UniformState.paymentPlan = 1;
        renderOrderItems();
        updateOrderTotals();
        selectPaymentPlan(1);
        employeeSelect.value = '';
        locationSelect.value = '';
        if (notesInput) notesInput.value = '';
        
        // Reset new employee panel
        document.getElementById('newEmployeePanel').style.display = 'none';
        resetNewEmployeeState();
        
        // Refresh orders list AND reload employees (to include new employee)
        loadUniformOrders();
        if (orderData.isNewEmployee) {
          loadUniformEmployees();
        }
      } else {
        showToast(result.error || 'Failed to create order', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error creating order: ' + error.message, 'error');
    })
    .createUniformOrder(orderData);
}

/**
 * Loads uniform orders
 */
function loadUniformOrders() {
  const statusFilter = document.getElementById('orderStatusFilter');
  const status = statusFilter ? statusFilter.value : 'Current';
  
  // "Current" = Pending + Active + Store Paid (orders that need attention or are recent)
  const filters = {};
  if (status === 'Current') {
    filters.statuses = ['Pending', 'Active', 'Store Paid'];
  } else if (status) {
    filters.status = status;
  }
  
  google.script.run
    .withSuccessHandler(function(orders) {
      UniformState.orders = orders || [];
      renderUniformOrders();
    })
    .withFailureHandler(console.error)
    .getUniformOrders(filters);
}

/**
 * Renders the uniform orders table
 */
function renderUniformOrders() {
  const tbody = document.getElementById('uniformOrdersBody');
  const countEl = document.getElementById('ordersCount');
  if (!tbody) return;
  
  if (UniformState.orders.length === 0) {
    tbody.innerHTML = `
      <tr><td colspan="9"><div class="empty-state">
        <span class="material-icons-round">checkroom</span>
        <h3>No Orders</h3>
        <p>No orders match the selected filter</p>
      </div></td></tr>
    `;
    if (countEl) countEl.textContent = '';
    return;
  }
  
  tbody.innerHTML = UniformState.orders.map(order => {
    const progressPercent = order.paymentPlan > 0 ? (order.paymentsMade / order.paymentPlan) * 100 : 100;
    const statusClass = order.status === 'Active' ? 'moderate' : 
                        order.status === 'Pending' ? 'flag-pending' :
                        order.status === 'Completed' ? 'normal' : 
                        order.status === 'Store Paid' ? 'normal' : 'high';
    
    // Determine which action buttons to show
    const showMarkReceived = order.status === 'Pending';
    const showMarkPayment = order.status === 'Active';
    const showCancel = order.status === 'Pending' || order.status === 'Active';
    
    return `
      <tr data-employee-name="${order.employeeName}" data-location="${order.location || ''}" data-order-id="${order.orderId}">
        <td><strong style="cursor: pointer; color: var(--cfa-red);" onclick="viewOrderDetails('${order.orderId}')">${order.orderId}</strong></td>
        <td>${order.employeeName}</td>
        <td>${order.location || '-'}</td>
        <td>${formatDate(order.orderDate)}</td>
        <td class="numeric">$${order.totalAmount.toFixed(2)}</td>
        <td class="numeric">$${order.amountRemaining.toFixed(2)}</td>
        <td>
          <div style="display: flex; align-items: center; gap: 6px;">
            <div style="flex: 1; height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; min-width: 50px;">
              <div style="width: ${progressPercent}%; height: 100%; background: ${order.status === 'Completed' || order.status === 'Store Paid' ? 'var(--success)' : order.status === 'Pending' ? 'var(--warning)' : 'var(--cfa-red)'};"></div>
            </div>
            <span style="font-size: 0.7rem; color: var(--gray-600); white-space: nowrap;">${order.paymentsMade}/${order.paymentPlan}</span>
          </div>
        </td>
        <td><span class="flag ${statusClass}">${order.status}</span></td>
        <td>
          <div style="display: flex; gap: 4px;">
            ${showMarkReceived ? `
              <button class="btn btn-outline btn-sm" onclick="markOrderReceived('${order.orderId}')" title="Mark Received">
                <span class="material-icons-round" style="font-size: 14px;">inventory</span>
              </button>
            ` : ''}
            ${showMarkPayment ? `
              <button class="btn btn-outline btn-sm" onclick="markOrderPayment('${order.orderId}')" title="Record Payment">
                <span class="material-icons-round" style="font-size: 14px;">paid</span>
              </button>
            ` : ''}
            <button class="btn btn-outline btn-sm" onclick="viewOrderDetails('${order.orderId}')" title="View Details">
              <span class="material-icons-round" style="font-size: 14px;">visibility</span>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  if (countEl) {
    countEl.textContent = `Showing ${UniformState.orders.length} order${UniformState.orders.length !== 1 ? 's' : ''}`;
  }
}

/**
 * Cancels an order
 */
function cancelOrder(orderId) {
  if (!confirm('Are you sure you want to cancel this order?')) return;
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Order cancelled', 'success');
        loadUniformOrders();
      } else {
        showToast(result.error || 'Failed to cancel order', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .cancelUniformOrder(orderId);
}

/**
 * Filters the orders table by search and location
 */
function filterOrdersTable() {
  const search = (document.getElementById('orderSearchInput')?.value || '').toLowerCase();
  const location = document.getElementById('orderLocationFilter')?.value || '';
  
  const rows = document.querySelectorAll('#uniformOrdersBody tr[data-order-id]');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const employeeName = (row.dataset.employeeName || '').toLowerCase();
    const rowLocation = row.dataset.location || '';
    
    const matchesSearch = !search || employeeName.includes(search);
    const matchesLocation = !location || rowLocation === location;
    
    const show = matchesSearch && matchesLocation;
    row.style.display = show ? '' : 'none';
    if (show) visibleCount++;
  });
  
  const countEl = document.getElementById('ordersCount');
  if (countEl) {
    countEl.textContent = `Showing ${visibleCount} of ${UniformState.orders.length} order${UniformState.orders.length !== 1 ? 's' : ''}`;
  }
}

/**
 * Updates the order status preview (shows pending workflow info)
 */
function updateDeductionPreview() {
  const preview = document.getElementById('deductionPreview');
  if (!preview) return;
  
  const total = UniformState.orderItems.reduce((sum, item) => sum + item.lineTotal, 0);
  
  if (total === 0 && UniformState.orderItems.length > 0) {
    // All items are free/replacements
    preview.style.background = 'var(--success-light)';
    preview.style.borderColor = 'var(--success)';
    preview.innerHTML = `
      <span style="color: var(--success); font-size: 0.85rem;">
        <span class="material-icons-round" style="font-size: 16px; vertical-align: middle;">check_circle</span>
        No deductions needed (free/replacement items only). Order will be marked as <strong>Store Paid</strong>.
      </span>
    `;
    return;
  }
  
  // Show the standard pending workflow message
  preview.style.background = 'var(--info-light)';
  preview.style.borderColor = 'var(--info)';
  preview.innerHTML = `
    <span style="color: var(--info); font-size: 0.85rem;">
      <span class="material-icons-round" style="font-size: 16px; vertical-align: middle;">info</span>
      Order will be created as <strong>Pending</strong>. Deductions start when you mark items as received.
    </span>
  `;
}

/**
 * Marks an order as received (changes from Pending to Active)
 */
function markOrderReceived(orderId) {
  const order = UniformState.orders.find(o => o.orderId === orderId);
  if (!order) return;
  
  if (!confirm(`Mark order ${orderId} for ${order.employeeName} as received?\n\nThis will:\n‚Ä¢ Change status to Active\n‚Ä¢ Set first deduction date to next payday (7+ days out)`)) {
    return;
  }
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast(`Order received! First deduction: ${result.firstDeductionDate}`, 'success');
        loadUniformOrders();
      } else {
        showToast(result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .markOrderReceived(orderId);
}

/**
 * Marks the next payment as complete for an order
 */
function markOrderPayment(orderId) {
  const order = UniformState.orders.find(o => o.orderId === orderId);
  if (!order) return;
  
  const nextPayment = order.paymentsMade + 1;
  const confirmMsg = `Record payment ${nextPayment} of ${order.paymentPlan} for ${order.employeeName}?\n\nAmount: $${order.amountPerPaycheck.toFixed(2)}`;
  
  if (!confirm(confirmMsg)) return;
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast(`Payment ${result.paymentsMade}/${order.paymentPlan} recorded`, 'success');
        loadUniformOrders();
      } else {
        showToast(result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .recordUniformPayment(orderId);
}

/**
 * Current order being viewed in modal (for action buttons)
 */
let currentModalOrder = null;

/**
 * Opens the order details modal
 */
function viewOrderDetails(orderId) {
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      console.log('getOrderDetails returned:', result);
      
      // Handle null result (old deployment issue)
      if (result === null || result === undefined) {
        showToast('Error: Could not load order details. Try refreshing the page.', 'error');
        console.error('getOrderDetails returned null - deployment may be outdated');
        return;
      }
      
      if (result.success) {
        currentModalOrder = result.order;
        renderOrderDetailsModal(result.order);
      } else {
        showToast(result.error || 'Unknown error', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .getOrderDetails(orderId);
}

/**
 * Renders the order details modal content
 */
function renderOrderDetailsModal(order) {
  document.getElementById('orderDetailsTitle').textContent = `Order ${order.orderId}`;
  
  const isPending = order.status === 'Pending';
  
  // Build items table with receiving status (and checkboxes for pending orders)
  const itemsHtml = (order.items || []).map(item => {
    const isCancelled = item.itemStatus === 'Cancelled';
    const isReceived = item.itemReceived || item.itemStatus === 'Received';
    
    const statusBadge = item.itemStatus === 'Received' 
      ? '<span class="badge-item-status received">‚úì Received</span>'
      : item.itemStatus === 'Cancelled'
      ? '<span class="badge-item-status cancelled">‚úó Cancelled</span>'
      : '<span class="badge-item-status pending">‚è≥ Pending</span>';
    
    // For pending orders, show checkboxes; for others, show status badge
    const statusColumn = isPending && !isCancelled
      ? `<td>
           <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
             <input type="checkbox" class="item-received-checkbox" data-line-id="${item.lineId}" 
                    ${isReceived ? 'checked' : ''} onchange="toggleModalItemReceived('${item.lineId}', this.checked)"
                    style="width: 18px; height: 18px; accent-color: var(--success);">
             <span style="font-size: 0.8rem; color: ${isReceived ? 'var(--success)' : 'var(--gray-500)'};">
               ${isReceived ? 'Received' : 'Pending'}
             </span>
           </label>
         </td>
         <td>
           <button class="btn-icon-sm" onclick="cancelItemFromModal('${item.lineId}', '${item.itemName}')" title="Cancel item">
             <span class="material-icons-round" style="font-size: 16px; color: var(--gray-400);">cancel</span>
           </button>
         </td>`
      : `<td>${statusBadge}</td><td></td>`;
    
    return `
      <tr class="${isCancelled ? 'item-cancelled-row' : ''}" data-line-id="${item.lineId}">
        <td>
          ${item.itemName}
          ${item.isReplacement ? '<span class="badge-replacement">REPL</span>' : ''}
        </td>
        <td>${item.size}</td>
        <td class="numeric">${item.quantity}</td>
        <td class="numeric">${item.isReplacement ? 'FREE' : '$' + (item.unitPrice || 0).toFixed(2)}</td>
        <td class="numeric">$${(item.lineTotal || 0).toFixed(2)}</td>
        ${statusColumn}
      </tr>
    `;
  }).join('');
  
  // Build payment schedule
  let paymentScheduleHtml = '';
  if (order.totalAmount > 0 && order.firstDeductionDate) {
    const firstDate = new Date(order.firstDeductionDate + 'T12:00:00');
    const perCheck = order.amountPerPaycheck || 0;
    
    for (let i = 0; i < order.paymentPlan; i++) {
      const date = new Date(firstDate);
      date.setDate(date.getDate() + (i * 14));
      const paymentNum = i + 1;
      const isCompleted = paymentNum <= order.paymentsMade;
      const isCurrent = paymentNum === order.paymentsMade + 1 && order.status === 'Active';
      
      // Calculate amount (last payment may differ due to rounding)
      let amount = perCheck;
      if (i === order.paymentPlan - 1) {
        amount = order.totalAmount - (perCheck * (order.paymentPlan - 1));
      }
      
      paymentScheduleHtml += `
        <div class="payment-schedule-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
          <span class="material-icons-round check-icon ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
            ${isCompleted ? 'check_circle' : isCurrent ? 'schedule' : 'radio_button_unchecked'}
          </span>
          <span style="flex: 1;">Payment ${paymentNum} - ${formatDate(date.toISOString())}</span>
          <span>$${amount.toFixed(2)}</span>
        </div>
      `;
    }
  } else if (order.totalAmount === 0) {
    paymentScheduleHtml = '<p style="color: var(--success);">No payments required (free/replacement order)</p>';
  } else if (order.status === 'Pending') {
    paymentScheduleHtml = '<p style="color: var(--warning);">Payment schedule will be set when order is marked as received</p>';
  }
  
  const statusClass = order.status === 'Active' ? 'moderate' : 
                      order.status === 'Pending' ? 'flag-pending' :
                      order.status === 'Completed' ? 'normal' : 
                      order.status === 'Store Paid' ? 'normal' : 'high';
  
  const html = `
    <div class="order-info-grid">
      <div class="order-info-item">
        <label>Employee</label>
        <strong>${order.employeeName}</strong>
      </div>
      <div class="order-info-item">
        <label>Location</label>
        <strong>${order.location || 'Not specified'}</strong>
      </div>
      <div class="order-info-item">
        <label>Order Date</label>
        <strong>${formatDate(order.orderDate)}</strong>
      </div>
      <div class="order-info-item">
        <label>Status</label>
        <span class="flag ${statusClass}">${order.status}</span>
      </div>
      ${order.receivedDate ? `
        <div class="order-info-item">
          <label>Received Date</label>
          <strong>${formatDate(order.receivedDate)}</strong>
        </div>
      ` : ''}
      ${order.notes ? `
        <div class="order-info-item" style="grid-column: span 2;">
          <label>Notes</label>
          <strong>${order.notes}</strong>
        </div>
      ` : ''}
    </div>
    
    <h4 style="margin-bottom: 8px;">Items ${order.receivedCount !== undefined ? `<span style="font-weight: normal; font-size: 0.85rem; color: var(--gray-500);">(${order.receivedCount}/${order.totalItemCount} received)</span>` : ''}</h4>
    <div class="table-wrapper" style="margin-bottom: 16px;">
      <table class="data-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>Size</th>
            <th class="numeric">Qty</th>
            <th class="numeric">Price</th>
            <th class="numeric">Total</th>
            <th>Status</th>
            ${order.status === 'Pending' ? '<th style="width: 40px;"></th>' : ''}
          </tr>
        </thead>
        <tbody>${itemsHtml}</tbody>
        <tfoot>
          <tr><td colspan="${order.status === 'Pending' ? '6' : '5'}" class="text-right"><strong>Order Total:</strong></td><td class="numeric"><strong>$${order.totalAmount.toFixed(2)}</strong></td></tr>
        </tfoot>
      </table>
    </div>
    
    ${order.status === 'Pending' ? `
      <div id="receivingSummaryAdmin" style="background: var(--success-light); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <strong>Received Total:</strong> 
          <span id="modalReceivedTotal" style="color: var(--success); font-weight: 700;">$${(order.receivedTotal || 0).toFixed(2)}</span>
          <span style="color: var(--gray-500);"> of $${order.totalAmount.toFixed(2)}</span>
        </div>
        <button class="btn btn-primary btn-sm" onclick="saveAndActivateFromModal()" id="saveActivateBtn">
          <span class="material-icons-round" style="font-size: 16px;">check_circle</span>
          Save & Activate
        </button>
      </div>
    ` : ''}
    
    <h4 style="margin-bottom: 8px;">Payment Schedule (${order.paymentPlan} payment${order.paymentPlan > 1 ? 's' : ''})</h4>
    <div class="payment-schedule">
      ${paymentScheduleHtml}
    </div>
    
    ${order.amountRemaining > 0 && order.status === 'Active' ? `
      <div style="margin-top: 16px; padding: 12px; background: var(--gray-50); border-radius: 6px;">
        <strong>Remaining Balance:</strong> $${order.amountRemaining.toFixed(2)} 
        <span style="color: var(--gray-500);">(${order.paymentPlan - order.paymentsMade} payment${order.paymentPlan - order.paymentsMade > 1 ? 's' : ''} left)</span>
      </div>
    ` : ''}
  `;
  
  document.getElementById('orderDetailsBody').innerHTML = html;
  
  // Show/hide action buttons based on status
  document.getElementById('cancelOrderBtn').style.display = 
    (order.status === 'Pending' || order.status === 'Active') ? 'inline-flex' : 'none';
  document.getElementById('markReceivedBtn').style.display = 
    order.status === 'Pending' ? 'inline-flex' : 'none';
  document.getElementById('markPaymentBtn').style.display = 
    order.status === 'Active' ? 'inline-flex' : 'none';
  
  // Show modal
  document.getElementById('orderDetailsModal').style.display = 'flex';
}

/**
 * Closes the order details modal
 */
function closeOrderDetailsModal() {
  document.getElementById('orderDetailsModal').style.display = 'none';
  currentModalOrder = null;
}

/**
 * Marks order received from modal
 */
function markOrderReceivedFromModal() {
  if (!currentModalOrder) return;
  closeOrderDetailsModal();
  markOrderReceived(currentModalOrder.orderId);
}

/**
 * Records payment from modal
 */
function markPaymentFromModal() {
  if (!currentModalOrder) return;
  closeOrderDetailsModal();
  markOrderPayment(currentModalOrder.orderId);
}

/**
 * Cancels order from modal
 */
function cancelOrderFromModal() {
  if (!currentModalOrder) return;
  const orderId = currentModalOrder.orderId;
  closeOrderDetailsModal();
  cancelOrder(orderId);
}

/**
 * Toggle item received status in modal
 */
function toggleModalItemReceived(lineId, received) {
  console.log('toggleModalItemReceived called:', { lineId: lineId, received: received, type: typeof received });
  
  if (!currentModalOrder) {
    console.error('No currentModalOrder!');
    return;
  }
  
  // Ensure received is a boolean
  const isReceived = received === true || received === 'true';
  
  // Find and update the item in our local state (compare as strings to be safe)
  const item = currentModalOrder.items.find(i => String(i.lineId) === String(lineId));
  if (item) {
    item.itemReceived = isReceived;
    item.itemStatus = isReceived ? 'Received' : 'Pending';
    console.log('Updated item:', { lineId: item.lineId, itemReceived: item.itemReceived, itemStatus: item.itemStatus });
  } else {
    console.error('Item not found with lineId:', lineId);
    console.log('Available lineIds:', currentModalOrder.items.map(i => i.lineId));
  }
  
  // Update the label next to this specific checkbox
  const checkbox = document.querySelector(`input.item-received-checkbox[data-line-id="${lineId}"]`);
  if (checkbox) {
    // Find the span sibling within the same label
    const label = checkbox.closest('label');
    if (label) {
      const span = label.querySelector('span');
      if (span) {
        span.textContent = isReceived ? 'Received' : 'Pending';
        span.style.color = isReceived ? 'var(--success)' : 'var(--gray-500)';
      }
    }
  }
  
  // Recalculate received total
  updateModalReceivedTotal();
}

/**
 * Update the received total display in modal
 */
function updateModalReceivedTotal() {
  if (!currentModalOrder) return;
  
  // Count items based on their current itemReceived state (which we update on checkbox change)
  const activeItems = currentModalOrder.items.filter(i => i.itemStatus !== 'Cancelled');
  const receivedItems = activeItems.filter(i => i.itemReceived === true);
  const receivedTotal = receivedItems.reduce((sum, i) => sum + (i.lineTotal || 0), 0);
  
  currentModalOrder.receivedCount = receivedItems.length;
  currentModalOrder.receivedTotal = receivedTotal;
  
  // Update the total display
  const totalEl = document.getElementById('modalReceivedTotal');
  if (totalEl) {
    totalEl.textContent = '$' + receivedTotal.toFixed(2);
  }
  
  // Also update the header count
  const itemsHeader = document.querySelector('#orderDetailsBody h4');
  if (itemsHeader && itemsHeader.textContent.includes('Items')) {
    itemsHeader.innerHTML = `Items <span style="font-weight: normal; font-size: 0.85rem; color: var(--gray-500);">(${receivedItems.length}/${activeItems.length} received)</span>`;
  }
  
  console.log('Updated totals:', { receivedCount: receivedItems.length, receivedTotal: receivedTotal, activeItems: activeItems.length });
}

/**
 * Cancel an item from the modal
 */
function cancelItemFromModal(lineId, itemName) {
  if (!confirm(`Cancel "${itemName}"?\n\nThis cannot be undone.`)) {
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Item cancelled', 'success');
        // Refresh the modal
        viewOrderDetails(currentModalOrder.orderId);
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .cancelUniformItem(lineId);
}

/**
 * Save item statuses and activate order from modal
 */
function saveAndActivateFromModal() {
  if (!currentModalOrder) return;
  
  console.log('saveAndActivateFromModal - all items:', currentModalOrder.items.map(i => ({
    lineId: i.lineId,
    itemName: i.itemName,
    itemReceived: i.itemReceived,
    itemStatus: i.itemStatus
  })));
  
  const activeItems = currentModalOrder.items.filter(i => i.itemStatus !== 'Cancelled');
  // Check for itemReceived being exactly true (boolean)
  const receivedItems = activeItems.filter(i => i.itemReceived === true);
  const unreceivedItems = activeItems.filter(i => i.itemReceived !== true);
  
  console.log('Active items:', activeItems.length, 'Received items:', receivedItems.length);
  
  if (receivedItems.length === 0) {
    showToast('Please mark at least one item as received', 'error');
    return;
  }
  
  const receivedTotal = receivedItems.reduce((sum, i) => sum + (i.lineTotal || 0), 0);
  
  let message = `Activate order with ${receivedItems.length} received item(s)?

Deduction amount: $${receivedTotal.toFixed(2)}`;
  
  if (unreceivedItems.length > 0) {
    message += `

${unreceivedItems.length} unreceived item(s) will be moved to a new pending order.`;
  }
  
  if (!confirm(message)) {
    return;
  }
  
  showLoading(true);
  
  // First, save the item statuses
  const updates = currentModalOrder.items
    .filter(i => i.itemStatus !== 'Cancelled')
    .map(item => ({
      lineId: item.lineId,
      received: item.itemReceived || item.itemStatus === 'Received'
    }));
  
  google.script.run
    .withSuccessHandler(function(saveResult) {
      if (!saveResult.success) {
        showLoading(false);
        showToast('Error saving: ' + saveResult.error, 'error');
        return;
      }
      
      // Now activate the order
      google.script.run
        .withSuccessHandler(function(activateResult) {
          showLoading(false);
          if (activateResult.success) {
            let msg = `Order activated! Deductions of $${activateResult.newTotal.toFixed(2)} will begin.`;
            if (activateResult.newOrderId) {
              msg += ` Unreceived items moved to ${activateResult.newOrderId}.`;
            }
            showToast(msg, 'success');
            closeOrderDetailsModal();
            loadUniformOrders(); // Refresh the orders list
          } else {
            showToast('Error: ' + activateResult.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showToast('Error: ' + error.message, 'error');
        })
        .activateOrderWithReceivedItems(currentModalOrder.orderId);
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .updateItemsReceivedStatus(updates, 'Admin');
}

/**
 * Loads payroll deductions for selected payday
 */
function loadPayrollDeductions() {
  const paydaySelect = document.getElementById('deductionPayday');
  if (!paydaySelect || !paydaySelect.value) {
    document.getElementById('deductionsSummary').classList.add('hidden');
    document.getElementById('deductionsBody').innerHTML = `
      <tr><td colspan="5"><div class="empty-state">
        <span class="material-icons-round">calendar_today</span>
        <h3>Select a Payday</h3>
        <p>Choose a payday above to see deductions due</p>
      </div></td></tr>
    `;
    document.getElementById('markAllPaidBtn').disabled = true;
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        UniformState.deductions = result.deductions || [];
        renderPayrollDeductions(result);
      } else {
        showToast(result.error || 'Failed to load deductions', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .getPayrollDeductions(paydaySelect.value);
}

/**
 * Renders payroll deductions (includes both paid and due)
 */
function renderPayrollDeductions(result) {
  const tbody = document.getElementById('deductionsBody');
  const summary = document.getElementById('deductionsSummary');
  const markAllBtn = document.getElementById('markAllPaidBtn');
  
  if (!tbody) return;
  
  // Update summary with both paid and due counts
  document.getElementById('deductionsCount').textContent = result.count;
  document.getElementById('deductionsTotal').textContent = '$' + result.total.toFixed(2);
  
  if (result.deductions.length === 0) {
    summary.classList.add('hidden');
    markAllBtn.disabled = true;
    tbody.innerHTML = `
      <tr><td colspan="5"><div class="empty-state">
        <span class="material-icons-round">check_circle</span>
        <h3>No Deductions</h3>
        <p>No uniform deductions scheduled for this payday</p>
      </div></td></tr>
    `;
    return;
  }
  
  summary.classList.remove('hidden');
  
  // Only enable "Mark All Paid" if there are due (unpaid) deductions
  const dueCount = result.dueCount || result.deductions.filter(d => d.isDue).length;
  markAllBtn.disabled = dueCount === 0;
  
  tbody.innerHTML = result.deductions.map(d => {
    const isPaid = d.isPaid;
    const isDue = d.isDue;
    const rowClass = isPaid ? 'deduction-paid' : (isDue ? 'deduction-due' : '');
    const statusBadge = isPaid 
      ? '<span class="badge badge-success" style="font-size: 0.7rem; padding: 2px 6px;">PAID</span>'
      : (isDue 
          ? '<span class="badge badge-warning" style="font-size: 0.7rem; padding: 2px 6px;">DUE</span>'
          : '<span class="badge" style="font-size: 0.7rem; padding: 2px 6px;">‚Äî</span>');
    
    return `
      <tr class="${rowClass}" style="${isPaid ? 'opacity: 0.7; background: #f0fff0;' : ''}">
        <td><strong>${d.employeeName}</strong></td>
        <td>${d.orderId}</td>
        <td>${d.paymentNumber} of ${d.totalPayments} ${statusBadge}</td>
        <td class="numeric"><strong>$${d.amount.toFixed(2)}</strong></td>
        <td>
          ${isDue ? `
            <button class="btn btn-primary btn-sm" onclick="recordSinglePayment('${d.orderId}')">
              <span class="material-icons-round" style="font-size: 16px;">check</span> Mark Paid
            </button>
          ` : (isPaid ? `
            <span style="color: var(--success-color); font-size: 0.85rem;">
              <span class="material-icons-round" style="font-size: 16px; vertical-align: middle;">check_circle</span> Recorded
            </span>
          ` : '')}
        </td>
      </tr>
    `;
  }).join('');
}

/**
 * Records a single payment
 */
function recordSinglePayment(orderId) {
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast(result.message, 'success');
        loadPayrollDeductions();
        loadUniformOrders();
      } else {
        showToast(result.error || 'Failed to record payment', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .recordUniformPayment(orderId);
}

/**
 * Marks all deductions as paid for the selected payday
 */
function markAllDeductionsPaid() {
  const paydaySelect = document.getElementById('deductionPayday');
  if (!paydaySelect || !paydaySelect.value) return;
  
  if (!confirm(`Mark all ${UniformState.deductions.length} deductions as paid?`)) return;
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast(result.message, 'success');
        loadPayrollDeductions();
        loadUniformOrders();
      } else {
        showToast(result.error || 'Failed to record payments', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .markAllDeductionsPaid(paydaySelect.value);
}

/**
 * Exports deductions to CSV
 */
function exportDeductionsCSV() {
  if (UniformState.deductions.length === 0) {
    showToast('No deductions to export', 'error');
    return;
  }
  
  const paydaySelect = document.getElementById('deductionPayday');
  const payday = paydaySelect ? formatDate(paydaySelect.value) : 'Unknown';
  
  let csv = 'Employee,Order ID,Payment,Amount\n';
  UniformState.deductions.forEach(d => {
    csv += `"${d.employeeName}","${d.orderId}","${d.paymentNumber} of ${d.totalPayments}","$${d.amount.toFixed(2)}"\n`;
  });
  
  const total = UniformState.deductions.reduce((sum, d) => sum + d.amount, 0);
  csv += `\n"TOTAL","","","$${total.toFixed(2)}"\n`;
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `Uniform_Deductions_${payday.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
  link.click();
  
  showToast('CSV exported', 'success');
}

/**
 * Toggles the catalog section visibility
 */
function toggleCatalogSection() {
  const section = document.getElementById('catalogSection');
  const icon = document.getElementById('catalogToggleIcon');
  
  if (section.classList.contains('hidden')) {
    section.classList.remove('hidden');
    icon.textContent = 'expand_less';
    loadCatalogTable();
  } else {
    section.classList.add('hidden');
    icon.textContent = 'expand_more';
  }
}

/**
 * Loads the catalog table
 */
function loadCatalogTable() {
  google.script.run
    .withSuccessHandler(function(items) {
      const tbody = document.getElementById('catalogBody');
      if (!tbody) return;
      
      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><span class="material-icons-round">inventory_2</span><p>No catalog items</p></div></td></tr>';
        return;
      }
      
      tbody.innerHTML = items.map(item => `
        <tr style="${!item.active ? 'opacity: 0.5;' : ''}">
          <td><code>${item.itemId}</code></td>
          <td>${item.itemName}</td>
          <td>${item.category}</td>
          <td style="font-size: 0.75rem;">${item.availableSizes.join(', ')}</td>
          <td class="numeric">$${item.price.toFixed(2)}</td>
          <td>${item.active ? '‚úì' : '‚úó'}</td>
          <td style="white-space: nowrap;">
            <button class="btn btn-outline btn-sm" onclick="showEditCatalogItemModal('${item.itemId}')" title="Edit item">
              <span class="material-icons-round" style="font-size: 16px;">edit</span>
            </button>
            <button class="btn btn-outline btn-sm" onclick="toggleCatalogItemActive('${item.itemId}', ${!item.active})" title="${item.active ? 'Deactivate' : 'Activate'}">
              <span class="material-icons-round" style="font-size: 16px;">${item.active ? 'visibility_off' : 'visibility'}</span>
            </button>
          </td>
        </tr>
      `).join('');
    })
    .withFailureHandler(console.error)
    .getCatalogItems(false);
}

/**
 * Toggles a catalog item's active status
 */
function toggleCatalogItemActive(itemId, active) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast(active ? 'Item activated' : 'Item deactivated', 'success');
        loadCatalogTable();
        // Refresh catalog in state
        google.script.run
          .withSuccessHandler(function(items) {
            UniformState.catalog = items || [];
            populateItemDropdown();
          })
          .getCatalogItems(true);
      } else {
        showToast(result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('Error: ' + error.message, 'error');
    })
    .updateCatalogItem(itemId, { active: active });
}

/**
 * Show the Add Catalog Item modal
 */
function showAddCatalogItemModal() {
  const modal = document.getElementById('addCatalogItemModal');
  if (!modal) return;
  
  // Reset form
  document.getElementById('addCatalogItemForm').reset();
  document.getElementById('newCategoryInput').style.display = 'none';
  document.getElementById('noSizeCheckbox').checked = false;
  document.getElementById('sizeOptionsContainer').classList.remove('disabled');
  
  // Reset custom sizes and pants overrides
  const customSizesInput = document.getElementById('newCustomSizes');
  const customSizesSection = document.getElementById('customSizesSection');
  const pantsSection = document.getElementById('pantsOverrideSection');
  const waistInput = document.getElementById('newWaistSizes');
  const inseamInput = document.getElementById('newInseamSizes');
  
  if (customSizesInput) customSizesInput.value = '';
  if (customSizesSection) customSizesSection.style.display = 'block';
  if (pantsSection) pantsSection.style.display = 'none';
  if (waistInput) waistInput.value = '';
  if (inseamInput) inseamInput.value = '';
  
  // Check default sizes (XS through 3XL)
  document.querySelectorAll('#sizeOptionsContainer input[name="sizes"]').forEach((cb, index) => {
    cb.checked = index < 7;
  });
  
  // Populate category dropdown
  const categorySelect = document.getElementById('newItemCategory');
  categorySelect.innerHTML = '<option value="">Select category...</option>';
  categorySelect.disabled = false;
  if (UniformState.categories && UniformState.categories.length > 0) {
    UniformState.categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    });
  }
  
  // Add "New category..." option
  const newCatOption = document.createElement('option');
  newCatOption.value = '__new__';
  newCatOption.textContent = '+ New category...';
  categorySelect.appendChild(newCatOption);
  
  // Show modal
  modal.style.display = 'flex';
}

/**
 * Close the Add Catalog Item modal
 */
function closeAddCatalogItemModal() {
  const modal = document.getElementById('addCatalogItemModal');
  if (modal) modal.style.display = 'none';
}

/**
 * Toggle the new category input field
 */
function toggleNewCategoryInput() {
  const input = document.getElementById('newCategoryInput');
  const select = document.getElementById('newItemCategory');
  
  if (input.style.display === 'none') {
    input.style.display = 'block';
    select.value = '';
    select.disabled = true;
    input.focus();
  } else {
    input.style.display = 'none';
    input.value = '';
    select.disabled = false;
  }
}

/**
 * Handle category dropdown change
 */
function handleCategoryChange() {
  const input = document.getElementById('newCategoryInput');
  const categorySelect = document.getElementById('newItemCategory');
  const pantsSection = document.getElementById('pantsOverrideSection');
  
  // If user selected "New category..." option
  if (categorySelect.value === '__new__') {
    input.style.display = 'block';
    input.focus();
    // Hide pants section until category is entered
    if (pantsSection) pantsSection.style.display = 'none';
    return;
  }
  
  // Hide new category input if visible
  if (input.style.display === 'block') {
    input.style.display = 'none';
    input.value = '';
  }
  
  // Show pants override section if category is PANTS
  const category = categorySelect.value.toUpperCase();
  const isPants = category === 'PANTS' || category.includes('PANT');
  if (pantsSection) {
    pantsSection.style.display = isPants ? 'block' : 'none';
  }
}

/**
 * Toggle size options based on "No size" checkbox
 */
function toggleSizeOptions() {
  const noSizeCheckbox = document.getElementById('noSizeCheckbox');
  const sizeContainer = document.getElementById('sizeOptionsContainer');
  const customSection = document.getElementById('customSizesSection');
  
  if (noSizeCheckbox.checked) {
    sizeContainer.classList.add('disabled');
    document.querySelectorAll('#sizeOptionsContainer input[name="sizes"]').forEach(cb => {
      cb.checked = false;
    });
    if (customSection) customSection.style.display = 'none';
  } else {
    sizeContainer.classList.remove('disabled');
    if (customSection) customSection.style.display = 'block';
  }
}

/**
 * Submit the Add Catalog Item form
 */
function submitAddCatalogItem(event) {
  event.preventDefault();
  
  const itemId = document.getElementById('newItemId').value.trim().toUpperCase();
  const itemName = document.getElementById('newItemName').value.trim();
  const categorySelect = document.getElementById('newItemCategory');
  const newCategoryInput = document.getElementById('newCategoryInput');
  const price = parseFloat(document.getElementById('newItemPrice').value) || 0;
  const noSize = document.getElementById('noSizeCheckbox').checked;
  
  // Get category (from dropdown or new input)
  let category = categorySelect.value;
  if (newCategoryInput.style.display === 'block' && newCategoryInput.value.trim()) {
    category = newCategoryInput.value.trim();
  }
  
  // Validation
  if (!itemId) {
    showToast('Please enter an Item ID', 'error');
    return;
  }
  if (!itemName) {
    showToast('Please enter an Item Name', 'error');
    return;
  }
  if (!category) {
    showToast('Please select or enter a Category', 'error');
    return;
  }
  
  // Get selected sizes
  let sizes = '';
  if (noSize) {
    sizes = 'N/A';
  } else {
    const selectedSizes = [];
    document.querySelectorAll('#sizeOptionsContainer input[name="sizes"]:checked').forEach(cb => {
      selectedSizes.push(cb.value);
    });
    
    // Add custom sizes
    const customSizes = document.getElementById('newCustomSizes')?.value || '';
    if (customSizes.trim()) {
      customSizes.split(',').forEach(s => {
        const trimmed = s.trim();
        if (trimmed && !selectedSizes.includes(trimmed)) {
          selectedSizes.push(trimmed);
        }
      });
    }
    
    if (selectedSizes.length === 0) {
      showToast('Please select at least one size or check "No size"', 'error');
      return;
    }
    sizes = selectedSizes.join(',');
  }
  
  // Get pants waist/inseam overrides (if applicable)
  const waistSizes = document.getElementById('newWaistSizes')?.value?.trim() || '';
  const inseamSizes = document.getElementById('newInseamSizes')?.value?.trim() || '';
  
  // Close modal and show loading
  closeAddCatalogItemModal();
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Item added successfully!', 'success');
        loadCatalogTable();
        // Refresh catalog
        google.script.run
          .withSuccessHandler(function(items) {
            UniformState.catalog = items || [];
            UniformState.categories = [...new Set(items.map(i => i.category))].sort();
            populateCategoryDropdown();
            populateItemDropdown();
          })
          .getCatalogItems(true);
      } else {
        showToast(result.error || 'Failed to add item', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .addCatalogItem({
      itemId: itemId,
      itemName: itemName,
      category: category,
      availableSizes: sizes,
      price: price,
      waistSizes: waistSizes,
      inseamSizes: inseamSizes
    });
}

// ============================================================================
// EDIT CATALOG ITEM FUNCTIONS
// ============================================================================

/**
 * Show the Edit Catalog Item modal with item data
 */
function showEditCatalogItemModal(itemId) {
  // Find the item in catalog
  google.script.run
    .withSuccessHandler(function(items) {
      const item = items.find(i => i.itemId === itemId);
      if (!item) {
        showToast('Item not found', 'error');
        return;
      }
      
      const modal = document.getElementById('editCatalogItemModal');
      if (!modal) return;
      
      // Store original ID
      document.getElementById('editItemOriginalId').value = item.itemId;
      
      // Populate form fields
      document.getElementById('editItemId').value = item.itemId;
      document.getElementById('editItemName').value = item.itemName;
      document.getElementById('editItemPrice').value = item.price.toFixed(2);
      document.getElementById('editItemActive').checked = item.active;
      
      // Reset new category input
      document.getElementById('editNewCategoryInput').style.display = 'none';
      document.getElementById('editNewCategoryInput').value = '';
      
      // Populate category dropdown
      const categorySelect = document.getElementById('editItemCategory');
      categorySelect.innerHTML = '<option value="">Select category...</option>';
      categorySelect.disabled = false;
      
      // Get all categories (including from loaded items)
      const allCategories = [...new Set(items.map(i => i.category))].sort();
      allCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        if (cat === item.category) option.selected = true;
        categorySelect.appendChild(option);
      });
      
      // Add "New category..." option
      const newCatOption = document.createElement('option');
      newCatOption.value = '__new__';
      newCatOption.textContent = '+ New category...';
      categorySelect.appendChild(newCatOption);
      
      // Handle sizes
      const sizes = item.availableSizes || [];
      const standardSizes = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL'];
      const noSize = sizes.length === 1 && (sizes[0] === 'N/A' || sizes[0] === 'One Size');
      
      // Set no-size checkbox
      document.getElementById('editNoSizeCheckbox').checked = noSize;
      
      // Clear all size checkboxes first
      document.querySelectorAll('#editSizeOptionsContainer input[name="editSizes"]').forEach(cb => {
        cb.checked = false;
      });
      
      // Separate standard and custom sizes
      const customSizes = [];
      sizes.forEach(size => {
        if (standardSizes.includes(size)) {
          const cb = document.querySelector(`#editSizeOptionsContainer input[name="editSizes"][value="${size}"]`);
          if (cb) cb.checked = true;
        } else if (size !== 'N/A' && size !== 'One Size') {
          customSizes.push(size);
        }
      });
      
      // Set custom sizes
      document.getElementById('editCustomSizes').value = customSizes.join(', ');
      
      // Update size options visibility
      toggleEditSizeOptions();
      
      // Handle pants waist/inseam overrides
      const isPants = item.category.toUpperCase() === 'PANTS' || item.category.toUpperCase().includes('PANT');
      const pantsSection = document.getElementById('editPantsOverrideSection');
      if (pantsSection) {
        pantsSection.style.display = isPants ? 'block' : 'none';
      }
      
      // Populate waist/inseam values
      const waistInput = document.getElementById('editWaistSizes');
      const inseamInput = document.getElementById('editInseamSizes');
      if (waistInput) waistInput.value = (item.waistSizes || []).join(', ');
      if (inseamInput) inseamInput.value = (item.inseamSizes || []).join(', ');
      
      // Show modal
      modal.style.display = 'flex';
    })
    .withFailureHandler(function(error) {
      showToast('Error loading item: ' + error.message, 'error');
    })
    .getCatalogItems(false);
}

/**
 * Close the Edit Catalog Item modal
 */
function closeEditCatalogItemModal() {
  const modal = document.getElementById('editCatalogItemModal');
  if (modal) modal.style.display = 'none';
}

/**
 * Handle category change in edit modal
 */
function handleEditCategoryChange() {
  const categorySelect = document.getElementById('editItemCategory');
  const newCategoryInput = document.getElementById('editNewCategoryInput');
  const pantsSection = document.getElementById('editPantsOverrideSection');
  
  if (categorySelect.value === '__new__') {
    newCategoryInput.style.display = 'block';
    newCategoryInput.focus();
  } else {
    // Show/hide pants section based on category
    const category = categorySelect.value.toUpperCase();
    const isPants = category === 'PANTS' || category.includes('PANT');
    if (pantsSection) {
      pantsSection.style.display = isPants ? 'block' : 'none';
    }
    newCategoryInput.style.display = 'none';
  }
}

/**
 * Toggle new category input in edit modal
 */
function toggleEditNewCategoryInput() {
  const categorySelect = document.getElementById('editItemCategory');
  const newCategoryInput = document.getElementById('editNewCategoryInput');
  
  if (newCategoryInput.style.display === 'none' || newCategoryInput.style.display === '') {
    newCategoryInput.style.display = 'block';
    categorySelect.disabled = true;
    newCategoryInput.focus();
  } else {
    newCategoryInput.style.display = 'none';
    newCategoryInput.value = '';
    categorySelect.disabled = false;
  }
}

/**
 * Toggle size options in edit modal
 */
function toggleEditSizeOptions() {
  const noSize = document.getElementById('editNoSizeCheckbox').checked;
  const container = document.getElementById('editSizeOptionsContainer');
  const customSection = document.getElementById('editCustomSizesSection');
  
  if (container) container.classList.toggle('disabled', noSize);
  if (customSection) customSection.style.display = noSize ? 'none' : 'block';
}

/**
 * Submit the Edit Catalog Item form
 */
function submitEditCatalogItem(event) {
  event.preventDefault();
  
  const itemId = document.getElementById('editItemOriginalId').value;
  const itemName = document.getElementById('editItemName').value.trim();
  const categorySelect = document.getElementById('editItemCategory');
  const newCategoryInput = document.getElementById('editNewCategoryInput');
  const price = parseFloat(document.getElementById('editItemPrice').value) || 0;
  const active = document.getElementById('editItemActive').checked;
  const noSize = document.getElementById('editNoSizeCheckbox').checked;
  
  // Get category (from dropdown or new input)
  let category = categorySelect.value;
  if (categorySelect.disabled && newCategoryInput.value.trim()) {
    category = newCategoryInput.value.trim();
  } else if (category === '__new__' && newCategoryInput.value.trim()) {
    category = newCategoryInput.value.trim();
  }
  
  // Validation
  if (!itemName) {
    showToast('Please enter an Item Name', 'error');
    return;
  }
  if (!category || category === '__new__') {
    showToast('Please select or enter a Category', 'error');
    return;
  }
  
  // Get selected sizes
  let sizes = '';
  if (noSize) {
    sizes = 'N/A';
  } else {
    const selectedSizes = [];
    
    // Get standard sizes
    document.querySelectorAll('#editSizeOptionsContainer input[name="editSizes"]:checked').forEach(cb => {
      selectedSizes.push(cb.value);
    });
    
    // Get custom sizes
    const customSizes = document.getElementById('editCustomSizes').value;
    if (customSizes.trim()) {
      customSizes.split(',').forEach(s => {
        const trimmed = s.trim();
        if (trimmed && !selectedSizes.includes(trimmed)) {
          selectedSizes.push(trimmed);
        }
      });
    }
    
    if (selectedSizes.length === 0) {
      showToast('Please select at least one size or check "No size"', 'error');
      return;
    }
    sizes = selectedSizes.join(',');
  }
  
  // Get pants waist/inseam overrides (if applicable)
  const waistSizes = document.getElementById('editWaistSizes')?.value?.trim() || '';
  const inseamSizes = document.getElementById('editInseamSizes')?.value?.trim() || '';
  
  // Close modal and show loading
  closeEditCatalogItemModal();
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Item updated successfully!', 'success');
        loadCatalogTable();
        // Refresh catalog in state
        google.script.run
          .withSuccessHandler(function(items) {
            UniformState.catalog = items || [];
            UniformState.categories = [...new Set(items.map(i => i.category))].sort();
            populateCategoryDropdown();
            populateItemDropdown();
          })
          .getCatalogItems(true);
      } else {
        showToast(result.error || 'Failed to update item', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .updateCatalogItem(itemId, {
      itemName: itemName,
      category: category,
      availableSizes: sizes,
      price: price,
      active: active,
      waistSizes: waistSizes,
      inseamSizes: inseamSizes
    });
}

// ============================================================================
// VIEW INITIALIZATION FUNCTIONS (for MainApp dynamic loading)
// ============================================================================

/**
 * Initialize Dashboard view
 */
// Dashboard state
const DashboardState = {
  lastLoaded: null,
  data: null,
  refreshInterval: null
};

/**
 * Initialize Dashboard view
 */
function initDashboard() {
  showLoading(true);
  
  // Start auto-refresh timer
  startDashboardAutoRefresh();
  
  // Load payroll calendar widget (Chunk 15)
  if (typeof loadPayrollCalendar === 'function') {
    loadPayrollCalendar();
  }
  
  // Check if we should refresh (more than 30 seconds since last load)
  const now = Date.now();
  if (DashboardState.lastLoaded && (now - DashboardState.lastLoaded) < 30000 && DashboardState.data) {
    // Use cached data
    renderDashboard(DashboardState.data);
    showLoading(false);
    return;
  }
  
  // Load fresh data
  loadDashboardDataNew();
}

/**
 * Start dashboard auto-refresh (every 30 minutes)
 */
function startDashboardAutoRefresh() {
  // Clear any existing interval first
  stopDashboardAutoRefresh();
  
  // Set up 30-minute refresh (1800000 ms)
  DashboardState.refreshInterval = setInterval(function() {
    // Only refresh if we're still on the dashboard
    const currentHash = window.location.hash.slice(1) || 'home';
    if (currentHash === 'home' || currentHash === '') {
      silentDashboardRefresh();
    }
  }, 1800000); // 30 minutes
  
  console.log('Dashboard auto-refresh started (30 min interval)');
}

/**
 * Stop dashboard auto-refresh
 */
function stopDashboardAutoRefresh() {
  if (DashboardState.refreshInterval) {
    clearInterval(DashboardState.refreshInterval);
    DashboardState.refreshInterval = null;
    console.log('Dashboard auto-refresh stopped');
  }
}

/**
 * Silent refresh (no loading spinner, for auto-refresh)
 */
function silentDashboardRefresh() {
  // Don't refresh if last refresh was less than 1 minute ago
  const now = Date.now();
  if (DashboardState.lastLoaded && (now - DashboardState.lastLoaded) < 60000) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.success) {
        DashboardState.data = result;
        DashboardState.lastLoaded = Date.now();
        renderDashboard(result);
        console.log('Dashboard auto-refreshed at', new Date().toLocaleTimeString());
      }
    })
    .withFailureHandler(function(error) {
      console.error('Silent refresh failed:', error);
    })
    .getDashboardData();
}

/**
 * Open PTO request form in new tab
 */
function openPTOForm() {
  // Get the base URL (remove any existing hash or parameters)
  let baseUrl = window.location.href;
  
  // Remove hash if present
  if (baseUrl.includes('#')) {
    baseUrl = baseUrl.split('#')[0];
  }
  
  // Remove existing query params if present, then add our view param
  if (baseUrl.includes('?')) {
    baseUrl = baseUrl.split('?')[0];
  }
  
  // Open PTO form in new tab
  window.open(baseUrl + '?view=pto-request', '_blank');
}

/**
 * Load dashboard data from server
 */
function loadDashboardDataNew() {
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result && result.success) {
        DashboardState.data = result;
        DashboardState.lastLoaded = Date.now();
        renderDashboard(result);
      } else {
        showToast(result?.error || 'Failed to load dashboard data', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      console.error('Dashboard load error:', error);
      showToast('Failed to load dashboard', 'error');
    })
    .getDashboardData();
}

/**
 * Force refresh dashboard
 */
function refreshDashboard() {
  const btn = document.querySelector('.refresh-btn');
  if (btn) btn.classList.add('spinning');
  
  DashboardState.lastLoaded = null; // Force refresh
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (btn) btn.classList.remove('spinning');
      if (result && result.success) {
        DashboardState.data = result;
        DashboardState.lastLoaded = Date.now();
        renderDashboard(result);
        showToast('Dashboard refreshed', 'success');
      }
    })
    .withFailureHandler(function(error) {
      if (btn) btn.classList.remove('spinning');
      showToast('Failed to refresh', 'error');
    })
    .getDashboardData();
}

/**
 * Render all dashboard sections
 */
function renderDashboard(data) {
  renderPeriodInfo(data.currentPeriod);
  renderMetricCards(data.otMetrics, data.uniformMetrics, data.ptoMetrics, data.alerts);
  renderActionItems(data.actionItems);
  renderTopOTEmployees(data.topOTEmployees);
  renderUpcomingPayments(data.uniformMetrics.upcomingPayments);
  renderAlertsList(data.alerts);
  updateLastUpdated(data.lastUpdated);
}

/**
 * Render period info bar
 */
function renderPeriodInfo(period) {
  const bar = document.getElementById('periodInfoBar');
  const rangeEl = document.getElementById('periodRange');
  const payrollEl = document.getElementById('nextPayroll');
  
  if (!period || !period.periodEnd) {
    if (rangeEl) rangeEl.textContent = 'No pay period data available';
    if (payrollEl) payrollEl.textContent = 'Upload OT data to see payroll info';
    return;
  }
  
  // Set period range
  if (rangeEl) {
    rangeEl.innerHTML = `<strong>CURRENT PAY PERIOD:</strong> ${period.periodStart} - ${period.periodEnd}`;
  }
  
  // Set payroll countdown
  if (payrollEl && period.nextPayrollDate) {
    let urgencyText = '';
    let urgencyClass = '';
    
    if (period.daysUntilPayroll === 0) {
      urgencyText = '<strong>(Today!)</strong>';
      urgencyClass = 'today';
    } else if (period.daysUntilPayroll === 1) {
      urgencyText = '<strong>(Tomorrow!)</strong>';
      urgencyClass = 'urgent';
    } else if (period.daysUntilPayroll <= 3) {
      urgencyText = `<strong>(In ${period.daysUntilPayroll} days)</strong>`;
      urgencyClass = 'urgent';
    } else {
      urgencyText = `(In ${period.daysUntilPayroll} days)`;
    }
    
    payrollEl.innerHTML = `Next Payroll: <strong>${period.nextPayrollDate}</strong> ${urgencyText}`;
    
    // Update bar styling
    if (bar) {
      bar.classList.remove('urgent', 'today');
      if (urgencyClass) bar.classList.add(urgencyClass);
    }
  }
}

/**
 * Render metric cards
 */
function renderMetricCards(otMetrics, uniformMetrics, ptoMetrics, alerts) {
  // OT Hours
  const otHoursEl = document.getElementById('metricOTHours');
  const otChangeEl = document.getElementById('otChange');
  if (otHoursEl) {
    otHoursEl.textContent = otMetrics.latestPeriodHours.toFixed(1) + ' hrs';
  }
  if (otChangeEl && otMetrics.percentChange !== 0) {
    const isUp = otMetrics.percentChange > 0;
    otChangeEl.textContent = (isUp ? '‚Üë' : '‚Üì') + Math.abs(otMetrics.percentChange) + '%';
    otChangeEl.className = 'metric-change ' + (isUp ? 'up' : 'down');
  } else if (otChangeEl) {
    otChangeEl.textContent = '';
    otChangeEl.className = 'metric-change';
  }
  
  // Uniform Deductions
  const uniformEl = document.getElementById('metricUniformDeductions');
  if (uniformEl) {
    uniformEl.textContent = '$' + uniformMetrics.nextPaycheckDeductions.toFixed(2);
  }
  
  // PTO Pending
  const ptoEl = document.getElementById('metricPTOPending');
  const ptoSublabel = document.getElementById('ptoHoursSublabel');
  if (ptoEl) {
    ptoEl.textContent = ptoMetrics.pendingCount + ' requests';
  }
  if (ptoSublabel) {
    if (ptoMetrics.unpaidHoursTotal > 0) {
      ptoSublabel.textContent = ptoMetrics.unpaidHoursTotal + ' hours total';
    } else {
      ptoSublabel.textContent = 'No pending hours';
    }
  }
  
  // Alerts count
  const alertsEl = document.getElementById('metricAlerts');
  const alertsCard = document.getElementById('alertsMetricCard');
  if (alertsEl) {
    const alertCount = alerts ? alerts.length : 0;
    alertsEl.textContent = alertCount;
    
    // Add urgency styling if alerts exist
    if (alertsCard) {
      if (alertCount > 0) {
        alertsCard.classList.add('has-alerts');
      } else {
        alertsCard.classList.remove('has-alerts');
      }
    }
  }
}

/**
 * Render action items
 */
function renderActionItems(items) {
  const container = document.getElementById('actionItemsList');
  if (!container) return;
  
  if (!items || items.length === 0) {
    container.innerHTML = `
      <div class="action-item">
        <span class="material-icons-round" style="color: #059669;">check_circle</span>
        <span class="action-item-text">All caught up! No action items.</span>
      </div>
    `;
    return;
  }
  
  container.innerHTML = items.map((item, index) => `
    <div class="action-item ${item.urgent ? 'urgent' : ''}" data-action="${item.action || ''}" onclick="handleActionItemClick(this, '${item.action}')">
      <div class="action-item-checkbox" onclick="event.stopPropagation(); toggleActionItem(this)">
        <span class="material-icons-round" style="display: none;">check</span>
      </div>
      <span class="action-item-text">${item.description}</span>
      ${item.action ? '<span class="material-icons-round action-item-arrow">chevron_right</span>' : ''}
    </div>
  `).join('');
}

/**
 * Toggle action item checkbox
 */
function toggleActionItem(checkbox) {
  checkbox.classList.toggle('checked');
  const icon = checkbox.querySelector('.material-icons-round');
  if (icon) {
    icon.style.display = checkbox.classList.contains('checked') ? 'block' : 'none';
  }
  checkbox.closest('.action-item').classList.toggle('completed');
}

/**
 * Handle action item click
 */
function handleActionItemClick(element, action) {
  if (action && typeof navigateTo === 'function') {
    navigateTo(action);
  }
}

/**
 * Render top OT employees
 */
function renderTopOTEmployees(employees) {
  const container = document.getElementById('topOTList');
  if (!container) return;
  
  if (!employees || employees.length === 0) {
    container.innerHTML = `
      <div class="empty-state small">
        <span class="material-icons-round">people</span>
        <p>No OT data available</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = employees.map((emp, index) => `
    <div class="top-ot-item" onclick="searchEmployee('${emp.name.replace(/'/g, "\\'")}')">
      <div class="top-ot-rank">${index + 1}</div>
      <div class="top-ot-name">${emp.name}</div>
      <div class="top-ot-hours">${emp.hours.toFixed(1)} hrs</div>
      <span class="flag ${emp.flag === 'Really High' ? 'high' : emp.flag === 'Moderate' ? 'moderate' : 'normal'}">${emp.flag}</span>
    </div>
  `).join('');
}

/**
 * Search for an employee from dashboard
 */
function searchEmployee(name) {
  navigateTo('ot-employee');
  // Set search value after navigation
  setTimeout(() => {
    const searchInput = document.getElementById('employeeSearch');
    if (searchInput) {
      searchInput.value = name;
      loadEmployeeData(name);
    }
  }, 500);
}

/**
 * Render upcoming uniform payments
 */
function renderUpcomingPayments(payments) {
  const container = document.getElementById('upcomingPaymentsList');
  if (!container) return;
  
  if (!payments || payments.length === 0) {
    container.innerHTML = `
      <div class="empty-state small">
        <span class="material-icons-round">event_available</span>
        <p>No upcoming uniform payments</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = payments.map(payment => `
    <div class="payment-item" onclick="navigateTo('uniforms-deductions')">
      <div class="payment-date">${payment.date}</div>
      <div class="payment-details">${payment.employeeCount} employee${payment.employeeCount !== 1 ? 's' : ''}</div>
      <div class="payment-amount">$${payment.amount.toFixed(2)}</div>
    </div>
  `).join('');
}

/**
 * Render alerts list
 */
function renderAlertsList(alerts) {
  const container = document.getElementById('alertsList');
  if (!container) return;
  
  if (!alerts || alerts.length === 0) {
    container.innerHTML = `
      <div class="empty-state small">
        <span class="material-icons-round" style="color: #059669;">check_circle</span>
        <p>No active alerts</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = alerts.map(alert => {
    // Determine navigation action based on alert type
    let navAction = 'ot-trends'; // default
    if (alert.type === 'high_ot' || alert.type === 'rising_trend') {
      navAction = 'ot-trends';
    } else if (alert.type === 'uniform_due' || alert.type === 'uniform_deductions') {
      navAction = 'uniforms-deductions';
    } else if (alert.type === 'pto_pending') {
      navAction = 'pto-records';
    } else if (alert.type === 'payroll_urgent' || alert.type === 'payroll') {
      navAction = 'payroll-processing';
    }
    
    return `
      <div class="alert-item ${alert.severity || 'warning'}" onclick="navigateTo('${navAction}')">
      <span class="material-icons-round">${alert.severity === 'error' ? 'error' : 'warning'}</span>
      <div class="alert-content">
        <div class="alert-title">${alert.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
        <div class="alert-message">${alert.message}</div>
      </div>
    </div>
    `;
  }).join('');
}

/**
 * Update last updated text
 */
function updateLastUpdated(timestamp) {
  const el = document.getElementById('lastUpdatedText');
  if (!el) return;
  
  if (timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) {
      el.textContent = 'Last updated: Just now';
    } else if (diffMins === 1) {
      el.textContent = 'Last updated: 1 minute ago';
    } else if (diffMins < 60) {
      el.textContent = `Last updated: ${diffMins} minutes ago`;
    } else {
      el.textContent = `Last updated: ${date.toLocaleTimeString()}`;
    }
  } else {
    el.textContent = 'Last updated: --';
  }
}

/**
 * Scroll to alerts section
 */
function scrollToAlerts() {
  const alertsSection = document.getElementById('alertsSection');
  if (alertsSection) {
    alertsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

/**
 * Initialize OT Upload view with dynamic locations
 */
function initUploadTab() {
  console.log('initUploadTab called');
  
  // First, load locations from backend
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('getActiveLocations returned:', result);
      
      // Ensure we have a valid locations array
      var locations = result || [{ id: 'location1', name: 'Location 1' }];
      if (!Array.isArray(locations) || locations.length === 0) {
        locations = [{ id: 'location1', name: 'Location 1' }];
      }
      
      // Store locations in AppState
      AppState.locations = locations;
      
      // Initialize uploadedData with dynamic keys
      AppState.uploadedData = {};
      locations.forEach(function(loc) {
        AppState.uploadedData[loc.id] = null;
      });
      
      // Generate upload cards dynamically
      generateUploadCards(locations);
      
      // Update multi-location table headers
      updateMultiLocationHeaders(locations);
      
      // Setup buttons
      var processBtn = document.getElementById('processBtn');
      if (processBtn) {
        processBtn.addEventListener('click', processUploadedData);
      }
      
      var saveBtn = document.getElementById('saveBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', saveToHistory);
      }
      
      var clearBtn = document.getElementById('clearDataBtn');
      if (clearBtn) {
        clearBtn.addEventListener('click', clearUploadedData);
      }
      
      console.log('OT Upload initialized with', locations.length, 'locations');
    })
    .withFailureHandler(function(error) {
      console.error('Failed to load locations:', error);
      showToast('Failed to load location settings', 'error');
      
      // Fallback: create default upload cards
      var defaultLocations = [{ id: 'location1', name: 'Location 1' }];
      AppState.locations = defaultLocations;
      AppState.uploadedData = { location1: null };
      generateUploadCards(defaultLocations);
    })
    .getActiveLocations();
}

/**
 * Generate upload cards dynamically based on configured locations
 */
function generateUploadCards(locations) {
  const container = document.getElementById('uploadCardsContainer');
  if (!container) return;
  
  container.innerHTML = '';
  
  locations.forEach(function(loc, index) {
    const cardId = 'upload_' + loc.id;
    const inputId = 'fileInput_' + loc.id;
    
    const card = document.createElement('div');
    card.className = 'upload-card';
    card.id = cardId;
    card.innerHTML = [
      '<span class="location-tag">Location ' + (index + 1) + '</span>',
      '<span class="material-icons-round">upload_file</span>',
      '<h3>' + escapeHtml(loc.name) + '</h3>',
      '<p>Drop CSV or click to upload</p>',
      '<input type="file" id="' + inputId + '" accept=".csv">'
    ].join('');
    
    container.appendChild(card);
    
    // Setup the upload handler for this card
    setupDynamicUploadCard(cardId, inputId, loc);
  });
}

/**
 * Setup upload handler for a dynamically created card
 */
function setupDynamicUploadCard(cardId, inputId, location) {
  const card = document.getElementById(cardId);
  const input = document.getElementById(inputId);
  
  if (!card || !input) return;
  
  // Click handler
  card.addEventListener('click', function(e) {
    if (e.target !== input) {
      input.click();
    }
  });
  
  // File input change
  input.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      handleDynamicFileUpload(e.target.files[0], location, cardId);
    }
  });
  
  // Drag and drop
  card.addEventListener('dragover', function(e) {
    e.preventDefault();
    card.classList.add('dragover');
  });
  
  card.addEventListener('dragleave', function() {
    card.classList.remove('dragover');
  });
  
  card.addEventListener('drop', function(e) {
    e.preventDefault();
    card.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      handleDynamicFileUpload(e.dataTransfer.files[0], location, cardId);
    }
  });
}

/**
 * Handle file upload for dynamic locations
 */
function handleDynamicFileUpload(file, location, cardId) {
  if (!file.name.endsWith('.csv')) {
    showToast('Please upload a CSV file', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const result = parseCSV(e.target.result, location.name);
    if (result.success) {
      AppState.uploadedData[location.id] = result;
      updateUploadCard(cardId, file.name, result.employeeCount);
      showToast('Loaded ' + result.employeeCount + ' employees from ' + location.name, 'success');
      updateProcessButton();
    } else {
      showToast(result.error, 'error');
    }
  };
  reader.readAsText(file);
}

/**
 * Update multi-location table headers based on configured locations
 */
function updateMultiLocationHeaders(locations) {
  // Update multi-location table header
  const multiHead = document.getElementById('multiTableHead');
  if (multiHead && locations.length > 0) {
    let headerHtml = '<tr><th>Employee</th>';
    locations.forEach(function(loc) {
      headerHtml += '<th class="numeric">' + escapeHtml(loc.name) + '</th>';
    });
    headerHtml += '<th class="numeric">Total Hrs</th>';
    headerHtml += '<th class="numeric">Regular</th>';
    headerHtml += '<th class="numeric">OT</th>';
    headerHtml += '<th>Status</th></tr>';
    multiHead.innerHTML = headerHtml;
  }
}

/**
 * Initialize OT History view
 */
function initHistoryTab() {
  showLoading(true);
  loadSettings(function() {
    // Update location column headers based on settings
    const s = AppState.settings || {};
    const loc1Header = document.getElementById('loc1HoursHeader');
    const loc2Header = document.getElementById('loc2HoursHeader');
    if (loc1Header) loc1Header.textContent = (s.location1Name || 'Loc 1').substring(0, 10) + ' Hrs';
    if (loc2Header) loc2Header.textContent = (s.location2Name || 'Loc 2').substring(0, 10) + ' Hrs';
    
    // Load periods from server
    google.script.run
      .withSuccessHandler(function(periods) {
        AppState.periods = periods || [];
        
        const select = document.getElementById('periodSelect');
        if (select) {
          select.innerHTML = '<option value="">Select a pay period...</option>';
          periods.forEach(period => {
            const opt = document.createElement('option');
            opt.value = new Date(period).toISOString();
            opt.textContent = formatDate(period);
            select.appendChild(opt);
          });
          
          select.addEventListener('change', function() {
            if (this.value) loadPeriodData();
          });
        }
        showLoading(false);
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showToast('Error loading periods: ' + error.message, 'error');
      })
      .getPayPeriods();
  });
}

/**
 * Initialize OT Employee Lookup view
 */
function initEmployeeTab() {
  showLoading(true);
  loadSettings(function() {
    // Load employee names for autocomplete
    google.script.run
      .withSuccessHandler(function(names) {
        const datalist = document.getElementById('employeeList');
        if (datalist) {
          datalist.innerHTML = '';
          (names || []).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            datalist.appendChild(opt);
          });
        }
        
        // Setup search handler
        const searchInput = document.getElementById('employeeSearch');
        if (searchInput) {
          searchInput.addEventListener('input', debounce(function() {
            const name = this.value.trim();
            if (name.length >= 2) {
              loadEmployeeData(name);
            }
          }, 300));
        }
        
        showLoading(false);
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        console.error('Error loading employee names:', error);
      })
      .getAllEmployeeNames();
  });
}

/**
 * Initialize OT Trends view
 */
function initTrendsTab() {
  showLoading(true);
  loadSettings(function() {
    // Load periods first
    google.script.run
      .withSuccessHandler(function(periods) {
        AppState.periods = periods || [];
        
        // Populate transfer month selector
        const monthSelect = document.getElementById('transferMonthSelect');
        if (monthSelect) {
          monthSelect.innerHTML = '<option value="">Select Month...</option>';
          
          const months = new Set();
          periods.forEach(period => {
            const date = new Date(period);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            months.add(monthKey);
          });
          
          Array.from(months).sort().reverse().forEach(month => {
            const [year, mon] = month.split('-');
            const date = new Date(year, mon - 1);
            const label = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const opt = document.createElement('option');
            opt.value = month;
            opt.textContent = label;
            monthSelect.appendChild(opt);
          });
        }
        
        // Setup trend range handler
        const trendRange = document.getElementById('trendRange');
        if (trendRange) {
          trendRange.addEventListener('change', function() {
            loadTrendData();
          });
        }
        
        // Load initial trends data
        loadTrendData();
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showToast('Error loading periods: ' + error.message, 'error');
      })
      .getPayPeriods();
  });
}

/**
 * Initialize Uniform Orders view
 */
function initUniformOrdersView() {
  showLoading(true);
  loadSettings(function() {
    // Populate location dropdowns from settings
    populateLocationDropdowns(['uniformLocation', 'orderLocationFilter']);
    loadUniformsTab();
  });
}

/**
 * Populate location dropdown(s) with configured locations from backend
 * Now uses getActiveLocations() directly for consistency with employee forms
 * @param {Array} dropdownIds - Array of dropdown element IDs to populate
 */
function populateLocationDropdowns(dropdownIds) {
  console.log('populateLocationDropdowns called for:', dropdownIds);
  
  // Fetch locations directly from backend (same as employee forms)
  google.script.run
    .withSuccessHandler(function(locations) {
      console.log('Locations loaded for dropdowns:', locations);
      
      // Ensure we have valid locations
      if (!locations || !Array.isArray(locations) || locations.length === 0) {
        locations = [{ id: 'location1', name: 'Location 1' }];
      }
      
      // Extract location names
      var locationNames = locations.map(function(loc) {
        return loc.name || loc;
      });
      
      dropdownIds.forEach(function(id) {
        var dropdown = document.getElementById(id);
        if (!dropdown) {
          console.log('Dropdown not found:', id);
          return;
        }
        
        // Preserve first option (placeholder or "All" option)
        var firstOption = dropdown.options[0];
        
        // Clear existing location options
        dropdown.innerHTML = '';
        
        // Re-add first option
        if (firstOption) {
          dropdown.appendChild(firstOption.cloneNode(true));
        }
        
        // Add location options
        locationNames.forEach(function(name) {
          var option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          dropdown.appendChild(option);
        });
        
        console.log('Dropdown', id, 'populated with', locationNames.length, 'locations');
      });
    })
    .withFailureHandler(function(error) {
      console.error('Failed to load locations for dropdowns:', error);
      // Fallback to settings if backend call fails
      var s = AppState.settings || {};
      var numLocs = parseInt(s.numberOfLocations) || 2;
      var locations = [];
      if (s.location1Name) locations.push(s.location1Name);
      if (numLocs >= 2 && s.location2Name) locations.push(s.location2Name);
      if (numLocs >= 3 && s.location3Name) locations.push(s.location3Name);
      if (locations.length === 0) locations.push('Location 1');
      
      dropdownIds.forEach(function(id) {
        var dropdown = document.getElementById(id);
        if (!dropdown) return;
        var firstOption = dropdown.options[0];
        dropdown.innerHTML = '';
        if (firstOption) dropdown.appendChild(firstOption.cloneNode(true));
        locations.forEach(function(loc) {
          var option = document.createElement('option');
          option.value = loc;
          option.textContent = loc;
          dropdown.appendChild(option);
        });
      });
    })
    .getActiveLocations();
}

/**
 * Initialize Uniform Deductions view
 */
function initUniformDeductionsView() {
  showLoading(true);
  loadSettings(function() {
    loadPaydays();
    showLoading(false);
  });
}

/**
 * Initialize Uniform Catalog view
 */
function initUniformCatalogView() {
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(items) {
      UniformState.catalog = items || [];
      
      // Extract and store categories in state (needed for Add Item modal)
      const categoriesList = [...new Set(items.map(item => item.category).filter(c => c))].sort();
      UniformState.categories = categoriesList;
      
      // Populate category filter
      const catFilter = document.getElementById('catalogCategoryFilter');
      if (catFilter) {
        catFilter.innerHTML = '<option value="">All Categories</option>';
        categoriesList.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          catFilter.appendChild(opt);
        });
      }
      
      // Update summary stats
      const total = items.length;
      const active = items.filter(i => i.active).length;
      const categoryCount = categoriesList.length;
      
      const totalEl = document.getElementById('totalItems');
      const activeEl = document.getElementById('activeItems');
      const catEl = document.getElementById('categoryCount');
      
      if (totalEl) totalEl.textContent = total;
      if (activeEl) activeEl.textContent = active;
      if (catEl) catEl.textContent = categoryCount;
      
      // Load catalog table
      loadCatalogTable();
      showLoading(false);
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error loading catalog: ' + error.message, 'error');
    })
    .getCatalogItems(false);
}

/**
 * Initialize Settings view
 */
function initSettingsTab() {
  // Force reload settings to get fresh data
  AppState.settings = null;
  
  loadSettings(function() {
    populateSettingsForm();
    setupNotificationToggle();
    loadActivityLog();
    loadBackupStatus(); // Load backup status (Chunk 20)
    checkWeeklySummaryStatus();
    loadManagerPasscode(); // Load the manager receiving passcode
    loadArchiveStatus(); // Load data archive status
    
    // Load employee management data
    loadEmployeesNeedingReview();
    loadEmployeeAuditLog();
  });
}

// ============================================================================
// EMPLOYEE MANAGEMENT FUNCTIONS
// ============================================================================

/**
 * Scan for potential duplicate employees
 */
function scanForDuplicates() {
  const container = document.getElementById('duplicatesList');
  if (!container) return;
  
  container.innerHTML = '<div class="empty-state-small"><span class="material-icons-round">hourglass_empty</span><p>Scanning...</p></div>';
  
  google.script.run
    .withSuccessHandler(function(duplicates) {
      renderDuplicatesList(duplicates);
    })
    .withFailureHandler(function(error) {
      container.innerHTML = '<div class="empty-state-small"><span class="material-icons-round">error</span><p>Error: ' + error.message + '</p></div>';
    })
    .scanForDuplicateEmployees();
}

/**
 * Render the duplicates list
 */
function renderDuplicatesList(duplicates) {
  const container = document.getElementById('duplicatesList');
  if (!container) return;
  
  if (!duplicates || duplicates.length === 0) {
    container.innerHTML = '<div class="empty-state-small"><span class="material-icons-round">check_circle</span><p>No potential duplicates found</p></div>';
    return;
  }
  
  let html = '';
  duplicates.forEach(function(pair) {
    html += 
      '<div class="duplicate-pair">' +
        '<div class="duplicate-info">' +
          '<strong>' + pair.employee1.fullName + '</strong>' +
          '<span class="vs">‚Üî</span>' +
          '<strong>' + pair.employee2.fullName + '</strong>' +
          '<span class="similarity-badge">' + pair.similarity + '% similar</span>' +
        '</div>' +
        '<button type="button" class="btn btn-outline btn-sm" onclick="showMergeModal(\'' + 
          pair.employee1.matchKey.replace(/'/g, "\\'") + '\', \'' + 
          pair.employee2.matchKey.replace(/'/g, "\\'") + '\')">' +
          'Review & Merge' +
        '</button>' +
      '</div>';
  });
  
  container.innerHTML = html;
}

/**
 * Load employees needing review
 */
function loadEmployeesNeedingReview() {
  const container = document.getElementById('employeesNeedingReview');
  console.log('loadEmployeesNeedingReview called, container:', container ? 'found' : 'NOT FOUND');
  if (!container) return;
  
  // First check code version to verify deployment
  google.script.run
    .withSuccessHandler(function(version) {
      console.log('Backend code version:', version);
    })
    .withFailureHandler(function(e) {
      console.log('Could not get code version (function may not exist in deployed version)');
    })
    .getCodeVersion();
  
  // Show loading state
  container.innerHTML = '<div class="empty-state-small"><span class="material-icons-round">hourglass_empty</span><p>Loading...</p></div>';
  
  // Try the new function name first (bypasses caching), fall back to old name
  google.script.run
    .withSuccessHandler(function(employees) {
      console.log('fetchEmployeesForReview returned:', employees);
      console.log('Employee count:', employees ? employees.length : 0);
      if (employees === null) {
        console.error('WARNING: Function returned null - trying fallback');
        // Try the original function name as fallback
        google.script.run
          .withSuccessHandler(function(emp2) {
            console.log('Fallback getEmployeesNeedingReview returned:', emp2);
            renderEmployeesNeedingReview(emp2);
          })
          .withFailureHandler(function(err) {
            console.error('Fallback also failed:', err);
            container.innerHTML = '<div class="empty-state-small" style="color: #E51636;"><span class="material-icons-round">error</span><p>Could not load employees. Please redeploy the web app.</p></div>';
          })
          .getEmployeesNeedingReview();
      } else {
        renderEmployeesNeedingReview(employees);
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error loading employees for review:', error);
      // Function might not exist in old deployment, try original name
      google.script.run
        .withSuccessHandler(function(employees) {
          console.log('Fallback getEmployeesNeedingReview returned:', employees);
          renderEmployeesNeedingReview(employees);
        })
        .withFailureHandler(function(err2) {
          container.innerHTML = '<div class="empty-state-small" style="color: #E51636;"><span class="material-icons-round">error</span><p>Error loading: ' + err2.message + '</p></div>';
        })
        .getEmployeesNeedingReview();
    })
    .fetchEmployeesForReview();
}

/**
 * Render employees needing review
 */
function renderEmployeesNeedingReview(employees) {
  const container = document.getElementById('employeesNeedingReview');
  if (!container) return;
  
  if (!employees || employees.length === 0) {
    container.innerHTML = '<div class="empty-state-small"><span class="material-icons-round">check_circle</span><p>No employees pending review</p></div>';
    return;
  }
  
  let html = '';
  employees.forEach(function(emp) {
    const dateStr = emp.timestamp ? new Date(emp.timestamp).toLocaleDateString() : '';
    html += 
      '<div class="review-item">' +
        '<div class="review-item-info">' +
          '<div class="review-item-name">' + emp.fullName + '</div>' +
          '<div class="review-item-meta">' + emp.location + ' ‚Ä¢ Created by ' + emp.createdBy + ' on ' + dateStr + '</div>' +
          (emp.similarWarnings ? '<div class="review-item-warning">Similar to: ' + emp.similarWarnings + '</div>' : '') +
        '</div>' +
        '<button type="button" class="btn btn-outline btn-sm" onclick="markEmployeeReviewed(' + emp.rowIndex + ')">' +
          '<span class="material-icons-round" style="font-size: 16px;">check</span>' +
          'Mark OK' +
        '</button>' +
      '</div>';
  });
  
  container.innerHTML = html;
}

/**
 * Mark an employee as reviewed
 */
function markEmployeeReviewed(rowIndex) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Employee marked as reviewed', 'success');
        loadEmployeesNeedingReview();
        loadEmployeeAuditLog();
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('Error: ' + error.message, 'error');
    })
    .markEmployeeReviewed(rowIndex);
}

/**
 * Load employee audit log
 */
function loadEmployeeAuditLog() {
  const container = document.getElementById('employeeAuditLog');
  if (!container) return;
  
  google.script.run
    .withSuccessHandler(function(entries) {
      renderEmployeeAuditLog(entries);
    })
    .withFailureHandler(function(error) {
      console.error('Error loading audit log:', error);
    })
    .getEmployeeAuditLog(30);
}

/**
 * Render employee audit log
 */
function renderEmployeeAuditLog(entries) {
  const container = document.getElementById('employeeAuditLog');
  if (!container) return;
  
  if (!entries || entries.length === 0) {
    container.innerHTML = '<div class="empty-state-small"><span class="material-icons-round">history</span><p>No recent employee additions</p></div>';
    return;
  }
  
  let html = '<table><thead><tr><th>Date</th><th>Employee</th><th>Method</th><th>Created By</th></tr></thead><tbody>';
  
  entries.forEach(function(entry) {
    const dateStr = entry.timestamp ? new Date(entry.timestamp).toLocaleDateString() : '';
    const methodClass = entry.creationMethod === 'OT Upload' ? 'ot-upload' : 
                        entry.creationMethod === 'Uniform Order' ? 'uniform-order' : 
                        entry.creationMethod === 'Merge' ? 'merge' : '';
    
    html += 
      '<tr>' +
        '<td>' + dateStr + '</td>' +
        '<td><strong>' + entry.fullName + '</strong></td>' +
        '<td><span class="method-badge ' + methodClass + '">' + entry.creationMethod + '</span></td>' +
        '<td>' + (entry.createdBy || '-') + '</td>' +
      '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

/**
 * Show the merge modal
 */
function showMergeModal(sourceKey, targetKey) {
  // Get merge preview
  google.script.run
    .withSuccessHandler(function(preview) {
      if (!preview.success) {
        showToast('Error: ' + preview.error, 'error');
        return;
      }
      
      // Populate modal
      document.getElementById('mergeSourceKey').value = sourceKey;
      document.getElementById('mergeTargetKey').value = targetKey;
      document.getElementById('mergeSourceName').textContent = preview.source.fullName;
      document.getElementById('mergeTargetName').textContent = preview.target.fullName;
      document.getElementById('keepTargetLabel').textContent = preview.target.fullName + ' (recommended)';
      document.getElementById('keepSourceLabel').textContent = preview.source.fullName;
      
      document.getElementById('mergeImpact').innerHTML = 
        '<ul>' +
          '<li>' + preview.uniformOrdersAffected + ' uniform order(s) will be updated</li>' +
          '<li>' + preview.ptoRecordsAffected + ' PTO record(s) will be updated</li>' +
          '<li>' + preview.otHistoryAffected + ' OT history record(s) will be updated</li>' +
        '</ul>';
      
      // Show modal
      document.getElementById('mergeEmployeeModal').style.display = 'flex';
    })
    .withFailureHandler(function(error) {
      showToast('Error loading merge preview: ' + error.message, 'error');
    })
    .getMergePreview(sourceKey, targetKey);
}

/**
 * Close merge modal
 */
function closeMergeModal() {
  document.getElementById('mergeEmployeeModal').style.display = 'none';
}

/**
 * Execute the employee merge
 */
function executeMerge() {
  const sourceKey = document.getElementById('mergeSourceKey').value;
  const targetKey = document.getElementById('mergeTargetKey').value;
  const keepName = document.querySelector('input[name="mergeKeepName"]:checked').value;
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Employees merged successfully! ' + result.uniformOrdersUpdated + ' orders, ' + 
                  result.ptoRecordsUpdated + ' PTO, ' + result.otHistoryUpdated + ' OT records updated.', 'success');
        closeMergeModal();
        scanForDuplicates();
        loadEmployeeAuditLog();
      } else {
        showToast('Merge failed: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .mergeEmployees(sourceKey, targetKey, keepName);
}

/**
 * Populate the settings form with current values
 */
function populateSettingsForm() {
    const s = AppState.settings || {};
    
  // Cost Settings
    const wage = document.getElementById('settingWage');
    const mult = document.getElementById('settingMultiplier');
  if (wage) wage.value = s.hourlyWage || 16.5;
  if (mult) mult.value = s.otMultiplier || 1.5;
  
  // Location Settings
  const numLocs = document.getElementById('settingNumLocations');
    const loc1 = document.getElementById('settingLoc1');
    const loc2 = document.getElementById('settingLoc2');
  const loc3 = document.getElementById('settingLoc3');
  if (numLocs) numLocs.value = s.numberOfLocations || 2;
  if (loc1) loc1.value = s.location1Name || 'Cockrell Hill DTO';
  if (loc2) loc2.value = s.location2Name || 'DBU';
  if (loc3) loc3.value = s.location3Name || '';
  
  // Update visibility of location fields based on count
  updateLocationFieldsVisibility();
  
  // OT Thresholds
  const mod = document.getElementById('settingModerate');
  const high = document.getElementById('settingHigh');
  const reallyHigh = document.getElementById('settingReallyHigh');
    if (mod) mod.value = s.moderateThreshold || 5;
    if (high) high.value = s.highThreshold || 10;
  if (reallyHigh) reallyHigh.value = s.reallyHighThreshold || 15;
  
  // Alert Thresholds
  const ptoThreshold = document.getElementById('settingPTOThreshold');
  const payrollUrgency = document.getElementById('settingPayrollUrgency');
  if (ptoThreshold) ptoThreshold.value = s.pendingPTOAlertThreshold || 5;
  if (payrollUrgency) payrollUrgency.value = s.payrollUrgencyDays || 2;
  
  // Notification Settings
  const notifEnabled = document.getElementById('notificationsEnabled');
  const adminEmails = document.getElementById('adminEmails');
  const notifyPTO = document.getElementById('notifyPTO');
  const notifyHighOT = document.getElementById('notifyHighOT');
  const notifyPayroll = document.getElementById('notifyPayroll');
  const notifyUniform = document.getElementById('notifyUniform');
  
  if (notifEnabled) notifEnabled.checked = s.notificationsEnabled === true;
  if (adminEmails) adminEmails.value = s.adminEmails || '';
  if (notifyPTO) notifyPTO.checked = s.notifyOnPTORequest !== false;
  if (notifyHighOT) notifyHighOT.checked = s.notifyOnHighOT !== false;
  if (notifyPayroll) notifyPayroll.checked = s.notifyOnPayrollDue !== false;
  if (notifyUniform) notifyUniform.checked = s.notifyOnUniformOrder === true;
  
  // Update notification UI state
  updateNotificationUIState();
}

/**
 * Setup notification toggle behavior
 */
function setupNotificationToggle() {
  const toggle = document.getElementById('notificationsEnabled');
  if (toggle) {
    toggle.addEventListener('change', function() {
      updateNotificationUIState();
    });
  }
}

/**
 * Update notification settings UI based on enabled state
 */
function updateNotificationUIState() {
  const toggle = document.getElementById('notificationsEnabled');
  const label = document.getElementById('notificationsLabel');
  const settingsSection = document.getElementById('notificationSettings');
  
  if (toggle && label) {
    label.textContent = toggle.checked ? 'Enabled' : 'Disabled';
    label.style.color = toggle.checked ? 'var(--success)' : 'var(--gray-500)';
  }
  
  if (settingsSection) {
    settingsSection.classList.toggle('disabled', !toggle?.checked);
  }
}

/**
 * Update location field visibility based on number of locations selected
 */
function updateLocationFieldsVisibility() {
  const numLocs = parseInt(document.getElementById('settingNumLocations')?.value) || 2;
  
  const loc1Group = document.getElementById('location1Group');
  const loc2Group = document.getElementById('location2Group');
  const loc3Group = document.getElementById('location3Group');
  
  // Location 1 is always visible
  if (loc1Group) loc1Group.style.display = 'block';
  
  // Location 2 visible if 2+ locations
  if (loc2Group) {
    loc2Group.style.display = numLocs >= 2 ? 'block' : 'none';
  }
  
  // Location 3 visible if 3 locations
  if (loc3Group) {
    loc3Group.style.display = numLocs >= 3 ? 'block' : 'none';
  }
}

/**
 * Save all settings
 */
function saveAllSettings(event) {
  if (event) event.preventDefault();
  
  showLoading(true);
  
  const settings = {
    // Cost Settings
    hourlyWage: parseFloat(document.getElementById('settingWage')?.value) || 16.5,
    otMultiplier: parseFloat(document.getElementById('settingMultiplier')?.value) || 1.5,
    
    // Location Settings
    numberOfLocations: parseInt(document.getElementById('settingNumLocations')?.value) || 2,
    location1Name: document.getElementById('settingLoc1')?.value || 'Cockrell Hill DTO',
    location2Name: document.getElementById('settingLoc2')?.value || 'DBU',
    location3Name: document.getElementById('settingLoc3')?.value || '',
    
    // OT Thresholds
    moderateThreshold: parseInt(document.getElementById('settingModerate')?.value) || 5,
    highThreshold: parseInt(document.getElementById('settingHigh')?.value) || 10,
    reallyHighThreshold: parseInt(document.getElementById('settingReallyHigh')?.value) || 15,
    
    // Alert Thresholds
    pendingPTOAlertThreshold: parseInt(document.getElementById('settingPTOThreshold')?.value) || 5,
    payrollUrgencyDays: parseInt(document.getElementById('settingPayrollUrgency')?.value) || 2,
    
    // Notification Settings
    notificationsEnabled: document.getElementById('notificationsEnabled')?.checked || false,
    adminEmails: document.getElementById('adminEmails')?.value || '',
    notifyOnPTORequest: document.getElementById('notifyPTO')?.checked || false,
    notifyOnHighOT: document.getElementById('notifyHighOT')?.checked || false,
    notifyOnPayrollDue: document.getElementById('notifyPayroll')?.checked || false,
    notifyOnUniformOrder: document.getElementById('notifyUniform')?.checked || false
  };
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Settings saved successfully!', 'success');
        // Update local state
        AppState.settings = { ...AppState.settings, ...settings };
        CONFIG.MODERATE_THRESHOLD = settings.moderateThreshold;
        CONFIG.HIGH_THRESHOLD = settings.highThreshold;
      } else {
        showToast(result.error || 'Failed to save settings', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error saving settings: ' + error.message, 'error');
    })
    .saveSettings(settings);
}

// =====================================================
// UNIFORM SIZE CONFIGURATION
// =====================================================

/**
 * Load size configuration into the settings form
 */
function loadSizeConfiguration() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success && result.config) {
        const c = result.config;
        
        // Female pants
        const femaleWaist = document.getElementById('sizeFemaleWaist');
        const femaleInseam = document.getElementById('sizeFemaleInseam');
        if (femaleWaist) femaleWaist.value = (c.pants_female_waist || []).join(', ');
        if (femaleInseam) femaleInseam.value = (c.pants_female_inseam || []).join(', ');
        
        // Male pants
        const maleWaist = document.getElementById('sizeMaleWaist');
        const maleInseam = document.getElementById('sizeMaleInseam');
        if (maleWaist) maleWaist.value = (c.pants_male_waist || []).join(', ');
        if (maleInseam) maleInseam.value = (c.pants_male_inseam || []).join(', ');
        
        // Shorts
        const shortsWaist = document.getElementById('sizeShortsWaist');
        const shortsInseam = document.getElementById('sizeShortsInseam');
        if (shortsWaist) shortsWaist.value = (c.shorts_waist || []).join(', ');
        if (shortsInseam) shortsInseam.value = (c.shorts_inseam || []).join(', ');
        
        // Store in AppState for use in uniform orders
        AppState.sizeConfig = c;
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error loading size configuration:', error);
    })
    .getSizeConfiguration();
}

/**
 * Save size configuration from the settings form
 */
function saveSizeConfig() {
  const statusEl = document.getElementById('sizeConfigStatus');
  
  // Parse comma-separated values into arrays
  function parseCommaList(inputId) {
    const el = document.getElementById(inputId);
    if (!el || !el.value) return [];
    return el.value.split(',').map(s => s.trim()).filter(s => s);
  }
  
  const config = {
    pants_female_waist: parseCommaList('sizeFemaleWaist'),
    pants_female_inseam: parseCommaList('sizeFemaleInseam'),
    pants_male_waist: parseCommaList('sizeMaleWaist'),
    pants_male_inseam: parseCommaList('sizeMaleInseam'),
    shorts_waist: parseCommaList('sizeShortsWaist'),
    shorts_inseam: parseCommaList('sizeShortsInseam')
  };
  
  // Validate - at least some sizes should be provided
  if (config.pants_male_waist.length === 0 && config.pants_female_waist.length === 0) {
    showToast('Please enter at least some waist sizes', 'error');
    return;
  }
  
  if (statusEl) statusEl.textContent = 'Saving...';
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Size configuration saved!', 'success');
        if (statusEl) statusEl.textContent = 'Saved ‚úì';
        // Update local state
        AppState.sizeConfig = config;
        setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 3000);
      } else {
        showToast(result.error || 'Failed to save size configuration', 'error');
        if (statusEl) statusEl.textContent = 'Error';
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error saving sizes: ' + error.message, 'error');
      if (statusEl) statusEl.textContent = 'Error';
    })
    .saveSizeConfiguration(config);
}

/**
 * Reset size configuration to defaults
 */
function resetSizeConfigToDefaults() {
  if (!confirm('Reset all pants/shorts sizes to defaults? This will overwrite your current settings.')) {
    return;
  }
  
  // Default values
  const defaults = {
    pants_male_waist: ['28', '30', '32', '34', '36', '38', '40', '42', '44', '46', '48', '50', '52', '54', '56', '58', '60'],
    pants_male_inseam: ['28', '30', '32', '34', '36'],
    pants_female_waist: ['00', '0', '2', '4', '6', '8', '10', '12', '14', '16', '18', '20', '22', '24', '26', '28', '30', '32', '34', '36'],
    pants_female_inseam: ['29', '31', '33', '35'],
    shorts_waist: ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL'],
    shorts_inseam: ['30', '32', '34']
  };
  
  // Populate the form fields
  document.getElementById('sizeFemaleWaist').value = defaults.pants_female_waist.join(', ');
  document.getElementById('sizeFemaleInseam').value = defaults.pants_female_inseam.join(', ');
  document.getElementById('sizeMaleWaist').value = defaults.pants_male_waist.join(', ');
  document.getElementById('sizeMaleInseam').value = defaults.pants_male_inseam.join(', ');
  document.getElementById('sizeShortsWaist').value = defaults.shorts_waist.join(', ');
  document.getElementById('sizeShortsInseam').value = defaults.shorts_inseam.join(', ');
  
  showToast('Defaults loaded - click "Save Size Configuration" to apply', 'info');
}

/**
 * Send test email notification
 */
function sendTestEmail() {
  const adminEmails = document.getElementById('adminEmails')?.value;
  
  if (!adminEmails || adminEmails.trim() === '') {
    showToast('Please enter an email address first', 'error');
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast(result.message || 'Test email sent!', 'success');
      } else {
        showToast(result.error || 'Failed to send test email', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .sendTestNotification();
}

// =====================================================
// WEEKLY SUMMARY FUNCTIONS
// =====================================================

/**
 * Check and display weekly summary status
 */
function checkWeeklySummaryStatus() {
  const statusEl = document.getElementById('weeklySummaryStatus');
  if (!statusEl) return;
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.active) {
        statusEl.textContent = '‚úì Active';
        statusEl.style.background = 'var(--success-light)';
        statusEl.style.color = 'var(--success)';
      } else {
        statusEl.textContent = 'Not Active';
        statusEl.style.background = 'var(--gray-200)';
        statusEl.style.color = 'var(--gray-600)';
      }
    })
    .withFailureHandler(function(error) {
      statusEl.textContent = 'Error';
      statusEl.style.background = 'var(--danger-light)';
      statusEl.style.color = 'var(--danger)';
    })
    .isWeeklySummaryTriggerActive();
}

/**
 * Enable weekly summary email trigger
 */
function setupWeeklySummary() {
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Weekly summary enabled! Emails will be sent every Saturday at 1 PM.', 'success');
        checkWeeklySummaryStatus();
      } else {
        showToast(result.error || 'Failed to enable weekly summary', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .setupWeeklySummaryTrigger();
}

/**
 * Disable weekly summary email trigger
 */
function disableWeeklySummary() {
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Weekly summary disabled.', 'success');
        checkWeeklySummaryStatus();
      } else {
        showToast('Failed to disable weekly summary', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .removeWeeklySummaryTrigger();
}

/**
 * Send weekly summary now (for testing)
 */
function testWeeklySummary() {
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        if (result.reason === 'No new requests') {
          showToast('No new PTO or Uniform requests this week - no email sent.', 'info');
        } else {
          showToast(`Weekly summary sent! (${result.ptoCount} PTO, ${result.uniformCount} Uniforms)`, 'success');
        }
      } else {
        showToast(result.reason || result.error || 'Failed to send summary', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .sendWeeklySummaryNow();
}

/**
 * Load and display activity log
 */
function loadActivityLog() {
  const container = document.getElementById('activityLogContainer');
  if (!container) return;
  
  google.script.run
    .withSuccessHandler(function(activities) {
      renderActivityLog(activities);
    })
    .withFailureHandler(function(error) {
      console.error('Error loading activity log:', error);
      container.innerHTML = `
        <div class="activity-empty">
          <span class="material-icons-round">error_outline</span>
          <p>Failed to load activity log</p>
        </div>
      `;
    })
    .getActivityLog(50);
}

/**
 * Refresh activity log
 */
function refreshActivityLog() {
  const container = document.getElementById('activityLogContainer');
  if (container) {
    container.innerHTML = `
      <div class="loading-placeholder">
        <span class="material-icons-round spin">sync</span>
        <span>Loading activity...</span>
      </div>
    `;
  }
  loadActivityLog();
}

/**
 * Render activity log entries
 */
function renderActivityLog(activities) {
  const container = document.getElementById('activityLogContainer');
  if (!container) return;
  
  if (!activities || activities.length === 0) {
    container.innerHTML = `
      <div class="activity-empty">
        <span class="material-icons-round">history</span>
        <p>No activity recorded yet</p>
        <small>Activities will appear here as you use the system</small>
      </div>
    `;
    return;
  }
  
  const categoryIcons = {
    'PTO': { icon: 'beach_access', class: 'pto' },
    'UNIFORM': { icon: 'checkroom', class: 'uniform' },
    'PAYROLL': { icon: 'payments', class: 'payroll' },
    'OT': { icon: 'schedule', class: 'ot' },
    'SETTINGS': { icon: 'settings', class: 'settings' }
  };
  
  const html = activities.map(activity => {
    const catInfo = categoryIcons[activity.category] || { icon: 'event_note', class: 'settings' };
    const timeAgo = getTimeAgo(new Date(activity.timestamp));
    const userName = activity.user ? activity.user.split('@')[0] : 'System';
    
    return `
      <div class="activity-item">
        <div class="activity-icon ${catInfo.class}">
          <span class="material-icons-round">${catInfo.icon}</span>
        </div>
        <div class="activity-content">
          <strong>${activity.action}</strong>
          <p>${activity.description}</p>
        </div>
        <div class="activity-meta">
          <div>${timeAgo}</div>
          <div style="font-size: 11px;">${userName}</div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

/**
 * Get time ago string from date
 */
function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

// =====================================================
// MANAGER RECEIVING PASSCODE FUNCTIONS
// =====================================================

/**
 * Load the current manager passcode (called when settings page loads)
 */
function loadManagerPasscode() {
  const displayInput = document.getElementById('currentPasscodeDisplay');
  if (!displayInput) return;
  
  google.script.run
    .withSuccessHandler(function(passcode) {
      displayInput.value = passcode || '03177';
    })
    .withFailureHandler(function(error) {
      console.error('Failed to load passcode:', error);
      displayInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    })
    .getManagerReceivingPasscode();
}

/**
 * Toggle passcode visibility
 */
function togglePasscodeVisibility() {
  const input = document.getElementById('currentPasscodeDisplay');
  const icon = document.getElementById('togglePasscodeIcon');
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.textContent = 'visibility_off';
  } else {
    input.type = 'password';
    icon.textContent = 'visibility';
  }
}

/**
 * Update the manager receiving passcode
 */
function updateManagerPasscode() {
  const input = document.getElementById('newPasscodeInput');
  const newPasscode = input.value.trim();
  
  if (!newPasscode) {
    showToast('Please enter a new passcode', 'error');
    return;
  }
  
  if (newPasscode.length < 4) {
    showToast('Passcode must be at least 4 characters', 'error');
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Passcode updated successfully!', 'success');
        document.getElementById('currentPasscodeDisplay').value = newPasscode;
        input.value = '';
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error updating passcode: ' + error.message, 'error');
    })
    .setManagerReceivingPasscode(newPasscode);
}

// =====================================================
// DATA BACKUP FUNCTIONS
// =====================================================

/**
 * Create a full backup
 */
function createBackup() {
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('Backup created successfully!', 'success');
        loadBackupHistory();
        
        // Open backup in new tab
        if (result.backupUrl) {
          window.open(result.backupUrl, '_blank');
        }
      } else {
        showToast(result.error || 'Failed to create backup', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .createBackup();
}

/**
 * Download data as JSON
 */
function downloadBackupJSON() {
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        // Create download link
        const blob = new Blob([result.data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `payroll_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('JSON export downloaded!', 'success');
      } else {
        showToast(result.error || 'Failed to export data', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .exportDataAsJSON();
}

// =====================================================
// CHUNK 20: DATA BACKUP FUNCTIONS
// =====================================================

/**
 * Load backup status and render UI
 */
function loadBackupStatus() {
  const badge = document.getElementById('backupBadge');
  const statusCard = document.getElementById('backupStatusCard');
  const statusIcon = document.getElementById('backupStatusIcon');
  const statusTitle = document.getElementById('backupStatusTitle');
  const statusMeta = document.getElementById('backupStatusMeta');
  const viewLink = document.getElementById('backupViewLink');
  const autoBackupStatus = document.getElementById('autoBackupStatus');
  
  google.script.run
    .withSuccessHandler(function(result) {
      // Update badge
      if (badge) {
        if (result.hasBackup) {
          badge.className = 'badge badge-success';
          badge.textContent = '‚úì Backed Up';
        } else {
          badge.className = 'badge';
          badge.textContent = 'No Backup';
        }
      }
      
      // Update status card
      if (statusCard && result.hasBackup) {
        statusCard.className = 'backup-status-card success';
        statusIcon.innerHTML = '<span class="material-icons-round">cloud_done</span>';
        statusTitle.textContent = 'Last Backup: ' + result.status;
        statusMeta.textContent = result.lastDate || '';
        
        if (viewLink && result.folderUrl) {
          viewLink.href = result.folderUrl;
          viewLink.style.display = 'inline-flex';
        }
      } else if (statusCard) {
        statusCard.className = 'backup-status-card';
        statusIcon.innerHTML = '<span class="material-icons-round">cloud_queue</span>';
        statusTitle.textContent = 'No backup yet';
        statusMeta.textContent = 'Run a backup to protect your data';
      }
      
      // Update auto-backup status
      if (autoBackupStatus) {
        if (result.autoBackupEnabled) {
          autoBackupStatus.className = 'auto-backup-status enabled';
          autoBackupStatus.innerHTML = `
            <span class="material-icons-round">check_circle</span>
            <span>Auto-backup is enabled (runs first Sunday of each month)</span>
            <button type="button" class="btn btn-outline btn-sm" onclick="toggleAutoBackup(false)" style="margin-left: auto;">
              <span class="material-icons-round">cancel</span> Disable
            </button>
          `;
        } else {
          autoBackupStatus.className = 'auto-backup-status disabled';
          autoBackupStatus.innerHTML = `
            <span class="material-icons-round">schedule</span>
            <span>Auto-backup is disabled</span>
            <button type="button" class="btn btn-primary btn-sm" onclick="toggleAutoBackup(true)" style="margin-left: auto;">
              <span class="material-icons-round">check_circle</span> Enable
            </button>
          `;
        }
      }
    })
    .withFailureHandler(function(error) {
      if (badge) {
        badge.className = 'badge';
        badge.textContent = 'Error';
      }
      if (statusTitle) {
        statusTitle.textContent = 'Could not load backup status';
      }
      console.error('Error loading backup status:', error);
    })
    .getBackupStatus();
}

/**
 * Run a manual backup
 */
function runBackupNow() {
  const btn = document.getElementById('runBackupBtn');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<span class="material-icons-round spin">sync</span> Running Backup...';
  }
  
  showToast('Starting backup... This may take a minute.', 'info');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons-round">backup</span> Run Backup Now';
      }
      
      if (result.success) {
        showToast('‚úÖ Backup completed! ' + result.filesCount + ' files backed up.', 'success');
        loadBackupStatus(); // Refresh the status
        
        // Open the backup folder
        if (result.folderUrl) {
          if (confirm('Backup complete! Would you like to view the backup folder?')) {
            window.open(result.folderUrl, '_blank');
          }
        }
      } else {
        showToast('‚ùå Backup failed: ' + (result.error || 'Unknown error'), 'error');
      }
    })
    .withFailureHandler(function(error) {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons-round">backup</span> Run Backup Now';
      }
      showToast('‚ùå Backup failed: ' + error, 'error');
    })
    .runManualBackup();
}

/**
 * Toggle auto-backup on/off
 */
function toggleAutoBackup(enable) {
  const autoBackupStatus = document.getElementById('autoBackupStatus');
  if (autoBackupStatus) {
    autoBackupStatus.innerHTML = '<span class="material-icons-round spin">sync</span> <span>Updating...</span>';
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast(result.message, 'success');
        loadBackupStatus(); // Refresh the status
      } else {
        showToast('Failed: ' + (result.error || 'Unknown error'), 'error');
        loadBackupStatus(); // Refresh anyway
      }
    })
    .withFailureHandler(function(error) {
      showToast('Error: ' + error, 'error');
      loadBackupStatus();
    })
    .toggleAutoBackup(enable);
}

// =====================================================
// PDF EXPORT FUNCTIONS
// =====================================================

/**
 * Export current report to PDF
 */
function exportToPDF(reportType, options = {}) {
  showLoading(true);
  showToast('Generating PDF...', 'info');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('PDF generated! Opening...', 'success');
        
        // Open PDF in new tab
        if (result.fileUrl) {
          window.open(result.fileUrl, '_blank');
        }
      } else {
        showToast(result.error || 'Failed to generate PDF', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .generatePDFReport(reportType, options);
}

/**
 * Helper: Load settings with callback
 */
function loadSettings(callback) {
  if (AppState.settings) {
    if (callback) callback();
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(settings) {
      // Handle null/undefined settings gracefully
      const s = settings || {};
      AppState.settings = s;
      CONFIG.MODERATE_THRESHOLD = s.moderateThreshold || 5;
      CONFIG.HIGH_THRESHOLD = s.highThreshold || 10;
      if (callback) callback();
    })
    .withFailureHandler(function(error) {
      console.error('Failed to load settings:', error);
      AppState.settings = {};
      if (callback) callback();
    })
    .getSettings();
}

// =====================================================
// DATA ARCHIVE FUNCTIONS
// =====================================================

/**
 * Load archive status on settings page
 */
function loadArchiveStatus() {
  const statusEl = document.getElementById('archiveStatus');
  const badgeEl = document.getElementById('archiveBadge');
  const controlsEl = document.getElementById('archiveTriggerControls');
  
  if (!statusEl || !badgeEl) return;
  
  google.script.run
    .withSuccessHandler(function(status) {
      if (status.annualArchiveActive) {
        badgeEl.textContent = '‚úì Auto-Archive Active';
        badgeEl.className = 'badge badge-success';
        statusEl.innerHTML = '<div class="archive-stat"><span class="material-icons-round" style="color: var(--success);">check_circle</span><span>Annual archive is scheduled for January 1st</span></div>';
        if (controlsEl) {
          controlsEl.innerHTML = '<button type="button" class="btn btn-outline btn-sm" onclick="toggleArchiveTrigger()" style="color: var(--danger);"><span class="material-icons-round">schedule_off</span> Disable Auto-Archive</button>';
        }
      } else {
        badgeEl.textContent = 'Not Configured';
        badgeEl.className = 'badge';
        statusEl.innerHTML = '<div class="archive-stat"><span class="material-icons-round" style="color: var(--gray-400);">schedule</span><span>No automatic archive scheduled</span></div>';
        if (controlsEl) {
          controlsEl.innerHTML = '<button type="button" class="btn btn-outline btn-sm" onclick="toggleArchiveTrigger()"><span class="material-icons-round">schedule</span> Enable Auto-Archive</button>';
        }
      }
    })
    .withFailureHandler(function(error) {
      badgeEl.textContent = 'Error';
      badgeEl.className = 'badge';
      statusEl.innerHTML = '<div class="archive-stat"><span class="material-icons-round" style="color: var(--danger);">error</span><span>Could not check status</span></div>';
    })
    .getArchiveTriggerStatus();
}

/**
 * Preview what would be archived (dry run)
 */
function previewArchive() {
  showLoading(true, 'Previewing archive...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      
      let message = '<strong>Archive Preview</strong><br><br>';
      
      if (result.orders && result.orders.wouldArchive > 0) {
        message += `üì¶ <strong>${result.orders.wouldArchive}</strong> completed orders would be archived<br>`;
        if (result.orders.orders) {
          message += '<small style="color: var(--gray-500);">' + result.orders.orders.slice(0, 5).map(o => o.orderId).join(', ');
          if (result.orders.orders.length > 5) message += '...';
          message += '</small><br><br>';
        }
      } else {
        message += 'üì¶ No completed orders to archive<br><br>';
      }
      
      if (result.otData && result.otData.wouldArchive > 0) {
        message += `üìä <strong>${result.otData.wouldArchive}</strong> OT records would be archived<br>`;
        if (result.otData.byYear) {
          message += '<small style="color: var(--gray-500);">By year: ' + Object.entries(result.otData.byYear).map(([y, c]) => `${y}: ${c}`).join(', ') + '</small>';
        }
      } else {
        message += 'üìä No OT data to archive';
      }
      
      showToast(message, 'info', 8000);
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error previewing archive: ' + error.message, 'error');
    })
    .runAnnualArchive(true); // true = dry run
}

/**
 * Run archive manually
 */
function runManualArchive() {
  if (!confirm('This will archive all completed orders and OT data from prior years. Continue?')) {
    return;
  }
  
  showLoading(true, 'Running archive...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      
      if (result.success) {
        let message = '‚úÖ Archive completed!<br><br>';
        message += `üì¶ Orders archived: ${result.orders?.archivedCount || 0}<br>`;
        message += `üìä OT records archived: ${result.otData?.archivedCount || 0}`;
        showToast(message, 'success', 5000);
      } else {
        showToast('Archive had some issues. Check the sheets.', 'warning');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error running archive: ' + error.message, 'error');
    })
    .runAnnualArchive(false); // false = real run
}

/**
 * Toggle auto-archive trigger
 */
function toggleArchiveTrigger() {
  showLoading(true, 'Updating triggers...');
  
  // First check current status
  google.script.run
    .withSuccessHandler(function(status) {
      if (status.annualArchiveActive) {
        // Remove trigger
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            showToast('Auto-archive disabled', 'success');
            loadArchiveStatus();
          })
          .withFailureHandler(function(error) {
            showLoading(false);
            showToast('Error: ' + error.message, 'error');
          })
          .removeArchiveTriggers();
      } else {
        // Add trigger
        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            showToast('Auto-archive enabled! Will run January 1st.', 'success');
            loadArchiveStatus();
          })
          .withFailureHandler(function(error) {
            showLoading(false);
            showToast('Error: ' + error.message, 'error');
          })
          .setupAutoArchiveTriggers();
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error checking status: ' + error.message, 'error');
    })
    .getArchiveTriggerStatus();
}

// =====================================================
// PTO RECORDS VIEW FUNCTIONS
// =====================================================

// PTO State
const PTOState = {
  records: [],
  stats: null,
  selectedIds: new Set()
};

/**
 * Initialize PTO Records View
 */
function initPTORecordsView() {
  console.log('Initializing PTO Records view');
  // Load settings first to populate location dropdown
  loadSettings(function() {
    populateLocationDropdowns(['ptoLocationFilter']);
  loadPTOStats();
  loadPTORecords();
  loadPayoutPeriodFilter();
  });
}

/**
 * Load PTO summary statistics
 */
function loadPTOStats() {
  google.script.run
    .withSuccessHandler(function(stats) {
      PTOState.stats = stats;
      renderPTOStats(stats);
    })
    .withFailureHandler(console.error)
    .getPTOSummaryStats();
}

/**
 * Render PTO statistics
 */
function renderPTOStats(stats) {
  const pendingCountEl = document.getElementById('statPendingCount');
  const pendingHoursEl = document.getElementById('statPendingHours');
  const recentCountEl = document.getElementById('statRecentCount');
  const paidHoursEl = document.getElementById('statPaidHours');
  
  if (pendingCountEl) pendingCountEl.textContent = stats.pendingCount || 0;
  if (pendingHoursEl) pendingHoursEl.textContent = (stats.totalHoursPending || 0) + ' hrs';
  if (recentCountEl) recentCountEl.textContent = stats.recentSubmissions || 0;
  if (paidHoursEl) paidHoursEl.textContent = (stats.totalHoursPaid || 0) + ' hrs';
}

/**
 * Load payout period filter options
 */
function loadPayoutPeriodFilter() {
  google.script.run
    .withSuccessHandler(function(dates) {
      const select = document.getElementById('ptoPayoutFilter');
      if (!select) return;
      
      select.innerHTML = '<option value="">All Pay Periods</option>';
      dates.forEach(function(d) {
        const option = document.createElement('option');
        option.value = d.date;
        option.textContent = d.displayEnglish;
        select.appendChild(option);
      });
      
      // Also populate batch pay modal
      const batchSelect = document.getElementById('batchPayPeriod');
      if (batchSelect) {
        batchSelect.innerHTML = '<option value="">Select pay period...</option>';
        dates.forEach(function(d) {
          const option = document.createElement('option');
          option.value = d.date;
          option.textContent = d.displayEnglish;
          select.appendChild(option);
          batchSelect.appendChild(option.cloneNode(true));
        });
      }
      
      // Also populate edit modal
      const editSelect = document.getElementById('editPayoutPeriod');
      if (editSelect) {
        editSelect.innerHTML = '<option value="">Select pay period...</option>';
        dates.forEach(function(d) {
          const option = document.createElement('option');
          option.value = d.date;
          option.textContent = d.displayEnglish;
          editSelect.appendChild(option);
        });
      }
    })
    .withFailureHandler(console.error)
    .getUpcomingPayrollDates();
}

/**
 * Load PTO records with current filters
 */
function loadPTORecords() {
  const status = document.getElementById('ptoStatusFilter')?.value || '';
  const location = document.getElementById('ptoLocationFilter')?.value || '';
  const payoutPeriod = document.getElementById('ptoPayoutFilter')?.value || '';
  
  const filters = {};
  if (status) filters.status = status;
  if (location) filters.location = location;
  if (payoutPeriod) filters.payoutPeriod = payoutPeriod;
  
  google.script.run
    .withSuccessHandler(function(records) {
      PTOState.records = records || [];
      PTOState.selectedIds.clear();
      renderPTOTable();
    })
    .withFailureHandler(function(error) {
      console.error('Error loading PTO records:', error);
      showToast('Error loading PTO records', 'error');
    })
    .getPTORecords(filters);
}

/**
 * Filter PTO records by search term (client-side)
 */
function filterPTORecords() {
  const search = (document.getElementById('ptoSearchInput')?.value || '').toLowerCase();
  
  const rows = document.querySelectorAll('#ptoTableBody tr[data-pto-id]');
  rows.forEach(row => {
    const employeeName = (row.dataset.employeeName || '').toLowerCase();
    const show = !search || employeeName.includes(search);
    row.style.display = show ? '' : 'none';
  });
  
  updatePTOCounts();
}

/**
 * Render PTO records table
 */
function renderPTOTable() {
  const tbody = document.getElementById('ptoTableBody');
  if (!tbody) return;
  
  if (PTOState.records.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="10">
          <div class="empty-state" style="padding: 40px;">
            <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">beach_access</span>
            <h3 style="margin: 16px 0 8px; color: var(--gray-600);">No PTO Records</h3>
            <p style="color: var(--gray-500);">No records match the selected filters</p>
          </div>
        </td>
      </tr>
    `;
    updatePTOCounts();
    return;
  }
  
  tbody.innerHTML = PTOState.records.map(record => {
    const statusClass = record.status.toLowerCase().replace(' ', '-');
    const hsIcon = record.hotSchedulesConfirmed ? 'check_circle' : 'cancel';
    const hsClass = record.hotSchedulesConfirmed ? 'confirmed' : 'not-confirmed';
    
    const dateRange = record.ptoStartDate === record.ptoEndDate 
      ? formatDate(record.ptoStartDate)
      : `${formatDate(record.ptoStartDate)} - ${formatDate(record.ptoEndDate)}`;
    
    const showMarkPaid = record.status === 'Pending';
    const showActions = record.status !== 'Cancelled';
    
    return `
      <tr class="pto-row" data-pto-id="${record.ptoId}" data-employee-name="${record.employeeName}">
        <td onclick="event.stopPropagation();">
          <input type="checkbox" class="pto-select" data-id="${record.ptoId}" 
                 onchange="togglePTOSelect('${record.ptoId}')"
                 ${PTOState.selectedIds.has(record.ptoId) ? 'checked' : ''}>
        </td>
        <td><strong>${record.ptoId}</strong></td>
        <td>${record.employeeName}</td>
        <td>${record.location}</td>
        <td><strong>${record.hoursRequested}</strong> hrs</td>
        <td>${dateRange}</td>
        <td>${formatDate(record.payoutPeriod)}</td>
        <td>
          <span class="hs-badge ${hsClass}">
            <span class="material-icons-round" style="font-size: 16px;">${hsIcon}</span>
          </span>
        </td>
        <td><span class="pto-status ${statusClass}">${record.status}</span></td>
        <td onclick="event.stopPropagation();">
          <div class="action-btns">
            ${showMarkPaid ? `
              <button class="btn btn-outline btn-sm" onclick="markSinglePTOPaid('${record.ptoId}')" title="Mark as Paid">
                <span class="material-icons-round" style="font-size: 14px;">paid</span>
              </button>
            ` : ''}
            ${showActions ? `
              <button class="btn btn-outline btn-sm" onclick="showEditPTOModal('${record.ptoId}')" title="Edit">
                <span class="material-icons-round" style="font-size: 14px;">edit</span>
              </button>
              <button class="btn btn-outline btn-sm" onclick="deletePTO('${record.ptoId}')" title="Delete" style="color: var(--error);">
                <span class="material-icons-round" style="font-size: 14px;">delete</span>
              </button>
            ` : ''}
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  // Add click handler for row expansion
  document.querySelectorAll('.pto-row').forEach(row => {
    row.addEventListener('click', function() {
      viewPTODetails(this.dataset.ptoId);
    });
  });
  
  updatePTOCounts();
}

/**
 * Update record counts and totals
 */
function updatePTOCounts() {
  const visibleRows = document.querySelectorAll('#ptoTableBody tr[data-pto-id]:not([style*="display: none"])');
  const countEl = document.getElementById('ptoRecordsCount');
  const totalEl = document.getElementById('ptoTotalHours');
  
  let totalHours = 0;
  visibleRows.forEach(row => {
    const record = PTOState.records.find(r => r.ptoId === row.dataset.ptoId);
    if (record) totalHours += record.hoursRequested;
  });
  
  if (countEl) countEl.textContent = `Showing ${visibleRows.length} records`;
  if (totalEl) totalEl.textContent = `Total: ${totalHours} hours`;
}

/**
 * Toggle select all PTO checkboxes
 */
function toggleSelectAllPTO(checkbox) {
  const rows = document.querySelectorAll('#ptoTableBody tr[data-pto-id]:not([style*="display: none"])');
  rows.forEach(row => {
    const id = row.dataset.ptoId;
    const cb = row.querySelector('.pto-select');
    if (cb) {
      cb.checked = checkbox.checked;
      if (checkbox.checked) {
        PTOState.selectedIds.add(id);
      } else {
        PTOState.selectedIds.delete(id);
      }
    }
  });
}

/**
 * Toggle single PTO selection
 */
function togglePTOSelect(ptoId) {
  if (PTOState.selectedIds.has(ptoId)) {
    PTOState.selectedIds.delete(ptoId);
  } else {
    PTOState.selectedIds.add(ptoId);
  }
}

/**
 * View PTO details in modal
 */
function viewPTODetails(ptoId) {
  const record = PTOState.records.find(r => r.ptoId === ptoId);
  if (!record) return;
  
  const modal = document.getElementById('ptoDetailsModal');
  const body = document.getElementById('ptoModalBody');
  const footer = document.getElementById('ptoModalFooter');
  const title = document.getElementById('ptoModalTitle');
  
  if (title) title.textContent = `PTO Request: ${record.ptoId}`;
  
  const dateRange = record.ptoStartDate === record.ptoEndDate 
    ? formatDate(record.ptoStartDate)
    : `${formatDate(record.ptoStartDate)} - ${formatDate(record.ptoEndDate)}`;
  
  body.innerHTML = `
    <div class="detail-row">
      <span class="detail-label">Employee</span>
      <span class="detail-value">${record.employeeName}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Location</span>
      <span class="detail-value">${record.location}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Hours Requested</span>
      <span class="detail-value">${record.hoursRequested} hours</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Dates</span>
      <span class="detail-value">${dateRange}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Payout Period</span>
      <span class="detail-value">${formatDate(record.payoutPeriod)}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">HotSchedules Confirmed</span>
      <span class="detail-value">${record.hotSchedulesConfirmed ? '‚úÖ Yes' : '‚ùå No'}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Status</span>
      <span class="detail-value"><span class="pto-status ${record.status.toLowerCase()}">${record.status}</span></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Submitted</span>
      <span class="detail-value">${record.submissionDate ? new Date(record.submissionDate).toLocaleString() : '-'}</span>
    </div>
    ${record.notes ? `
      <div class="detail-row" style="flex-direction: column; gap: 4px;">
        <span class="detail-label">Notes</span>
        <span class="detail-value" style="font-weight: 400;">${record.notes}</span>
      </div>
    ` : ''}
  `;
  
  const showMarkPaid = record.status === 'Pending';
  footer.innerHTML = `
    <button class="btn btn-outline" onclick="closePTOModal()">Close</button>
    ${showMarkPaid ? `
      <button class="btn btn-primary" onclick="markSinglePTOPaid('${record.ptoId}'); closePTOModal();">
        <span class="material-icons-round" style="font-size: 18px;">paid</span>
        Mark as Paid
      </button>
    ` : ''}
  `;
  
  modal.style.display = 'flex';
}

/**
 * Close PTO details modal
 */
function closePTOModal() {
  document.getElementById('ptoDetailsModal').style.display = 'none';
}

/**
 * Mark single PTO as paid
 */
function markSinglePTOPaid(ptoId) {
  const record = PTOState.records.find(r => r.ptoId === ptoId);
  if (!record) return;
  
  if (!confirm(`Mark ${record.ptoId} (${record.hoursRequested} hours) for ${record.employeeName} as paid?`)) {
    return;
  }
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast(`${result.ptoId} marked as paid!`, 'success');
        loadPTORecords();
        loadPTOStats();
      } else {
        showToast(result.error || 'Error marking as paid', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .markPTOPaid(ptoId);
}

/**
 * Show batch pay modal
 */
function showBatchPayModal() {
  document.getElementById('batchPayModal').style.display = 'flex';
  document.getElementById('batchPayPreview').style.display = 'none';
  document.getElementById('batchPayBtn').disabled = true;
  
  // Add change listener for preview
  const select = document.getElementById('batchPayPeriod');
  select.value = '';
  select.onchange = updateBatchPayPreview;
}

/**
 * Update batch pay preview
 */
function updateBatchPayPreview() {
  const payPeriod = document.getElementById('batchPayPeriod').value;
  if (!payPeriod) {
    document.getElementById('batchPayPreview').style.display = 'none';
    document.getElementById('batchPayBtn').disabled = true;
    return;
  }
  
  // Get pending records for this pay period
  google.script.run
    .withSuccessHandler(function(records) {
      const preview = document.getElementById('batchPayPreview');
      const count = document.getElementById('batchPayCount');
      const hours = document.getElementById('batchPayHours');
      const btn = document.getElementById('batchPayBtn');
      
      const totalHours = records.reduce((sum, r) => sum + r.hoursRequested, 0);
      
      count.textContent = `${records.length} pending requests`;
      hours.textContent = `${totalHours} hours total`;
      preview.style.display = 'block';
      btn.disabled = records.length === 0;
    })
    .withFailureHandler(console.error)
    .getPTORecords({ payoutPeriod: payPeriod, status: 'Pending' });
}

/**
 * Close batch pay modal
 */
function closeBatchPayModal() {
  document.getElementById('batchPayModal').style.display = 'none';
}

/**
 * Execute batch pay
 */
function executeBatchPay() {
  const payPeriod = document.getElementById('batchPayPeriod').value;
  if (!payPeriod) return;
  
  if (!confirm(`Mark ALL pending PTO for ${payPeriod} as paid?`)) {
    return;
  }
  
  // Get all pending PTO IDs for this period
  google.script.run
    .withSuccessHandler(function(records) {
      const ptoIds = records.map(r => r.ptoId);
      if (ptoIds.length === 0) {
        showToast('No pending PTO for this pay period', 'info');
        closeBatchPayModal();
        return;
      }
      
      showLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          showLoading(false);
          closeBatchPayModal();
          if (result.success) {
            showToast(`Marked ${result.updatedCount} PTO requests as paid (${result.totalHours} hours)`, 'success');
            loadPTORecords();
            loadPTOStats();
          } else {
            showToast(result.error || 'Error processing batch', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showToast('Error: ' + error.message, 'error');
        })
        .batchMarkPTOPaid(ptoIds, payPeriod);
    })
    .withFailureHandler(console.error)
    .getPTORecords({ payoutPeriod: payPeriod, status: 'Pending' });
}

/**
 * Show edit PTO modal
 */
function showEditPTOModal(ptoId) {
  const record = PTOState.records.find(r => r.ptoId === ptoId);
  if (!record) return;
  
  document.getElementById('editPtoId').value = record.ptoId;
  document.getElementById('editHours').value = record.hoursRequested;
  document.getElementById('editStartDate').value = record.ptoStartDate;
  document.getElementById('editEndDate').value = record.ptoEndDate;
  document.getElementById('editPayoutPeriod').value = record.payoutPeriod || '';
  document.getElementById('editStatus').value = record.status;
  document.getElementById('editNotes').value = record.notes || '';
  
  document.getElementById('editPTOModal').style.display = 'flex';
}

/**
 * Close edit PTO modal
 */
function closeEditPTOModal() {
  document.getElementById('editPTOModal').style.display = 'none';
}

/**
 * Save edited PTO record
 */
function saveEditPTO() {
  const ptoId = document.getElementById('editPtoId').value;
  const updates = {
    hoursRequested: parseFloat(document.getElementById('editHours').value),
    ptoStartDate: document.getElementById('editStartDate').value,
    ptoEndDate: document.getElementById('editEndDate').value,
    payoutPeriod: document.getElementById('editPayoutPeriod').value,
    status: document.getElementById('editStatus').value,
    notes: document.getElementById('editNotes').value
  };
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      closeEditPTOModal();
      if (result.success) {
        showToast('PTO record updated', 'success');
        loadPTORecords();
        loadPTOStats();
      } else {
        showToast(result.error || 'Error updating record', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .updatePTORecord(ptoId, updates);
}

/**
 * Delete PTO record
 */
function deletePTO(ptoId) {
  const record = PTOState.records.find(r => r.ptoId === ptoId);
  if (!record) return;
  
  if (!confirm(`Delete PTO request ${ptoId} for ${record.employeeName}?\n\nThis cannot be undone.`)) {
    return;
  }
  
  showLoading(true);
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        showToast('PTO record deleted', 'success');
        loadPTORecords();
        loadPTOStats();
      } else {
        showToast(result.error || 'Error deleting record', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .deletePTORecord(ptoId);
}

/**
 * Export PTO records to CSV
 */
function exportPTOToCSV() {
  const records = PTOState.records;
  if (records.length === 0) {
    showToast('No records to export', 'info');
    return;
  }
  
  const headers = ['PTO_ID', 'Employee', 'Location', 'Hours', 'Start Date', 'End Date', 'Payout Period', 'HotSchedules', 'Status', 'Submitted', 'Notes'];
  
  const rows = records.map(r => [
    r.ptoId,
    r.employeeName,
    r.location,
    r.hoursRequested,
    r.ptoStartDate,
    r.ptoEndDate,
    r.payoutPeriod,
    r.hotSchedulesConfirmed ? 'Yes' : 'No',
    r.status,
    r.submissionDate ? new Date(r.submissionDate).toLocaleString() : '',
    (r.notes || '').replace(/"/g, '""')
  ]);
  
  const csvContent = [headers.join(','), ...rows.map(r => r.map(cell => `"${cell}"`).join(','))].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `PTO_Export_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  showToast(`Exported ${records.length} records`, 'success');
}

// =====================================================
// PAYROLL PROCESSING VIEW FUNCTIONS
// =====================================================

// ============================================================================
// PTO SUMMARY VIEW
// ============================================================================

/**
 * Initialize PTO Summary View
 */
function initPTOSummaryView() {
  console.log('Initializing PTO Summary view');
  loadPTOSummaryData();
}

/**
 * Load PTO Summary data
 */
function loadPTOSummaryData() {
  google.script.run
    .withSuccessHandler(function(data) {
      if (data && data.success) {
        renderPTOSummary(data);
      } else {
        showToast(data?.error || 'Failed to load PTO summary', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error loading PTO summary:', error);
      showToast('Failed to load PTO summary', 'error');
    })
    .getPTOSummaryData();
}

/**
 * Refresh PTO Summary
 */
function refreshPTOSummary() {
  showToast('Refreshing...', 'info');
  loadPTOSummaryData();
}

/**
 * Render PTO Summary data
 */
function renderPTOSummary(data) {
  // Render summary stats
  document.getElementById('statTotalRequests').textContent = data.summary.totalRequests;
  document.getElementById('statTotalHours').textContent = data.summary.totalHours + ' hours';
  document.getElementById('statPendingRequests').textContent = data.summary.pendingRequests;
  document.getElementById('statPendingHours').textContent = data.summary.pendingHours + ' hours';
  document.getElementById('statPaidRequests').textContent = data.summary.paidRequests;
  document.getElementById('statPaidHours').textContent = data.summary.paidHours + ' hours';
  document.getElementById('statUniqueEmployees').textContent = data.summary.uniqueEmployees;
  document.getElementById('statAvgHours').textContent = data.summary.averageHoursPerRequest + ' avg hrs/request';
  
  // Render top employees
  renderPTOTopEmployees(data.topEmployees);
  
  // Render by location
  renderPTOByLocation(data.byLocation);
  
  // Render monthly trend
  renderPTOMonthlyTrend(data.byMonth);
  
  // Render recent activity
  renderPTORecentActivity(data.recentActivity);
}

/**
 * Render top employees list
 */
function renderPTOTopEmployees(employees) {
  const container = document.getElementById('topEmployeesContent');
  if (!container) return;
  
  if (!employees || employees.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">people</span>
        <p style="color: var(--gray-500);">No PTO data yet</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = employees.map(emp => `
    <div class="top-employee-item">
      <div class="top-employee-rank">${emp.rank}</div>
      <div class="top-employee-info">
        <div class="top-employee-name">${emp.employeeName}</div>
        <div class="top-employee-location">${emp.location}</div>
      </div>
      <div style="text-align: right;">
        <div class="top-employee-hours">${emp.totalHours} hrs</div>
        <div class="top-employee-requests">${emp.requestCount} request${emp.requestCount !== 1 ? 's' : ''}</div>
      </div>
    </div>
  `).join('');
}

/**
 * Render PTO by location
 */
function renderPTOByLocation(locations) {
  const container = document.getElementById('byLocationContent');
  if (!container) return;
  
  if (!locations || locations.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">location_off</span>
        <p style="color: var(--gray-500);">No location data</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = locations.map(loc => `
    <div class="location-item">
      <div class="location-name">${loc.location}</div>
      <div class="location-stats">
        <div class="location-hours">${loc.hours} hrs</div>
        <div class="location-requests">${loc.requests} request${loc.requests !== 1 ? 's' : ''}</div>
      </div>
    </div>
  `).join('');
}

/**
 * Render monthly trend
 */
function renderPTOMonthlyTrend(months) {
  const container = document.getElementById('monthlyTrendContent');
  if (!container) return;
  
  if (!months || months.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">bar_chart</span>
        <p style="color: var(--gray-500);">No monthly data yet</p>
      </div>
    `;
    return;
  }
  
  // Find max hours for scaling
  const maxHours = Math.max(...months.map(m => m.hours), 1);
  
  container.innerHTML = `
    <div class="monthly-trend-grid">
      ${months.map(m => {
        const heightPercent = (m.hours / maxHours) * 100;
        return `
          <div class="month-bar-item">
            <div class="month-bar-container">
              <div class="month-bar" style="height: ${heightPercent}%;"></div>
            </div>
            <div class="month-label">${m.month}</div>
            <div class="month-value">${m.hours} hrs</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

/**
 * Render recent activity table
 */
function renderPTORecentActivity(activity) {
  const tbody = document.getElementById('recentActivityBody');
  if (!tbody) return;
  
  if (!activity || activity.length === 0) {
    tbody.innerHTML = `
      <tr><td colspan="6">
        <div class="empty-state small">
          <span class="material-icons-round">inbox</span>
          <p>No recent activity</p>
        </div>
      </td></tr>
    `;
    return;
  }
  
  tbody.innerHTML = activity.map(rec => `
    <tr>
      <td>${rec.submissionDate}</td>
      <td><strong>${rec.employeeName}</strong></td>
      <td>${rec.location}</td>
      <td class="numeric">${rec.hours} hrs</td>
      <td>${rec.ptoStartDate || '--'}</td>
      <td><span class="status-badge ${rec.status.toLowerCase()}">${rec.status}</span></td>
    </tr>
  `).join('');
}

// ============================================================================
// UNIFORM SUMMARY VIEW
// ============================================================================

/**
 * Initialize Uniform Summary View
 */
function initUniformSummaryView() {
  console.log('Initializing Uniform Summary view');
  loadUniformSummaryData();
}

/**
 * Load Uniform Summary data
 */
function loadUniformSummaryData() {
  google.script.run
    .withSuccessHandler(function(data) {
      if (data && data.success) {
        renderUniformSummary(data);
      } else {
        showToast(data?.error || 'Failed to load uniform summary', 'error');
      }
    })
    .withFailureHandler(function(error) {
      console.error('Error loading uniform summary:', error);
      showToast('Failed to load uniform summary', 'error');
    })
    .getUniformSummaryData();
}

/**
 * Refresh Uniform Summary
 */
function refreshUniformSummary() {
  showToast('Refreshing...', 'info');
  loadUniformSummaryData();
}

/**
 * Render Uniform Summary data
 */
function renderUniformSummary(data) {
  // Render summary stats
  document.getElementById('uniStatTotalOrders').textContent = data.summary.totalOrders;
  document.getElementById('uniStatActiveOrders').textContent = data.summary.activeOrders;
  document.getElementById('uniStatCompletedOrders').textContent = data.summary.completedOrders;
  document.getElementById('uniStatTotalRevenue').textContent = '$' + data.summary.totalRevenue.toFixed(2);
  document.getElementById('uniStatRevenueDetail').textContent = '$' + data.summary.totalCollected.toFixed(2) + ' collected';
  document.getElementById('uniStatOutstanding').textContent = '$' + data.summary.totalOutstanding.toFixed(2);
  document.getElementById('uniStatEmployees').textContent = data.summary.uniqueEmployees;
  
  // Render upcoming deductions
  renderUpcomingDeductions(data.upcomingDeductions);
  
  // Render by category
  renderUniformByCategory(data.byCategory);
  
  // Render top items
  renderUniformTopItems(data.topItems);
  
  // Render by location
  renderUniformByLocation(data.byLocation);
  
  // Render recent orders
  renderUniformRecentOrders(data.recentOrders);
}

/**
 * Render upcoming deductions alert
 */
function renderUpcomingDeductions(deductions) {
  const textEl = document.getElementById('upcomingDeductionsText');
  const cardEl = document.getElementById('upcomingDeductionsCard');
  
  if (!deductions || deductions.length === 0) {
    textEl.textContent = 'No deductions scheduled for upcoming pay periods';
    return;
  }
  
  const parts = deductions.map(d => `$${d.amount.toFixed(2)} on ${d.date} (${d.employeeCount} employee${d.employeeCount !== 1 ? 's' : ''})`);
  textEl.textContent = parts.join(' ‚Ä¢ ');
}

/**
 * Render by category list
 */
function renderUniformByCategory(categories) {
  const container = document.getElementById('byCategoryContent');
  if (!container) return;
  
  if (!categories || categories.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">category</span>
        <p style="color: var(--gray-500);">No category data yet</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = categories.map(cat => `
    <div class="category-item">
      <div>
        <div class="category-name">${cat.category}</div>
        <div class="category-count">${cat.itemCount} item${cat.itemCount !== 1 ? 's' : ''} ordered</div>
      </div>
      <div class="category-revenue">$${cat.revenue.toFixed(2)}</div>
    </div>
  `).join('');
}

/**
 * Render top items list
 */
function renderUniformTopItems(items) {
  const container = document.getElementById('topItemsContent');
  if (!container) return;
  
  if (!items || items.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">inventory_2</span>
        <p style="color: var(--gray-500);">No item data yet</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = items.map((item, index) => `
    <div class="top-item">
      <div class="item-rank">${index + 1}</div>
      <div class="item-info">
        <div class="item-name">${item.itemName}</div>
        <div class="item-category">${item.category}</div>
      </div>
      <div class="item-quantity">${item.quantity} ordered</div>
    </div>
  `).join('');
}

/**
 * Render by location
 */
function renderUniformByLocation(locations) {
  const container = document.getElementById('byLocationContent');
  if (!container) return;
  
  if (!locations || locations.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">location_off</span>
        <p style="color: var(--gray-500);">No location data</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = `
    <div class="location-grid">
      ${locations.map(loc => `
        <div class="location-card">
          <div class="location-card-name">${loc.location}</div>
          <div class="location-card-stat">
            <div>
              <div class="location-stat-value">${loc.orders}</div>
              <div class="location-stat-label">Orders</div>
            </div>
            <div>
              <div class="location-stat-value">$${loc.revenue.toFixed(2)}</div>
              <div class="location-stat-label">Revenue</div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

/**
 * Render recent orders table
 */
function renderUniformRecentOrders(orders) {
  const tbody = document.getElementById('recentOrdersBody');
  if (!tbody) return;
  
  if (!orders || orders.length === 0) {
    tbody.innerHTML = `
      <tr><td colspan="7">
        <div class="empty-state small">
          <span class="material-icons-round">inbox</span>
          <p>No recent orders</p>
        </div>
      </td></tr>
    `;
    return;
  }
  
  tbody.innerHTML = orders.map(order => `
    <tr>
      <td>${order.orderDate}</td>
      <td><strong>${order.orderId}</strong></td>
      <td>${order.employeeName}</td>
      <td>${order.location}</td>
      <td class="numeric">$${order.totalAmount.toFixed(2)}</td>
      <td>${order.paymentProgress}</td>
      <td><span class="order-status-badge ${order.status.toLowerCase()}">${order.status}</span></td>
    </tr>
  `).join('');
}

// ============================================================================
// PAYROLL PROCESSING VIEW
// ============================================================================

// Payroll State
const PayrollState = {
  reportData: null,
  selectedPayrollDate: null,
  skippedOrderIds: [],
  checkStates: {
    ot: {},
    uniform: {},
    pto: {},
    transfer: {}
  }
};

/**
 * Initialize Payroll Processing View
 */
function initPayrollProcessingView() {
  console.log('Initializing Payroll Processing view');
  PayrollState.reportData = null;
  PayrollState.skippedOrderIds = [];
  PayrollState.checkStates = { ot: {}, uniform: {}, pto: {}, transfer: {} };
  
  document.getElementById('reportContent').style.display = 'none';
  loadPayrollDates();
  
  // Auto-run validation on page load
  runPayrollValidationCheck();
}

/**
 * Run pre-payroll validation checks
 */
function runPayrollValidationCheck() {
  // Use setTimeout to ensure DOM is ready (fixes "Already loading" issue)
  setTimeout(function() {
    const badge = document.getElementById('validationBadge');
    const content = document.getElementById('validationContent');
    const refreshBtn = document.getElementById('refreshValidationBtn');
    
    if (!badge || !content) {
      console.log('Validation elements not found, retrying in 500ms...');
      setTimeout(runPayrollValidationCheck, 500);
      return;
    }
    
    console.log('Running payroll validation check...');
    
    // Show loading state
    badge.className = 'validation-badge';
    badge.innerHTML = '<span class="material-icons-round spin" style="font-size: 14px;">sync</span> Checking...';
    content.innerHTML = '<div class="validation-loading"><span class="material-icons-round spin">sync</span><span>Running validation checks...</span></div>';
    if (refreshBtn) refreshBtn.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Validation result:', result);
        if (refreshBtn) refreshBtn.disabled = false;
        renderPayrollValidation(result);
      })
      .withFailureHandler(function(error) {
        console.error('Validation error:', error);
        if (refreshBtn) refreshBtn.disabled = false;
        badge.className = 'validation-badge errors';
        badge.innerHTML = '<span class="material-icons-round" style="font-size: 14px;">error</span> Error';
        content.innerHTML = '<div class="validation-loading"><span class="material-icons-round">error_outline</span><span>Validation failed: ' + (error.message || 'Unknown error') + '</span></div>';
      })
      .runPayrollValidation();
  }, 100);
}

/**
 * Render payroll validation results with accordion-style expandable details
 */
function renderPayrollValidation(result) {
  const badge = document.getElementById('validationBadge');
  const content = document.getElementById('validationContent');
  
  if (!result || !result.checks) {
    content.innerHTML = '<div class="validation-loading"><span class="material-icons-round">error_outline</span><span>No validation data</span></div>';
    return;
  }
  
  // Update badge
  if (result.status === 'ready') {
    badge.className = 'validation-badge ready';
    badge.innerHTML = '<span class="material-icons-round" style="font-size: 14px;">check_circle</span> Ready';
  } else if (result.status === 'warnings') {
    badge.className = 'validation-badge warnings';
    badge.innerHTML = '<span class="material-icons-round" style="font-size: 14px;">warning</span> ' + result.warningCount + ' Warning' + (result.warningCount > 1 ? 's' : '');
  } else {
    badge.className = 'validation-badge errors';
    badge.innerHTML = '<span class="material-icons-round" style="font-size: 14px;">error</span> ' + result.errorCount + ' Error' + (result.errorCount > 1 ? 's' : '');
  }
  
  // Build content
  let html = '<div class="validation-summary">';
  html += '<div class="validation-stat success"><span class="material-icons-round" style="font-size: 18px;">check_circle</span> ' + result.passCount + ' Passed</div>';
  if (result.warningCount > 0) {
    html += '<div class="validation-stat warning"><span class="material-icons-round" style="font-size: 18px;">warning</span> ' + result.warningCount + ' Warning' + (result.warningCount > 1 ? 's' : '') + '</div>';
  }
  if (result.errorCount > 0) {
    html += '<div class="validation-stat error"><span class="material-icons-round" style="font-size: 18px;">error</span> ' + result.errorCount + ' Error' + (result.errorCount > 1 ? 's' : '') + '</div>';
  }
  html += '</div>';
  
  // Sort checks: errors first, then warnings, then success
  const sortedChecks = [...result.checks].sort((a, b) => {
    const order = { error: 0, warning: 1, success: 2 };
    return order[a.status] - order[b.status];
  });
  
  html += '<div class="validation-checks">';
  for (let i = 0; i < sortedChecks.length; i++) {
    const check = sortedChecks[i];
    const icon = check.status === 'success' ? 'check_circle' : check.status === 'warning' ? 'warning' : 'error';
    const hasDetails = check.details && check.details.length > 0;
    const hasHowToFix = check.howToFix;
    const isExpandable = hasDetails || hasHowToFix;
    
    html += '<div class="validation-accordion ' + check.status + '">';
    
    // Accordion Header (clickable if has details)
    html += '<div class="validation-accordion-header' + (isExpandable ? ' expandable' : '') + '"' + 
            (isExpandable ? ' onclick="toggleValidationAccordion(' + i + ')"' : '') + '>';
    html += '<div class="validation-check-icon ' + check.status + '"><span class="material-icons-round">' + icon + '</span></div>';
    html += '<div class="validation-check-content">';
    html += '<div class="validation-check-title">' + check.title + '</div>';
    html += '<div class="validation-check-message">' + check.message + '</div>';
    html += '</div>';
    if (isExpandable) {
      html += '<div class="validation-expand-icon"><span class="material-icons-round">expand_more</span></div>';
    }
    html += '</div>';
    
    // Accordion Body (hidden by default)
    if (isExpandable) {
      html += '<div class="validation-accordion-body" id="validationAccordion' + i + '">';
      
      // Show details if present
      if (hasDetails) {
        html += '<div class="validation-details">';
        html += '<div class="validation-details-title">Affected Items:</div>';
        html += '<ul class="validation-details-list">';
        for (const detail of check.details) {
          html += '<li>' + escapeHtml(detail) + '</li>';
        }
        html += '</ul>';
        html += '</div>';
      }
      
      // Show how to fix if present
      if (hasHowToFix) {
        html += '<div class="validation-howtofix">';
        html += '<div class="validation-howtofix-title"><span class="material-icons-round" style="font-size: 16px;">lightbulb</span> How to Fix:</div>';
        html += '<p>' + escapeHtml(check.howToFix) + '</p>';
        html += '</div>';
      }
      
      // Show action button if present
      if (check.action && check.status !== 'success') {
        html += '<button class="btn btn-sm btn-outline" onclick="navigateTo(\'' + check.action + '\')" style="margin-top: 12px;">';
        html += '<span class="material-icons-round" style="font-size: 16px;">arrow_forward</span> Go to ' + check.action.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
        html += '</button>';
      }
      
      html += '</div>';
    }
    
    html += '</div>';
  }
  html += '</div>';
  
  content.innerHTML = html;
}

/**
 * Toggle validation accordion expansion
 */
function toggleValidationAccordion(index) {
  const body = document.getElementById('validationAccordion' + index);
  const accordion = body?.closest('.validation-accordion');
  
  if (body && accordion) {
    const isExpanded = accordion.classList.toggle('expanded');
    body.style.maxHeight = isExpanded ? body.scrollHeight + 'px' : '0';
  }
}

/**
 * Escape HTML for safe display
 */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Load payroll dates for the dropdown (includes historical and future dates)
 */
function loadPayrollDates() {
  google.script.run
    .withSuccessHandler(function(dates) {
      const select = document.getElementById('payrollDateSelect');
      if (!select) return;
      
      select.innerHTML = '';
      
      // Find the current or next payday to select by default
      let defaultIndex = 0;
      dates.forEach((d, index) => {
        if (d.isCurrent || d.isNext) {
          defaultIndex = index;
        }
      });
      
      // If no current/next found, select the most recent date (last historical one before future dates)
      if (defaultIndex === 0 && dates.length > 0) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        for (let i = dates.length - 1; i >= 0; i--) {
          if (new Date(dates[i].date) <= today) {
            defaultIndex = i;
            break;
          }
        }
      }
      
      dates.forEach((d, index) => {
        const option = document.createElement('option');
        option.value = d.date;
        option.textContent = d.displayEnglish;
        if (index === defaultIndex) option.selected = true;
        select.appendChild(option);
      });
      
      PayrollState.selectedPayrollDate = dates[defaultIndex]?.date;
      updatePayPeriodDisplay();
    })
    .withFailureHandler(function(error) {
      console.error('Error loading payroll dates:', error);
      showToast('Error loading payroll dates', 'error');
    })
    .getUpcomingPayrollDatesFromSettings(6, 26); // 6 future dates, 26 historical dates (~1 year)
}

/**
 * Update the pay period display based on selected date
 */
function updatePayPeriodDisplay() {
  const select = document.getElementById('payrollDateSelect');
  const display = document.getElementById('payPeriodDisplay');
  
  if (!select || !display) return;
  
  const selectedDate = select.value;
  PayrollState.selectedPayrollDate = selectedDate;
  
  if (!selectedDate) {
    display.textContent = 'Select a date to see pay period';
    return;
  }
  
  // Calculate pay period (6 days before payday to 13 days before that)
  const payday = new Date(selectedDate + 'T12:00:00');
  const periodEnd = new Date(payday);
  periodEnd.setDate(periodEnd.getDate() - 6);
  const periodStart = new Date(periodEnd);
  periodStart.setDate(periodStart.getDate() - 13);
  
  const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  display.textContent = `${formatDate(periodStart)} - ${formatDate(periodEnd)}`;
}

/**
 * Generate the payroll processing report
 */
function generatePayrollReport() {
  const payrollDate = PayrollState.selectedPayrollDate;
  
  if (!payrollDate) {
    showToast('Please select a payroll date', 'error');
    return;
  }
  
  const btn = document.getElementById('generateReportBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px;"></span> Generating...';
  
  google.script.run
    .withSuccessHandler(function(report) {
      btn.disabled = false;
      btn.innerHTML = '<span class="material-icons-round" style="font-size: 18px;">assessment</span> Generate Report';
      
      if (!report || !report.success) {
        showToast(report?.error || 'Error generating report', 'error');
        return;
      }
      
      PayrollState.reportData = report;
      PayrollState.skippedOrderIds = [];
      renderPayrollReport(report);
      document.getElementById('reportContent').style.display = 'block';
      showToast('Report generated successfully', 'success');
    })
    .withFailureHandler(function(error) {
      btn.disabled = false;
      btn.innerHTML = '<span class="material-icons-round" style="font-size: 18px;">assessment</span> Generate Report';
      console.error('Error generating report:', error);
      showToast('Error generating report: ' + error.message, 'error');
    })
    .generatePayrollProcessingReport(payrollDate);
}

/**
 * Render the complete payroll report
 */
function renderPayrollReport(report) {
  // Update summary cards
  document.getElementById('summaryOTCount').textContent = report.overtime.employeeCount;
  document.getElementById('summaryOTHours').textContent = report.overtime.totalOTHours + ' hours';
  document.getElementById('summaryUniformCount').textContent = report.uniformDeductions.orders.length;
  document.getElementById('summaryUniformTotal').textContent = '$' + report.uniformDeductions.totalDeductions.toFixed(2);
  document.getElementById('summaryPTOCount').textContent = report.ptoPayout.employeeCount;
  document.getElementById('summaryPTOHours').textContent = report.ptoPayout.totalHours + ' hours';
  document.getElementById('summaryTransferCount').textContent = report.timeTransfers.employeeCount;
  
  // Update badges
  document.getElementById('otBadge').textContent = report.overtime.employeeCount + ' employees';
  document.getElementById('uniformBadge').textContent = report.uniformDeductions.orders.length + ' orders';
  document.getElementById('ptoBadge').textContent = report.ptoPayout.requests.length + ' requests';
  document.getElementById('transferBadge').textContent = report.timeTransfers.employeeCount + ' employees';
  
  // Render sections
  renderOTSection(report.overtime);
  renderUniformSection(report.uniformDeductions);
  renderPTOSection(report.ptoPayout);
  renderTransferSection(report.timeTransfers);
}

/**
 * Render the OT section - compact display sorted by highest OT
 */
function renderOTSection(data) {
  const content = document.getElementById('otContent');
  
  if (data.employees.length === 0) {
    content.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">schedule</span>
        <p style="color: var(--gray-500);">No overtime this period</p>
      </div>
    `;
    return;
  }
  
  // Sort by OT hours descending (highest first)
  const sortedEmployees = [...data.employees].sort((a, b) => b.otHours - a.otHours);
  
  // Compact grid display - no checkboxes
  content.innerHTML = `
    <div class="ot-compact-grid">
      ${sortedEmployees.map(emp => `
        <div class="ot-compact-card ${emp.otHours >= 10 ? 'high-ot' : emp.otHours >= 5 ? 'moderate-ot' : ''}">
          <div class="ot-compact-header">
            <span class="ot-compact-name">${emp.employeeName}</span>
            <span class="ot-compact-hours">${emp.otHours.toFixed(1)} OT</span>
      </div>
          <div class="ot-compact-details">
            <span>${emp.location}</span>
            ${emp.isMultiLocation ? '<span class="ot-multi-badge">Multi</span>' : ''}
        </div>
          <div class="ot-compact-breakdown">
            W1: ${emp.week1OT} ¬∑ W2: ${emp.week2OT} ¬∑ Total: ${emp.totalHours}h
        </div>
      </div>
      `).join('')}
    </div>
  `;
}

/**
 * Render the Uniform Deductions section
 */
function renderUniformSection(data) {
  const content = document.getElementById('uniformContent');
  
  if (data.orders.length === 0) {
    content.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">checkroom</span>
        <p style="color: var(--gray-500);">No uniform deductions this period</p>
      </div>
    `;
    return;
  }
  
  content.innerHTML = data.orders.map((order, index) => {
    const isSkipped = PayrollState.skippedOrderIds.includes(order.orderId);
    
    return `
    <div class="payroll-item ${isSkipped ? 'item-skipped' : ''}" data-id="${order.orderId}">
      <div class="payroll-checkbox">
        <input type="checkbox" id="uniform-${index}" data-section="uniform" data-id="${order.orderId}"
               ${PayrollState.checkStates.uniform[order.orderId] ? 'checked' : ''} 
               ${isSkipped ? 'disabled' : ''}
               onchange="toggleCheck('uniform', '${order.orderId}')">
      </div>
      <div class="payroll-item-content">
        <div class="payroll-item-header">
          <span class="payroll-item-name">
            ${order.employeeName}
            ${order.isFinalPayment ? '<span class="badge-final">FINAL</span>' : ''}
            ${isSkipped ? '<span class="skipped-badge">SKIPPED</span>' : ''}
          </span>
          ${!isSkipped ? `<button class="skip-btn" onclick="showSkipModal('${order.orderId}', '${order.employeeName}', ${order.deductionAmount})">Skip</button>` : ''}
        </div>
        <div class="payroll-item-location">${order.location} ‚Ä¢ ${order.orderId}</div>
        <div class="payroll-item-details">
          <div>Order Date: ${order.orderDate} ‚Ä¢ Total: $${order.totalOrderCost.toFixed(2)}</div>
          <div>Payment: Check ${order.checkNumber} of ${order.paymentSchedule} ‚Ä¢ <strong>Deduct: $${order.deductionAmount.toFixed(2)}</strong></div>
          <div>Remaining after this: $${order.amountRemaining.toFixed(2)}</div>
          <div class="items-summary">Items: ${order.items.map(i => i.description + (i.size ? ' ('+i.size+')' : '')).join(', ')}</div>
        </div>
      </div>
    </div>
  `;
  }).join('');
}

/**
 * Render the PTO section
 */
function renderPTOSection(data) {
  const content = document.getElementById('ptoContent');
  
  if (data.requests.length === 0) {
    content.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">beach_access</span>
        <p style="color: var(--gray-500);">No PTO payouts this period</p>
      </div>
    `;
    return;
  }
  
  content.innerHTML = data.requests.map((pto, index) => `
    <div class="payroll-item" data-id="${pto.ptoId}">
      <div class="payroll-checkbox">
        <input type="checkbox" id="pto-${index}" data-section="pto" data-id="${pto.ptoId}"
               ${PayrollState.checkStates.pto[pto.ptoId] ? 'checked' : ''} 
               onchange="toggleCheck('pto', '${pto.ptoId}')">
      </div>
      <div class="payroll-item-content">
        <div class="payroll-item-header">
          <span class="payroll-item-name">
            ${pto.employeeName}
            <span class="badge-hs ${pto.hotSchedulesConfirmed ? 'confirmed' : 'not-confirmed'}">
              <span class="material-icons-round" style="font-size: 14px;">${pto.hotSchedulesConfirmed ? 'check_circle' : 'warning'}</span>
              ${pto.hotSchedulesConfirmed ? 'HS ‚úì' : 'HS ?'}
            </span>
          </span>
        </div>
        <div class="payroll-item-location">${pto.location} ‚Ä¢ ${pto.ptoId}</div>
        <div class="payroll-item-details">
          <div><strong>${pto.hoursRequested} hrs</strong> ‚Ä¢ ${pto.ptoStartDate}${pto.ptoStartDate !== pto.ptoEndDate ? ' - ' + pto.ptoEndDate : ''} (${pto.durationDays} day${pto.durationDays > 1 ? 's' : ''})</div>
          ${pto.notes ? `<div>Notes: ${pto.notes}</div>` : ''}
        </div>
      </div>
    </div>
  `).join('');
}

/**
 * Render the Time Transfers section
 */
function renderTransferSection(data) {
  const content = document.getElementById('transferContent');
  
  if (data.employees.length === 0) {
    content.innerHTML = `
      <div class="empty-state" style="padding: 40px;">
        <span class="material-icons-round" style="font-size: 48px; color: var(--gray-300);">swap_horiz</span>
        <p style="color: var(--gray-500);">No multi-location employees this period</p>
      </div>
    `;
    return;
  }
  
  content.innerHTML = data.employees.map((emp, index) => {
    // Format total time as hours and minutes
    const totalMins = emp.grandTotalMinutes || 0;
    const totalHrs = Math.floor(totalMins / 60);
    const remainingMins = totalMins % 60;
    const totalTimeFormatted = `${totalHrs} hrs ${remainingMins} min`;
    
    // Calculate total regular and OT across all locations
    const totalRegular = emp.locations.reduce((sum, loc) => sum + (loc.regularHours || 0), 0);
    const totalOT = emp.locations.reduce((sum, loc) => sum + (loc.otHours || 0), 0);
    
    // Helper to convert decimal hours to hours:minutes format
    function formatDecimalHours(decimalHours) {
      const hours = Math.floor(decimalHours);
      const minutes = Math.round((decimalHours - hours) * 60);
      return `${hours}:${minutes.toString().padStart(2, '0')}`;
    }
    
    const regFormatted = formatDecimalHours(totalRegular);
    const otFormatted = formatDecimalHours(totalOT);
    
    return `
    <div class="payroll-item" data-id="${emp.employeeId}">
      <div class="payroll-checkbox">
        <input type="checkbox" id="transfer-${index}" data-section="transfer" data-id="${emp.employeeId}"
               ${PayrollState.checkStates.transfer[emp.employeeId] ? 'checked' : ''} 
               onchange="toggleCheck('transfer', '${emp.employeeId}')">
      </div>
      <div class="payroll-item-content">
        <div class="payroll-item-header">
          <span class="payroll-item-name">${emp.employeeName}</span>
          <span style="font-size: 0.85rem; color: var(--gray-600); font-weight: 600;">Total: ${totalTimeFormatted} ‚Äî Reg: ${regFormatted}, OT: ${otFormatted}</span>
        </div>
        <div class="payroll-item-location">Paid from: ${emp.paidFromLocation}</div>
        <div class="transfer-locations">
          ${emp.locations.map(loc => {
            const locRegHrs = Math.floor(loc.regularHours || 0);
            const locRegMins = Math.round(((loc.regularHours || 0) - locRegHrs) * 60);
            const locOtHrs = Math.floor(loc.otHours || 0);
            const locOtMins = Math.round(((loc.otHours || 0) - locOtHrs) * 60);
            const locRegFormatted = locRegHrs + ':' + locRegMins.toString().padStart(2, '0');
            const locOtFormatted = locOtHrs + ':' + locOtMins.toString().padStart(2, '0');
            return `
            <div class="transfer-location">
              <strong>${loc.name}:</strong> ${loc.totalHours} hrs (${loc.totalMinutes} min) ‚Äî Reg: ${locRegFormatted}, OT: ${locOtFormatted}
            </div>
          `}).join('')}
        </div>
        <div class="transfer-summary">
          Transfer: ${emp.transferHours} hrs (${emp.transferMinutes} min) from ${emp.transferFrom} ‚Üí ${emp.transferTo}
        </div>
      </div>
    </div>
  `}).join('');
}

/**
 * Toggle a single checkbox
 */
function toggleCheck(section, id) {
  PayrollState.checkStates[section][id] = !PayrollState.checkStates[section][id];
}

/**
 * Toggle all checkboxes in a section
 */
function toggleAllChecks(section) {
  const checkboxes = document.querySelectorAll(`input[data-section="${section}"]:not(:disabled)`);
  
  // Determine if we're checking or unchecking (if any unchecked, check all)
  let anyUnchecked = false;
  checkboxes.forEach(cb => {
    if (!cb.checked) anyUnchecked = true;
  });
  
  checkboxes.forEach(cb => {
    cb.checked = anyUnchecked;
    const id = cb.dataset.id;
    PayrollState.checkStates[section][id] = anyUnchecked;
  });
}

/**
 * Show skip payment confirmation modal
 */
function showSkipModal(orderId, employeeName, amount) {
  document.getElementById('skipOrderId').textContent = orderId;
  document.getElementById('skipEmployeeName').textContent = employeeName;
  document.getElementById('skipAmount').textContent = amount.toFixed(2);
  
  document.getElementById('confirmSkipBtn').onclick = function() {
    executeSkipPayment(orderId);
  };
  
  document.getElementById('skipModal').style.display = 'flex';
}

/**
 * Close skip modal
 */
function closeSkipModal() {
  document.getElementById('skipModal').style.display = 'none';
}

/**
 * Execute skip payment
 */
function executeSkipPayment(orderId) {
  closeSkipModal();
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        PayrollState.skippedOrderIds.push(orderId);
        showToast(`Payment skipped. Next deduction: ${result.newFirstDeduction}`, 'success');
        
        // Re-render uniform section to show skipped state
        if (PayrollState.reportData) {
          renderUniformSection(PayrollState.reportData.uniformDeductions);
        }
      } else {
        showToast(result.error || 'Error skipping payment', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .skipUniformPayment(orderId, PayrollState.selectedPayrollDate);
}

/**
 * Show mark complete confirmation modal
 */
function confirmMarkComplete() {
  if (!PayrollState.reportData) return;
  
  // Validate we have a selected payroll date
  if (!PayrollState.selectedPayrollDate) {
    showToast('Please select a payroll date first', 'error');
    return;
  }
  
  const report = PayrollState.reportData;
  const activeUniformCount = report.uniformDeductions.orders.length - PayrollState.skippedOrderIds.length;
  const ptoCount = report.ptoPayout.requests.length;
  
  // Calculate next payroll date with validation
  let nextDateStr = 'Next payroll date';
  try {
  const currentDate = new Date(PayrollState.selectedPayrollDate + 'T12:00:00');
    if (!isNaN(currentDate.getTime())) {
  const nextDate = new Date(currentDate);
  nextDate.setDate(nextDate.getDate() + 14);
      nextDateStr = nextDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    }
  } catch (e) {
    console.error('Error calculating next date:', e);
  }
  
  document.getElementById('completeUniformCount').textContent = activeUniformCount;
  document.getElementById('completePTOCount').textContent = ptoCount;
  document.getElementById('completeNextDate').textContent = nextDateStr;
  document.getElementById('completeSkippedCount').textContent = PayrollState.skippedOrderIds.length;
  
  document.getElementById('completeModal').style.display = 'flex';
}

/**
 * Close complete modal
 */
function closeCompleteModal() {
  document.getElementById('completeModal').style.display = 'none';
}

/**
 * Execute mark complete
 */
function executeMarkComplete() {
  closeCompleteModal();
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(result) {
      showLoading(false);
      if (result.success) {
        // Show success modal
        document.getElementById('successPayrollDate').textContent = result.payrollDate;
        document.getElementById('successUniformCount').textContent = result.uniformPayments.marked + ' ($' + result.uniformPayments.totalAmount.toFixed(2) + ')';
        document.getElementById('successPTOCount').textContent = result.ptoPayouts.marked + ' (' + result.ptoPayouts.totalHours + ' hrs)';
        document.getElementById('successNextDate').textContent = result.newPayrollDate;
        
        document.getElementById('successModal').style.display = 'flex';
        
        // Reload payroll dates to reflect new next date
        loadPayrollDates();
      } else {
        showToast(result.error || 'Error marking complete', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error: ' + error.message, 'error');
    })
    .markPayrollComplete(PayrollState.selectedPayrollDate, PayrollState.skippedOrderIds);
}

/**
 * Close success modal
 */
function closeSuccessModal() {
  document.getElementById('successModal').style.display = 'none';
}

/**
 * Export report as printable HTML (opens in new tab)
 */
function exportReportHTML() {
  if (!PayrollState.reportData) {
    showToast('Generate a report first', 'error');
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(html) {
      showLoading(false);
      
      // Open in new tab
      const newWindow = window.open('', '_blank');
      newWindow.document.write(html);
      newWindow.document.close();
      
      showToast('Report opened in new tab. Use Ctrl+P to print/save as PDF.', 'success');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error generating report: ' + error.message, 'error');
    })
    .generatePayrollReportHTML(PayrollState.reportData);
}

/**
 * Export report as CSV (downloads file)
 */
function exportReportCSV() {
  if (!PayrollState.reportData) {
    showToast('Generate a report first', 'error');
    return;
  }
  
  showLoading(true);
  
  google.script.run
    .withSuccessHandler(function(csvContent) {
      showLoading(false);
      
      // Trigger download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `Payroll_Report_${PayrollState.selectedPayrollDate}.csv`;
      link.click();
      
      showToast('CSV downloaded', 'success');
    })
    .withFailureHandler(function(error) {
      showLoading(false);
      showToast('Error generating CSV: ' + error.message, 'error');
    })
    .generatePayrollReportCSV(PayrollState.reportData);
}

/**
 * Export payroll report to PDF
 */
function exportPayrollToPDF() {
  if (!PayrollState.selectedPayrollDate) {
    showToast('Generate a report first', 'error');
    return;
  }
  
  exportToPDF('payroll', { 
    payrollDate: PayrollState.selectedPayrollDate 
  });
}

// ============================================================
// SYSTEM HEALTH VIEW FUNCTIONS
// ============================================================

let healthCheckTimeout = null;

/**
 * Initialize the System Health view
 */
function initSystemHealthView() {
  console.log('initSystemHealthView called');
  runHealthCheck();
}

/**
 * Manual trigger - can be called from console if auto-init fails
 */
function forceHealthCheck() {
  console.log('forceHealthCheck called manually');
  runHealthCheck();
}

/**
 * Run the health check
 */
function runHealthCheck() {
  const refreshBtn = document.getElementById('refreshBtn');
  const statusBadge = document.getElementById('overallStatus');
  const checksList = document.getElementById('checksList');
  
  if (!refreshBtn || !statusBadge || !checksList) {
    console.error('System Health UI elements not found');
    return;
  }
  
  // Update UI to show loading
  refreshBtn.disabled = true;
  refreshBtn.innerHTML = '<span class="material-icons-round spin">sync</span> Checking...';
  statusBadge.className = 'health-status-badge checking';
  document.getElementById('overallIcon').textContent = 'pending';
  document.getElementById('overallText').textContent = 'Checking...';
  
  checksList.innerHTML = '<div class="loading-placeholder"><span class="material-icons-round spin">sync</span><p>Running health checks...</p></div>';
  
  // Set a timeout to show a message if it takes too long
  if (healthCheckTimeout) clearTimeout(healthCheckTimeout);
  healthCheckTimeout = setTimeout(function() {
    checksList.innerHTML = '<div class="loading-placeholder"><span class="material-icons-round spin">sync</span><p>Still checking... this is taking longer than expected.</p><p style="font-size: 0.85rem; color: var(--gray-400); margin-top: 8px;">If this continues, try refreshing the page.</p></div>';
  }, 15000);
  
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('Health check SUCCESS handler called');
      console.log('Result received:', result);
      if (healthCheckTimeout) clearTimeout(healthCheckTimeout);
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = '<span class="material-icons-round">refresh</span> Refresh';
      
      if (result && result.checks) {
        renderHealthResults(result);
      } else {
        checksList.innerHTML = '<div class="loading-placeholder"><span class="material-icons-round">error_outline</span><p>Failed to run health checks</p><button class="btn btn-outline btn-sm" onclick="runHealthCheck()" style="margin-top: 12px;">Try Again</button></div>';
      }
    })
    .withFailureHandler(function(error) {
      console.log('Health check FAILURE handler called');
      console.log('Error received:', error);
      if (healthCheckTimeout) clearTimeout(healthCheckTimeout);
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = '<span class="material-icons-round">refresh</span> Refresh';
      
      const errorMsg = error.message || String(error);
      checksList.innerHTML = '<div class="loading-placeholder"><span class="material-icons-round">error_outline</span><p>Error: ' + escapeHtmlHealth(errorMsg) + '</p><button class="btn btn-outline btn-sm" onclick="runHealthCheck()" style="margin-top: 12px;">Try Again</button></div>';
    })
    .runSystemHealthCheck();
}

/**
 * Render health check results
 */
function renderHealthResults(result) {
  const statusBadge = document.getElementById('overallStatus');
  const statusIcon = document.getElementById('overallIcon');
  const statusText = document.getElementById('overallText');
  
  statusBadge.className = 'health-status-badge ' + result.status;
  
  if (result.status === 'healthy') {
    statusIcon.textContent = 'check_circle';
    statusText.textContent = 'All Systems Healthy';
  } else if (result.status === 'warnings') {
    statusIcon.textContent = 'warning';
    statusText.textContent = 'Warnings Found';
  } else {
    statusIcon.textContent = 'error';
    statusText.textContent = 'Issues Detected';
  }
  
  document.getElementById('successCount').textContent = result.successCount || 0;
  document.getElementById('warningCount').textContent = result.warningCount || 0;
  document.getElementById('errorCount').textContent = result.errorCount || 0;
  
  if (result.lastRun) {
    const lastRunDate = new Date(result.lastRun);
    document.getElementById('lastRun').textContent = 'Last checked: ' + lastRunDate.toLocaleString();
  }
  
  const checksList = document.getElementById('checksList');
  
  if (!result.checks || result.checks.length === 0) {
    checksList.innerHTML = '<div class="loading-placeholder"><span class="material-icons-round">info</span><p>No health checks available</p></div>';
    return;
  }
  
  const sortedChecks = [...result.checks].sort((a, b) => {
    const order = { error: 0, warning: 1, success: 2 };
    return order[a.status] - order[b.status];
  });
  
  checksList.innerHTML = sortedChecks.map(check => {
    const icon = check.status === 'success' ? 'check_circle' : check.status === 'warning' ? 'warning' : 'error';
    const hasDetails = (check.details && check.details.length > 0) || check.howToFix;
    
    return '<div class="check-item ' + check.status + '"' + (hasDetails ? ' onclick="toggleCheckDetails(this)"' : '') + '>' +
      '<div class="check-header">' +
        '<div class="check-icon"><span class="material-icons-round">' + icon + '</span></div>' +
        '<div class="check-content">' +
          '<div class="check-title">' + escapeHtmlHealth(check.title) + '</div>' +
          '<div class="check-message">' + escapeHtmlHealth(check.message) + '</div>' +
        '</div>' +
        (hasDetails ? '<span class="material-icons-round check-expand">expand_more</span>' : '') +
      '</div>' +
      (hasDetails ? '<div class="check-details">' +
        (check.details && check.details.length > 0 ? '<ul class="check-details-list">' + check.details.map(d => '<li>' + escapeHtmlHealth(d) + '</li>').join('') + '</ul>' : '') +
        (check.howToFix ? '<div class="how-to-fix"><span class="material-icons-round">lightbulb</span><div><strong>How to fix:</strong> ' + escapeHtmlHealth(check.howToFix) + '</div></div>' : '') +
      '</div>' : '') +
    '</div>';
  }).join('');
}

/**
 * Toggle check details expansion
 */
function toggleCheckDetails(element) {
  element.classList.toggle('expanded');
}

/**
 * Escape HTML for safe rendering (health-specific to avoid conflicts)
 */
function escapeHtmlHealth(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================================
// IN-APP HELP SYSTEM
// ============================================================

/**
 * Page-specific help content
 */
const HELP_CONTENT = {
  'home': {
    title: 'Dashboard',
    sections: [
      {
        heading: 'What this page shows',
        content: 'Your central hub for payroll metrics. See overtime hours, costs, pending uniform orders, and recent activity at a glance.'
      },
      {
        heading: 'Key metrics explained',
        content: `<ul>
          <li><strong>OT Hours (Latest Period)</strong> - Total overtime from the most recent upload</li>
          <li><strong>Employees with OT</strong> - How many people worked overtime</li>
          <li><strong>Estimated OT Cost</strong> - Calculated using your hourly rate √ó 1.5 √ó hours</li>
          <li><strong>Pending Orders</strong> - Uniform orders waiting to be processed</li>
        </ul>`
      },
      {
        heading: 'What to do here',
        content: 'Check this page daily to spot any issues. Click on cards to navigate to detailed views.'
      }
    ]
  },
  'ot-upload': {
    title: 'Upload OT Data',
    sections: [
      {
        heading: 'What this page does',
        content: 'Import overtime data from CFA Home into the system for tracking and reporting.'
      },
      {
        heading: 'How to get the data',
        content: `<ol>
          <li>Go to <strong>CFA Home</strong></li>
          <li>Navigate to <strong>Analytics Hub</strong></li>
          <li>Select <strong>DataFeeds</strong></li>
          <li>Choose <strong>Time Punches Included Open Punches</strong></li>
          <li>Set the correct pay period date range</li>
          <li>Download as <strong>CSV</strong></li>
        </ol>`
      },
      {
        heading: 'How to upload',
        content: `<ol>
          <li>Drag and drop the CSV file into the upload area, or click to browse</li>
          <li>Review the preview to ensure data looks correct</li>
          <li>Click <strong>Import Data</strong></li>
        </ol>`
      },
      {
        heading: 'How often to upload',
        content: 'Upload after each pay period ends (typically bi-weekly). The system tracks when you last uploaded.'
      },
      {
        heading: 'If something looks wrong',
        content: 'Verify you selected the correct date range in CFA Home. You can re-upload to overwrite existing data for the same period.'
      }
    ]
  },
  'ot-history': {
    title: 'OT History',
    sections: [
      {
        heading: 'What this page shows',
        content: 'All historical overtime data organized by pay period.'
      },
      {
        heading: 'How to use filters',
        content: 'Use the location and date filters to narrow down results. Click on any employee name to see their details.'
      },
      {
        heading: 'Color-coded flags',
        content: `<ul>
          <li>üü¢ <strong>Green</strong> - Normal OT (under threshold)</li>
          <li>üü° <strong>Yellow</strong> - Moderate OT (review recommended)</li>
          <li>üî¥ <strong>Red</strong> - High OT (needs attention)</li>
        </ul>`
      }
    ]
  },
  'ot-employee': {
    title: 'Employee Lookup',
    sections: [
      {
        heading: 'What this page does',
        content: 'Search for a specific employee to see all their overtime history and patterns.'
      },
      {
        heading: 'How to search',
        content: 'Start typing an employee name - results appear as you type. Select an employee to see their full history.'
      }
    ]
  },
  'uniforms-orders': {
    title: 'Uniform Orders',
    sections: [
      {
        heading: 'What this page shows',
        content: 'All uniform orders - pending, active (being deducted), and completed.'
      },
      {
        heading: 'Order statuses',
        content: `<ul>
          <li><strong>Pending</strong> - Order placed, waiting for items to arrive</li>
          <li><strong>Active</strong> - Items received, deductions in progress</li>
          <li><strong>Completed</strong> - All payments finished</li>
        </ul>`
      },
      {
        heading: 'Creating new orders',
        content: 'Click "New Order" to create an order on behalf of an employee. They can also submit orders themselves via the uniform request form.'
      },
      {
        heading: 'Processing pending orders',
        content: 'When items arrive, go to the uniform request page and use Manager Access to mark items received and activate the order.'
      }
    ]
  },
  'uniforms-deductions': {
    title: 'Payroll Deductions',
    sections: [
      {
        heading: 'What this page shows',
        content: 'Current active deductions and payment schedules for all employees.'
      },
      {
        heading: 'How deductions work',
        content: 'When an order is activated, the total is split across the payment plan (1-3 paychecks). This page shows what to deduct each pay period.'
      },
      {
        heading: 'Recording payments',
        content: 'After running payroll, mark payments as made. The system tracks remaining balances automatically.'
      }
    ]
  },
  'uniforms-catalog': {
    title: 'Uniform Catalog',
    sections: [
      {
        heading: 'What this page shows',
        content: 'All available uniform items with prices and sizes.'
      },
      {
        heading: 'Adding items',
        content: 'Click "Add Item" to add new uniform pieces. Include the item name, available sizes, and price.'
      },
      {
        heading: 'Editing prices',
        content: 'Click on any item to edit. Price changes only affect new orders - existing orders keep their original prices.'
      }
    ]
  },
  'settings': {
    title: 'Settings',
    sections: [
      {
        heading: 'Cost Settings',
        content: 'Set your average hourly wage and OT multiplier for cost calculations.'
      },
      {
        heading: 'Location Settings',
        content: 'Configure your location names (e.g., "Cockrell Hill DTO", "DBU").'
      },
      {
        heading: 'Alert Thresholds',
        content: 'Set when overtime flags appear (moderate, high, really high hours).'
      },
      {
        heading: 'Data Archive',
        content: 'Archive old completed orders and OT data to keep the system fast. Enable auto-archive for January 1st cleanup.'
      },
      {
        heading: 'Backups',
        content: 'Create manual backups or export all data as JSON for safekeeping.'
      }
    ]
  },
  'system-health': {
    title: 'System Health',
    sections: [
      {
        heading: 'What this page does',
        content: 'Automated checks to ensure everything is working correctly.'
      },
      {
        heading: 'Status colors',
        content: `<ul>
          <li>‚úÖ <strong>Green</strong> - All good, no action needed</li>
          <li>‚ö†Ô∏è <strong>Yellow</strong> - Warning, review recommended</li>
          <li>‚ùå <strong>Red</strong> - Error, action required</li>
        </ul>`
      },
      {
        heading: 'When to check',
        content: 'Review weekly and always before running payroll. Click any item for details and fix instructions.'
      }
    ]
  },
  'payroll-processing': {
    title: 'Payroll Processing',
    sections: [
      {
        heading: 'What this page does',
        content: 'Generate reports for payroll processing including all deductions.'
      },
      {
        heading: 'How to use',
        content: `<ol>
          <li>Select the pay period date</li>
          <li>Click "Generate Report"</li>
          <li>Review the deductions list</li>
          <li>Export to CSV or PDF for payroll processing</li>
        </ol>`
      }
    ]
  },
  'help': {
    title: 'Help & Documentation',
    sections: [
      {
        heading: 'Using this page',
        content: 'Find guides, maintenance checklists, and troubleshooting help. Use the tabs to navigate between sections.'
      }
    ]
  }
};

/**
 * Show contextual help for current page
 */
function showPageHelp() {
  const currentView = NavState.currentView || 'home';
  const helpData = HELP_CONTENT[currentView] || HELP_CONTENT['home'];
  
  let sectionsHtml = helpData.sections.map(section => `
    <div class="help-section">
      <h4>${section.heading}</h4>
      <div class="help-content">${section.content}</div>
    </div>
  `).join('');
  
  const modalHtml = `
    <div class="help-modal-overlay" onclick="closeHelpModal()">
      <div class="help-modal" onclick="event.stopPropagation()">
        <div class="help-modal-header">
          <h3><span class="material-icons-round">help_outline</span> ${helpData.title} - Help</h3>
          <button class="help-modal-close" onclick="closeHelpModal()">
            <span class="material-icons-round">close</span>
          </button>
        </div>
        <div class="help-modal-body">
          ${sectionsHtml}
        </div>
        <div class="help-modal-footer">
          <button class="btn btn-outline btn-sm" onclick="navigateTo('help'); closeHelpModal();">
            <span class="material-icons-round">menu_book</span> Full User Guide
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existingModal = document.querySelector('.help-modal-overlay');
  if (existingModal) existingModal.remove();
  
  // Add modal to body
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

/**
 * Close help modal
 */
function closeHelpModal() {
  const modal = document.querySelector('.help-modal-overlay');
  if (modal) modal.remove();
}

// Close help modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeHelpModal();
});

// ============================================================
// HELP PAGE FUNCTIONS
// ============================================================

/**
 * Initialize Help page
 */
function initHelpView() {
  // Load saved checklist state
  loadChecklistState();
}

/**
 * Switch between help tabs
 */
function switchHelpTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.help-tab').forEach(tab => tab.classList.remove('active'));
  const tabBtn = document.getElementById('tab-' + tabName);
  if (tabBtn) tabBtn.classList.add('active');
  
  // Update content
  document.querySelectorAll('.help-tab-content').forEach(content => content.classList.remove('active'));
  const contentEl = document.getElementById('content-' + tabName);
  if (contentEl) contentEl.classList.add('active');
}

/**
 * Save checklist state to localStorage
 */
function saveChecklistState() {
  const checkboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
  const state = Array.from(checkboxes).map(cb => cb.checked);
  localStorage.setItem('annualChecklistState', JSON.stringify(state));
}

/**
 * Load checklist state from localStorage
 */
function loadChecklistState() {
  const saved = localStorage.getItem('annualChecklistState');
  if (saved) {
    try {
      const state = JSON.parse(saved);
      const checkboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
      checkboxes.forEach((cb, i) => {
        if (state[i] !== undefined) cb.checked = state[i];
      });
    } catch (e) {
      console.log('Could not load checklist state');
    }
  }
}

/**
 * Reset checklist
 */
function resetChecklist() {
  const checkboxes = document.querySelectorAll('.checklist-item input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
  localStorage.removeItem('annualChecklistState');
  if (typeof showToast === 'function') {
    showToast('Checklist reset', 'success');
  }
}

// ============================================================
// CHUNK 15: PAYROLL CALENDAR WIDGET
// ============================================================

/**
 * Load and render the payroll calendar widget
 */
function loadPayrollCalendar() {
  const container = document.getElementById('payrollCalendarWidget');
  if (!container) return;
  
  google.script.run
    .withSuccessHandler(function(data) {
      if (data && data.success) {
        renderPayrollCalendarWidget(data, container);
      } else {
        container.innerHTML = '<div class="empty-state"><span class="material-icons-round">event_busy</span><h3>Could not load calendar</h3><p>' + (data?.error || 'Unknown error') + '</p></div>';
      }
    })
    .withFailureHandler(function(error) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons-round">error</span><h3>Calendar Error</h3><p>' + error + '</p></div>';
    })
    .getPayrollCalendarData(3);
}

/**
 * Refresh the payroll calendar
 */
function refreshPayrollCalendar() {
  const container = document.getElementById('payrollCalendarWidget');
  if (container) {
    container.innerHTML = '<div class="calendar-loading"><div class="spinner" style="width: 32px; height: 32px;"></div><span>Refreshing...</span></div>';
  }
  loadPayrollCalendar();
}

/**
 * Render the payroll calendar widget
 */
function renderPayrollCalendarWidget(data, container) {
  const nextPayday = data.nextPayday;
  const currentPeriod = data.currentPeriod;
  const upcomingPaydays = data.upcomingPaydays || [];
  
  let html = `
    <!-- Current Period Header -->
    <div class="calendar-current-period">
      <div class="period-info">
        <div class="period-label">Current Pay Period</div>
        <div class="period-dates">${currentPeriod.startFormatted} - ${currentPeriod.endFormatted}</div>
      </div>
      <div class="next-payday-box">
        <div class="days">${nextPayday.daysUntil}</div>
        <div class="label">days until payday</div>
      </div>
    </div>
    
    <!-- This Cycle Stats -->
    <div class="calendar-cycle-stats">
      <div class="cycle-stat green">
        <div class="value">$${nextPayday.totalAmount.toFixed(2)}</div>
        <div class="label">This Cycle Deductions</div>
      </div>
      <div class="cycle-stat blue">
        <div class="value">${nextPayday.employeeCount}</div>
        <div class="label">Employees</div>
      </div>
      <div class="cycle-stat purple">
        <div class="value">${nextPayday.completingOrders}</div>
        <div class="label">Orders Completing</div>
      </div>
    </div>
    
    <!-- Upcoming Paydays -->
    <div class="calendar-upcoming-list">
      <h4>Upcoming Paydays</h4>
  `;
  
  // Show next 4 paydays
  upcomingPaydays.slice(0, 4).forEach((payday, index) => {
    const isNext = index === 0;
    
    // Robust date parsing - handle multiple formats
    let month = '--';
    let day = '--';
    if (payday.dateFormatted && payday.dateFormatted.includes(' ')) {
      // Format: "Dec 11"
      const dateParts = payday.dateFormatted.split(' ');
      month = dateParts[0] || '--';
      day = dateParts[1] || '--';
    } else if (payday.date) {
      // Fallback: parse ISO date "2024-12-11"
      const d = new Date(payday.date + 'T12:00:00');
      month = d.toLocaleDateString('en-US', { month: 'short' });
      day = d.getDate();
    }
    
    html += `
      <div class="upcoming-payday${isNext ? ' next' : ''}">
        <div class="date-badge">
          <div class="day">${day}</div>
          <div class="month">${month}</div>
        </div>
        <div class="details">
          <div class="amount">$${payday.totalAmount.toFixed(2)}</div>
          <div class="meta">${payday.employeeCount} employee${payday.employeeCount !== 1 ? 's' : ''} with deductions</div>
        </div>
        ${payday.completingOrders > 0 ? `<span class="completing-badge">${payday.completingOrders} completing</span>` : ''}
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
}

/**
 * Initialize payroll calendar on dashboard load
 * Called when dashboard tab is shown
 */
function initPayrollCalendarWidget() {
  loadPayrollCalendar();
}

// ============================================================
// CHUNK 15: FULL PAYROLL CALENDAR VIEW
// ============================================================

// Calendar state
const CalendarState = {
  currentMonth: new Date().getMonth(),
  currentYear: new Date().getFullYear(),
  calendarData: null,
  pastPaydays: null
};

/**
 * Initialize the full payroll calendar view
 */
function initPayrollCalendarView() {
  // Load calendar data
  google.script.run
    .withSuccessHandler(function(data) {
      if (data && data.success) {
        CalendarState.calendarData = data;
        renderFullCalendar();
        renderCalendarSidebar(data);
      } else {
        showToast('Could not load calendar data', 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('Calendar error: ' + error, 'error');
    })
    .getPayrollCalendarData(6);
}

/**
 * Navigate the calendar by months
 */
function navigateCalendar(direction) {
  if (direction === 0) {
    // Today
    CalendarState.currentMonth = new Date().getMonth();
    CalendarState.currentYear = new Date().getFullYear();
  } else {
    CalendarState.currentMonth += direction;
    if (CalendarState.currentMonth > 11) {
      CalendarState.currentMonth = 0;
      CalendarState.currentYear++;
    } else if (CalendarState.currentMonth < 0) {
      CalendarState.currentMonth = 11;
      CalendarState.currentYear--;
    }
  }
  renderFullCalendar();
}

/**
 * Render the full calendar grid
 */
function renderFullCalendar() {
  const container = document.getElementById('calendarDays');
  const monthYearEl = document.getElementById('calendarMonthYear');
  
  if (!container) return;
  
  const year = CalendarState.currentYear;
  const month = CalendarState.currentMonth;
  
  // Update header
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
  if (monthYearEl) {
    monthYearEl.textContent = monthNames[month] + ' ' + year;
  }
  
  // Get first day of month and total days
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrevMonth = new Date(year, month, 0).getDate();
  
  // Build calendar grid
  let html = '';
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Get events from calendar data
  const paydays = CalendarState.calendarData?.upcomingPaydays || [];
  const paydayDates = new Set(paydays.map(p => p.date));
  const otDueDates = new Set((CalendarState.calendarData?.otDueDates || []).map(d => d.date));
  
  // Calculate pay period starts (Sunday of each bi-weekly period)
  // Period starts on Sunday, 18 days before payday (since payday Friday pays for period ending Saturday before)
  // Actually: pay period runs Sun-Sat (14 days), paid on Friday after period ends
  // So if payday is Friday Dec 12, period was Dec 1 (Sun) - Dec 7 (Sat) + Dec 8 (Sun) - Dec 14? 
  // Simpler: Period start = the Sunday that is 12 days before payday (Friday - 12 = Sunday of previous week)
  const periodStartDates = new Set();
  paydays.forEach(p => {
    const payday = new Date(p.date + 'T12:00:00'); // Use noon to avoid timezone issues
    // Friday (day 5) minus 12 days = Sunday (day 0) of the pay period start
    const periodStart = new Date(payday);
    periodStart.setDate(payday.getDate() - 12);
    periodStartDates.add(periodStart.toISOString().split('T')[0]);
  });
  
  // Previous month days
  for (let i = firstDay - 1; i >= 0; i--) {
    const day = daysInPrevMonth - i;
    html += '<div class="calendar-day other-month"><div class="day-number">' + day + '</div></div>';
  }
  
  // Current month days
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = date.toISOString().split('T')[0];
    const isToday = date.getTime() === today.getTime();
    
    let classes = 'calendar-day';
    if (isToday) classes += ' today';
    
    let events = '';
    
    // Check for payday
    if (paydayDates.has(dateStr)) {
      const paydayInfo = paydays.find(p => p.date === dateStr);
      events += '<div class="day-event payday" onclick="showDayDetail(\'' + dateStr + '\')">üí∞ Payday ($' + (paydayInfo?.totalAmount?.toFixed(0) || '0') + ')</div>';
    }
    
    // Check for pay period start
    if (periodStartDates.has(dateStr)) {
      events += '<div class="day-event period-start">üìÖ Period Starts</div>';
    }
    
    // Check for OT due (Mondays of payroll weeks only)
    if (otDueDates.has(dateStr)) {
      events += '<div class="day-event ot-due">‚è∞ Time Punches Due</div>';
    }
    
    html += '<div class="' + classes + '">';
    html += '<div class="day-number">' + day + '</div>';
    html += '<div class="day-events">' + events + '</div>';
    html += '</div>';
  }
  
  // Next month days to fill remaining slots
  const totalCells = firstDay + daysInMonth;
  const remainingCells = (7 - (totalCells % 7)) % 7;
  for (let i = 1; i <= remainingCells; i++) {
    html += '<div class="calendar-day other-month"><div class="day-number">' + i + '</div></div>';
  }
  
  container.innerHTML = html;
}

/**
 * Render calendar sidebar with next payday and upcoming list
 */
function renderCalendarSidebar(data) {
  const nextPayday = data.nextPayday;
  
  // Next Payday Card
  const nextPaydayInfo = document.getElementById('nextPaydayInfo');
  const nextPaydayStats = document.getElementById('nextPaydayStats');
  
  if (nextPaydayInfo) {
    nextPaydayInfo.innerHTML = `
      <div class="date">${nextPayday.dateFormatted}</div>
      <div class="countdown">${nextPayday.daysUntil} day${nextPayday.daysUntil !== 1 ? 's' : ''} away</div>
    `;
  }
  
  if (nextPaydayStats) {
    nextPaydayStats.innerHTML = `
      <div class="next-payday-stat">
        <div class="value">$${nextPayday.totalAmount.toFixed(2)}</div>
        <div class="label">Total Deductions</div>
      </div>
      <div class="next-payday-stat">
        <div class="value">${nextPayday.employeeCount}</div>
        <div class="label">Employees</div>
      </div>
    `;
  }
  
  // Upcoming Paydays List
  const upcomingList = document.getElementById('upcomingPaydaysList');
  if (upcomingList && data.upcomingPaydays) {
    let html = '';
    data.upcomingPaydays.slice(1, 5).forEach(payday => {
      // Parse date safely - handle both "Dec 12" format and ISO dates
      let month = '--';
      let day = '--';
      if (payday.dateFormatted && payday.dateFormatted.includes(' ')) {
        const dateParts = payday.dateFormatted.split(' ');
        month = dateParts[0] || '--';
        day = dateParts[1] || '--';
      } else if (payday.date) {
        // Fallback: parse ISO date
        const d = new Date(payday.date + 'T12:00:00');
        month = d.toLocaleDateString('en-US', { month: 'short' });
        day = d.getDate();
      }
      html += `
        <div class="upcoming-item">
          <div class="date-badge">
            <div class="day">${day}</div>
            <div class="month">${month}</div>
          </div>
          <div class="details">
            <div class="amount">$${payday.totalAmount.toFixed(2)}</div>
            <div class="meta">${payday.employeeCount} employee${payday.employeeCount !== 1 ? 's' : ''}${payday.completingOrders > 0 ? ' ‚Ä¢ ' + payday.completingOrders + ' completing' : ''}</div>
          </div>
        </div>
      `;
    });
    upcomingList.innerHTML = html || '<p style="color: var(--gray-500); font-size: 0.9rem;">No upcoming paydays found.</p>';
  }
}

/**
 * Toggle past paydays visibility
 */
function togglePastPaydays() {
  const container = document.getElementById('pastPaydays');
  const toggle = document.querySelector('.past-toggle .material-icons-round:last-child');
  
  if (!container) return;
  
  const isVisible = container.classList.toggle('visible');
  
  if (toggle) {
    toggle.textContent = isVisible ? 'expand_less' : 'expand_more';
  }
  
  // Load past paydays if not already loaded
  if (isVisible && !CalendarState.pastPaydays) {
    container.innerHTML = '<div class="calendar-loading"><div class="spinner" style="width: 24px; height: 24px;"></div></div>';
    
    google.script.run
      .withSuccessHandler(function(data) {
        CalendarState.pastPaydays = data;
        renderPastPaydays(data);
      })
      .withFailureHandler(function(error) {
        container.innerHTML = '<p style="color: var(--gray-500); padding: 10px;">Could not load past paydays.</p>';
      })
      .getPastPayrollCycles(6);
  }
}

/**
 * Render past paydays list
 */
function renderPastPaydays(data) {
  const container = document.getElementById('pastPaydays');
  if (!container || !data) return;
  
  let html = '';
  data.forEach(cycle => {
    html += `
      <div class="past-item">
        <span class="date">${cycle.dateFormatted}</span>
        <span class="amount">$${cycle.totalAmount.toFixed(2)}</span>
      </div>
    `;
  });
  
  container.innerHTML = html || '<p style="color: var(--gray-500);">No past paydays found.</p>';
}

/**
 * Show day detail modal for a payday
 */
function showDayDetail(dateStr) {
  const modal = document.getElementById('dayDetailModal');
  const titleEl = document.getElementById('dayDetailTitle');
  const bodyEl = document.getElementById('dayDetailBody');
  
  if (!modal || !bodyEl) return;
  
  // Format the date for display
  const date = new Date(dateStr + 'T00:00:00');
  const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
  const formattedDate = date.toLocaleDateString('en-US', options);
  
  if (titleEl) {
    titleEl.textContent = 'Payday: ' + formattedDate;
  }
  
  bodyEl.innerHTML = '<div class="calendar-loading"><div class="spinner" style="width: 32px; height: 32px;"></div><span>Loading details...</span></div>';
  modal.classList.add('visible');
  
  // Get details for this date
  google.script.run
    .withSuccessHandler(function(data) {
      renderDayDetail(data);
    })
    .withFailureHandler(function(error) {
      bodyEl.innerHTML = '<p style="color: var(--gray-500);">Could not load details.</p>';
    })
    .getPayrollDatePreview(dateStr);
}

/**
 * Render day detail content
 */
function renderDayDetail(data) {
  const bodyEl = document.getElementById('dayDetailBody');
  if (!bodyEl) return;
  
  if (!data.orders || data.orders.length === 0) {
    bodyEl.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: 20px;">No deductions scheduled for this payday.</p>';
    return;
  }
  
  let html = '<div class="deduction-list">';
  
  data.orders.forEach(order => {
    html += `
      <div class="deduction-item">
        <div>
          <div class="employee">${order.employeeName}</div>
          <div class="payment-info">Payment ${order.paymentNumber} of ${order.totalPayments}${order.isFinalPayment ? ' (Final)' : ''}</div>
        </div>
        <div class="amount">$${order.deductionAmount.toFixed(2)}</div>
      </div>
    `;
  });
  
  html += '</div>';
  
  html += `
    <div class="deduction-total">
      <span class="label">Total Deductions</span>
      <span class="amount">$${data.totalAmount.toFixed(2)}</span>
    </div>
  `;
  
  if (data.completingOrders > 0) {
    html += '<p style="margin-top: 12px; font-size: 0.85rem; color: var(--success);"><span class="material-icons-round" style="font-size: 16px; vertical-align: middle;">check_circle</span> ' + data.completingOrders + ' order(s) will be fully paid off</p>';
  }
  
  bodyEl.innerHTML = html;
}

/**
 * Close day detail modal
 */
function closeDayDetail() {
  const modal = document.getElementById('dayDetailModal');
  if (modal) {
    modal.classList.remove('visible');
  }
}

// ============================================================
// YEAR-END WIZARD FUNCTIONS
// ============================================================

// Wizard state
var wizardState = {
  currentStep: 1,
  completedSteps: [],
  reportsData: null,
  archiveData: null,
  backupData: null,
  year: new Date().getFullYear()
};

/**
 * Initialize Year-End Wizard view
 */
function initYearEndWizardView() {
  console.log('Initializing Year-End Wizard');
  
  // Load saved progress
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success && result.status) {
        wizardState = Object.assign(wizardState, result.status);
        updateWizardUI();
      }
      // Load step 1 issues
      refreshReviewIssues();
    })
    .withFailureHandler(function(error) {
      console.error('Error loading wizard status:', error);
      refreshReviewIssues();
    })
    .getYearEndWizardStatus();
}

/**
 * Update wizard UI based on state
 */
function updateWizardUI() {
  // Update progress bar
  var progressBar = document.getElementById('wizardProgressBar');
  if (progressBar) {
    var progressPercent = (wizardState.currentStep / 5) * 100;
    progressBar.style.width = progressPercent + '%';
  }
  
  // Update step indicators
  for (var i = 1; i <= 5; i++) {
    var stepEl = document.getElementById('wizardStep' + i);
    if (stepEl) {
      stepEl.classList.remove('active', 'completed');
      if (i === wizardState.currentStep) {
        stepEl.classList.add('active');
      } else if (wizardState.completedSteps.indexOf(i) >= 0) {
        stepEl.classList.add('completed');
      }
    }
  }
  
  // Show correct panel
  for (var j = 1; j <= 5; j++) {
    var panel = document.getElementById('wizardPanel' + j);
    if (panel) {
      panel.style.display = (j === wizardState.currentStep) ? 'block' : 'none';
    }
  }
}

/**
 * Go to a specific wizard step
 */
function goToWizardStep(step) {
  if (step < 1 || step > 5) return;
  
  // Can only go to completed steps or current step
  if (step > wizardState.currentStep && wizardState.completedSteps.indexOf(step) < 0) {
    showToast('Please complete the current step first', 'error');
    return;
  }
  
  wizardState.currentStep = step;
  updateWizardUI();
  
  // Load step-specific content
  if (step === 1) {
    refreshReviewIssues();
  } else if (step === 2) {
    loadAnnualReports();
  } else if (step === 5) {
    renderCompletionStats();
  }
  
  // Save progress
  saveWizardProgress();
}

/**
 * Complete a step and move to next
 */
function completeStep(step) {
  if (wizardState.completedSteps.indexOf(step) < 0) {
    wizardState.completedSteps.push(step);
  }
  
  wizardState.currentStep = step + 1;
  updateWizardUI();
  
  // Load next step content
  if (step === 1) {
    loadAnnualReports();
  } else if (step === 4) {
    renderCompletionStats();
  }
  
  saveWizardProgress();
}

/**
 * Save wizard progress to backend
 */
function saveWizardProgress() {
  google.script.run
    .withSuccessHandler(function() {})
    .withFailureHandler(function(error) {
      console.error('Error saving wizard progress:', error);
    })
    .saveYearEndWizardProgress(wizardState);
}

/**
 * Step 1: Refresh review issues
 */
function refreshReviewIssues() {
  var contentEl = document.getElementById('reviewIssuesContent');
  if (!contentEl) return;
  
  contentEl.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><span>Loading issues to review...</span></div>';
  
  google.script.run
    .withSuccessHandler(function(result) {
      renderReviewIssues(result);
    })
    .withFailureHandler(function(error) {
      contentEl.innerHTML = '<div class="error-state"><span>Error loading issues: ' + error.message + '</span></div>';
    })
    .getYearEndReviewIssues();
}

/**
 * Render review issues
 */
function renderReviewIssues(result) {
  var contentEl = document.getElementById('reviewIssuesContent');
  if (!contentEl || !result.success) {
    contentEl.innerHTML = '<div class="error-state"><span>Error: ' + (result.error || 'Unknown error') + '</span></div>';
    return;
  }
  
  var issues = result.issues;
  var html = '';
  
  // Pending Orders Section
  html += '<div class="review-section">';
  html += '<h4>Pending Orders from This Year</h4>';
  if (issues.pendingOrders.length === 0) {
    html += '<div class="success-item"><span class="check-icon">&#10004;</span> No pending orders to review</div>';
  } else {
    html += '<div class="warning-item"><span class="warning-icon">!</span> ' + issues.pendingOrders.length + ' pending orders need attention</div>';
    html += '<div class="issue-list">';
    issues.pendingOrders.forEach(function(order) {
      html += '<div class="issue-item">';
      html += '<span><strong>' + order.employeeName + '</strong> - $' + (order.amount || 0).toFixed(2) + ' (' + order.orderDate + ')</span>';
      html += '<span class="status-badge">' + order.status + '</span>';
      html += '</div>';
    });
    html += '</div>';
  }
  html += '</div>';
  
  // Stale Employees Section
  html += '<div class="review-section">';
  html += '<h4>Employees Not in Recent Time Punches (3+ months)</h4>';
  if (issues.staleEmployees.length === 0) {
    html += '<div class="success-item"><span class="check-icon">&#10004;</span> All active employees appear in recent data</div>';
  } else {
    html += '<div class="warning-item"><span class="warning-icon">!</span> ' + issues.staleEmployees.length + ' employees may need to be marked inactive</div>';
    html += '<div class="stale-employees-actions">';
    html += '<label class="select-all-label"><input type="checkbox" id="selectAllStaleEmployees" onchange="toggleAllStaleEmployees(this.checked)"> Select All</label>';
    html += '<button class="btn btn-sm btn-primary" id="markSelectedInactiveBtn" onclick="markSelectedEmployeesInactive()" disabled>Mark Selected as Inactive</button>';
    html += '</div>';
    html += '<div class="issue-list" id="staleEmployeesList">';
    issues.staleEmployees.forEach(function(emp) {
      html += '<div class="issue-item">';
      html += '<label class="employee-checkbox-label">';
      html += '<input type="checkbox" class="stale-employee-checkbox" data-employee-id="' + emp.employeeId + '" data-employee-name="' + emp.employeeName + '" onchange="updateStaleEmployeeSelection()">';
      html += '<span>' + emp.employeeName + '</span>';
      html += '</label>';
      html += '</div>';
    });
    html += '</div>';
    html += '<div id="staleEmployeeStatus" class="selection-status"></div>';
  }
  html += '</div>';
  
  // Inactive with Deductions Section
  html += '<div class="review-section">';
  html += '<h4>Inactive Employees with Active Deductions</h4>';
  if (issues.inactiveWithDeductions.length === 0) {
    html += '<div class="success-item"><span class="check-icon">&#10004;</span> No conflicts found</div>';
  } else {
    html += '<div class="error-item"><span class="error-icon">X</span> ' + issues.inactiveWithDeductions.length + ' inactive employees still have active deductions</div>';
    html += '<div class="issue-list">';
    issues.inactiveWithDeductions.forEach(function(order) {
      html += '<div class="issue-item">';
      html += '<span><strong>' + order.employeeName + '</strong> - $' + (order.amount || 0).toFixed(2) + ' remaining</span>';
      html += '<span class="status-badge error">Needs Resolution</span>';
      html += '</div>';
    });
    html += '</div>';
  }
  html += '</div>';
  
  contentEl.innerHTML = html;
}

/**
 * Toggle all stale employee checkboxes
 */
function toggleAllStaleEmployees(checked) {
  var checkboxes = document.querySelectorAll('.stale-employee-checkbox');
  checkboxes.forEach(function(cb) {
    cb.checked = checked;
  });
  updateStaleEmployeeSelection();
}

/**
 * Update selection status and button state
 */
function updateStaleEmployeeSelection() {
  var checkboxes = document.querySelectorAll('.stale-employee-checkbox:checked');
  var btn = document.getElementById('markSelectedInactiveBtn');
  var statusEl = document.getElementById('staleEmployeeStatus');
  var selectAllCb = document.getElementById('selectAllStaleEmployees');
  var allCheckboxes = document.querySelectorAll('.stale-employee-checkbox');
  
  var count = checkboxes.length;
  
  if (btn) {
    btn.disabled = count === 0;
    btn.textContent = count === 0 ? 'Mark Selected as Inactive' : 'Mark ' + count + ' as Inactive';
  }
  
  if (statusEl) {
    statusEl.textContent = count > 0 ? count + ' employee' + (count > 1 ? 's' : '') + ' selected' : '';
  }
  
  // Update "Select All" checkbox state
  if (selectAllCb && allCheckboxes.length > 0) {
    selectAllCb.checked = count === allCheckboxes.length;
    selectAllCb.indeterminate = count > 0 && count < allCheckboxes.length;
  }
}

/**
 * Mark all selected employees as inactive
 */
function markSelectedEmployeesInactive() {
  var checkboxes = document.querySelectorAll('.stale-employee-checkbox:checked');
  if (checkboxes.length === 0) {
    showToast('No employees selected', 'error');
    return;
  }
  
  var employeeIds = [];
  var employeeNames = [];
  checkboxes.forEach(function(cb) {
    employeeIds.push(cb.dataset.employeeId);
    employeeNames.push(cb.dataset.employeeName);
  });
  
  // Disable button and show processing state
  var btn = document.getElementById('markSelectedInactiveBtn');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Processing...';
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast(result.count + ' employee' + (result.count > 1 ? 's' : '') + ' marked as inactive', 'success');
        // Remove the processed employees from the list instead of full reload
        employeeIds.forEach(function(id) {
          var cb = document.querySelector('.stale-employee-checkbox[data-employee-id="' + id + '"]');
          if (cb) {
            var itemEl = cb.closest('.issue-item');
            if (itemEl) {
              itemEl.style.transition = 'opacity 0.3s, transform 0.3s';
              itemEl.style.opacity = '0';
              itemEl.style.transform = 'translateX(20px)';
              setTimeout(function() {
                itemEl.remove();
                updateStaleEmployeeCount();
              }, 300);
            }
          }
        });
      } else {
        showToast('Error: ' + result.error, 'error');
        if (btn) {
          btn.disabled = false;
          updateStaleEmployeeSelection();
        }
      }
    })
    .withFailureHandler(function(error) {
      showToast('Error: ' + error.message, 'error');
      if (btn) {
        btn.disabled = false;
        updateStaleEmployeeSelection();
      }
    })
    .markEmployeesInactive(employeeIds);
}

/**
 * Update stale employee count after removing items
 */
function updateStaleEmployeeCount() {
  var remainingItems = document.querySelectorAll('#staleEmployeesList .issue-item');
  var warningEl = document.querySelector('.review-section:nth-child(2) .warning-item');
  var actionsEl = document.querySelector('.stale-employees-actions');
  
  if (remainingItems.length === 0) {
    // All done! Replace with success message
    var listEl = document.getElementById('staleEmployeesList');
    if (listEl) listEl.remove();
    if (actionsEl) actionsEl.remove();
    if (warningEl) {
      warningEl.className = 'success-item';
      warningEl.innerHTML = '<span class="check-icon">&#10004;</span> All active employees appear in recent data';
    }
    var statusEl = document.getElementById('staleEmployeeStatus');
    if (statusEl) statusEl.remove();
  } else {
    // Update the count
    if (warningEl) {
      warningEl.innerHTML = '<span class="warning-icon">!</span> ' + remainingItems.length + ' employees may need to be marked inactive';
    }
    updateStaleEmployeeSelection();
  }
}

/**
 * Step 2: Load annual reports
 */
function loadAnnualReports() {
  var contentEl = document.getElementById('reportsContent');
  if (!contentEl) return;
  
  contentEl.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><span>Generating reports...</span></div>';
  
  google.script.run
    .withSuccessHandler(function(result) {
      renderAnnualReports(result);
    })
    .withFailureHandler(function(error) {
      contentEl.innerHTML = '<div class="error-state"><span>Error generating reports: ' + error.message + '</span></div>';
    })
    .generateAnnualReports(wizardState.year);
}

/**
 * Render annual reports
 */
function renderAnnualReports(result) {
  var contentEl = document.getElementById('reportsContent');
  var exportBtn = document.getElementById('exportReportsBtn');
  
  if (!contentEl || !result.success) {
    contentEl.innerHTML = '<div class="error-state"><span>Error: ' + (result.error || 'Unknown error') + '</span></div>';
    return;
  }
  
  wizardState.reportsData = result.reports;
  
  var reports = result.reports;
  var html = '<div class="reports-preview">';
  
  // Uniform Summary
  html += '<div class="report-card">';
  html += '<h4>Uniform Orders Summary</h4>';
  html += '<div class="stat-row"><span>Total Orders:</span><strong>' + reports.uniformSummary.totalOrders + '</strong></div>';
  html += '<div class="stat-row"><span>Total Amount:</span><strong>$' + reports.uniformSummary.totalAmount.toFixed(2) + '</strong></div>';
  
  html += '<h5>By Location:</h5>';
  for (var loc in reports.uniformSummary.byLocation) {
    var locData = reports.uniformSummary.byLocation[loc];
    html += '<div class="stat-row sub"><span>' + loc + ':</span><span>' + locData.orders + ' orders, $' + locData.amount.toFixed(2) + '</span></div>';
  }
  
  html += '<h5>Top Spenders:</h5>';
  var topEmp = reports.uniformSummary.byEmployee.slice(0, 5);
  topEmp.forEach(function(emp) {
    html += '<div class="stat-row sub"><span>' + emp.name + ':</span><span>$' + emp.amount.toFixed(2) + '</span></div>';
  });
  html += '</div>';
  
  // OT Summary
  html += '<div class="report-card">';
  html += '<h4>Overtime Summary</h4>';
  html += '<div class="stat-row"><span>Total OT Hours:</span><strong>' + reports.otSummary.totalHours.toFixed(1) + ' hrs</strong></div>';
  html += '<div class="stat-row"><span>Total OT Cost:</span><strong>$' + reports.otSummary.totalCost.toFixed(2) + '</strong></div>';
  
  html += '<h5>By Location:</h5>';
  for (var otLoc in reports.otSummary.byLocation) {
    var otLocData = reports.otSummary.byLocation[otLoc];
    html += '<div class="stat-row sub"><span>' + otLoc + ':</span><span>' + otLocData.hours.toFixed(1) + ' hrs, $' + otLocData.cost.toFixed(2) + '</span></div>';
  }
  html += '</div>';
  
  html += '</div>';
  
  contentEl.innerHTML = html;
  
  if (exportBtn) {
    exportBtn.disabled = false;
  }
}

/**
 * Export reports to Drive
 */
function exportReportsToDrive() {
  var btn = document.getElementById('exportReportsBtn');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Exporting...';
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        // Show success modal
        showExportSuccessModal(result);
      } else {
        showToast('Error: ' + result.error, 'error');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Export to Drive and Continue';
        }
      }
    })
    .withFailureHandler(function(error) {
      showToast('Error: ' + error.message, 'error');
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Export to Drive and Continue';
      }
    })
    .exportAnnualReportsToDrive(wizardState.year);
}

/**
 * Show export success modal
 */
function showExportSuccessModal(result) {
  var modal = document.getElementById('exportSuccessModal');
  var filesList = document.getElementById('exportedFilesList');
  var folderName = document.getElementById('exportFolderName');
  var folderLink = document.getElementById('exportFolderLink');
  
  if (filesList && result.files) {
    var filesHtml = '';
    result.files.forEach(function(file) {
      filesHtml += '<div style="margin: 4px 0;"><strong>' + file.type + ':</strong> ' + file.name + '</div>';
    });
    filesList.innerHTML = filesHtml;
  }
  
  if (folderName) {
    folderName.textContent = result.folderName;
  }
  
  if (folderLink && result.folderUrl) {
    folderLink.href = result.folderUrl;
  }
  
  if (modal) {
    modal.style.display = 'flex';
  }
}

/**
 * Close export modal and continue
 */
function closeExportModal() {
  var modal = document.getElementById('exportSuccessModal');
  if (modal) {
    modal.style.display = 'none';
  }
  completeStep(2);
}

/**
 * Step 3: Run archive
 */
function runArchive() {
  var btn = document.getElementById('runArchiveBtn');
  var resultsEl = document.getElementById('archiveResults');
  
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Archiving...';
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      wizardState.archiveData = result;
      
      if (resultsEl) {
        resultsEl.style.display = 'block';
        if (result.success) {
          resultsEl.innerHTML = '<div class="success-box">' +
            '<h4>Archive Complete</h4>' +
            '<p>Orders archived: ' + (result.ordersArchived || 0) + '</p>' +
            '<p>OT records archived: ' + (result.otArchived || 0) + '</p>' +
            '</div>';
          
          // Mark step complete and move on
          setTimeout(function() {
            completeStep(3);
          }, 1500);
        } else {
          resultsEl.innerHTML = '<div class="error-box"><p>Error: ' + result.error + '</p></div>';
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'Run Archive and Continue';
          }
        }
      }
    })
    .withFailureHandler(function(error) {
      if (resultsEl) {
        resultsEl.style.display = 'block';
        resultsEl.innerHTML = '<div class="error-box"><p>Error: ' + error.message + '</p></div>';
      }
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Run Archive and Continue';
      }
    })
    .runYearEndArchive();
}

/**
 * Step 4: Run year-end backup
 */
function runYearEndBackup() {
  var btn = document.getElementById('runBackupBtn');
  var resultsEl = document.getElementById('backupResults');
  
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Creating backup...';
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      wizardState.backupData = result;
      
      if (resultsEl) {
        resultsEl.style.display = 'block';
        if (result.success) {
          resultsEl.innerHTML = '<div class="success-box">' +
            '<h4>Backup Complete</h4>' +
            '<p>Files backed up: ' + result.fileCount + '</p>' +
            '<p>Folder: <strong>' + result.folderName + '</strong></p>' +
            '<a href="' + result.folderUrl + '" target="_blank" class="btn btn-secondary">Open in Drive</a>' +
            '</div>';
          
          // Mark step complete and move on
          setTimeout(function() {
            completeStep(4);
          }, 1500);
        } else {
          resultsEl.innerHTML = '<div class="error-box"><p>Error: ' + result.error + '</p></div>';
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'Create Backup and Continue';
          }
        }
      }
    })
    .withFailureHandler(function(error) {
      if (resultsEl) {
        resultsEl.style.display = 'block';
        resultsEl.innerHTML = '<div class="error-box"><p>Error: ' + error.message + '</p></div>';
      }
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Create Backup and Continue';
      }
    })
    .createYearEndBackup();
}

/**
 * Step 5: Render completion stats
 */
function renderCompletionStats() {
  var statsEl = document.getElementById('completionStats');
  if (!statsEl) return;
  
  var html = '<div class="completion-grid">';
  
  if (wizardState.reportsData) {
    html += '<div class="completion-stat">';
    html += '<span class="stat-value">' + wizardState.reportsData.uniformSummary.totalOrders + '</span>';
    html += '<span class="stat-label">Uniform Orders</span>';
    html += '</div>';
    html += '<div class="completion-stat">';
    html += '<span class="stat-value">$' + wizardState.reportsData.uniformSummary.totalAmount.toFixed(2) + '</span>';
    html += '<span class="stat-label">Total Uniforms</span>';
    html += '</div>';
    html += '<div class="completion-stat">';
    html += '<span class="stat-value">' + wizardState.reportsData.otSummary.totalHours.toFixed(0) + ' hrs</span>';
    html += '<span class="stat-label">Total OT Hours</span>';
    html += '</div>';
  }
  
  if (wizardState.archiveData) {
    html += '<div class="completion-stat">';
    html += '<span class="stat-value">' + (wizardState.archiveData.ordersArchived || 0) + '</span>';
    html += '<span class="stat-label">Orders Archived</span>';
    html += '</div>';
  }
  
  if (wizardState.backupData) {
    html += '<div class="completion-stat">';
    html += '<span class="stat-value">' + (wizardState.backupData.fileCount || 0) + '</span>';
    html += '<span class="stat-label">Files Backed Up</span>';
    html += '</div>';
  }
  
  html += '</div>';
  statsEl.innerHTML = html;
}

/**
 * Send year-end summary email
 */
function sendSummaryEmail() {
  showToast('Sending summary email...', 'info');
  
  var summaryData = {
    year: wizardState.year,
    uniformOrders: wizardState.reportsData ? wizardState.reportsData.uniformSummary.totalOrders : 0,
    uniformAmount: wizardState.reportsData ? wizardState.reportsData.uniformSummary.totalAmount : 0,
    otHours: wizardState.reportsData ? wizardState.reportsData.otSummary.totalHours : 0,
    otCost: wizardState.reportsData ? wizardState.reportsData.otSummary.totalCost : 0,
    ordersArchived: wizardState.archiveData ? wizardState.archiveData.ordersArchived : 0,
    otArchived: wizardState.archiveData ? wizardState.archiveData.otArchived : 0,
    backupFolder: wizardState.backupData ? wizardState.backupData.folderName : '',
    backupUrl: wizardState.backupData ? wizardState.backupData.folderUrl : ''
  };
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showToast('Summary email sent!', 'success');
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    })
    .withFailureHandler(function(error) {
      showToast('Error: ' + error.message, 'error');
    })
    .sendYearEndSummaryEmail(summaryData);
}

</script>


