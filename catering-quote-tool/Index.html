<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CFA Catering Quotes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --cfa-red:#E51636;--cfa-red-dark:#C41230;--cfa-red-light:#FFF0F2;--cfa-red-hover:#D0132F;
      --gray-50:#F9FAFB;--gray-100:#F3F4F6;--gray-200:#E5E7EB;--gray-300:#D1D5DB;--gray-400:#9CA3AF;
      --gray-500:#6B7280;--gray-600:#4B5563;--gray-700:#374151;--gray-800:#1F2937;--gray-900:#111827;
      --white:#FFFFFF;--success:#059669;--success-light:#ECFDF5;--warning:#D97706;--warning-light:#FFFBEB;
      --danger:#DC2626;--danger-light:#FEF2F2;
      --shadow-sm:0 1px 2px rgba(0,0,0,0.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,0.07),0 2px 4px -2px rgba(0,0,0,0.05);--shadow-lg:0 10px 15px -3px rgba(0,0,0,0.08),0 4px 6px -4px rgba(0,0,0,0.04);
      --radius:10px;--radius-lg:14px;
      --font:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;--mono:'JetBrains Mono',monospace;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:var(--font);background:var(--gray-50);color:var(--gray-800);line-height:1.5;-webkit-font-smoothing:antialiased;}

    /* Layout */
    .app-shell{min-height:100vh;display:flex;flex-direction:column;}
    .top-bar{background:var(--white);border-bottom:1px solid var(--gray-200);padding:0 24px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-sm);}
    .top-bar-brand{display:flex;align-items:center;gap:12px;}
    .top-bar-brand .brand-icon{width:36px;height:36px;background:var(--cfa-red);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px;}
    .top-bar-brand h1{font-size:18px;font-weight:700;color:var(--gray-900);}
    .top-bar-brand .brand-sub{font-size:12px;color:var(--gray-400);font-weight:500;}
    .tab-nav{display:flex;gap:4px;}
    .tab-btn{padding:8px 20px;border:none;background:transparent;color:var(--gray-500);font-family:var(--font);font-size:14px;font-weight:600;cursor:pointer;border-radius:8px;transition:all .15s ease;}
    .tab-btn:hover{background:var(--gray-100);color:var(--gray-700);}
    .tab-btn.active{background:var(--cfa-red-light);color:var(--cfa-red);}
    .main-content{flex:1;padding:24px;max-width:1100px;margin:0 auto;width:100%;}
    .view{display:none;}.view.active{display:block;}

    /* Cards */
    .card{background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius-lg);padding:24px;margin-bottom:20px;box-shadow:var(--shadow-sm);}
    .card-title{font-size:16px;font-weight:700;color:var(--gray-900);margin-bottom:20px;display:flex;align-items:center;gap:8px;}
    .card-title .icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;}
    .card-title .icon.red{background:var(--cfa-red-light);color:var(--cfa-red);}
    .card-title .icon.green{background:var(--success-light);color:var(--success);}
    .card-title .icon.amber{background:var(--warning-light);color:var(--warning);}
    .card-title .icon.blue{background:#DBEAFE;color:#2563EB;}

    /* Form */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .form-group{display:flex;flex-direction:column;gap:5px;}
    .form-group.full-width{grid-column:1/-1;}
    .form-label{font-size:13px;font-weight:600;color:var(--gray-600);text-transform:uppercase;letter-spacing:.3px;}
    .form-input,.form-select,.form-textarea{font-family:var(--font);font-size:15px;padding:10px 14px;border:1.5px solid var(--gray-200);border-radius:8px;background:var(--white);color:var(--gray-800);transition:border-color .15s,box-shadow .15s;width:100%;}
    .form-textarea{resize:vertical;min-height:120px;line-height:1.6;}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--cfa-red);box-shadow:0 0 0 3px rgba(229,22,54,.1);}
    .form-input:read-only{background:var(--gray-50);color:var(--gray-500);cursor:not-allowed;}
    .form-input.error{border-color:var(--danger);box-shadow:0 0 0 3px rgba(220,38,38,.1);}
    .error-msg{font-size:12px;color:var(--danger);font-weight:500;display:none;}
    .error-msg.show{display:block;}
    .field-hint{font-size:12px;color:var(--gray-400);margin-top:2px;}

    /* Buttons */
    .btn{font-family:var(--font);font-size:14px;font-weight:600;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;transition:all .15s ease;display:inline-flex;align-items:center;gap:8px;white-space:nowrap;}
    .btn-primary{background:var(--cfa-red);color:var(--white);}
    .btn-primary:hover{background:var(--cfa-red-hover);transform:translateY(-1px);box-shadow:var(--shadow-md);}
    .btn-secondary{background:var(--gray-100);color:var(--gray-700);border:1px solid var(--gray-200);}
    .btn-secondary:hover{background:var(--gray-200);}
    .btn-danger{background:var(--danger-light);color:var(--danger);}
    .btn-danger:hover{background:#FEE2E2;}
    .btn-success{background:var(--success);color:var(--white);}
    .btn-blue{background:#2563EB;color:var(--white);}
    .btn-blue:hover{background:#1D4ED8;transform:translateY(-1px);box-shadow:var(--shadow-md);}
    .btn-sm{padding:7px 14px;font-size:13px;}
    .btn-lg{padding:14px 28px;font-size:15px;}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important;}

    /* Order Type Toggle */
    .order-type-toggle{display:flex;background:var(--gray-100);border-radius:10px;padding:4px;border:2px solid var(--gray-200);}
    .order-type-btn{flex:1;padding:14px 24px;border:none;background:transparent;font-family:var(--font);font-size:15px;font-weight:700;color:var(--gray-500);cursor:pointer;border-radius:8px;transition:all .2s;text-align:center;}
    .order-type-btn.active{background:var(--cfa-red);color:var(--white);box-shadow:var(--shadow-md);}
    .order-type-btn:hover:not(.active){color:var(--gray-700);background:var(--gray-200);}

    /* Tax Exempt */
    .tax-exempt-toggle{display:inline-flex;align-items:center;gap:10px;padding:8px 16px;border-radius:8px;border:2px solid var(--gray-200);cursor:pointer;transition:all .2s;background:var(--white);user-select:none;}
    .tax-exempt-toggle:hover{border-color:var(--gray-300);}
    .tax-exempt-toggle.active{border-color:var(--cfa-red);background:var(--cfa-red-light);}
    .tax-exempt-toggle .toggle-indicator{width:20px;height:20px;border-radius:4px;border:2px solid var(--gray-300);display:flex;align-items:center;justify-content:center;transition:all .15s;font-size:12px;color:transparent;}
    .tax-exempt-toggle.active .toggle-indicator{background:var(--cfa-red);border-color:var(--cfa-red);color:white;}
    .tax-exempt-label{font-weight:600;font-size:14px;color:var(--gray-700);}

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SEARCHABLE ITEM PICKER ‚Äî custom dropdown with categories
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .item-picker{position:relative;width:100%;}
    .item-picker-input{font-family:var(--font);font-size:14px;padding:8px 32px 8px 10px;border:1.5px solid var(--gray-200);border-radius:8px;background:var(--white);color:var(--gray-800);width:100%;cursor:pointer;transition:border-color .15s,box-shadow .15s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .item-picker-input:focus{outline:none;border-color:var(--cfa-red);box-shadow:0 0 0 3px rgba(229,22,54,.1);}
    .item-picker-input::placeholder{color:var(--gray-400);}
    /* Chevron */
    .item-picker::after{content:'‚ñæ';position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--gray-400);font-size:12px;pointer-events:none;}
    .item-picker.open::after{content:'‚ñ¥';}
    /* Dropdown panel */
    .item-picker-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--white);border:1.5px solid var(--gray-200);border-radius:10px;box-shadow:var(--shadow-lg);z-index:50;max-height:280px;overflow-y:auto;display:none;}
    .item-picker.open .item-picker-dropdown{display:block;}
    .item-picker-dropdown::-webkit-scrollbar{width:6px;}
    .item-picker-dropdown::-webkit-scrollbar-thumb{background:var(--gray-300);border-radius:3px;}
    /* Category headers */
    .picker-cat-header{padding:8px 12px 4px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--gray-400);background:var(--gray-50);border-bottom:1px solid var(--gray-100);position:sticky;top:0;}
    /* Option items */
    .picker-option{padding:9px 12px;font-size:14px;color:var(--gray-700);cursor:pointer;transition:background .1s;display:flex;align-items:center;gap:8px;}
    .picker-option:hover,.picker-option.highlighted{background:var(--cfa-red-light);color:var(--cfa-red);}
    .picker-option .picker-price{margin-left:auto;font-family:var(--mono);font-size:12px;color:var(--gray-400);}
    .picker-option:hover .picker-price{color:var(--cfa-red);}
    /* Special options */
    .picker-option.custom-opt{border-top:1px solid var(--gray-200);color:var(--gray-500);font-style:italic;}
    .picker-option.custom-opt:hover{color:var(--cfa-red);}
    /* No results */
    .picker-no-results{padding:16px 12px;font-size:13px;color:var(--gray-400);text-align:center;}

    /* Line Items Table */
    .line-items-table{width:100%;border-collapse:separate;border-spacing:0;}
    .line-items-table thead th{background:var(--gray-100);padding:10px 14px;font-size:12px;font-weight:700;color:var(--gray-600);text-transform:uppercase;letter-spacing:.5px;text-align:left;border-bottom:1px solid var(--gray-200);}
    .line-items-table thead th:first-child{border-radius:8px 0 0 0;}
    .line-items-table thead th:last-child{border-radius:0 8px 0 0;text-align:right;}
    .line-items-table thead th:nth-child(3),.line-items-table thead th:nth-child(2){text-align:center;}
    .line-items-table tbody td{padding:6px 8px;border-bottom:1px solid var(--gray-100);vertical-align:top;}
    .line-items-table tbody td:last-child{text-align:right;font-family:var(--mono);font-size:14px;vertical-align:middle;}
    .line-items-table tbody td:nth-child(2),.line-items-table tbody td:nth-child(3){text-align:center;vertical-align:middle;}
    .line-items-table .form-input{padding:8px 10px;font-size:14px;}
    .line-items-table .form-input[type="number"]{width:80px;text-align:center;}
    .line-items-table .price-input{width:100px;text-align:right;font-family:var(--mono);}
    .line-items-table .ext-amount{font-weight:600;color:var(--gray-700);min-width:90px;vertical-align:middle;}
    .line-items-table .row-delete{width:36px;height:36px;border:none;background:transparent;color:var(--gray-400);cursor:pointer;border-radius:6px;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
    .line-items-table .row-delete:hover{background:var(--danger-light);color:var(--danger);}
    .custom-item-input{width:100%;margin-top:4px;}

    /* Totals */
    .totals-table{width:300px;}
    .totals-row{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;font-size:14px;}
    .totals-row.subtotal{border-bottom:1px solid var(--gray-200);}
    .totals-row.tax{border-bottom:1px solid var(--gray-200);}
    .totals-row.total{background:var(--gray-100);border-radius:8px;font-size:18px;font-weight:700;margin-top:4px;}
    .totals-label{color:var(--gray-600);font-weight:500;}
    .totals-amount{font-family:var(--mono);font-weight:600;color:var(--gray-800);}
    .tax-rate-inline{width:60px;padding:4px 6px;text-align:center;font-size:13px;border:1.5px solid var(--gray-200);border-radius:6px;font-family:var(--mono);margin:0 4px;}
    .tax-rate-inline:focus{border-color:var(--cfa-red);outline:none;}
    .action-bar{display:flex;gap:12px;margin-top:24px;justify-content:flex-end;flex-wrap:wrap;}

    /* History */
    .search-bar{position:relative;margin-bottom:20px;}
    .search-bar input{width:100%;padding:12px 16px 12px 44px;font-size:15px;border:1.5px solid var(--gray-200);border-radius:10px;font-family:var(--font);background:var(--white);}
    .search-bar input:focus{border-color:var(--cfa-red);outline:none;box-shadow:0 0 0 3px rgba(229,22,54,.08);}
    .search-bar .search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--gray-400);font-size:18px;}
    .quote-list-item{background:var(--white);border:1px solid var(--gray-200);border-radius:var(--radius);padding:16px 20px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all .15s;}
    .quote-list-item:hover{border-color:var(--cfa-red);box-shadow:var(--shadow-md);transform:translateY(-1px);}
    .quote-list-meta{display:flex;flex-direction:column;gap:2px;}
    .quote-list-id{font-family:var(--mono);font-size:13px;color:var(--cfa-red);font-weight:600;}
    .quote-list-customer{font-size:15px;font-weight:600;color:var(--gray-800);}
    .quote-list-details{font-size:13px;color:var(--gray-500);}
    .quote-list-total{font-family:var(--mono);font-size:18px;font-weight:700;color:var(--gray-800);}
    .quote-list-type{font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;text-transform:uppercase;letter-spacing:.5px;}
    .quote-list-type.pickup{background:#DBEAFE;color:#1D4ED8;}
    .quote-list-type.delivery{background:#FEF3C7;color:#92400E;}
    .quote-list-right{display:flex;align-items:center;gap:16px;}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;display:none;align-items:center;justify-content:center;padding:24px;}
    .modal-overlay.show{display:flex;}
    .modal-box{background:var(--white);border-radius:var(--radius-lg);max-width:700px;width:100%;max-height:85vh;overflow-y:auto;padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.15);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .modal-header h2{font-size:20px;font-weight:700;}
    .modal-close{width:36px;height:36px;border:none;background:var(--gray-100);border-radius:8px;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;color:var(--gray-500);}
    .modal-close:hover{background:var(--gray-200);}
    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
    .detail-field label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--gray-400);}
    .detail-field p{font-size:15px;font-weight:500;color:var(--gray-800);margin-top:2px;}
    .detail-items-table{width:100%;border-collapse:collapse;margin:16px 0;}
    .detail-items-table th{background:var(--gray-100);padding:8px 12px;font-size:12px;font-weight:700;text-transform:uppercase;color:var(--gray-600);text-align:left;}
    .detail-items-table th:last-child,.detail-items-table td:last-child{text-align:right;}
    .detail-items-table td{padding:8px 12px;font-size:14px;border-bottom:1px solid var(--gray-100);}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--gray-100);flex-wrap:wrap;}
    .email-prompt{display:none;margin-top:16px;padding:16px;background:var(--gray-50);border-radius:10px;border:1px solid var(--gray-200);}
    .email-prompt.show{display:block;}
    .email-prompt-row{display:flex;gap:10px;align-items:flex-end;}
    .email-prompt-row .form-group{flex:1;margin-bottom:0;}

    /* Settings */
    .settings-field-row{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
    .settings-field-row label{min-width:160px;font-size:14px;font-weight:600;color:var(--gray-600);}
    .settings-field-row input,.settings-field-row select{flex:1;max-width:400px;}
    .settings-field-row textarea{flex:1;max-width:500px;}
    .menu-editor-table{width:100%;border-collapse:collapse;}
    .menu-editor-table th{background:var(--gray-100);padding:10px 14px;text-align:left;font-size:12px;font-weight:700;text-transform:uppercase;color:var(--gray-600);}
    .menu-editor-table td{padding:6px 10px;border-bottom:1px solid var(--gray-100);}
    .menu-editor-table input{width:100%;padding:8px 10px;border:1.5px solid var(--gray-200);border-radius:6px;font-family:var(--font);font-size:14px;}
    .menu-editor-table input:focus{border-color:var(--cfa-red);outline:none;}
    .menu-editor-table .cat-col{width:140px;}
    .menu-editor-table .price-col{width:110px;}
    .menu-editor-table .price-col input{font-family:var(--mono);text-align:right;}
    .menu-editor-table .action-col{width:50px;text-align:center;}
    .logo-preview{width:160px;height:auto;border:1px solid var(--gray-200);border-radius:8px;margin-top:8px;}
    .template-vars{font-size:12px;color:var(--gray-400);margin-top:6px;line-height:1.8;}
    .template-vars code{background:var(--gray-100);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:11px;color:var(--gray-600);}

    /* Spinner/Toast/Confirm */
    .spinner-overlay{position:fixed;inset:0;background:rgba(255,255,255,.7);z-index:300;display:none;align-items:center;justify-content:center;}
    .spinner-overlay.show{display:flex;}
    .spinner{width:40px;height:40px;border:4px solid var(--gray-200);border-top-color:var(--cfa-red);border-radius:50%;animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .toast{position:fixed;bottom:24px;right:24px;padding:14px 24px;border-radius:10px;font-size:14px;font-weight:600;color:var(--white);z-index:400;transform:translateY(100px);opacity:0;transition:all .3s;box-shadow:var(--shadow-lg);max-width:400px;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.success{background:var(--success);}.toast.error{background:var(--danger);}.toast.info{background:var(--gray-700);}
    .empty-state{text-align:center;padding:60px 20px;color:var(--gray-400);}
    .empty-state .empty-icon{font-size:48px;margin-bottom:12px;}
    .confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;display:none;align-items:center;justify-content:center;}
    .confirm-overlay.show{display:flex;}
    .confirm-box{background:var(--white);border-radius:var(--radius-lg);padding:28px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.15);text-align:center;}
    .confirm-box h3{font-size:18px;margin-bottom:8px;}
    .confirm-box p{font-size:14px;color:var(--gray-500);margin-bottom:20px;}
    .confirm-actions{display:flex;gap:10px;justify-content:center;}

    @media(max-width:768px){
      .top-bar{padding:0 16px;}.top-bar-brand h1{font-size:16px;}.tab-btn{padding:8px 14px;font-size:13px;}
      .main-content{padding:16px;}.form-grid{grid-template-columns:1fr;}.detail-grid{grid-template-columns:1fr;}
      .action-bar{justify-content:stretch;}.action-bar .btn{flex:1;justify-content:center;}
      .totals-table{width:100%;}.settings-field-row{flex-direction:column;align-items:flex-start;}
      .settings-field-row input,.settings-field-row select,.settings-field-row textarea{max-width:100%;}
      .quote-list-item{flex-direction:column;align-items:flex-start;gap:10px;}
      .quote-list-right{width:100%;justify-content:space-between;}
      .modal-box{padding:20px;}.email-prompt-row{flex-direction:column;}
      .table-scroll-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch;}
    }
  </style>
</head>
<body>
<div class="app-shell">

  <!-- Top Nav -->
  <header class="top-bar">
    <div class="top-bar-brand">
      <div class="brand-icon">CFA</div>
      <div><h1>Catering Quotes</h1><div class="brand-sub" id="activeLocationLabel">Loading‚Ä¶</div></div>
    </div>
    <nav class="tab-nav">
      <button class="tab-btn active" data-view="newQuote" onclick="switchView('newQuote')">Ôºã New Quote</button>
      <button class="tab-btn" data-view="history" onclick="switchView('history')">History</button>
      <button class="tab-btn" data-view="settings" onclick="switchView('settings')">Settings</button>
    </nav>
  </header>

  <main class="main-content">

    <!-- ‚ïê‚ïê‚ïê VIEW 1: NEW QUOTE ‚ïê‚ïê‚ïê -->
    <section id="view-newQuote" class="view active">
      <div class="card" style="text-align:center;">
        <div class="card-title"><span class="icon red">‚áÑ</span> Order Type</div>
        <div class="order-type-toggle" id="orderTypeToggle">
          <button class="order-type-btn active" data-type="Pickup" onclick="setOrderType('Pickup')">üè™ Pickup</button>
          <button class="order-type-btn" data-type="Delivery" onclick="setOrderType('Delivery')">üöö Delivery</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span class="icon red">üë§</span> Customer Information</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Customer / Organization Name *</label><input type="text" class="form-input" id="customerName" placeholder="e.g., Dallas ISD"><span class="error-msg" id="err-customerName">Customer name is required.</span></div>
          <div class="form-group"><label class="form-label">Contact Person Name *</label><input type="text" class="form-input" id="contactPerson" placeholder="e.g., Jane Smith"><span class="error-msg" id="err-contactPerson">Contact person is required.</span></div>
          <div class="form-group"><label class="form-label">Customer Email</label><input type="email" class="form-input" id="customerEmail" placeholder="e.g., jane@dallasisd.org"><span class="field-hint">Optional ‚Äî used to email the quote directly.</span></div>
          <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="quoteDate"></div>
          <div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="quoteTime"></div>
          <div class="form-group full-width"><label class="form-label" id="addressLabel">Pickup Location</label><input type="text" class="form-input" id="orderAddress" readonly><span class="error-msg" id="err-orderAddress">Delivery address is required.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><span class="icon green">üìã</span> Line Items</div>
        <div class="table-scroll-wrapper">
          <table class="line-items-table" id="lineItemsTable">
            <thead><tr><th style="width:40%">Description</th><th style="width:12%">Qty</th><th style="width:18%">Price/Item</th><th style="width:18%">Amount</th><th style="width:12%"></th></tr></thead>
            <tbody id="lineItemsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-secondary btn-sm" style="margin-top:12px;" onclick="addLineItemRow()">Ôºã Add Row</button>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;">
          <div>
            <div class="card-title"><span class="icon amber">üí∞</span> Totals</div>
            <div class="tax-exempt-toggle" id="taxExemptToggle" onclick="toggleTaxExempt()"><div class="toggle-indicator">‚úì</div><span class="tax-exempt-label">Tax Exempt</span></div>
          </div>
          <div class="totals-table">
            <div class="totals-row subtotal"><span class="totals-label">Subtotal</span><span class="totals-amount" id="subtotalDisplay">$0.00</span></div>
            <div class="totals-row tax"><span class="totals-label">Sales Tax <input type="number" class="tax-rate-inline" id="taxRateInput" value="8.25" step="0.01" min="0" max="99" onchange="recalcTotals()">%</span><span class="totals-amount" id="taxDisplay">$0.00</span></div>
            <div class="totals-row total"><span class="totals-label">Total</span><span class="totals-amount" id="totalDisplay">$0.00</span></div>
          </div>
        </div>
      </div>
      <div class="action-bar">
        <button class="btn btn-secondary btn-lg" onclick="saveQuoteOnly()">üíæ Save Quote</button>
        <button class="btn btn-blue btn-lg" onclick="saveAndEmail()">‚úâÔ∏è Save &amp; Email</button>
        <button class="btn btn-primary btn-lg" onclick="previewAndPrint()">üìÑ Preview &amp; Generate PDF</button>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê VIEW 2: HISTORY ‚ïê‚ïê‚ïê -->
    <section id="view-history" class="view">
      <div class="card">
        <div class="card-title"><span class="icon red">üìÅ</span> Quote History <span style="font-weight:400;color:var(--gray-400);font-size:13px;margin-left:8px;">(Last 30 days)</span></div>
        <div class="search-bar"><span class="search-icon">üîç</span><input type="text" placeholder="Search by customer, contact, or quote ID‚Ä¶" id="historySearch" oninput="filterHistory()"></div>
        <div id="historyList"><div class="empty-state"><div class="empty-icon">üì≠</div><p>No quotes yet.</p></div></div>
      </div>
    </section>

    <!-- ‚ïê‚ïê‚ïê VIEW 3: SETTINGS ‚ïê‚ïê‚ïê -->
    <section id="view-settings" class="view">
      <div class="card">
        <div class="card-title"><span class="icon red">üè¨</span> Store Profile</div>
        <div class="settings-field-row"><label>Active Location</label><select class="form-select" id="settingsActiveLocation" onchange="saveSettingField('Store Name (Active)',this.value)"><option>Loading‚Ä¶</option></select></div>
        <hr style="border:none;border-top:1px solid var(--gray-100);margin:16px 0;">
        <p style="font-size:13px;font-weight:600;color:var(--gray-400);text-transform:uppercase;margin-bottom:12px;">Location 1</p>
        <div class="settings-field-row"><label>Name</label><input class="form-input" id="settingsLoc1Name" onchange="saveSettingField('Location 1 Name',this.value);refreshLocationDropdown();"></div>
        <div class="settings-field-row"><label>Address</label><input class="form-input" id="settingsLoc1Addr" onchange="saveSettingField('Location 1 Address',this.value)"></div>
        <div class="settings-field-row"><label>Phone</label><input class="form-input" id="settingsLoc1Phone" onchange="saveSettingField('Location 1 Phone',this.value)"></div>
        <hr style="border:none;border-top:1px solid var(--gray-100);margin:16px 0;">
        <p style="font-size:13px;font-weight:600;color:var(--gray-400);text-transform:uppercase;margin-bottom:12px;">Location 2</p>
        <div class="settings-field-row"><label>Name</label><input class="form-input" id="settingsLoc2Name" onchange="saveSettingField('Location 2 Name',this.value);refreshLocationDropdown();"></div>
        <div class="settings-field-row"><label>Address</label><input class="form-input" id="settingsLoc2Addr" onchange="saveSettingField('Location 2 Address',this.value)"></div>
        <div class="settings-field-row"><label>Phone</label><input class="form-input" id="settingsLoc2Phone" onchange="saveSettingField('Location 2 Phone',this.value)"></div>
        <hr style="border:none;border-top:1px solid var(--gray-100);margin:16px 0;">
        <div class="settings-field-row"><label>Quote Contact Name</label><input class="form-input" id="settingsContactName" onchange="saveSettingField('Quote Contact Name',this.value)"></div>
      </div>
      <div class="card">
        <div class="card-title"><span class="icon amber">‚öôÔ∏è</span> Tax &amp; Logo</div>
        <div class="settings-field-row"><label>Default Tax Rate (%)</label><input type="number" class="form-input" id="settingsTaxRate" step="0.01" min="0" max="99" style="max-width:120px;" onchange="saveSettingField('Default Tax Rate (%)',this.value)"></div>
        <div class="settings-field-row" style="align-items:flex-start;"><label>Logo</label><div><input type="file" id="logoUpload" accept="image/png,image/jpeg" onchange="handleLogoUpload(event)" style="margin-bottom:8px;"><div id="logoPreviewContainer"></div></div></div>
      </div>
      <div class="card">
        <div class="card-title"><span class="icon blue">‚úâÔ∏è</span> Email Template</div>
        <div class="settings-field-row" style="align-items:flex-start;"><label>Subject Line</label><input class="form-input" id="settingsEmailSubject" onchange="saveSettingField('Email Subject',this.value)"></div>
        <div class="settings-field-row" style="align-items:flex-start;"><label>Email Body</label><textarea class="form-textarea" id="settingsEmailBody" rows="8" onchange="saveSettingField('Email Body',this.value)"></textarea></div>
        <div class="template-vars" style="margin-left:172px;">Placeholders: <code>{{customer}}</code> <code>{{contact}}</code> <code>{{location}}</code> <code>{{phone}}</code> <code>{{quoteId}}</code> <code>{{total}}</code> <code>{{date}}</code></div>
        <div class="settings-field-row" style="margin-top:16px;"><label>BCC Email</label><input class="form-input" id="settingsBccEmail" placeholder="Optional ‚Äî receive a copy of every sent quote" onchange="saveSettingField('BCC Email',this.value)"></div>
        <div class="field-hint" style="margin-left:172px;">Emails are sent from the Google account that deployed this app.</div>
      </div>
      <div class="card">
        <div class="card-title"><span class="icon green">üçî</span> Menu Catalog</div>
        <div class="table-scroll-wrapper">
          <table class="menu-editor-table" id="menuEditorTable">
            <thead><tr><th class="cat-col">Category</th><th>Item Name</th><th class="price-col">Pickup</th><th class="price-col">Delivery</th><th class="action-col"></th></tr></thead>
            <tbody id="menuEditorBody"></tbody>
          </table>
        </div>
        <button class="btn btn-secondary btn-sm" style="margin-top:12px;" onclick="addMenuItemUI()">Ôºã Add Item</button>
      </div>
    </section>
  </main>
</div>

<!-- Overlays -->
<div class="spinner-overlay" id="spinner"><div class="spinner"></div></div>
<div class="toast" id="toast"></div>
<div class="confirm-overlay" id="confirmOverlay"><div class="confirm-box"><h3 id="confirmTitle">Are you sure?</h3><p id="confirmMsg"></p><div class="confirm-actions"><button class="btn btn-secondary" onclick="closeConfirm(false)">Cancel</button><button class="btn btn-primary" onclick="closeConfirm(true)">Confirm</button></div></div></div>
<div class="modal-overlay" id="quoteDetailModal"><div class="modal-box"><div class="modal-header"><h2 id="modalQuoteId">Quote Details</h2><button class="modal-close" onclick="closeModal()">‚úï</button></div><div id="modalBody"></div><div class="modal-actions" id="modalActions"></div><div class="email-prompt" id="modalEmailPrompt"><div style="font-weight:600;font-size:14px;margin-bottom:10px;color:var(--gray-700);">‚úâÔ∏è Send Quote by Email</div><div class="email-prompt-row"><div class="form-group"><label class="form-label">Recipient Email</label><input type="email" class="form-input" id="modalEmailInput" placeholder="customer@example.com"></div><button class="btn btn-blue" onclick="sendEmailFromModal()">Send</button></div></div></div></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPLICATION JAVASCRIPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var appSettings = {}, menuItems = [], allQuotes = [];
var currentOrderType = 'Pickup', isTaxExempt = false, confirmResolve = null, currentModalQuote = null;

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
  showSpinner();
  document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
  loadAppData();
  // Close any open pickers when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.item-picker')) {
      document.querySelectorAll('.item-picker.open').forEach(function(p) { p.classList.remove('open'); });
    }
  });
});

function loadAppData() {
  var loaded = 0;
  function done() { loaded++; if (loaded >= 3) { hideSpinner(); applySettings(); buildLineItemRows(8); refreshLocationDropdown(); } }
  google.script.run.withSuccessHandler(function(s) { appSettings = s; done(); }).withFailureHandler(function(e) { showToast('Settings error: '+e.message,'error'); done(); }).getSettings();
  google.script.run.withSuccessHandler(function(m) { menuItems = m; done(); }).withFailureHandler(function(e) { showToast('Menu error: '+e.message,'error'); done(); }).getMenuItems();
  google.script.run.withSuccessHandler(function(q) { allQuotes = q; done(); }).withFailureHandler(function(e) { showToast('Quotes error: '+e.message,'error'); done(); }).getQuotes();
}

function applySettings() {
  document.getElementById('activeLocationLabel').textContent = appSettings['Store Name (Active)'] || '';
  document.getElementById('taxRateInput').value = parseFloat(appSettings['Default Tax Rate (%)']) || 8.25;
  updateAddressField();
  document.getElementById('settingsLoc1Name').value = appSettings['Location 1 Name'] || '';
  document.getElementById('settingsLoc1Addr').value = appSettings['Location 1 Address'] || '';
  document.getElementById('settingsLoc1Phone').value = appSettings['Location 1 Phone'] || '';
  document.getElementById('settingsLoc2Name').value = appSettings['Location 2 Name'] || '';
  document.getElementById('settingsLoc2Addr').value = appSettings['Location 2 Address'] || '';
  document.getElementById('settingsLoc2Phone').value = appSettings['Location 2 Phone'] || '';
  document.getElementById('settingsContactName').value = appSettings['Quote Contact Name'] || '';
  document.getElementById('settingsTaxRate').value = appSettings['Default Tax Rate (%)'] || 8.25;
  document.getElementById('settingsEmailSubject').value = appSettings['Email Subject'] || '';
  document.getElementById('settingsEmailBody').value = appSettings['Email Body'] || '';
  document.getElementById('settingsBccEmail').value = appSettings['BCC Email'] || '';
  var l = appSettings['Logo (Base64)'] || '';
  document.getElementById('logoPreviewContainer').innerHTML = l ? '<img src="'+l+'" class="logo-preview" alt="Logo">' : '<p style="font-size:13px;color:var(--gray-400);">No logo uploaded.</p>';
  buildMenuEditor();
}

// ‚îÄ‚îÄ View Switching ‚îÄ‚îÄ
function switchView(v) {
  document.querySelectorAll('.view').forEach(function(el) { el.classList.remove('active'); });
  document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById('view-'+v).classList.add('active');
  document.querySelector('.tab-btn[data-view="'+v+'"]').classList.add('active');
  if (v === 'history') renderHistory();
}

// ‚îÄ‚îÄ Order Type ‚îÄ‚îÄ
function setOrderType(type) {
  if (type === currentOrderType) return;
  var has = false;
  document.querySelectorAll('.item-picker').forEach(function(p) { if (p.dataset.value && p.dataset.value !== '__custom__') has = true; });
  if (has) { showConfirm('Switch to '+type+'?','All item prices will update to '+type.toLowerCase()+' pricing.').then(function(ok) { if (ok) applyOrderType(type); }); }
  else applyOrderType(type);
}
function applyOrderType(type) {
  currentOrderType = type;
  document.querySelectorAll('.order-type-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.type===type); });
  updateAddressField(); recalcAllPrices();
}
function updateAddressField() {
  var inp = document.getElementById('orderAddress'), lbl = document.getElementById('addressLabel');
  if (currentOrderType === 'Pickup') {
    lbl.textContent = 'Pickup Location';
    var an = appSettings['Store Name (Active)'] || '';
    inp.value = an === (appSettings['Location 2 Name']||'') ? (appSettings['Location 2 Address']||'') : (appSettings['Location 1 Address']||'');
    inp.readOnly = true;
  } else { lbl.textContent = 'Delivery Address *'; inp.value = ''; inp.readOnly = false; inp.placeholder = 'Enter delivery address‚Ä¶'; }
}
function recalcAllPrices() {
  document.querySelectorAll('.line-item-row').forEach(function(row) {
    var picker = row.querySelector('.item-picker');
    var priceInput = row.querySelector('.line-item-price');
    var val = picker.dataset.value || '';
    if (val && val !== '__custom__') {
      var item = menuItems.find(function(m) { return m.name === val; });
      if (item) priceInput.value = (currentOrderType === 'Delivery' ? item.deliveryPrice : item.pickupPrice).toFixed(2);
    }
    calcRowAmount(row);
  });
  recalcTotals();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCHABLE ITEM PICKER ‚Äî builds categorized dropdown
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildPickerHtml(filterText) {
  // Group items by category
  var cats = {};
  var uncategorized = [];
  menuItems.forEach(function(item) {
    var c = item.category || '';
    if (c) { if (!cats[c]) cats[c] = []; cats[c].push(item); }
    else uncategorized.push(item);
  });
  var catNames = Object.keys(cats).sort();
  var ft = (filterText || '').toLowerCase();
  var html = '';
  var hasResults = false;

  function matchesFilter(item) {
    if (!ft) return true;
    return item.name.toLowerCase().indexOf(ft) >= 0 || item.category.toLowerCase().indexOf(ft) >= 0;
  }

  // Categorized items
  catNames.forEach(function(cat) {
    var filtered = cats[cat].filter(matchesFilter);
    if (filtered.length === 0) return;
    html += '<div class="picker-cat-header">' + escHtml(cat) + '</div>';
    filtered.forEach(function(item) {
      var price = currentOrderType === 'Delivery' ? item.deliveryPrice : item.pickupPrice;
      html += '<div class="picker-option" data-name="' + escAttr(item.name) + '" onclick="selectPickerItem(this)">' +
        '<span>' + escHtml(item.name) + '</span>' +
        '<span class="picker-price">$' + price.toFixed(2) + '</span></div>';
      hasResults = true;
    });
  });

  // Uncategorized items
  var filteredUncat = uncategorized.filter(matchesFilter);
  if (filteredUncat.length > 0) {
    if (catNames.length > 0) html += '<div class="picker-cat-header">Other</div>';
    filteredUncat.forEach(function(item) {
      var price = currentOrderType === 'Delivery' ? item.deliveryPrice : item.pickupPrice;
      html += '<div class="picker-option" data-name="' + escAttr(item.name) + '" onclick="selectPickerItem(this)">' +
        '<span>' + escHtml(item.name) + '</span>' +
        '<span class="picker-price">$' + price.toFixed(2) + '</span></div>';
      hasResults = true;
    });
  }

  if (!hasResults && ft) {
    html += '<div class="picker-no-results">No items match "' + escHtml(ft) + '"</div>';
  }

  // Custom item option always at the bottom
  html += '<div class="picker-option custom-opt" data-name="__custom__" onclick="selectPickerItem(this)">‚úèÔ∏è Custom Item (freeform)</div>';

  return html;
}

function createItemPicker() {
  var div = document.createElement('div');
  div.className = 'item-picker';
  div.dataset.value = '';
  div.innerHTML = '<input type="text" class="item-picker-input" placeholder="Search or select an item‚Ä¶" autocomplete="off">' +
    '<div class="item-picker-dropdown"></div>' +
    '<input type="text" class="form-input custom-item-input" style="display:none;" placeholder="Enter custom item name‚Ä¶">';

  var input = div.querySelector('.item-picker-input');
  var dropdown = div.querySelector('.item-picker-dropdown');

  // Open on click/focus
  input.addEventListener('focus', function() {
    // Close other pickers
    document.querySelectorAll('.item-picker.open').forEach(function(p) { if (p !== div) p.classList.remove('open'); });
    dropdown.innerHTML = buildPickerHtml(input.value);
    div.classList.add('open');
  });

  // Filter on typing
  input.addEventListener('input', function() {
    dropdown.innerHTML = buildPickerHtml(input.value);
    div.classList.add('open');
    // If user clears, reset selection
    if (!input.value.trim()) {
      div.dataset.value = '';
      div.querySelector('.custom-item-input').style.display = 'none';
    }
  });

  // Keyboard nav
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { div.classList.remove('open'); input.blur(); }
    if (e.key === 'Enter') {
      var highlighted = dropdown.querySelector('.picker-option.highlighted');
      if (highlighted) { highlighted.click(); e.preventDefault(); }
      else {
        var first = dropdown.querySelector('.picker-option');
        if (first) { first.click(); e.preventDefault(); }
      }
    }
    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
      e.preventDefault();
      var opts = Array.from(dropdown.querySelectorAll('.picker-option'));
      if (opts.length === 0) return;
      var cur = dropdown.querySelector('.picker-option.highlighted');
      var idx = cur ? opts.indexOf(cur) : -1;
      if (cur) cur.classList.remove('highlighted');
      if (e.key === 'ArrowDown') idx = (idx + 1) % opts.length;
      else idx = idx <= 0 ? opts.length - 1 : idx - 1;
      opts[idx].classList.add('highlighted');
      opts[idx].scrollIntoView({ block: 'nearest' });
    }
  });

  return div;
}

function selectPickerItem(optionEl) {
  var picker = optionEl.closest('.item-picker');
  var input = picker.querySelector('.item-picker-input');
  var customInput = picker.querySelector('.custom-item-input');
  var row = picker.closest('.line-item-row');
  var priceInput = row.querySelector('.line-item-price');
  var name = optionEl.dataset.name;

  if (name === '__custom__') {
    picker.dataset.value = '__custom__';
    input.value = 'Custom Item';
    customInput.style.display = 'block';
    customInput.focus();
    priceInput.value = '';
  } else {
    picker.dataset.value = name;
    input.value = name;
    customInput.style.display = 'none';
    customInput.value = '';
    var item = menuItems.find(function(m) { return m.name === name; });
    if (item) priceInput.value = (currentOrderType === 'Delivery' ? item.deliveryPrice : item.pickupPrice).toFixed(2);
  }

  picker.classList.remove('open');
  calcRowAmount(row);
  recalcTotals();
}


// ‚îÄ‚îÄ Line Items ‚îÄ‚îÄ
function buildLineItemRows(count) { document.getElementById('lineItemsBody').innerHTML = ''; for (var i = 0; i < count; i++) addLineItemRow(); }

function addLineItemRow() {
  var body = document.getElementById('lineItemsBody');
  var tr = document.createElement('tr');
  tr.className = 'line-item-row';

  // Build cells
  var tdItem = document.createElement('td');
  tdItem.appendChild(createItemPicker());

  tr.appendChild(tdItem);
  tr.insertAdjacentHTML('beforeend',
    '<td><input type="number" class="form-input line-item-qty" min="0" step="1" value="" placeholder="0" oninput="calcRowAmount(this.closest(\'.line-item-row\'));recalcTotals();"></td>' +
    '<td><input type="number" class="form-input price-input line-item-price" min="0" step="0.01" value="" placeholder="0.00" oninput="calcRowAmount(this.closest(\'.line-item-row\'));recalcTotals();"></td>' +
    '<td class="ext-amount" data-amount="0">$0.00</td>' +
    '<td><button class="row-delete" onclick="deleteLineRow(this)" title="Remove">‚úï</button></td>');
  body.appendChild(tr);
}

function calcRowAmount(row) {
  var q = parseFloat(row.querySelector('.line-item-qty').value) || 0;
  var p = parseFloat(row.querySelector('.line-item-price').value) || 0;
  var c = row.querySelector('.ext-amount'); c.dataset.amount = q*p; c.textContent = '$'+(q*p).toFixed(2);
}
function deleteLineRow(btn) { btn.closest('.line-item-row').remove(); recalcTotals(); }
function recalcTotals() {
  var sub = 0; document.querySelectorAll('.ext-amount').forEach(function(c) { sub += parseFloat(c.dataset.amount)||0; });
  var tr = parseFloat(document.getElementById('taxRateInput').value)||0;
  var ta = isTaxExempt ? 0 : sub*(tr/100);
  document.getElementById('subtotalDisplay').textContent = '$'+sub.toFixed(2);
  document.getElementById('taxDisplay').textContent = isTaxExempt?'$0.00':'$'+ta.toFixed(2);
  document.getElementById('totalDisplay').textContent = '$'+(sub+ta).toFixed(2);
}
function toggleTaxExempt() { isTaxExempt = !isTaxExempt; document.getElementById('taxExemptToggle').classList.toggle('active',isTaxExempt); recalcTotals(); }

// ‚îÄ‚îÄ Validation ‚îÄ‚îÄ
function validateForm() {
  var ok = true;
  ['customerName','contactPerson','orderAddress'].forEach(function(id) { document.getElementById(id).classList.remove('error'); });
  document.querySelectorAll('.error-msg').forEach(function(e) { e.classList.remove('show'); });
  if (!document.getElementById('customerName').value.trim()) { document.getElementById('customerName').classList.add('error'); document.getElementById('err-customerName').classList.add('show'); ok=false; }
  if (!document.getElementById('contactPerson').value.trim()) { document.getElementById('contactPerson').classList.add('error'); document.getElementById('err-contactPerson').classList.add('show'); ok=false; }
  if (currentOrderType==='Delivery' && !document.getElementById('orderAddress').value.trim()) { document.getElementById('orderAddress').classList.add('error'); document.getElementById('err-orderAddress').classList.add('show'); ok=false; }
  var hasItem = false;
  document.querySelectorAll('.line-item-row').forEach(function(row) {
    var val = row.querySelector('.item-picker').dataset.value || '';
    var qty = parseFloat(row.querySelector('.line-item-qty').value)||0;
    if (val && qty > 0) hasItem = true;
  });
  if (!hasItem) { showToast('Add at least one item with a quantity.','error'); ok=false; }
  return ok;
}

// ‚îÄ‚îÄ Collect Data ‚îÄ‚îÄ
function collectFormData() {
  var li = [];
  document.querySelectorAll('.line-item-row').forEach(function(row) {
    var picker = row.querySelector('.item-picker');
    var val = picker.dataset.value || '';
    var custom = picker.querySelector('.custom-item-input');
    var qty = parseFloat(row.querySelector('.line-item-qty').value)||0;
    var price = parseFloat(row.querySelector('.line-item-price').value)||0;
    var desc = val === '__custom__' ? custom.value.trim() : val;
    if (desc && qty > 0) li.push({description:desc, quantity:qty, price:price, amount:qty*price});
  });
  var sub = 0; li.forEach(function(i) { sub += i.amount; });
  var tr = parseFloat(document.getElementById('taxRateInput').value)||0;
  var ta = isTaxExempt ? 0 : sub*(tr/100);
  return {
    customerName:document.getElementById('customerName').value.trim(),
    contactName:document.getElementById('contactPerson').value.trim(),
    customerEmail:document.getElementById('customerEmail').value.trim(),
    orderType:currentOrderType, deliveryAddress:document.getElementById('orderAddress').value.trim(),
    date:document.getElementById('quoteDate').value, time:document.getElementById('quoteTime').value,
    lineItems:li, subtotal:sub, taxRate:tr, taxAmount:ta, total:sub+ta,
    taxExempt:isTaxExempt, locationName:appSettings['Store Name (Active)']||''
  };
}

// ‚îÄ‚îÄ Save / Email / Print ‚îÄ‚îÄ
function saveQuoteOnly() { if (!validateForm()) return; showSpinner();
  google.script.run.withSuccessHandler(function(id) { hideSpinner(); showToast('Quote '+id+' saved!','success'); resetForm(); google.script.run.withSuccessHandler(function(q){allQuotes=q;}).getQuotes();
  }).withFailureHandler(function(e) { hideSpinner(); showToast('Error: '+e.message,'error'); }).saveQuote(collectFormData());
}
function saveAndEmail() { if (!validateForm()) return; var d = collectFormData();
  if (!d.customerEmail) { showToast('Enter a customer email to send the quote.','error'); document.getElementById('customerEmail').focus(); return; }
  showSpinner();
  google.script.run.withSuccessHandler(function(id) { d.quoteId=id;
    google.script.run.withSuccessHandler(function() { hideSpinner(); showToast('Quote '+id+' emailed to '+d.customerEmail+'!','success'); resetForm(); google.script.run.withSuccessHandler(function(q){allQuotes=q;}).getQuotes();
    }).withFailureHandler(function(e) { hideSpinner(); showToast('Saved but email failed: '+e.message,'error'); resetForm(); google.script.run.withSuccessHandler(function(q){allQuotes=q;}).getQuotes(); }).sendQuoteEmail(d, d.customerEmail);
  }).withFailureHandler(function(e) { hideSpinner(); showToast('Error: '+e.message,'error'); }).saveQuote(d);
}
function previewAndPrint() { if (!validateForm()) return; var d = collectFormData(); showSpinner();
  google.script.run.withSuccessHandler(function(id) { d.quoteId=id;
    google.script.run.withSuccessHandler(function(pd) { hideSpinner(); pd.quoteId=id; openPrintWindow(pd); showToast('Quote '+id+' saved!','success'); resetForm(); google.script.run.withSuccessHandler(function(q){allQuotes=q;}).getQuotes();
    }).withFailureHandler(function(e) { hideSpinner(); showToast('Error: '+e.message,'error'); }).getPrintData(d);
  }).withFailureHandler(function(e) { hideSpinner(); showToast('Error: '+e.message,'error'); }).saveQuote(d);
}
function generatePDFFromQuote(q) { showSpinner();
  var li=[]; try{li=JSON.parse(q.lineItems);}catch(e){}
  var d={customerName:q.customerName,contactName:q.contactName,orderType:q.orderType,deliveryAddress:q.deliveryAddress,date:q.createdDate?new Date(q.createdDate).toLocaleDateString():'',time:'',lineItems:li,subtotal:q.subtotal,taxRate:q.taxRateUsed,taxAmount:q.taxAmount,total:q.total,taxExempt:q.taxExempt==='TRUE'||q.taxExempt===true,locationName:q.locationName,quoteId:q.quoteId};
  google.script.run.withSuccessHandler(function(pd) { hideSpinner(); pd.quoteId=q.quoteId; openPrintWindow(pd); }).withFailureHandler(function(e) { hideSpinner(); showToast('Error: '+e.message,'error'); }).getPrintData(d);
}
function showModalEmailPrompt(q) { currentModalQuote=q; document.getElementById('modalEmailInput').value=q.customerEmail||''; document.getElementById('modalEmailPrompt').classList.add('show'); }
function sendEmailFromModal() {
  var email = document.getElementById('modalEmailInput').value.trim();
  if (!email) { showToast('Enter an email address.','error'); return; }
  var q = currentModalQuote; if (!q) return;
  var li=[]; try{li=JSON.parse(q.lineItems);}catch(e){}
  var d={customerName:q.customerName,contactName:q.contactName,customerEmail:email,orderType:q.orderType,deliveryAddress:q.deliveryAddress,date:q.createdDate?new Date(q.createdDate).toLocaleDateString():'',time:'',lineItems:li,subtotal:q.subtotal,taxRate:q.taxRateUsed,taxAmount:q.taxAmount,total:q.total,taxExempt:q.taxExempt==='TRUE'||q.taxExempt===true,locationName:q.locationName,quoteId:q.quoteId};
  showSpinner(); closeModal();
  google.script.run.withSuccessHandler(function() { hideSpinner(); showToast('Email sent to '+email+'!','success'); }).withFailureHandler(function(e) { hideSpinner(); showToast('Email failed: '+e.message,'error'); }).sendQuoteEmail(d,email);
}

// ‚îÄ‚îÄ Print Window ‚îÄ‚îÄ
function openPrintWindow(data) {
  var win = window.open('','_blank','width=850,height=1100');
  if (!win) { showToast('Pop-up blocked! Allow pop-ups for this site.','error'); return; }
  var liH=''; (data.lineItems||[]).forEach(function(i) { liH+='<tr><td style="text-align:center;padding:10px 12px;border-bottom:1px solid #E5E7EB;font-size:14px;">'+i.quantity+'</td><td style="padding:10px 12px;border-bottom:1px solid #E5E7EB;font-size:14px;">'+escHtml(i.description)+'</td><td style="text-align:right;padding:10px 12px;border-bottom:1px solid #E5E7EB;font-family:monospace;font-size:14px;">$'+(i.price||0).toFixed(2)+'</td><td style="text-align:right;padding:10px 12px;border-bottom:1px solid #E5E7EB;font-family:monospace;font-size:14px;font-weight:600;">$'+(i.amount||0).toFixed(2)+'</td></tr>'; });
  var tl=data.taxExempt?'<tr><td style="padding:8px 16px;font-size:14px;color:#6B7280;">TAX EXEMPT</td><td style="padding:8px 16px;text-align:right;font-family:monospace;font-size:14px;">$0.00</td></tr>':'<tr><td style="padding:8px 16px;font-size:14px;color:#6B7280;">SALES TAX ('+(data.taxRate||0)+'%)</td><td style="padding:8px 16px;text-align:right;font-family:monospace;font-size:14px;">$'+(data.taxAmount||0).toFixed(2)+'</td></tr>';
  var ad=data.orderType==='Delivery'?(data.deliveryAddress||''):(data.storeAddress||'');
  var lo=data.logo?'<img src="'+data.logo+'" style="max-width:140px;max-height:80px;margin-bottom:8px;" alt="Logo">':'<div style="font-size:24px;font-weight:800;color:#E51636;margin-bottom:8px;">Chick-fil-A</div>';
  var h='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Quote '+escHtml(data.quoteId||'')+'</title><style>@page{size:letter;margin:0.6in;}body{font-family:-apple-system,"Segoe UI",Helvetica,Arial,sans-serif;color:#1F2937;margin:0;padding:40px;}@media print{body{padding:0;}.no-print{display:none!important;}}.print-btn{background:#E51636;color:white;border:none;padding:12px 32px;font-size:15px;font-weight:700;border-radius:8px;cursor:pointer;font-family:inherit;}.print-btn:hover{background:#C41230;}</style></head><body>'+
    '<div class="no-print" style="text-align:center;margin-bottom:24px;padding:16px;background:#F9FAFB;border-radius:10px;"><button class="print-btn" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button><p style="font-size:13px;color:#6B7280;margin-top:8px;">Use "Save as PDF" in the print dialog.</p></div>'+
    '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;"><div>'+lo+'<div style="font-size:16px;font-weight:700;">'+escHtml(data.storeName||'')+'</div><div style="font-size:13px;color:#6B7280;margin-top:2px;">'+escHtml(data.storeAddress||'')+'</div><div style="font-size:13px;color:#6B7280;">'+escHtml(data.storePhone||'')+'</div></div><div style="text-align:right;"><div style="font-size:36px;font-weight:300;color:#D1D5DB;letter-spacing:2px;">QUOTE</div><div style="font-size:13px;color:#6B7280;margin-top:4px;font-family:monospace;">'+escHtml(data.quoteId||'')+'</div><div style="font-size:13px;color:#6B7280;margin-top:8px;">Date: '+escHtml(data.date||'')+'</div>'+(data.time?'<div style="font-size:13px;color:#6B7280;">Time: '+escHtml(data.time)+'</div>':'')+'<div style="font-size:14px;font-weight:700;margin-top:8px;">For: '+escHtml(data.customerName||'')+'</div><div style="font-size:13px;color:#6B7280;">'+escHtml(data.orderType||'')+'</div><div style="font-size:13px;color:#6B7280;">'+escHtml(ad)+'</div><div style="font-size:13px;font-weight:600;margin-top:4px;">'+escHtml(data.contactPerson||'')+'</div></div></div>'+
    '<table style="width:100%;border-collapse:collapse;margin-bottom:24px;"><thead><tr style="background:#F3F4F6;"><th style="padding:10px 12px;text-align:center;font-size:12px;font-weight:700;color:#4B5563;text-transform:uppercase;border-bottom:2px solid #E5E7EB;width:10%;">QTY</th><th style="padding:10px 12px;text-align:left;font-size:12px;font-weight:700;color:#4B5563;text-transform:uppercase;border-bottom:2px solid #E5E7EB;width:50%;">DESCRIPTION</th><th style="padding:10px 12px;text-align:right;font-size:12px;font-weight:700;color:#4B5563;text-transform:uppercase;border-bottom:2px solid #E5E7EB;width:18%;">PRICE/ITEM</th><th style="padding:10px 12px;text-align:right;font-size:12px;font-weight:700;color:#4B5563;text-transform:uppercase;border-bottom:2px solid #E5E7EB;width:22%;">AMOUNT</th></tr></thead><tbody>'+liH+'</tbody></table>'+
    '<div style="display:flex;justify-content:space-between;align-items:flex-end;"><div style="font-size:13px;color:#6B7280;max-width:320px;">If you have any questions concerning this Quote, contact:<br><strong style="color:#1F2937;">'+escHtml(data.contactName||'')+' at '+escHtml(data.storePhone||'')+'</strong></div><table style="width:280px;background:#F9FAFB;border-radius:8px;overflow:hidden;"><tr><td style="padding:8px 16px;font-size:14px;color:#6B7280;">SUBTOTAL</td><td style="padding:8px 16px;text-align:right;font-family:monospace;font-size:14px;">$'+(data.subtotal||0).toFixed(2)+'</td></tr>'+tl+'<tr style="background:#E5E7EB;"><td style="padding:10px 16px;font-size:15px;font-weight:700;">TOTAL</td><td style="padding:10px 16px;text-align:right;font-family:monospace;font-size:16px;font-weight:700;">$'+(data.total||0).toFixed(2)+'</td></tr></table></div></body></html>';
  win.document.write(h); win.document.close();
}

// ‚îÄ‚îÄ Reset ‚îÄ‚îÄ
function resetForm() {
  document.getElementById('customerName').value=''; document.getElementById('contactPerson').value='';
  document.getElementById('customerEmail').value=''; document.getElementById('quoteDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('quoteTime').value=''; currentOrderType='Pickup'; isTaxExempt=false;
  document.getElementById('taxExemptToggle').classList.remove('active');
  document.querySelectorAll('.order-type-btn').forEach(function(b){b.classList.toggle('active',b.dataset.type==='Pickup');});
  updateAddressField(); document.getElementById('taxRateInput').value=appSettings['Default Tax Rate (%)']||8.25;
  buildLineItemRows(8); recalcTotals();
  document.querySelectorAll('.error-msg').forEach(function(e){e.classList.remove('show');});
  document.querySelectorAll('.form-input.error').forEach(function(e){e.classList.remove('error');});
}

// ‚îÄ‚îÄ History ‚îÄ‚îÄ
function renderHistory() { showSpinner();
  google.script.run.withSuccessHandler(function(q) { allQuotes=q; hideSpinner(); displayHistory(q); }).withFailureHandler(function(e) { hideSpinner(); showToast('Error: '+e.message,'error'); }).getQuotes();
}
function displayHistory(quotes) {
  var c = document.getElementById('historyList');
  if (!quotes||!quotes.length) { c.innerHTML='<div class="empty-state"><div class="empty-icon">üì≠</div><p>No quotes found.</p></div>'; return; }
  var h=''; quotes.forEach(function(q,i) {
    var ds=q.createdDate?new Date(q.createdDate).toLocaleDateString():'';
    h+='<div class="quote-list-item" onclick="openQuoteDetail('+i+')"><div class="quote-list-meta"><span class="quote-list-id">'+escHtml(q.quoteId)+'</span><span class="quote-list-customer">'+escHtml(q.customerName)+'</span><span class="quote-list-details">'+ds+' ¬∑ '+escHtml(q.contactName||'')+(q.customerEmail?' ¬∑ '+escHtml(q.customerEmail):'')+'</span></div><div class="quote-list-right"><span class="quote-list-type '+(q.orderType||'').toLowerCase()+'">'+escHtml(q.orderType||'')+'</span><span class="quote-list-total">$'+(parseFloat(q.total)||0).toFixed(2)+'</span></div></div>';
  }); c.innerHTML=h;
}
function filterHistory() {
  var f=document.getElementById('historySearch').value.toLowerCase().trim();
  if (!f) { displayHistory(allQuotes); return; }
  displayHistory(allQuotes.filter(function(q) { return (q.customerName||'').toLowerCase().indexOf(f)>=0||(q.contactName||'').toLowerCase().indexOf(f)>=0||(q.quoteId||'').toLowerCase().indexOf(f)>=0; }));
}

// ‚îÄ‚îÄ Quote Detail Modal ‚îÄ‚îÄ
function openQuoteDetail(idx) {
  var q=allQuotes[idx]; if (!q) return; currentModalQuote=q;
  document.getElementById('modalQuoteId').textContent=q.quoteId;
  var ds=q.createdDate?new Date(q.createdDate).toLocaleDateString():'';
  var li=[]; try{li=JSON.parse(q.lineItems);}catch(e){}
  var te=q.taxExempt==='TRUE'||q.taxExempt===true;
  var h='<div class="detail-grid"><div class="detail-field"><label>Customer</label><p>'+escHtml(q.customerName)+'</p></div><div class="detail-field"><label>Contact</label><p>'+escHtml(q.contactName)+'</p></div><div class="detail-field"><label>Date</label><p>'+ds+'</p></div><div class="detail-field"><label>Order Type</label><p>'+escHtml(q.orderType)+'</p></div><div class="detail-field"><label>Location</label><p>'+escHtml(q.locationName||'')+'</p></div>'+(q.customerEmail?'<div class="detail-field"><label>Email</label><p>'+escHtml(q.customerEmail)+'</p></div>':'')+(q.orderType==='Delivery'?'<div class="detail-field"><label>Delivery Address</label><p>'+escHtml(q.deliveryAddress)+'</p></div>':'')+'</div>';
  if (li.length) { h+='<table class="detail-items-table"><thead><tr><th>Qty</th><th>Description</th><th>Price</th><th>Amount</th></tr></thead><tbody>'; li.forEach(function(i){h+='<tr><td>'+i.quantity+'</td><td>'+escHtml(i.description)+'</td><td style="font-family:var(--mono);">$'+(i.price||0).toFixed(2)+'</td><td style="font-family:var(--mono);">$'+(i.amount||0).toFixed(2)+'</td></tr>';}); h+='</tbody></table>'; }
  h+='<div style="display:flex;justify-content:flex-end;margin-top:12px;"><div class="totals-table"><div class="totals-row subtotal"><span class="totals-label">Subtotal</span><span class="totals-amount">$'+(parseFloat(q.subtotal)||0).toFixed(2)+'</span></div><div class="totals-row tax"><span class="totals-label">'+(te?'Tax Exempt':'Tax ('+q.taxRateUsed+'%)')+'</span><span class="totals-amount">$'+(parseFloat(q.taxAmount)||0).toFixed(2)+'</span></div><div class="totals-row total"><span class="totals-label">Total</span><span class="totals-amount">$'+(parseFloat(q.total)||0).toFixed(2)+'</span></div></div></div>';
  document.getElementById('modalBody').innerHTML=h;
  document.getElementById('modalActions').innerHTML='<button class="btn btn-danger btn-sm" onclick="deleteQuoteAction('+q.sheetRow+')">üóë Delete</button><button class="btn btn-secondary btn-sm" onclick="editAndReuse('+idx+')">‚úèÔ∏è Edit &amp; Reuse</button><button class="btn btn-blue btn-sm" onclick="showModalEmailPrompt(allQuotes['+idx+'])">‚úâÔ∏è Email</button><button class="btn btn-primary btn-sm" onclick="generatePDFFromQuote(allQuotes['+idx+']);closeModal();">üìÑ PDF</button>';
  document.getElementById('modalEmailPrompt').classList.remove('show');
  document.getElementById('quoteDetailModal').classList.add('show');
}
function closeModal() { document.getElementById('quoteDetailModal').classList.remove('show'); document.getElementById('modalEmailPrompt').classList.remove('show'); currentModalQuote=null; }
function deleteQuoteAction(sr) { showConfirm('Delete this quote?','This cannot be undone.').then(function(ok) { if(!ok) return; closeModal(); showSpinner();
  google.script.run.withSuccessHandler(function() { hideSpinner(); showToast('Deleted.','info'); renderHistory(); }).withFailureHandler(function(e) { hideSpinner(); showToast('Error: '+e.message,'error'); }).deleteQuote(sr); }); }

function editAndReuse(idx) {
  var q=allQuotes[idx]; if (!q) return; closeModal(); switchView('newQuote');
  document.getElementById('customerName').value=q.customerName||'';
  document.getElementById('contactPerson').value=q.contactName||'';
  document.getElementById('customerEmail').value=q.customerEmail||'';
  if (q.createdDate) document.getElementById('quoteDate').value=new Date(q.createdDate).toISOString().split('T')[0];
  currentOrderType=q.orderType||'Pickup';
  document.querySelectorAll('.order-type-btn').forEach(function(b){b.classList.toggle('active',b.dataset.type===currentOrderType);});
  updateAddressField();
  if (currentOrderType==='Delivery') document.getElementById('orderAddress').value=q.deliveryAddress||'';
  isTaxExempt=q.taxExempt==='TRUE'||q.taxExempt===true;
  document.getElementById('taxExemptToggle').classList.toggle('active',isTaxExempt);
  document.getElementById('taxRateInput').value=q.taxRateUsed||appSettings['Default Tax Rate (%)']||8.25;
  var li=[]; try{li=JSON.parse(q.lineItems);}catch(e){}
  var body=document.getElementById('lineItemsBody'); body.innerHTML='';
  li.forEach(function(item) {
    addLineItemRow();
    var rows=body.querySelectorAll('.line-item-row'), row=rows[rows.length-1];
    var picker=row.querySelector('.item-picker'), input=picker.querySelector('.item-picker-input'), custom=picker.querySelector('.custom-item-input');
    var match=menuItems.find(function(m){return m.name===item.description;});
    if (match) { picker.dataset.value=match.name; input.value=match.name; }
    else { picker.dataset.value='__custom__'; input.value='Custom Item'; custom.style.display='block'; custom.value=item.description; }
    row.querySelector('.line-item-qty').value=item.quantity;
    row.querySelector('.line-item-price').value=(item.price||0).toFixed(2);
    calcRowAmount(row);
  });
  var cur=body.querySelectorAll('.line-item-row').length;
  for (var i=cur;i<8;i++) addLineItemRow();
  recalcTotals();
}

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ
function saveSettingField(l,v) { google.script.run.withSuccessHandler(function() { appSettings[l]=v; if(l==='Store Name (Active)'){document.getElementById('activeLocationLabel').textContent=v;updateAddressField();} showToast('Saved!','success'); }).withFailureHandler(function(e){showToast('Error: '+e.message,'error');}).updateSetting(l,v); }
function refreshLocationDropdown() {
  var s=document.getElementById('settingsActiveLocation'), l1=appSettings['Location 1 Name']||'Location 1', l2=appSettings['Location 2 Name']||'Location 2', a=appSettings['Store Name (Active)']||l1;
  s.innerHTML='<option value="'+escHtml(l1)+'"'+(a===l1?' selected':'')+'>'+escHtml(l1)+'</option><option value="'+escHtml(l2)+'"'+(a===l2?' selected':'')+'>'+escHtml(l2)+'</option>';
}

// ‚îÄ‚îÄ Menu Editor (with Category column) ‚îÄ‚îÄ
function buildMenuEditor() {
  var body=document.getElementById('menuEditorBody'); body.innerHTML='';
  menuItems.forEach(function(item) {
    var tr=document.createElement('tr');
    tr.innerHTML='<td class="cat-col"><input class="menu-cat-input" value="'+escAttr(item.category)+'" data-row="'+item.row+'"></td><td><input class="menu-name-input" value="'+escAttr(item.name)+'" data-row="'+item.row+'"></td><td class="price-col"><input class="menu-pickup-input" type="number" step="0.01" min="0" value="'+item.pickupPrice.toFixed(2)+'" data-row="'+item.row+'"></td><td class="price-col"><input class="menu-delivery-input" type="number" step="0.01" min="0" value="'+item.deliveryPrice.toFixed(2)+'" data-row="'+item.row+'"></td><td class="action-col"><button class="btn btn-danger btn-sm" style="padding:5px 8px;" onclick="deleteMenuItemUI('+item.row+')" title="Delete">‚úï</button></td>';
    var ci=tr.querySelector('.menu-cat-input'), ni=tr.querySelector('.menu-name-input'), pi=tr.querySelector('.menu-pickup-input'), di=tr.querySelector('.menu-delivery-input');
    [ci,ni,pi,di].forEach(function(inp) { inp.addEventListener('change',function() { saveMenuItemInline(parseInt(ni.dataset.row),ci.value,ni.value,pi.value,di.value); }); });
    body.appendChild(tr);
  });
}
function saveMenuItemInline(row,cat,name,pickup,delivery) {
  google.script.run.withSuccessHandler(function() { showToast('Updated.','success');
    google.script.run.withSuccessHandler(function(m){menuItems=m;}).getMenuItems(); // refresh data, pickers auto-rebuild on next open
  }).withFailureHandler(function(e){showToast('Error: '+e.message,'error');}).updateMenuItem(row,cat,name,parseFloat(pickup)||0,parseFloat(delivery)||0);
}
function addMenuItemUI() { showSpinner();
  google.script.run.withSuccessHandler(function() { hideSpinner(); showToast('Item added.','success');
    google.script.run.withSuccessHandler(function(m){menuItems=m;buildMenuEditor();}).getMenuItems();
  }).withFailureHandler(function(e){hideSpinner();showToast('Error: '+e.message,'error');}).addMenuItem('','New Item',0,0);
}
function deleteMenuItemUI(row) { showConfirm('Delete item?','Remove from menu.').then(function(ok) { if(!ok) return; showSpinner();
  google.script.run.withSuccessHandler(function() { hideSpinner(); showToast('Deleted.','success');
    google.script.run.withSuccessHandler(function(m){menuItems=m;buildMenuEditor();}).getMenuItems();
  }).withFailureHandler(function(e){hideSpinner();showToast('Error: '+e.message,'error');}).deleteMenuItem(row); }); }

// ‚îÄ‚îÄ Logo Upload ‚îÄ‚îÄ
function handleLogoUpload(e) { var f=e.target.files[0]; if (!f) return;
  if (!f.type.match('image/(png|jpeg|jpg)')) { showToast('Upload PNG or JPG.','error'); return; }
  var r=new FileReader(); r.onload=function(ev) { var b=ev.target.result; showSpinner();
    google.script.run.withSuccessHandler(function() { hideSpinner(); appSettings['Logo (Base64)']=b; document.getElementById('logoPreviewContainer').innerHTML='<img src="'+b+'" class="logo-preview" alt="Logo">'; showToast('Logo updated!','success');
    }).withFailureHandler(function(e){hideSpinner();showToast('Error: '+e.message,'error');}).updateSetting('Logo (Base64)',b);
  }; r.readAsDataURL(f); }

// ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ
function escHtml(s) { if (!s) return ''; var d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function escAttr(s) { return (s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function showSpinner(){document.getElementById('spinner').classList.add('show');}
function hideSpinner(){document.getElementById('spinner').classList.remove('show');}
function showToast(m,t){var e=document.getElementById('toast');e.textContent=m;e.className='toast '+(t||'info');setTimeout(function(){e.classList.add('show');},10);setTimeout(function(){e.classList.remove('show');},3500);}
function showConfirm(t,m){document.getElementById('confirmTitle').textContent=t;document.getElementById('confirmMsg').textContent=m;document.getElementById('confirmOverlay').classList.add('show');return new Promise(function(r){confirmResolve=r;});}
function closeConfirm(r){document.getElementById('confirmOverlay').classList.remove('show');if(confirmResolve){confirmResolve(r);confirmResolve=null;}}
</script>
</body>
</html>
