<!DOCTYPE html>
<!-- saved from url=(0076)file:///Users/brentjustworking/Desktop/enhanced-schedule-counter_final6.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Staff Scheduling Counter with Sales Analysis</title>
    <style>
        /* --- NEW SHIFT PLAN STYLES (Force Insert) --- */
        .shift-plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .plan-column {
            background: #fff;
            border-radius: 12px;
            padding: 0;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            max-height: 600px; /* Limit height */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .plan-column-header {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        }

        .plan-column-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plan-badge {
            background: #cbd5e1;
            color: #475569;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 600;
        }

        .plan-list {
            list-style: none;
            padding: 16px;
            margin: 0;
            overflow-y: auto; /* Scrollable list */
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .plan-item {
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            border-left-width: 4px;
            transition: transform 0.1s, box-shadow 0.1s;
            display: block; /* Ensure block display */
        }

        .plan-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .plan-item.burnout {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .plan-item.add {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .plan-item.cut {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .plan-item-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .plan-day-time {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .plan-title {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .plan-desc {
            font-size: 12px;
            color: #475569;
            line-height: 1.4;
        }

        /* Critical Section Styling */
        .critical-section {
            margin-bottom: 32px;
            background: linear-gradient(to right, #fff1f2, #fff);
            border: 1px solid #fecdd3;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.1);
        }

        .critical-header {
            color: #be123c;
            font-weight: 800;
            font-size: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .critical-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        
        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 32px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 16px;
            transition: color 0.2s;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        /* Layout for Converter Panel */
        .converter-layout {
            display: flex;
            gap: 32px;
            align-items: flex-start;
        }
        
        .converter-left {
            flex: 1;
            max-width: 500px;
        }

        .converter-right {
            flex: 1;
            background: #f8fafc;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            color: #1a1a1a;
        }

        .header {
            background: #DD0031;
            color: white;
            padding: 24px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.95;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .main-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            color: inherit;
            font-size: 11px;
            margin-right: 8px;
            font-weight: 700;
        }
        
        .tab-button.active .step-number {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .tab-button {
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            color: #475569;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .tab-button.active {
            background: #DD0031;
            border-color: #DD0031;
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(221, 0, 49, 0.3);
        }

        .tab-panel {
            margin-top: 8px;
        }

        .controls {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Converter panel styles (scoped to .converter-panel to avoid conflicts) */
        .converter-panel {
            margin-bottom: 24px;
            display: flex;
            justify-content: center;
        }

        .converter-panel .shell {
            width: 100%;
            max-width: 560px;
            padding: 24px;
        }

        .converter-panel .card {
            background: linear-gradient(145deg, rgba(15,23,42,0.9), rgba(15,23,42,0.98));
            border-radius: 20px;
            border: 1px solid rgba(148,163,184,0.2);
            box-shadow:
                0 24px 80px rgba(15,23,42,0.9),
                0 0 0 1px rgba(15,23,42,0.6);
            padding: 24px 22px 20px;
            backdrop-filter: blur(10px);
        }

        .converter-panel .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }

        .converter-panel .title-block {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .converter-panel h1 {
            margin: 0;
            font-size: 1.15rem;
            letter-spacing: 0.02em;
            color: #f9fafb;
        }

        .converter-panel .subtitle {
            margin: 0;
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .converter-panel .dropzone {
            position: relative;
            border-radius: 18px;
            border: 1px solid rgba(248, 250, 252, 0.35);
            background:
                radial-gradient(circle at top left, rgba(248, 113, 113, 0.25), rgba(15,23,42,0.9));
            padding: 24px 20px;
            cursor: pointer;
            transition: border-color 0.18s ease, background 0.18s ease, transform 0.08s ease,
                box-shadow 0.18s ease;
            margin-bottom: 10px;
            min-height: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .converter-panel .dropzone:hover {
            border-color: #fecaca;
            box-shadow: 0 14px 40px rgba(15,23,42,0.9);
            transform: translateY(-1px);
        }

        .converter-panel .dropzone.drag-active {
            border-color: #fecaca;
            background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.35), rgba(15,23,42,0.95));
            box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.5);
        }

        .converter-panel .dropzone input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .converter-panel .dropzone-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
        }

        .converter-panel .dropzone-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: radial-gradient(circle at top, rgba(248,250,252,0.9), rgba(254,226,226,0.3));
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 0 0 1px rgba(15,23,42,0.85);
        }

        .converter-panel .dropzone-icon svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: #0b1120;
            stroke-width: 1.7;
        }

        .converter-panel .dropzone-text-main {
            font-size: 0.92rem;
            margin-bottom: 4px;
            color: #f9fafb;
        }

        .converter-panel .dropzone-text-sub {
            font-size: 0.74rem;
            color: #9ca3af;
        }

        .converter-panel .hint-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            font-size: 0.74rem;
            color: #9ca3af;
            margin-top: 2px;
            margin-bottom: 4px;
        }

        .converter-panel .pill {
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.4);
            font-size: 0.68rem;
        }

        .converter-panel .error {
            margin-top: 4px;
            padding: 7px 9px;
            border-radius: 9px;
            border: 1px solid rgba(248,113,113,0.4);
            background: rgba(127,29,29,0.3);
            color: #fecaca;
            font-size: 0.75rem;
            display: none;
        }

        .converter-panel .error.visible {
            display: block;
        }

        .converter-panel .status {
            margin-top: 4px;
            font-size: 0.74rem;
            color: #9ca3af;
            min-height: 1.2em;
        }

        .converter-panel .actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
            gap: 8px;
        }

        .converter-panel .actions-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 14px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .converter-panel .instructions-card {
            background: rgba(2,6,23,0.55);
            border: 1px solid rgba(148,163,184,0.25);
            border-left: 4px solid #DD0031;
            border-radius: 12px;
            padding: 10px 12px;
            color: #e5e7eb;
            max-width: 320px;
            flex: 1 1 260px;
        }

        .converter-panel .instructions-card .title {
            font-weight: 700;
            font-size: 0.86rem;
            margin-bottom: 4px;
            color: #f3f4f6;
        }

        .converter-panel .instructions-card .text {
            font-size: 0.78rem;
            color: #cbd5e1;
            line-height: 1.5;
            margin-bottom: 6px;
        }

        .converter-panel .instructions-card .link {
            font-size: 0.78rem;
            color: #fecaca;
            text-decoration: underline;
            cursor: pointer;
        }

        .converter-panel .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }

        .converter-panel .modal {
            background: rgba(2,6,23,0.95);
            border: 1px solid rgba(148,163,184,0.25);
            border-radius: 14px;
            width: 100%;
            max-width: 640px;
            color: #e5e7eb;
            box-shadow: 0 20px 60px rgba(0,0,0,0.45);
        }

        .converter-panel .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid rgba(148,163,184,0.25);
        }

        .converter-panel .modal-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .converter-panel .modal-body {
            padding: 14px 16px 18px 16px;
            font-size: 0.9rem;
            color: #cbd5e1;
            line-height: 1.6;
        }

        .converter-panel .instructions-screenshot {
            width: 100%;
            max-height: 420px;
            object-fit: contain;
            border-radius: 10px;
            border: 1px solid rgba(148,163,184,0.35);
            background: rgba(2,6,23,0.6);
        }

        .converter-panel .screenshot-slot {
            margin-top: 8px;
            height: 220px;
            border: 1px dashed rgba(148,163,184,0.35);
            border-radius: 10px;
            background: rgba(2,6,23,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .converter-panel button {
            border: none;
            border-radius: 999px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: #0b1120;
            background: linear-gradient(135deg, #38bdf8, #22c55e);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow:
                0 10px 30px rgba(56,189,248,0.4),
                0 0 0 1px rgba(15,23,42,0.6);
            transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.1s ease;
        }

        .converter-panel button:hover {
            transform: translateY(-1px);
            filter: brightness(1.05);
            box-shadow:
                0 14px 40px rgba(56,189,248,0.55),
                0 0 0 1px rgba(15,23,42,0.6);
        }

        .converter-panel button:active {
            transform: translateY(0);
            box-shadow:
                0 8px 18px rgba(15,23,42,0.9),
                0 0 0 1px rgba(15,23,42,0.7);
        }

        .converter-panel button.secondary {
            background: transparent;
            color: #e5e7eb;
            border: 1px solid rgba(148,163,184,0.6);
            box-shadow: none;
            text-transform: none;
        }

        .converter-panel button.secondary:hover {
            filter: none;
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(15,23,42,0.7);
        }

        @media (max-width: 600px) {
            .converter-panel .shell {
                padding: 18px;
            }
            .converter-panel .card {
                padding: 20px 18px 17px;
            }
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group input[type="file"],
        .control-group input[type="week"],
        .control-group input[type="number"] {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .control-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .daily-sales-bar {
            margin-bottom: 16px;
        }

        .daily-sales-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .daily-sales-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px 12px;
            margin-top: 4px;
        }

        .daily-sales-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #475569;
        }

        .daily-sales-item span {
            min-width: 56px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            font-size: 11px;
            color: #64748b;
        }

        .daily-sales-item input[type="number"] {
            flex: 1;
            padding: 6px 8px;
            font-size: 13px;
        }

        .daily-sales-help {
            color: #64748b;
            margin-top: 6px;
            font-size: 11px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        button, a.btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: #DD0031;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(221, 0, 49, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .metrics-dashboard {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .metric-card.clickable {
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .metric-card.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .metric-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 26px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .metric-change {
            font-size: 12px;
            font-weight: 500;
        }

        .metric-change.positive {
            color: #10b981;
        }

        .metric-change.negative {
            color: #ef4444;
        }

        .metric-change.warning {
            color: #f59e0b;
        }

        /* OT Modal Styles */
        .ot-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .ot-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border: none;
            width: 420px;
            max-width: 90%;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
        }

        .ot-modal-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ot-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ot-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .ot-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .ot-modal-body {
            padding: 16px 20px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .ot-summary {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
            text-align: center;
        }

        .ot-summary-value {
            font-size: 26px;
            font-weight: 700;
            color: #b45309;
        }

        .ot-summary-label {
            font-size: 12px;
            color: #92400e;
            margin-top: 4px;
        }

        .ot-list {
            width: 100%;
        }

        .ot-list-header {
            display: flex;
            padding: 8px 0;
            border-bottom: 2px solid #e2e8f0;
            background: #f8fafc;
            font-size: 10px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .ot-list-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
            color: #334155;
        }

        .ot-list-row:last-child {
            border-bottom: none;
        }

        .ot-list-row:hover {
            background: #f8fafc;
        }

        .ot-col-name {
            flex: 1;
            padding: 0 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .ot-col-hrs {
            width: 50px;
            text-align: center;
            padding: 0 4px;
        }

        .ot-col-ot {
            width: 50px;
            text-align: center;
            padding: 0 4px;
            font-weight: 700;
            color: #b45309;
            background: #fef3c7;
            border-radius: 4px;
            margin-right: 4px;
        }

        .ot-no-overtime {
            text-align: center;
            padding: 32px 16px;
            color: #10b981;
        }

        .ot-no-overtime-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .ot-no-overtime-text {
            font-size: 16px;
            font-weight: 600;
        }

        .schedule-grid {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
            position: relative;
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .grid-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .view-toggle button {
            padding: 6px 12px;
            font-size: 12px;
        }

        .view-toggle button.active {
            background: #667eea;
            color: white;
        }

        /* Daypart toggle controls */
        .daypart-toggle {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 12px;
            color: #64748b;
        }

        .daypart-toggle-label {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 4px;
        }

        .daypart-toggle button {
            border-radius: 999px;
            padding: 4px 10px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            font-size: 11px;
            color: #475569;
            cursor: pointer;
        }

        .daypart-toggle button.active {
            background: #0f172a;
            color: #f9fafb;
            border-color: #0f172a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead th {
            padding: 12px 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #475569;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody td {
            padding: 0;
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
            height: 60px;
        }

        .hour-label {
            font-weight: 600;
            color: #64748b;
            background: #f8fafc;
            padding: 12px;
            font-size: 13px;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .staff-cell {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .staff-count {
            font-size: 20px;
            font-weight: 700;
            color: white;
            z-index: 2;
            position: relative;
        }

        .staff-label {
            font-size: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .staff-suggestion {
            font-size: 10px;
            margin-top: 2px;
            color: #f9fafb; /* high contrast on all staffing backgrounds */
            text-shadow: 0 1px 2px rgba(15, 23, 42, 0.6);
            font-weight: 600;
        }

        .staff-suggestion-below::before,
        .staff-suggestion-above::before,
        .staff-suggestion-at::before {
            content: '‚óè';
            display: inline-block;
            margin-right: 4px;
            font-size: 8px;
            vertical-align: middle;
        }

        .staff-suggestion-below::before {
            color: #fecaca; /* light red dot */
        }

        .staff-suggestion-above::before {
            color: #bfdbfe; /* light blue dot */
        }

        .staff-suggestion-at::before {
            color: #bbf7d0; /* light green dot */
        }

        .sales-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(59, 130, 246, 0.3);
            transition: height 0.3s ease;
            z-index: 1;
        }

        .productivity-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 4px;
            border-radius: 4px;
            z-index: 3;
        }

        .productivity-high {
            background: #10b981;
            color: white;
        }

        .productivity-medium {
            background: #f59e0b;
            color: white;
        }

        .productivity-low {
            background: #ef4444;
            color: white;
        }

        .understaffed {
            background: #ef4444;
        }

        .low-staffed {
            background: #f97316;
        }

        .adequate-staffed {
            background: #eab308;
        }

        .well-staffed {
            background: #22c55e;
        }

        .overstaffed {
            background: #60a5fa;
        }

        .legend {
            display: flex;
            gap: 24px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-section {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .legend-title {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #475569;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 24px;
        }

        .chart-header {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #salesChart {
            max-width: 100%;
        }

        .daily-productivity-summary {
            margin-top: 16px;
            font-size: 13px;
            color: #475569;
            border-top: 1px solid #e2e8f0;
            padding-top: 12px;
        }

        .daily-productivity-summary span {
            display: inline-block;
            margin-right: 12px;
            margin-bottom: 4px;
        }

        .day-charts-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .day-chart-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 12px 8px 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .curve-table-wrapper {
            margin-top: 8px;
            max-height: 260px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table.curve-table {
            width: 100%;
            border-collapse: collapse;
        }

        .curve-table th,
        .curve-table td {
            padding: 6px 8px;
            font-size: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .curve-table th {
            background: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 1;
            text-align: left;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .curve-table input[type="number"] {
            width: 80px;
            padding: 4px 6px;
            font-size: 12px;
        }

        /* Gentle input warning styling */
        .input-warning {
            border-color: #f97316 !important;
            background: #fffbeb;
        }

        .metric-label[data-tooltip] {
            position: relative;
            cursor: help;
        }

        .metric-label[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -28px;
            left: 0;
            padding: 4px 8px;
            background: #0f172a;
            color: #f9fafb;
            font-size: 11px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transform: translateY(4px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            z-index: 20;
        }

        .metric-label[data-tooltip]:hover::after {
            opacity: 1;
            transform: translateY(0);
        }

        .curve-total-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            padding: 8px;
            font-size: 12px;
            color: #475569;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .curve-config {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }

        .curve-config-section {
            font-size: 12px;
            color: #475569;
        }

        .curve-config-title {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: #64748b;
        }

        .curve-config-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px 12px;
        }

        .curve-config-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .curve-config-field label {
            font-size: 11px;
            font-weight: 500;
            color: #64748b;
        }

        .curve-config-field input[type="number"] {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-size: 12px;
        }

        .curve-config-field input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .labor-mix-total {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 11px;
        }

        .labor-mix-total span.total-bad {
            color: #ef4444;
            font-weight: 600;
        }

        .day-chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
        }

        .insights-panel {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 24px;
        }

        /* Staff Side Panel (Non-intrusive) */
        .staff-side-panel {
            position: fixed;
            top: 0;
            right: -360px; /* Hidden by default */
            width: 340px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 25px rgba(0,0,0,0.1);
            z-index: 2000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .staff-side-panel.open {
            right: 0;
        }

        .staff-side-panel-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
        }

        .staff-side-panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
        }

        .staff-side-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 0; 
        }

        /* List Styles */
        .staff-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .staff-list-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.15s;
        }
        
        .staff-list-item:hover {
            background: #f8fafc;
        }

        .staff-list-item:last-child {
            border-bottom: none;
        }

        .staff-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            flex-shrink: 0;
        }

        .staff-dept-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 999px;
            margin-left: auto;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-foh { background: #eff6ff; color: #3b82f6; }
        .badge-boh { background: #fef2f2; color: #ef4444; }

        /* Interactive Grid Cells */
        #scheduleTable td div.staff-cell {
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        #scheduleTable td div.staff-cell:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 5;
            position: relative;
        }

        .insights-header {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-item {
            padding: 12px;
            background: #f8fafc;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .insight-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .insight-item.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .insight-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .insight-description {
            color: #64748b;
            font-size: 13px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .control-row {
                grid-template-columns: 1fr;
            }
            
            .metrics-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .metrics-dashboard {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>
    <div class="header" style="display:flex; justify-content:space-between; align-items:center; text-align:left;">
        <div>
        <h1>üìä Enhanced Staff Scheduling Counter</h1>
        <p>Analyze staffing levels with sales data and productivity metrics</p>
        </div>
        <button onclick="showWalkthrough()" style="
            background: white; 
            color: #DD0031; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            font-weight: 700; 
            font-size: 16px; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; 
            align-items: center; 
            gap: 8px;
            transition: transform 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <span style="font-size: 20px;">‚ùì</span> How to Use
        </button>
    </div>

        <div class="container">
        <div class="main-tabs">
            <button id="tab-converter" class="tab-button active" type="button" onclick="switchMainPanel('converter')">
                <span class="step-number">1</span> File Converter
            </button>
            <button id="tab-counter" class="tab-button" type="button" onclick="switchMainPanel('counter')">
                <span class="step-number">2</span> Schedule Counter
            </button>
        </div>

        <div id="viewBadge" class="view-badge" style="margin-bottom: 12px; font-size: 12px; font-weight: 600; color: #64748b;">
            Current View: Overall ¬∑ Daypart: All Day
        </div>

        <div id="converterTabPanel" class="tab-panel converter-panel" style="display: block;">
            <div class="converter-layout">
                <!-- LEFT: Upload & Action -->
                <div class="converter-left">
                    <div class="card">
                        <div class="card-header">
                            <div class="title-block">
                                <h1>Schedule CSV Generator</h1>
                                <p class="subtitle">Upload your raw HotSchedules export to generate an hourly CSV.</p>
                            </div>
                        </div>

                        <label class="dropzone">
                            <input type="file" id="fileInput" accept=".xls,.html,.htm,.txt" />
                            <div class="dropzone-content">
                                <div class="dropzone-icon">
                                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 16V4m0 0l-4 4m4-4l4 4" /><path d="M6 12v5a3 3 0 003 3h6a3 3 0 003-3v-5" /></svg>
                                </div>
                                <div>
                                    <div class="dropzone-text-main">Click to choose your schedule file</div>
                                    <div class="dropzone-text-sub">After generating, use the file in Step 2 as FOH/BOH hourly CSV.</div>
                                </div>
                            </div>
                        </label>

                        <div class="hint-row">
                            <span>Expected input: HotSchedules ‚ÄúSchedule Report‚Äù (Excel/HTML export).</span>
                            <span class="pill">Hourly CSV</span>
                        </div>

                        <div id="error" class="error"></div>
                        <div id="status" class="status"></div>

                        <div class="actions-row" style="justify-content: flex-end; margin-top: 16px;">
                            <button id="processBtn" style="width: 100%; padding: 14px; font-size: 16px;">
                                <span>üöÄ Convert & Download CSV</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Instructions -->
                <div class="converter-right">
                    <h3 style="margin-top:0; color:#1e293b; font-size:18px; display:flex; align-items:center; gap:8px;">
                        <span>üìò</span> How to Get the Correct File
                    </h3>
                    <ol style="padding-left:20px; line-height:1.6; color:#475569; font-size:14px;">
                        <li style="margin-bottom:8px;">Go to <strong>HotSchedules</strong> ‚Üí Reporting ‚Üí Dashboard ‚Üí Schedules and Rosters ‚Üí <strong>Schedule Report</strong>.</li>
                        <li style="margin-bottom:8px;">Select the <strong>week</strong> you want to review.</li>
                        <li style="margin-bottom:8px;">Change the Output option to <strong>EXCEL XP‚Äì2007</strong>.</li>
                        <li style="margin-bottom:8px;">Under Schedule Report Details, check <strong>Include Out Times</strong>.</li>
                        <li style="margin-bottom:8px;">Under Available Shifts, check <strong>Total Day</strong>.</li>
                        <li style="margin-bottom:8px;">Under Schedule Selection, choose the schedule(s) you want.</li>
                    </ol>
                    
                    <div style="background:#f1f5f9; padding:12px; border-radius:8px; margin-top:16px;">
                        <strong style="font-size:13px; color:#334155; display:block; margin-bottom:4px;">Important Notes:</strong>
                        <ul style="padding-left:20px; font-size:13px; color:#64748b; margin:0;">
                            <li>FOH and BOH must be pulled separately if you want to analyze them separately in Step 2.</li>
                            <li>Ensure "Job Codes" are included if you want role-specific data.</li>
                        </ul>
                    </div>

                    <img src="../Python Parser/instructions-screenshot.png" style="width:100%; margin-top:16px; border-radius:8px; border:1px solid #e2e8f0;" alt="HotSchedules Screenshot" onerror="this.style.display='none'">
                </div>
            </div>
        </div>

        <div id="counterTabPanel" class="tab-panel" style="display: none;">
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>üìä FOH Schedule File (CSV)</label>
                    <input type="file" id="fohScheduleFile" accept=".csv">
                    <small style="color: #64748b; margin-top: 4px; font-size: 11px;">
                        Front of House - Format: Date,Time,Employee
                    </small>
                </div>
                <div class="control-group">
                    <label>üç≥ BOH Schedule File (CSV)</label>
                    <input type="file" id="bohScheduleFile" accept=".csv">
                    <small style="color: #64748b; margin-top: 4px; font-size: 11px;">
                        Back of House - Format: Date,Time,Employee
                    </small>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="generateReport()">
                    üìà Generate Analysis
                </button>
                    <button class="btn-secondary" onclick="loadDemoData()">
                        ü™Ñ Load Demo Data
                </button>
                <button class="btn-secondary" onclick="downloadResults()">
                    üì• Export Report
                </button>
                <button class="btn-secondary" onclick="showFormatHelp()">
                    ‚ùì CSV Format Help
                </button>
                <button class="btn-secondary" type="button" onclick="showCurveAdmin()">
                    ‚öôÔ∏è Edit Sales Curve
                </button>
                <button class="btn-secondary" type="button" onclick="generateIdealSchedule()">
                    ‚ú® Ideal Model
                </button>
            </div>
        </div>

        <div class="chart-container" id="idealModelPanel" style="display: none; margin-bottom: 24px; border: 2px solid #667eea;">
            <div class="chart-header">
                <span>‚ú® Ideal Staffing Model (Target Headcount)</span>
                <button class="btn-secondary" type="button" onclick="document.getElementById('idealModelPanel').style.display='none'">
                    Close
                </button>
            </div>
            <div style="margin-bottom: 12px; font-size: 13px; color: #64748b;">
                This model calculates exactly how many people you need to hit your <strong>$<span id="idealModelGoal"></span>/hr</strong> goal based on your sales forecast.
            </div>
            <div class="schedule-grid" style="box-shadow: none; padding: 0;">
                <table id="idealScheduleTable">
                    <thead>
                        <tr><th>Hour</th><th>Monday</th><th>Tuesday</th><th>Wednesday</th><th>Thursday</th><th>Friday</th><th>Saturday</th></tr>
                    </thead>
                    <tbody id="idealScheduleBody"></tbody>
                </table>
            </div>
        </div>

        <div class="chart-container" id="curveAdminPanel" style="display: none;">
            <div class="chart-header">
                <span>‚öôÔ∏è Sales Curve Settings (Percent of Daily Sales by Hour)</span>
                <div style="display:flex; gap:8px;">
                    <button class="btn-secondary" type="button" onclick="resetSalesCurve()" style="padding: 6px 12px; font-size: 12px; border-color: #ef4444; color: #ef4444;">
                        Reset to Defaults
                    </button>
                <button class="btn-secondary" type="button" onclick="hideCurveAdmin()">
                    Close
                </button>
                </div>
            </div>
            <div class="curve-table-wrapper">
                <table class="curve-table">
                    <thead>
                        <tr>
                            <th>Hour</th>
                            <th>Percent of Daily Sales</th>
                        </tr>
                    </thead>
                    <tbody id="curveAdminBody">
                    </tbody>
                </table>
                <div class="curve-total-row">
                    <span>Total</span>
                    <span id="curveTotalDisplay">0%</span>
                </div>
            </div>
            <div class="curve-config">
                <div class="curve-config-section">
                    <div class="curve-config-title">Productivity Goals ($/LH)</div>
                    <div class="curve-config-grid">
                        <div class="curve-config-field">
                            <label for="config-goal-overall">Overall</label>
                            <input type="number" id="config-goal-overall" min="0" step="1">
                        </div>
                        <div class="curve-config-field">
                            <label for="config-goal-foh">FOH</label>
                            <input type="number" id="config-goal-foh" min="0" step="0.1">
                        </div>
                        <div class="curve-config-field">
                            <label for="config-goal-boh">BOH</label>
                            <input type="number" id="config-goal-boh" min="0" step="0.1">
                        </div>
                        <div class="curve-config-field">
                            <label for="config-burnout">Burnout Risk ($/Hr)</label>
                            <input type="number" id="config-burnout" min="0" step="5" value="150" title="Sales $ per person that indicates high stress">
                        </div>
                    </div>
                </div>
                <div class="curve-config-section">
                    <div class="curve-config-title">Labor Mix (%)</div>
                    <div class="curve-config-grid">
                        <div class="curve-config-field">
                            <label for="config-share-foh">FOH %</label>
                            <input type="number" id="config-share-foh" min="0" step="0.1">
                        </div>
                        <div class="curve-config-field">
                            <label for="config-share-boh">BOH %</label>
                            <input type="number" id="config-share-boh" min="0" step="0.1">
                        </div>
                        <div class="curve-config-field">
                            <label for="config-share-other">Other %</label>
                            <input type="number" id="config-share-other" min="0" step="0.1">
                        </div>
                    </div>
                    <div class="labor-mix-total">
                        <span>Total</span>
                        <span id="laborMixTotalDisplay">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="metrics-dashboard" id="metricsPanel" style="display: grid;">
            <div class="metric-card">
                <div class="metric-label">Avg Staff/Hour</div>
                <div class="metric-value" id="avgStaff">12.2</div>
                <div class="metric-change positive">Balanced coverage</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Overall Productivity ($/LH)</div>
                <div class="metric-value" id="peakEfficiency">$82</div>
                <div class="metric-change">Average across staffed hours</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Overall $/LH (Goal: $90.00)</div>
                <div class="metric-value" id="splh">$80</div>
                <div class="metric-change negative">$-10 vs $90 goal</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Labor Hours</div>
                <div class="metric-value" id="laborCost">1094 hrs</div>
                <div class="metric-change">Overall scheduled hours</div>
            </div>
            <div class="metric-card clickable" id="otCard" onclick="showOTBreakdown()">
                <div class="metric-label">‚è±Ô∏è Overtime Hours</div>
                <div class="metric-value" id="otHours">0 hrs</div>
                <div class="metric-change positive" id="otSubtext">No overtime detected</div>
            </div>
        </div>

        <!-- OT Breakdown Modal -->
        <div class="ot-modal" id="otModal">
            <div class="ot-modal-content">
                <div class="ot-modal-header">
                    <h3>‚è±Ô∏è Overtime Breakdown</h3>
                    <button class="ot-modal-close" onclick="hideOTModal()">√ó</button>
                </div>
                <div class="ot-modal-body" id="otModalBody">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <div class="schedule-grid" id="scheduleGrid" style="display: block;">
            <div class="grid-header">
                <div class="grid-title" id="gridTitle">Overall Staff Coverage vs Sales Volume</div>
                <div>
                <div class="view-toggle">
                        <button class="active" onclick="switchDepartmentView('overall', event)">Overall</button>
                        <button onclick="switchDepartmentView('foh', event)">FOH</button>
                        <button onclick="switchDepartmentView('boh', event)">BOH</button>
                    </div>
                    <div class="daypart-toggle">
                        <span class="daypart-toggle-label">Daypart:</span>
                        <button class="active" onclick="setDaypart('all', event)">All Day</button>
                        <button onclick="setDaypart('breakfast', event)">Breakfast</button>
                        <button onclick="setDaypart('lunch', event)">Lunch</button>
                        <button onclick="setDaypart('afternoon', event)">Afternoon</button>
                        <button onclick="setDaypart('dinner', event)">Dinner</button>
                        <button onclick="setDaypart('latenight', event)">Late Night</button>
                    </div>
                </div>
            </div>
            <div class="daily-sales-bar">
                <div class="daily-sales-label">üí∞ Estimated Daily Sales (Mon‚ÄìSat)</div>
                <div class="daily-sales-grid">
                    <div class="daily-sales-item">
                        <span>Mon</span>
                        <input type="number" id="sales-Monday" min="0" step="1" placeholder="0">
                    </div>
                    <div class="daily-sales-item">
                        <span>Tue</span>
                        <input type="number" id="sales-Tuesday" min="0" step="1" placeholder="0">
                    </div>
                    <div class="daily-sales-item">
                        <span>Wed</span>
                        <input type="number" id="sales-Wednesday" min="0" step="1" placeholder="0">
                    </div>
                    <div class="daily-sales-item">
                        <span>Thu</span>
                        <input type="number" id="sales-Thursday" min="0" step="1" placeholder="0">
                    </div>
                    <div class="daily-sales-item">
                        <span>Fri</span>
                        <input type="number" id="sales-Friday" min="0" step="1" placeholder="0">
                    </div>
                    <div class="daily-sales-item">
                        <span>Sat</span>
                        <input type="number" id="sales-Saturday" min="0" step="1" placeholder="0">
                    </div>
                </div>
                <div class="daily-sales-help">
                    These values stay in place as you re-upload FOH/BOH schedules and are distributed across the day using the sales curve.
                </div>
            </div>
            <table id="scheduleTable">
                <thead>
                    <tr><th>Hour</th><th>Monday</th><th>Tuesday</th><th>Wednesday</th><th>Friday</th><th>Saturday</th></tr>
                </thead>
                <tbody id="scheduleBody"><tr><td class="hour-label">5 AM</td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                3
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                3
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                3
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                3
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                4
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">6 AM</td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 8.64%;"></div>
                            <div class="staff-count">
                                5
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 8.64%;"></div>
                            <div class="staff-count">
                                4
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 8.64%;"></div>
                            <div class="staff-count">
                                4
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 8.64%;"></div>
                            <div class="staff-count">
                                4
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 8.64%;"></div>
                            <div class="staff-count">
                                5
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td></tr><tr><td class="hour-label">7 AM</td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 11.6272%;"></div>
                            <div class="staff-count">
                                5
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 11.6272%;"></div>
                            <div class="staff-count">
                                5
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 11.6272%;"></div>
                            <div class="staff-count">
                                5
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 11.6272%;"></div>
                            <div class="staff-count">
                                6
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 11.6272%;"></div>
                            <div class="staff-count">
                                7
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td></tr><tr><td class="hour-label">8 AM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 14.9498%;"></div>
                            <div class="staff-count">
                                10
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 14.9498%;"></div>
                            <div class="staff-count">
                                10
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 14.9498%;"></div>
                            <div class="staff-count">
                                9
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 14.9498%;"></div>
                            <div class="staff-count">
                                9
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 14.9498%;"></div>
                            <div class="staff-count">
                                10
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">9 AM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 19.067999999999998%;"></div>
                            <div class="staff-count">
                                13
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 19.067999999999998%;"></div>
                            <div class="staff-count">
                                12
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 19.067999999999998%;"></div>
                            <div class="staff-count">
                                12
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 19.067999999999998%;"></div>
                            <div class="staff-count">
                                11
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 19.067999999999998%;"></div>
                            <div class="staff-count">
                                12
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">10 AM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 24.711599999999997%;"></div>
                            <div class="staff-count">
                                13
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 24.711599999999997%;"></div>
                            <div class="staff-count">
                                13
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 24.711599999999997%;"></div>
                            <div class="staff-count">
                                12
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 24.711599999999997%;"></div>
                            <div class="staff-count">
                                11
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 24.711599999999997%;"></div>
                            <div class="staff-count">
                                12
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td></tr><tr><td class="hour-label">11 AM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 30.918%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 30.918%;"></div>
                            <div class="staff-count">
                                13
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 30.918%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 30.918%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 30.918%;"></div>
                            <div class="staff-count">
                                18
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td></tr><tr><td class="hour-label">12 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 34.2096%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 34.2096%;"></div>
                            <div class="staff-count">
                                13
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 34.2096%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 34.2096%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 34.2096%;"></div>
                            <div class="staff-count">
                                18
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td></tr><tr><td class="hour-label">1 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 28.934199999999997%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 28.934199999999997%;"></div>
                            <div class="staff-count">
                                13
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 28.934199999999997%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 28.934199999999997%;"></div>
                            <div class="staff-count">
                                16
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 28.934199999999997%;"></div>
                            <div class="staff-count">
                                18
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">2 PM</td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.4558%;"></div>
                            <div class="staff-count">
                                17
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.4558%;"></div>
                            <div class="staff-count">
                                17
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.4558%;"></div>
                            <div class="staff-count">
                                16
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.4558%;"></div>
                            <div class="staff-count">
                                19
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell well-staffed">
                            <div class="sales-overlay" style="height: 23.4558%;"></div>
                            <div class="staff-count">
                                20
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">3 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.6976%;"></div>
                            <div class="staff-count">
                                13
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.6976%;"></div>
                            <div class="staff-count">
                                13
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.6976%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 22.6976%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 22.6976%;"></div>
                            <div class="staff-count">
                                17
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">4 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.2872%;"></div>
                            <div class="staff-count">
                                11
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.2872%;"></div>
                            <div class="staff-count">
                                11
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 22.2872%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 22.2872%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 22.2872%;"></div>
                            <div class="staff-count">
                                17
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">5 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 23.558600000000002%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.558600000000002%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.558600000000002%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.558600000000002%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.558600000000002%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">6 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 23.6752%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 23.6752%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-medium">‚óÜ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.6752%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.6752%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell adequate-staffed">
                            <div class="sales-overlay" style="height: 23.6752%;"></div>
                            <div class="staff-count">
                                15
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">7 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.5796%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.5796%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.5796%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.5796%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 22.5796%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">8 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 21.831%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 21.831%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 21.831%;"></div>
                            <div class="staff-count">
                                12
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-high">‚òÖ</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 21.831%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 21.831%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">9 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 17.2958%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 17.2958%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 17.2958%;"></div>
                            <div class="staff-count">
                                12
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 17.2958%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 17.2958%;"></div>
                            <div class="staff-count">
                                14
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">10 PM</td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 0.41079999999999994%;"></div>
                            <div class="staff-count">
                                11
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 0.41079999999999994%;"></div>
                            <div class="staff-count">
                                12
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0.41079999999999994%;"></div>
                            <div class="staff-count">
                                9
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 0.41079999999999994%;"></div>
                            <div class="staff-count">
                                11
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td><td>
                        <div class="staff-cell low-staffed">
                            <div class="sales-overlay" style="height: 0.41079999999999994%;"></div>
                            <div class="staff-count">
                                10
                                <div class="staff-label">staff</div>
                            </div>
                            <div class="productivity-indicator productivity-low">‚ñº</div>
                        </div>
                    </td></tr><tr><td class="hour-label">11 PM</td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                0
                                <div class="staff-label">staff</div>
                            </div>
                            
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                0
                                <div class="staff-label">staff</div>
                            </div>
                            
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                0
                                <div class="staff-label">staff</div>
                            </div>
                            
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                0
                                <div class="staff-label">staff</div>
                            </div>
                            
                        </div>
                    </td><td>
                        <div class="staff-cell understaffed">
                            <div class="sales-overlay" style="height: 0%;"></div>
                            <div class="staff-count">
                                0
                                <div class="staff-label">staff</div>
                            </div>
                            
                        </div>
                    </td></tr></tbody>
            </table>
            <div class="legend">
                <div class="legend-section">
                    <span class="legend-title">Staffing Levels:</span>
                    <div class="legend-item">
                        <div class="legend-color understaffed"></div>
                        <span>Severely understaffed (2+ below suggested)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color low-staffed"></div>
                        <span>Slightly off (¬±1 from suggested)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color well-staffed"></div>
                        <span>On target (matches suggested)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color overstaffed"></div>
                        <span>Overstaffed (2+ above suggested)</span>
                    </div>
                </div>
                <div class="legend-section">
                    <span class="legend-title">Sales Volume:</span>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(59, 130, 246, 0.3);"></div>
                        <span>Blue overlay = Sales intensity</span>
                    </div>
                </div>
                <div class="legend-section">
                    <span class="legend-title">Productivity (Goal $90/hr):</span>
                    <div class="legend-item">
                        <span>‚òÖ = Meeting goal ($90+)</span>
                    </div>
                    <div class="legend-item">
                        <span>‚óÜ = Near goal ($80-89)</span>
                    </div>
                    <div class="legend-item">
                        <span>‚ñº = Below goal (&lt;$80)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-container" id="chartContainer" style="display: block;">
            <div class="chart-header">
                <span>üìà Hourly Trends: Staffing vs Sales vs Productivity</span>
            </div>
            <div style="position: relative; height: 250px; width: 100%;">
                <canvas id="salesChart" width="1125" height="375" style="display: block; box-sizing: border-box; height: 250px; width: 750px;"></canvas>
            </div>
            <div id="dayChartsGrid" class="day-charts-grid"></div>
            <div id="dailyProductivitySummary" class="daily-productivity-summary"></div>
        </div>

        <div class="insights-panel" id="insightsPanel" style="display: block;">
            <div class="insights-header">
                üí° Optimization Insights
            </div>
            <div id="insightsList"><div class="insight-item warning">
                    <div class="insight-title">Below Productivity Target: Saturday 2 PM</div>
                    <div class="insight-description">20 staff scheduled achieving only $59/hour (goal: $90). Consider reducing by 6 staff members.</div>
                </div><div class="insight-item success">
                    <div class="insight-title">Exceeding Goal: Tuesday 12 PM</div>
                    <div class="insight-description">Excellent productivity at $132 per labor hour, exceeding the $90 goal by $42.</div>
                </div><div class="insight-item success">
                    <div class="insight-title">Exceeding Goal: Monday 12 PM</div>
                    <div class="insight-description">Excellent productivity at $122 per labor hour, exceeding the $90 goal by $32.</div>
                </div><div class="insight-item success">
                    <div class="insight-title">Exceeding Goal: Wednesday 12 PM</div>
                    <div class="insight-description">Excellent productivity at $122 per labor hour, exceeding the $90 goal by $32.</div>
                </div><div class="insight-item success">
                    <div class="insight-title">Exceeding Goal: Tuesday 11 AM</div>
                    <div class="insight-description">Excellent productivity at $119 per labor hour, exceeding the $90 goal by $29.</div>
                </div></div>
            </div>
        </div>
    </div>

    <!-- Staff Side Panel (was Modal) -->
    <div id="staffSidePanel" class="staff-side-panel">
        <div class="staff-side-panel-header">
            <div class="staff-side-panel-title" id="staffSidePanelTitle">Staff on Shift</div>
            <span class="close" onclick="closeStaffModal()" style="font-size:24px; line-height:1; cursor:pointer;">&times;</span>
        </div>
        <div class="staff-side-panel-body">
            <ul id="staffList" class="staff-list">
                <!-- List items will be injected here -->
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        let fohScheduleData = {};
        let bohScheduleData = {};
        let fohStaffNames = {}; // New: stores list of names per day/hour
        let bohStaffNames = {}; // New: stores list of names per day/hour
        let scheduleData = {}; // Combined view data
        let salesData = {};
        let chartInstance = null;
        let dayChartInstances = {};
        let currentDepartmentView = 'overall'; // 'overall', 'foh', or 'boh'
        let currentDaypart = 'all'; // 'all', 'breakfast', 'lunch', 'afternoon', 'dinner', 'latenight'

        const HOURS = ['5 AM', '6 AM', '7 AM', '8 AM', '9 AM', '10 AM', '11 AM', '12 PM',
                       '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM', '8 PM',
                       '9 PM', '10 PM', '11 PM'];

        // Standard dayparts (24h ranges)
        const DAYPARTS = {
            all: { label: 'All Day', ranges: [[5, 23]] },
            breakfast: { label: 'Breakfast', ranges: [[5, 10]] },     // 5 AM - 10 AM
            lunch: { label: 'Lunch', ranges: [[11, 14]] },            // 11 AM - 2 PM
            afternoon: { label: 'Afternoon', ranges: [[15, 16]] },    // 3 PM - 4 PM
            dinner: { label: 'Dinner', ranges: [[17, 21]] },          // 5 PM - 9 PM
            latenight: { label: 'Late Night', ranges: [[22, 23]] }    // 10 PM - 11 PM
        };

        const SALES_CURVE_STORAGE_KEY = 'salesCurveHourly_v1';
        const DEFAULT_SALES_CURVE = {
            '5 AM': 2,
            '6 AM': 4,
            '7 AM': 6,
            '8 AM': 8,
            '9 AM': 10,
            '10 AM': 10,
            '11 AM': 10,
            '12 PM': 10,
            '1 PM': 9,
            '2 PM': 8,
            '3 PM': 6,
            '4 PM': 5,
            '5 PM': 4,
            '6 PM': 3,
            '7 PM': 2.5,
            '8 PM': 2,
            '9 PM': 1.5,
            '10 PM': 1,
            '11 PM': 0.5
        };

        const DEFAULT_SALES_CONFIG = {
            goals: {
                overall: 90.0,
                foh: 46.40,
                boh: 41.70
            },
            laborSharesPercent: {
                foh: 46.4,
                boh: 41.7,
                other: 11.9
            },
            curve: DEFAULT_SALES_CURVE
        };

        let salesConfig = null;
        let salesCurveHourly = {};

        // Convert an hour label like "5 AM" or "5AM" to 24h integer (5‚Äì23)
        function hourLabelTo24(label) {
            if (!label) return null;
            let clean = label.toString().trim();
            // Normalize to "H AM"/"H PM"
            clean = clean.replace('AM', ' AM').replace('PM', ' PM').replace(/\s+/g, ' ').trim();
            const parts = clean.split(' ');
            if (parts.length !== 2) return null;
            let hour = parseInt(parts[0], 10);
            const ampm = parts[1].toUpperCase();
            if (isNaN(hour)) return null;
            if (ampm === 'PM' && hour !== 12) hour += 12;
            if (ampm === 'AM' && hour === 12) hour = 0;
            return hour;
        }

        // Check if an hour label is in the current daypart selection
        function isHourInCurrentDaypart(hourLabel) {
            if (currentDaypart === 'all') return true;
            const info = DAYPARTS[currentDaypart];
            if (!info) return true;
            const h24 = hourLabelTo24(hourLabel);
            if (h24 === null) return true;
            return info.ranges.some(([start, end]) => h24 >= start && h24 <= end);
        }

        // Set the current daypart from UI
        function setDaypart(part, event) {
            if (!DAYPARTS[part]) part = 'all';
            currentDaypart = part;

            // Update active button styling
            document.querySelectorAll('.daypart-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: activate the matching button by text
                const btn = Array.from(document.querySelectorAll('.daypart-toggle button'))
                    .find(b => b.textContent.toLowerCase().includes(DAYPARTS[part].label.toLowerCase().split(' ')[0]));
                if (btn) btn.classList.add('active');
            }

            // Regenerate main report
            if (Object.keys(scheduleData).length > 0) {
                generateReport();
            }
            // Update Ideal Model if visible
            const idealPanel = document.getElementById('idealModelPanel');
            if (idealPanel && idealPanel.style.display !== 'none') {
                generateIdealSchedule();
            }
        }

        // Update the small badge that shows current view and daypart
        function updateViewBadge() {
            const badge = document.getElementById('viewBadge');
            if (!badge) return;
            const deptName = currentDepartmentView === 'foh' ? 'FOH' : currentDepartmentView === 'boh' ? 'BOH' : 'Overall';
            const daypartInfo = DAYPARTS[currentDaypart] || DAYPARTS.all;
            badge.textContent = `Current View: ${deptName} ¬∑ Daypart: ${daypartInfo.label}`;
        }

        // Main tab switcher between converter and counter views
        function switchMainPanel(panel) {
            const converterPanel = document.getElementById('converterTabPanel');
            const counterPanel = document.getElementById('counterTabPanel');
            const tabConverter = document.getElementById('tab-converter');
            const tabCounter = document.getElementById('tab-counter');

            if (!converterPanel || !counterPanel || !tabConverter || !tabCounter) return;

            if (panel === 'converter') {
                converterPanel.style.display = 'block';
                counterPanel.style.display = 'none';
                tabConverter.classList.add('active');
                tabCounter.classList.remove('active');
            } else {
                converterPanel.style.display = 'none';
                counterPanel.style.display = 'block';
                tabConverter.classList.remove('active');
                tabCounter.classList.add('active');
            }
        }

        // Add file upload event listeners
        document.getElementById('fohScheduleFile').addEventListener('change', handleFOHScheduleUpload);
        document.getElementById('bohScheduleFile').addEventListener('change', handleBOHScheduleUpload);

        // Helper to check if file is a raw HotSchedules export
        function isRawHotSchedulesExport(text) {
            // Raw exports often start with HTML doctype or contain specific HS metadata
            if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) return true;
            if (text.includes('HotSchedules') && !text.includes('Department,Employee,Day,Date')) return true;
            // Check for typical HS CSV headers that aren't our processed format
            if (text.includes('Job Code,') || text.includes('Employee,') && !text.includes('Department,Employee,Day,Date')) return true;
            return false;
        }

        function handleFOHScheduleUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                reader.onload = function(e) {
                    const content = e.target.result;
                    if (isRawHotSchedulesExport(content)) {
                        alert('‚ö†Ô∏è ALERT: This looks like a raw HotSchedules export!\n\nPlease go to "Step 1: File Converter" to convert this file first.\nThen upload the resulting "hourly_schedule.csv" here.');
                        event.target.value = ''; // Clear input
                        return;
                    }
                    parseFOHScheduleCSV(content);
                };
                reader.readAsText(file);
            } else {
                alert('Please upload a CSV file.');
            }
        }

        function handleBOHScheduleUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                reader.onload = function(e) {
                    const content = e.target.result;
                    if (isRawHotSchedulesExport(content)) {
                        alert('‚ö†Ô∏è ALERT: This looks like a raw HotSchedules export!\n\nPlease go to "Step 1: File Converter" to convert this file first.\nThen upload the resulting "hourly_schedule.csv" here.');
                        event.target.value = ''; // Clear input
                        return;
                    }
                    parseBOHScheduleCSV(content);
                };
                reader.readAsText(file);
            } else {
                alert('Please upload a CSV file.');
            }
        }
        
        function getConfiguredGoals() {
            if (salesConfig && salesConfig.goals) {
                return salesConfig.goals;
            }
            return DEFAULT_SALES_CONFIG.goals;
        }

        // Helper function to get productivity goal based on current view
        function getProductivityGoal() {
            const goals = getConfiguredGoals();
            switch(currentDepartmentView) {
                case 'foh': return goals.foh;
                case 'boh': return goals.boh;
                default: return goals.overall;
            }
        }

        function getLaborShares() {
            const shares = (salesConfig && salesConfig.laborSharesPercent) || DEFAULT_SALES_CONFIG.laborSharesPercent;
            const foh = Number(shares.foh) || 0;
            const boh = Number(shares.boh) || 0;
            const other = Number(shares.other) || 0;
            const total = foh + boh + other || 1;
            return {
                fohShare: foh / total,
                bohShare: boh / total,
                otherShare: other / total
            };
        }

        function getSalesFractions() {
            const shares = (salesConfig && salesConfig.laborSharesPercent) || DEFAULT_SALES_CONFIG.laborSharesPercent;
            const foh = Number(shares.foh) || 0;
            const boh = Number(shares.boh) || 0;
            const totalFOHBOH = foh + boh || 1;
            return {
                fohFraction: foh / totalFOHBOH,
                bohFraction: boh / totalFOHBOH
            };
        }

        function loadSalesConfig() {
            let cfg = null;
            try {
                const stored = localStorage.getItem(SALES_CURVE_STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (parsed && parsed.curve) {
                        // Ensure curve values are numbers
                        const safeCurve = { ...DEFAULT_SALES_CURVE };
                        Object.keys(parsed.curve).forEach(k => {
                            safeCurve[k] = parseFloat(parsed.curve[k]) || 0;
                        });
                        
                        cfg = {
                            goals: { ...DEFAULT_SALES_CONFIG.goals, ...(parsed.goals || {}) },
                            laborSharesPercent: { ...DEFAULT_SALES_CONFIG.laborSharesPercent, ...(parsed.laborSharesPercent || {}) },
                            curve: safeCurve
                        };
                    } else {
                        // Legacy shape
                        const safeCurve = { ...DEFAULT_SALES_CURVE };
                        Object.keys(parsed || {}).forEach(k => {
                            safeCurve[k] = parseFloat((parsed || {})[k]) || 0;
                        });
                        cfg = {
                            ...DEFAULT_SALES_CONFIG,
                            curve: safeCurve
                        };
                    }
                }
            } catch (e) {
                console.warn('Failed to load sales config from storage, using defaults', e);
            }
            if (!cfg) {
                cfg = { ...DEFAULT_SALES_CONFIG, curve: { ...DEFAULT_SALES_CURVE } };
            }
            salesConfig = cfg;
            salesCurveHourly = { ...cfg.curve };
        }

        function resetSalesCurve() {
            if (!confirm('Reset sales curve to defaults? This cannot be undone.')) return;
            salesCurveHourly = { ...DEFAULT_SALES_CURVE };
            saveSalesConfig();
            buildCurveAdminTable();
            // If sales data exists, recalculate it
            if (Object.keys(scheduleData).length > 0 || getDailySalesTotalsFromInputs()['Monday']) {
                generateReport();
            }
        }

        function saveSalesConfig() {
            if (!salesConfig) {
                salesConfig = { ...DEFAULT_SALES_CONFIG, curve: { ...DEFAULT_SALES_CURVE } };
            }
            salesConfig.curve = { ...salesCurveHourly };
            try {
                localStorage.setItem(SALES_CURVE_STORAGE_KEY, JSON.stringify(salesConfig));
            } catch (e) {
                console.warn('Failed to save sales config to storage', e);
            }
        }

        function buildCurveAdminTable() {
            const tbody = document.getElementById('curveAdminBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            HOURS.forEach(hour => {
                const tr = document.createElement('tr');
                const tdHour = document.createElement('td');
                tdHour.textContent = hour;
                const tdInput = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '0';
                input.step = '0.1';
                input.value = salesCurveHourly[hour] != null ? salesCurveHourly[hour] : 0;
                input.dataset.hour = hour;
                input.addEventListener('change', function() {
                    const h = this.dataset.hour;
                    const val = parseFloat(this.value);
                    salesCurveHourly[h] = isNaN(val) ? 0 : val;
                    saveSalesConfig();
                    updateCurveTotalDisplay();
                });
                tdInput.appendChild(input);
                tr.appendChild(tdHour);
                tr.appendChild(tdInput);
                tbody.appendChild(tr);
            });

            updateCurveTotalDisplay();
        }

        function updateCurveTotalDisplay() {
            const el = document.getElementById('curveTotalDisplay');
            if (!el) return;
            let sum = 0;
            HOURS.forEach(h => {
                sum += salesCurveHourly[h] || 0;
            });
            el.textContent = `${sum.toFixed(1)}% (normalized to 100% in calculations)`;
        }

        function updateLaborMixTotalDisplay() {
            const el = document.getElementById('laborMixTotalDisplay');
            if (!el) return;
            const shares = (salesConfig && salesConfig.laborSharesPercent) || DEFAULT_SALES_CONFIG.laborSharesPercent;
            const foh = Number(shares.foh) || 0;
            const boh = Number(shares.boh) || 0;
            const other = Number(shares.other) || 0;
            const total = foh + boh + other;
            el.textContent = `${total.toFixed(1)}%`;
            if (Math.abs(total - 100) > 0.5) {
                el.classList.add('total-bad');
            } else {
                el.classList.remove('total-bad');
            }
        }

        function showCurveAdmin() {
            const panel = document.getElementById('curveAdminPanel');
            if (!panel) return;
            panel.style.display = 'block';
            
            // Populate config inputs when opening the panel
            const goals = getConfiguredGoals();
            const shares = (salesConfig && salesConfig.laborSharesPercent) || DEFAULT_SALES_CONFIG.laborSharesPercent;

            const overallInput = document.getElementById('config-goal-overall');
            const fohInput = document.getElementById('config-goal-foh');
            const bohInput = document.getElementById('config-goal-boh');
            if (overallInput) overallInput.value = goals.overall;
            if (fohInput) fohInput.value = goals.foh;
            if (bohInput) bohInput.value = goals.boh;

            const shareFOH = document.getElementById('config-share-foh');
            const shareBOH = document.getElementById('config-share-boh');
            const shareOther = document.getElementById('config-share-other');
            if (shareFOH) shareFOH.value = shares.foh;
            if (shareBOH) shareBOH.value = shares.boh;
            if (shareOther) shareOther.value = shares.other;

            updateLaborMixTotalDisplay();

            // Attach change listeners (idempotent)
            if (overallInput && !overallInput.dataset.bound) {
                overallInput.dataset.bound = 'true';
                overallInput.addEventListener('change', function() {
                    const val = parseFloat(this.value);
                    if (val && (val < 30 || val > 300)) {
                        setInputWarning(this, 'Unusual overall goal ‚Äì typical range is $30‚Äì$300/hr.');
                    } else {
                        setInputWarning(this, '');
                    }
                    if (!salesConfig) salesConfig = { ...DEFAULT_SALES_CONFIG, curve: { ...salesCurveHourly } };
                    salesConfig.goals.overall = isNaN(val) ? DEFAULT_SALES_CONFIG.goals.overall : val;
                    saveSalesConfig();
                });
            }
            if (fohInput && !fohInput.dataset.bound) {
                fohInput.dataset.bound = 'true';
                fohInput.addEventListener('change', function() {
                    const val = parseFloat(this.value);
                    if (val && (val < 20 || val > 300)) {
                        setInputWarning(this, 'Unusual FOH goal ‚Äì typical range is $20‚Äì$300/hr.');
                    } else {
                        setInputWarning(this, '');
                    }
                    if (!salesConfig) salesConfig = { ...DEFAULT_SALES_CONFIG, curve: { ...salesCurveHourly } };
                    salesConfig.goals.foh = isNaN(val) ? DEFAULT_SALES_CONFIG.goals.foh : val;
                    saveSalesConfig();
                });
            }
            if (bohInput && !bohInput.dataset.bound) {
                bohInput.dataset.bound = 'true';
                bohInput.addEventListener('change', function() {
                    const val = parseFloat(this.value);
                    if (val && (val < 20 || val > 300)) {
                        setInputWarning(this, 'Unusual BOH goal ‚Äì typical range is $20‚Äì$300/hr.');
                    } else {
                        setInputWarning(this, '');
                    }
                    if (!salesConfig) salesConfig = { ...DEFAULT_SALES_CONFIG, curve: { ...salesCurveHourly } };
                    salesConfig.goals.boh = isNaN(val) ? DEFAULT_SALES_CONFIG.goals.boh : val;
                    saveSalesConfig();
                });
            }

            const shareInputs = [
                { id: 'config-share-foh', key: 'foh' },
                { id: 'config-share-boh', key: 'boh' },
                { id: 'config-share-other', key: 'other' }
            ];
            shareInputs.forEach(({ id, key }) => {
                const input = document.getElementById(id);
                if (input && !input.dataset.bound) {
                    input.dataset.bound = 'true';
                    input.addEventListener('change', function() {
                        const val = parseFloat(this.value);
                        if (!salesConfig) salesConfig = { ...DEFAULT_SALES_CONFIG, curve: { ...salesCurveHourly } };
                        if (!salesConfig.laborSharesPercent) {
                            salesConfig.laborSharesPercent = { ...DEFAULT_SALES_CONFIG.laborSharesPercent };
                        }
                        salesConfig.laborSharesPercent[key] = isNaN(val) ? DEFAULT_SALES_CONFIG.laborSharesPercent[key] : val;
                        saveSalesConfig();
                        updateLaborMixTotalDisplay();

                        const total = (parseFloat(document.getElementById('config-share-foh').value) || 0)
                                      + (parseFloat(document.getElementById('config-share-boh').value) || 0)
                                      + (parseFloat(document.getElementById('config-share-other').value) || 0);
                        if (Math.abs(total - 100) > 15) {
                            setInputWarning(this, 'Labor mix total is far from 100% ‚Äì double-check your shares.');
                        } else {
                            setInputWarning(this, '');
                        }
                    });
                }
            });
        }

        function hideCurveAdmin() {
            const panel = document.getElementById('curveAdminPanel');
            if (!panel) return;
            panel.style.display = 'none';
        }

        function getDailySalesTotalsFromInputs() {
            const totals = {};
            const dayIds = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            dayIds.forEach(day => {
                const input = document.getElementById(`sales-${day}`);
                if (!input) return;
                const raw = input.value;
                if (raw === '') return;
                const val = parseFloat(raw);
                if (!isNaN(val) && val > 0) {
                    totals[day] = val;
                }
            });
            return totals;
        }

        function updateSalesDataFromDailyTotals() {
            salesData = {};
            const dailyTotals = getDailySalesTotalsFromInputs();
            if (Object.keys(dailyTotals).length === 0) {
                return;
            }

            let weightSum = 0;
            HOURS.forEach(h => {
                // Explicitly parse float to avoid string concatenation bugs
                weightSum += parseFloat(salesCurveHourly[h]) || 0;
            });
            
            if (weightSum <= 0) {
                return;
            }

            Object.keys(scheduleData).forEach(day => {
                const totalSales = dailyTotals[day] || 0;
                if (totalSales <= 0) {
                    return;
                }
                salesData[day] = {};
                HOURS.forEach(hour => {
                    const weight = parseFloat(salesCurveHourly[hour]) || 0;
                    const fraction = weight / weightSum;
                    salesData[day][hour] = totalSales * fraction;
                });
            });
        }
        
        // Helper function to combine FOH and BOH data
        function combineScheduleData() {
            scheduleData = {};
            
            // Initialize with all days and hours
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const hours = ['5 AM', '6 AM', '7 AM', '8 AM', '9 AM', '10 AM', '11 AM', '12 PM', 
                          '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM', '8 PM', 
                          '9 PM', '10 PM', '11 PM'];
            
            days.forEach(day => {
                scheduleData[day] = {};
                hours.forEach(hour => {
                    const fohCount = (fohScheduleData[day] && fohScheduleData[day][hour]) || 0;
                    const bohCount = (bohScheduleData[day] && bohScheduleData[day][hour]) || 0;
                    scheduleData[day][hour] = fohCount + bohCount;
                });
            });
            
            // Remove days with no data
            Object.keys(scheduleData).forEach(day => {
                let hasData = false;
                Object.values(scheduleData[day]).forEach(count => {
                    if (count > 0) hasData = true;
                });
                if (!hasData) delete scheduleData[day];
            });
        }
        
        // Function to switch department view
        function switchDepartmentView(view, event) {
            currentDepartmentView = view;
            
            // Update button states
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update schedule data based on view
            if (view === 'foh') {
                scheduleData = {...fohScheduleData};
            } else if (view === 'boh') {
                scheduleData = {...bohScheduleData};
            } else {
                combineScheduleData();
            }

            updateViewBadge();
            
            // Regenerate the display
            if (Object.keys(scheduleData).length > 0) {
                generateReport();
            }

            // Also update Ideal Model if visible
            const idealPanel = document.getElementById('idealModelPanel');
            if (idealPanel && idealPanel.style.display !== 'none') {
                generateIdealSchedule();
            }
        }

        function parseFOHScheduleCSV(csvText) {
            // Reset FOH schedule data
            fohScheduleData = {
                'Sunday': {}, 'Monday': {}, 'Tuesday': {}, 'Wednesday': {},
                'Thursday': {}, 'Friday': {}, 'Saturday': {}
            };
            // Reset FOH staff names
            fohStaffNames = {
                'Sunday': {}, 'Monday': {}, 'Tuesday': {}, 'Wednesday': {},
                'Thursday': {}, 'Friday': {}, 'Saturday': {}
            };

            const lines = csvText.split('\n');
            
            // Initialize all hours for all days
            const hours = ['5 AM', '6 AM', '7 AM', '8 AM', '9 AM', '10 AM', '11 AM', '12 PM', 
                          '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM', '8 PM', 
                          '9 PM', '10 PM', '11 PM'];
            
            Object.keys(fohScheduleData).forEach(day => {
                hours.forEach(hour => {
                    fohScheduleData[day][hour] = 0;
                    fohStaffNames[day][hour] = []; // Initialize empty array for names
                });
            });

            // Count employees per hour
            const employeesByDayHour = {};
            
            // Process each line (skip header)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parse CSV line
                const parts = line.split(',');
                if (parts.length < 3) continue;
                
                const dateStr = parts[0].trim();
                const timeStr = parts[1].trim();
                const employee = parts[2].trim();
                
                if (!dateStr || !timeStr || !employee) continue;
                
                // Parse date to get day of week
                const dateParts = dateStr.split('/');
                if (dateParts.length === 3) {
                    const month = parseInt(dateParts[0]) - 1; // JavaScript months are 0-indexed
                    const day = parseInt(dateParts[1]);
                    const year = parseInt(dateParts[2]);
                    
                    const date = new Date(year, month, day);
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const dayOfWeek = dayNames[date.getDay()];
                    
                    // Normalize time format (remove leading zeros from hour)
                    let normalizedTime = timeStr;
                    const timeParts = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                    if (timeParts) {
                        let hour = parseInt(timeParts[1]);
                        const period = timeParts[3].toUpperCase();
                        normalizedTime = `${hour}:${timeParts[2]} ${period}`;
                        
                        // Further normalize to match our hours array format
                        if (timeParts[2] === '00') {
                            normalizedTime = `${hour} ${period}`;
                        }
                    }
                    
                    // Create unique key for day-hour
                    const key = `${dayOfWeek}-${normalizedTime}`;
                    
                    // Track unique employees to avoid double counting
                    if (!employeesByDayHour[key]) {
                        employeesByDayHour[key] = new Set();
                    }
                    employeesByDayHour[key].add(employee);
                }
            }
            
            // Convert employee sets to counts AND store names
            Object.keys(employeesByDayHour).forEach(key => {
                const [dayOfWeek, time] = key.split('-');
                if (fohScheduleData[dayOfWeek] && hours.includes(time)) {
                    fohScheduleData[dayOfWeek][time] = employeesByDayHour[key].size;
                    // Sort names alphabetically for cleaner display
                    fohStaffNames[dayOfWeek][time] = Array.from(employeesByDayHour[key]).sort();
                }
            });
            
            // Remove any day that has no scheduled staff (closed days)
            Object.keys(fohScheduleData).forEach(day => {
                let hasData = false;
                hours.forEach(hour => {
                    if (fohScheduleData[day][hour] > 0) hasData = true;
                });
                if (!hasData) {
                    delete fohScheduleData[day];
                    delete fohStaffNames[day];
                }
            });
            
            console.log('FOH schedule data loaded:', fohScheduleData);
            
            // Update combined data
            combineScheduleData();
            
            // Verify we loaded some data
            let hasData = false;
            Object.keys(fohScheduleData).forEach(day => {
                Object.keys(fohScheduleData[day]).forEach(hour => {
                    if (fohScheduleData[day][hour] > 0) hasData = true;
                });
            });
            
            if (hasData) {
                alert('‚úÖ FOH schedule loaded! Found data for ' + Object.keys(fohScheduleData).join(', '));
            } else {
                alert('‚ö†Ô∏è No FOH schedule data found. Please check your CSV format.');
            }
        }

        function parseBOHScheduleCSV(csvText) {
            // Reset BOH schedule data
            bohScheduleData = {
                'Sunday': {}, 'Monday': {}, 'Tuesday': {}, 'Wednesday': {},
                'Thursday': {}, 'Friday': {}, 'Saturday': {}
            };
            // Reset BOH staff names
            bohStaffNames = {
                'Sunday': {}, 'Monday': {}, 'Tuesday': {}, 'Wednesday': {},
                'Thursday': {}, 'Friday': {}, 'Saturday': {}
            };

            const lines = csvText.split('\n');
            
            // Initialize all hours for all days
            const hours = ['5 AM', '6 AM', '7 AM', '8 AM', '9 AM', '10 AM', '11 AM', '12 PM', 
                          '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM', '8 PM', 
                          '9 PM', '10 PM', '11 PM'];
            
            Object.keys(bohScheduleData).forEach(day => {
                hours.forEach(hour => {
                    bohScheduleData[day][hour] = 0;
                    bohStaffNames[day][hour] = []; // Initialize empty name arrays
                });
            });

            // Count employees per hour
            const employeesByDayHour = {};
            
            // Process each line (skip header)
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parse CSV line
                const parts = line.split(',');
                if (parts.length < 3) continue;
                
                const dateStr = parts[0].trim();
                const timeStr = parts[1].trim();
                const employee = parts[2].trim();
                
                if (!dateStr || !timeStr || !employee) continue;
                
                // Parse date to get day of week
                const dateParts = dateStr.split('/');
                if (dateParts.length === 3) {
                    const month = parseInt(dateParts[0]) - 1; // JavaScript months are 0-indexed
                    const day = parseInt(dateParts[1]);
                    const year = parseInt(dateParts[2]);
                    
                    const date = new Date(year, month, day);
                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    const dayOfWeek = dayNames[date.getDay()];
                    
                    // Normalize time format (remove leading zeros from hour)
                    let normalizedTime = timeStr;
                    const timeParts = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                    if (timeParts) {
                        let hour = parseInt(timeParts[1]);
                        const period = timeParts[3].toUpperCase();
                        normalizedTime = `${hour}:${timeParts[2]} ${period}`;
                        
                        // Further normalize to match our hours array format
                        if (timeParts[2] === '00') {
                            normalizedTime = `${hour} ${period}`;
                        }
                    }
                    
                    // Create unique key for day-hour
                    const key = `${dayOfWeek}-${normalizedTime}`;
                    
                    // Track unique employees to avoid double counting
                    if (!employeesByDayHour[key]) {
                        employeesByDayHour[key] = new Set();
                    }
                    employeesByDayHour[key].add(employee);
                }
            }
            
            // Convert employee sets to counts AND store names
            Object.keys(employeesByDayHour).forEach(key => {
                const [dayOfWeek, time] = key.split('-');
                if (bohScheduleData[dayOfWeek] && hours.includes(time)) {
                    bohScheduleData[dayOfWeek][time] = employeesByDayHour[key].size;
                    // Store sorted names
                    bohStaffNames[dayOfWeek][time] = Array.from(employeesByDayHour[key]).sort();
                }
            });
            
            // Remove any day that has no scheduled staff (closed days)
            Object.keys(bohScheduleData).forEach(day => {
                let hasData = false;
                hours.forEach(hour => {
                    if (bohScheduleData[day][hour] > 0) hasData = true;
                });
                if (!hasData) {
                    delete bohScheduleData[day];
                    delete bohStaffNames[day];
                }
            });
            
            console.log('BOH schedule data loaded:', bohScheduleData);
            
            // Update combined data
            combineScheduleData();
            
            // Verify we loaded some data
            let hasData = false;
            Object.keys(bohScheduleData).forEach(day => {
                Object.keys(bohScheduleData[day]).forEach(hour => {
                    if (bohScheduleData[day][hour] > 0) hasData = true;
                });
            });
            
            if (hasData) {
                alert('‚úÖ BOH schedule loaded! Found data for ' + Object.keys(bohScheduleData).join(', '));
            } else {
                alert('‚ö†Ô∏è No BOH schedule data found. Please check your CSV format.');
            }
        }

        function parseTime(timeStr) {
            const match = timeStr.match(/(\d{1,2}):?(\d{0,2})\s*(AM|PM)/i);
            if (!match) return 0;
            
            let hours = parseInt(match[1]);
            const isPM = match[3].toUpperCase() === 'PM';
            
            if (hours === 12 && !isPM) hours = 0;
            if (hours !== 12 && isPM) hours += 12;
            
            return hours;
        }
        
        // Robust CSV splitter that respects quoted fields and embedded commas
        function splitCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    // Handle doubled quotes inside quoted field
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(v => {
                let val = v.trim();
                if (val.startsWith('"') && val.endsWith('"')) {
                    val = val.slice(1, -1).replace(/""/g, '"');
                }
                return val;
            });
        }

        // Legacy CSV-based sales loading has been replaced by daily estimate inputs and a configurable curve.

        // Sample data function - kept for potential testing but button removed
        /*
        function loadSampleData() {
            // Sample schedule data with overlapping shifts
            scheduleData = {
                'Monday': {
                    '5 AM': 3, '6 AM': 5, '7 AM': 8, '8 AM': 12, '9 AM': 15,
                    '10 AM': 18, '11 AM': 20, '12 PM': 22, '1 PM': 21, '2 PM': 19,
                    '3 PM': 17, '4 PM': 16, '5 PM': 18, '6 PM': 20, '7 PM': 18,
                    '8 PM': 15, '9 PM': 12, '10 PM': 8, '11 PM': 4
                },
                'Tuesday': {
                    '5 AM': 3, '6 AM': 4, '7 AM': 7, '8 AM': 11, '9 AM': 14,
                    '10 AM': 16, '11 AM': 19, '12 PM': 21, '1 PM': 20, '2 PM': 18,
                    '3 PM': 16, '4 PM': 15, '5 PM': 17, '6 PM': 19, '7 PM': 17,
                    '8 PM': 14, '9 PM': 11, '10 PM': 7, '11 PM': 3
                },
                'Wednesday': {
                    '5 AM': 4, '6 AM': 6, '7 AM': 9, '8 AM': 13, '9 AM': 16,
                    '10 AM': 19, '11 AM': 21, '12 PM': 23, '1 PM': 22, '2 PM': 20,
                    '3 PM': 18, '4 PM': 17, '5 PM': 19, '6 PM': 21, '7 PM': 19,
                    '8 PM': 16, '9 PM': 13, '10 PM': 9, '11 PM': 5
                },
                'Thursday': {
                    '5 AM': 3, '6 AM': 5, '7 AM': 8, '8 AM': 12, '9 AM': 15,
                    '10 AM': 17, '11 AM': 20, '12 PM': 22, '1 PM': 21, '2 PM': 19,
                    '3 PM': 17, '4 PM': 16, '5 PM': 18, '6 PM': 20, '7 PM': 18,
                    '8 PM': 15, '9 PM': 12, '10 PM': 8, '11 PM': 4
                },
                'Friday': {
                    '5 AM': 4, '6 AM': 6, '7 AM': 10, '8 AM': 14, '9 AM': 17,
                    '10 AM': 20, '11 AM': 23, '12 PM': 25, '1 PM': 24, '2 PM': 22,
                    '3 PM': 20, '4 PM': 19, '5 PM': 21, '6 PM': 24, '7 PM': 22,
                    '8 PM': 19, '9 PM': 16, '10 PM': 12, '11 PM': 6
                },
                'Saturday': {
                    '5 AM': 5, '6 AM': 7, '7 AM': 11, '8 AM': 15, '9 AM': 19,
                    '10 AM': 22, '11 AM': 25, '12 PM': 27, '1 PM': 26, '2 PM': 24,
                    '3 PM': 22, '4 PM': 21, '5 PM': 23, '6 PM': 25, '7 PM': 23,
                    '8 PM': 20, '9 PM': 17, '10 PM': 13, '11 PM': 7
                }
            };

            // Sample sales data (using realistic average daily sales)
            salesData = {};
            const avgSales = {
                '5 AM': 250,
                '6 AM': 931,
                '7 AM': 1253,
                '8 AM': 1611,
                '9 AM': 2055,
                '10 AM': 2663,
                '11 AM': 3332,
                '12 PM': 3686,
                '1 PM': 3118,
                '2 PM': 2528,
                '3 PM': 2446,
                '4 PM': 2402,
                '5 PM': 2539,
                '6 PM': 2551,
                '7 PM': 2433,
                '8 PM': 2352,
                '9 PM': 1864,
                '10 PM': 44,
                '11 PM': 0
            };
            
            // Apply average sales to all days in schedule
            Object.keys(scheduleData).forEach(day => {
                salesData[day] = {...avgSales};
            });

            generateReport();
        }
        */

        function generateReport() {
            // Show all panels
            document.getElementById('metricsPanel').style.display = 'grid';
            document.getElementById('scheduleGrid').style.display = 'block';
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('insightsPanel').style.display = 'block';

            // Check if we have at least FOH or BOH data
            const hasFOHData = Object.keys(fohScheduleData).length > 0;
            const hasBOHData = Object.keys(bohScheduleData).length > 0;
            
            if (!hasFOHData && !hasBOHData) {
                alert('Please upload at least one schedule file (FOH or BOH)!');
                document.getElementById('metricsPanel').style.display = 'none';
                document.getElementById('scheduleGrid').style.display = 'none';
                document.getElementById('chartContainer').style.display = 'none';
                document.getElementById('insightsPanel').style.display = 'none';
                return;
            }
            
            // Make sure schedule data reflects the current view
            if (currentDepartmentView === 'foh') {
                scheduleData = JSON.parse(JSON.stringify(fohScheduleData));
            } else if (currentDepartmentView === 'boh') {
                scheduleData = JSON.parse(JSON.stringify(bohScheduleData));
            } else {
                combineScheduleData();
            }
            
            // If current view is a department that has no data, switch to overall
            if (currentDepartmentView === 'foh' && !hasFOHData) {
                switchDepartmentView('overall', null);
            } else if (currentDepartmentView === 'boh' && !hasBOHData) {
                switchDepartmentView('overall', null);
            }

            // Build sales data from daily estimates and the sales curve
            updateSalesDataFromDailyTotals();

            // Calculate metrics
            calculateMetrics();
            
            // Generate schedule table
            generateScheduleTable();
            
            // Create chart
            createChart();
            
            // Create per-day mini charts
            createDayCharts();
            
            // Generate insights
            generateInsights();
        }

        function calculateMetrics() {
            let totalStaff = 0;
            let totalHours = 0;
            let totalSales = 0;
            let totalLaborHours = 0;
            let sumSPLH = 0;
            let splhSamples = 0;
            const dailySalesTotals = {};
            const dailyLaborTotals = {};
            
            const hasSalesData = Object.keys(salesData).length > 0;
            const goal = getProductivityGoal(); // Get current department goal

            const salesFractions = hasSalesData ? getSalesFractions() : { fohFraction: 0, bohFraction: 0 };

            Object.keys(scheduleData).forEach(day => {
                Object.keys(scheduleData[day]).forEach(hour => {
                    // Respect current daypart selection
                    if (!isHourInCurrentDaypart(hour)) {
                        return;
                    }
                    const staff = scheduleData[day][hour];
                    if (staff > 0) {
                        totalStaff += staff;
                        totalHours++;
                        totalLaborHours += staff; // Each person works 1 hour

                        if (!dailyLaborTotals[day]) dailyLaborTotals[day] = 0;
                        dailyLaborTotals[day] += staff;
                    }
                    
                    if (hasSalesData && salesData[day] && salesData[day][hour] && staff > 0) {
                        const rawSales = salesData[day][hour];
                        let effectiveSales = rawSales;
                        if (currentDepartmentView === 'foh') {
                            effectiveSales = rawSales * salesFractions.fohFraction;
                        } else if (currentDepartmentView === 'boh') {
                            effectiveSales = rawSales * salesFractions.bohFraction;
                        }

                        totalSales += effectiveSales;
                        if (!dailySalesTotals[day]) dailySalesTotals[day] = 0;
                        dailySalesTotals[day] += effectiveSales;
                        
                        const splh = effectiveSales / staff;
                        sumSPLH += splh;
                        splhSamples++;
                    }
                });
            });

            // Update metric cards
            const avgStaff = totalHours > 0 ? (totalStaff / totalHours).toFixed(1) : '0';
            document.getElementById('avgStaff').textContent = avgStaff;
            
            // Update the Sales/Labor Hour label to show current goal
            const splhLabel = document.querySelector('#splh').parentElement.querySelector('.metric-label');
            const deptName = currentDepartmentView === 'foh' ? 'FOH' : currentDepartmentView === 'boh' ? 'BOH' : 'Overall';
            splhLabel.textContent = `${deptName} $/LH (Goal: $${goal.toFixed(2)})`;
            // Update productivity card label to reflect SPLH
            const prodLabel = document.querySelector('#peakEfficiency').parentElement.querySelector('.metric-label');
            prodLabel.textContent = `${deptName} Productivity ($/LH)`;
            
            if (hasSalesData && totalLaborHours > 0) {
                const avgProductivity = splhSamples > 0 ? Math.round(sumSPLH / splhSamples) : 0;
                document.getElementById('peakEfficiency').textContent = '$' + avgProductivity;
                
                // Calculate SPLH correctly: total sales divided by total labor hours (Weighted Average)
                const splh = Math.round(totalSales / totalLaborHours);
                
                // Update Box 2 (Productivity) to use the Weighted Average (same as Box 3) for consistency
                document.getElementById('peakEfficiency').textContent = '$' + splh;
                
                // Update Box 3 (Comparison vs Goal)
                document.getElementById('splh').textContent = '$' + splh;
                
                // Update the change indicator to show vs department goal
                const splhChange = document.querySelector('#splh').nextElementSibling;
                const difference = splh - goal;
                if (difference > 0) {
                    splhChange.textContent = `+$${difference.toFixed(0)} vs $${goal.toFixed(0)} goal`;
                    splhChange.className = 'metric-change positive';
                } else {
                    splhChange.textContent = `$${difference.toFixed(0)} vs $${goal.toFixed(0)} goal`;
                    splhChange.className = 'metric-change negative';
                }
                
                // Helper text under productivity card (Box 2)
                const efficiencyChange = document.querySelector('#peakEfficiency').nextElementSibling;
                efficiencyChange.textContent = 'Total Sales / Total Hours';
                efficiencyChange.className = 'metric-change';
            } else {
                document.getElementById('peakEfficiency').textContent = 'N/A';
                document.getElementById('splh').textContent = 'N/A';
                document.querySelector('#splh').nextElementSibling.textContent = 'Enter daily sales estimates to see $/LH';
                document.querySelector('#splh').nextElementSibling.className = 'metric-change';
            }
            
            // Update labor cost (placeholder - could be enhanced with wage data)
            document.getElementById('laborCost').textContent = totalLaborHours + ' hrs';
            const laborCostChange = document.querySelector('#laborCost').nextElementSibling;
            laborCostChange.textContent = `${deptName} scheduled hours`;
            laborCostChange.className = 'metric-change';
            
            // Update average staff comparison
            const avgStaffChange = document.querySelector('#avgStaff').nextElementSibling;
            if (avgStaff < 10) {
                avgStaffChange.textContent = 'Light coverage';
                avgStaffChange.className = 'metric-change negative';
            } else if (avgStaff > 15) {
                avgStaffChange.textContent = 'Heavy coverage';
                avgStaffChange.className = 'metric-change';
            } else {
                avgStaffChange.textContent = 'Balanced coverage';
                avgStaffChange.className = 'metric-change positive';
            }

            // Update per-day productivity summary under the main chart
            const summaryEl = document.getElementById('dailyProductivitySummary');
            if (summaryEl) {
                if (!hasSalesData || Object.keys(dailySalesTotals).length === 0) {
                    summaryEl.textContent = 'Enter daily sales estimates above to see per-day productivity ($/LH).';
                } else {
                    const deptName = currentDepartmentView === 'foh' ? 'FOH' : currentDepartmentView === 'boh' ? 'BOH' : 'Overall';
                    const parts = [];
                    Object.keys(dailySalesTotals).forEach(day => {
                        const daySales = dailySalesTotals[day] || 0;
                        const dayLabor = dailyLaborTotals[day] || 0;
                        if (daySales > 0 && dayLabor > 0) {
                            const dayProd = daySales / dayLabor;
                            parts.push(`${day}: $${dayProd.toFixed(0)}/LH`);
                        }
                    });
                    if (parts.length > 0) {
                        summaryEl.textContent = `${deptName} daily productivity: ` + parts.join(' ¬∑ ');
                    } else {
                        summaryEl.textContent = 'No per-day productivity available yet for this view.';
                    }
                }
            }

            // Calculate and display overtime data
            updateOvertimeDisplay();
        }

        // ============================================
        // OVERTIME TRACKING FUNCTIONS
        // ============================================

        function calculateOvertimeData() {
            const employeeHours = {}; // { "Alice Smith": 32, "Bob Jones": 45, ... }
            
            // 1. Aggregate FOH hours - each appearance in fohStaffNames = 1 hour worked
            Object.keys(fohStaffNames).forEach(day => {
                Object.keys(fohStaffNames[day]).forEach(hour => {
                    const names = fohStaffNames[day][hour] || [];
                    names.forEach(name => {
                        if (!name || name.trim() === '') return;
                        const cleanName = name.trim();
                        if (!employeeHours[cleanName]) employeeHours[cleanName] = 0;
                        employeeHours[cleanName] += 1; // Each slot = 1 hour
                    });
                });
            });
            
            // 2. Aggregate BOH hours - each appearance in bohStaffNames = 1 hour worked
            Object.keys(bohStaffNames).forEach(day => {
                Object.keys(bohStaffNames[day]).forEach(hour => {
                    const names = bohStaffNames[day][hour] || [];
                    names.forEach(name => {
                        if (!name || name.trim() === '') return;
                        const cleanName = name.trim();
                        if (!employeeHours[cleanName]) employeeHours[cleanName] = 0;
                        employeeHours[cleanName] += 1;
                    });
                });
            });
            
            // 3. Calculate OT for each employee (hours over 40)
            let totalOTHours = 0;
            const employeesInOT = [];
            
            Object.keys(employeeHours).forEach(name => {
                const hours = employeeHours[name];
                if (hours > 40) {
                    const ot = hours - 40;
                    totalOTHours += ot;
                    employeesInOT.push({ name, totalHours: hours, otHours: ot });
                }
            });
            
            // Sort by most OT first
            employeesInOT.sort((a, b) => b.otHours - a.otHours);
            
            return {
                totalOTHours,
                employeesInOT,
                employeeCount: employeesInOT.length,
                allEmployeeHours: employeeHours,
                totalEmployees: Object.keys(employeeHours).length
            };
        }

        function updateOvertimeDisplay() {
            const otData = calculateOvertimeData();
            
            // Update the OT metric card
            const otHoursEl = document.getElementById('otHours');
            const otSubtextEl = document.getElementById('otSubtext');
            
            if (!otHoursEl || !otSubtextEl) return;
            
            otHoursEl.textContent = otData.totalOTHours + ' hrs';
            
            if (otData.employeeCount === 0) {
                otSubtextEl.textContent = 'No overtime this week';
                otSubtextEl.className = 'metric-change positive';
            } else if (otData.employeeCount === 1) {
                otSubtextEl.textContent = `1 employee over 40 hrs`;
                otSubtextEl.className = 'metric-change warning';
            } else {
                otSubtextEl.textContent = `${otData.employeeCount} employees over 40 hrs`;
                otSubtextEl.className = 'metric-change warning';
            }
        }

        function showOTBreakdown() {
            const otData = calculateOvertimeData();
            const modalBody = document.getElementById('otModalBody');
            
            if (!modalBody) return;
            
            let html = '';
            
            // Summary section
            html += `<div class="ot-summary">
                <div class="ot-summary-value">${otData.totalOTHours} hrs</div>
                <div class="ot-summary-label">Total Overtime (${otData.employeeCount} of ${otData.totalEmployees} employees)</div>
            </div>`;
            
            if (otData.employeesInOT.length === 0) {
                html += `<div class="ot-no-overtime">
                    <div class="ot-no-overtime-icon">üéâ</div>
                    <div class="ot-no-overtime-text">No employees are in overtime this week!</div>
                </div>`;
            } else {
                html += `<div class="ot-list">
                    <div class="ot-list-header">
                        <span class="ot-col-name">Employee</span>
                        <span class="ot-col-hrs">Total</span>
                        <span class="ot-col-ot">OT</span>
                    </div>`;
                
                otData.employeesInOT.forEach(emp => {
                    html += `<div class="ot-list-row">
                        <span class="ot-col-name" title="${emp.name}">${emp.name}</span>
                        <span class="ot-col-hrs">${emp.totalHours}</span>
                        <span class="ot-col-ot">${emp.otHours}</span>
                    </div>`;
                });
                
                html += `</div>`;
            }
            
            modalBody.innerHTML = html;
            document.getElementById('otModal').style.display = 'flex';
        }

        function hideOTModal() {
            document.getElementById('otModal').style.display = 'none';
        }

        // Close OT modal when clicking outside of it
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('otModal');
            if (event.target === modal) {
                hideOTModal();
            }
        });

        function generateScheduleTable() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            
            // Update grid title based on department view
            const gridTitle = document.getElementById('gridTitle');
            const deptName = currentDepartmentView === 'foh' ? 'FOH' : currentDepartmentView === 'boh' ? 'BOH' : 'Overall';
            gridTitle.textContent = `${deptName} Staff Coverage vs Sales Volume`;
            
            // Respect current daypart selection for rows/columns
            const hours = HOURS.filter(h => isHourInCurrentDaypart(h));
            
            const hasSalesData = Object.keys(salesData).length > 0;
            
            // Debug: log first day's sales data keys if available
            if (hasSalesData) {
                const firstDay = Object.keys(salesData)[0];
                console.log('Sales data check - First day:', firstDay, 'Hours with data:', Object.keys(salesData[firstDay] || {}));
            }
            
            // Get the days that have data
            const daysWithData = Object.keys(scheduleData);
            
            // Update table header
            const thead = document.querySelector('#scheduleTable thead tr');
                        thead.innerHTML = '<th>Hour</th>';
            daysWithData.forEach(day => {
                thead.innerHTML += `<th>${day}</th>`;
            });

            // Pre-compute recommended staffing per hour for FOH, BOH, and Overall logic
            const goals = getConfiguredGoals();
            const shares = getLaborShares();
            
            // We need specific recommendations for FOH and BOH regardless of current view 
            // to support the "Smart Aggregate" logic in Overall view.
            const recFOH = {};
            const recBOH = {};

            if (hasSalesData) {
                daysWithData.forEach(day => {
                    recFOH[day] = {};
                    recBOH[day] = {};
                    hours.forEach(hour => {
                        const salesHour = salesData[day] && salesData[day][hour] !== undefined ? salesData[day][hour] : 0;
                        if (salesHour > 0) {
                            // FOH Target
                            // Note: goal = $/hr. salesHour is total store sales.
                            // We want (salesHour * fohShare) / goalFOH ? No, simpler:
                            // Total Sales / Overall Goal = Total Staff.
                            // Then Total Staff * FOH% = FOH Staff.
                            // Actually, the consistent formula used before was:
                            // (Sales / OverallGoal) * SharePercent. Let's stick to that.
                            
                            // FOH
                            const fohHours = (salesHour / goals.overall) * shares.fohShare;
                            recFOH[day][hour] = Math.floor(fohHours);

                            // BOH
                            const bohHours = (salesHour / goals.overall) * shares.bohShare;
                            recBOH[day][hour] = Math.floor(bohHours);
                        } else {
                            recFOH[day][hour] = 0;
                            recBOH[day][hour] = 0;
                        }
                    });
                });
            }
            
            hours.forEach(hour => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="hour-label">${hour}</td>`;
                
                daysWithData.forEach(day => {
                    const cell = document.createElement('td');
                    const staffCount = scheduleData[day][hour] || 0;
                    const rawSales = salesData[day] && salesData[day][hour] !== undefined ? salesData[day][hour] : 0;
                    
                    // Determine context-specific values
                    let effectiveSales = rawSales;
                    let rec = 0;
                    let staffClass = '';
                    let suggestionHtml = '';

                    if (currentDepartmentView === 'foh') {
                        effectiveSales = rawSales * getSalesFractions().fohFraction;
                        rec = recFOH[day] ? recFOH[day][hour] : 0;
                    } else if (currentDepartmentView === 'boh') {
                        effectiveSales = rawSales * getSalesFractions().bohFraction;
                        rec = recBOH[day] ? recBOH[day][hour] : 0;
                    } else {
                        // Overall View
                        effectiveSales = rawSales; 
                        // We don't have a single "rec" that matters as much as the components
                    }

                    // --- LOGIC FOR FOH/BOH VIEWS (Standard) ---
                    if (currentDepartmentView !== 'overall') {
                        if (rec > 0 && hasSalesData) {
                            const diff = staffCount - rec;
                            if (diff <= -2) staffClass = 'understaffed';
                            else if (diff >= -1 && diff <= 1) staffClass = 'low-staffed'; // Using 'low-staffed' as 'near' color (yellowish/orange) or 'well-staffed' logic? 
                            // Re-reading existing CSS classes:
                            // .understaffed = red
                            // .low-staffed = orange/yellow
                            // .well-staffed = green
                            // .overstaffed = purple/blue
                            
                            if (diff <= -2) staffClass = 'understaffed';
                            else if (diff === -1 || diff === 1) staffClass = 'low-staffed';
                            else if (diff === 0) staffClass = 'well-staffed';
                            else if (diff >= 2) staffClass = 'overstaffed';
                            
                            // Generate text
                            if (staffCount < rec) suggestionHtml = `<div class="staff-suggestion staff-suggestion-below">Suggested: ${rec} (below)</div>`;
                            else if (staffCount > rec) suggestionHtml = `<div class="staff-suggestion staff-suggestion-above">Suggested: ${rec} (above)</div>`;
                            else suggestionHtml = `<div class="staff-suggestion staff-suggestion-at">Suggested: ${rec} (perfect)</div>`;
                        }
                    } 
                    // --- LOGIC FOR OVERALL VIEW (Smart Aggregate) ---
                    else if (hasSalesData) {
                        // We need actual staff counts for FOH vs BOH to compare against Rec
                        const actualFOH = fohScheduleData[day] ? (fohScheduleData[day][hour] || 0) : 0;
                        const actualBOH = bohScheduleData[day] ? (bohScheduleData[day][hour] || 0) : 0;
                        
                        const targetFOH = recFOH[day] ? recFOH[day][hour] : 0;
                        const targetBOH = recBOH[day] ? recBOH[day][hour] : 0;

                        if (targetFOH > 0 && targetBOH > 0) {
                            const diffFOH = actualFOH - targetFOH;
                            const diffBOH = actualBOH - targetBOH;

                            // Define severe/mild thresholds
                            const isSevere = (d) => Math.abs(d) >= 2;
                            const isMild = (d) => Math.abs(d) === 1;

                            // 1. Determine Color Class
                            if (isSevere(diffFOH) || isSevere(diffBOH)) {
                                staffClass = 'understaffed'; // RED (Severe imbalance)
                            } else if (isMild(diffFOH) || isMild(diffBOH)) {
                                staffClass = 'low-staffed'; // YELLOW (Mild imbalance)
                            } else {
                                staffClass = 'well-staffed'; // GREEN (Balanced)
                            }

                            // 2. Generate Summary Text
                            // Priority: Show severe problems first
                            let fohMsg = '', bohMsg = '';
                            
                            // High contrast badge style
                            const badgeStyle = "background:rgba(255,255,255,0.9); color:#0f172a; padding:1px 5px; border-radius:4px; box-shadow:0 1px 2px rgba(0,0,0,0.15); font-weight:700; border:1px solid rgba(0,0,0,0.1);";
                            const severeStyle = "color:#dc2626;"; // Darker red text for severe inside the white badge
                            
                            if (diffFOH !== 0) {
                                let txt = `FOH: ${diffFOH > 0 ? '+' : ''}${diffFOH}`;
                                let style = Math.abs(diffFOH) >= 2 ? severeStyle : '';
                                fohMsg = `<span style="${style}">${txt}</span>`;
                            }
                            if (diffBOH !== 0) {
                                let txt = `BOH: ${diffBOH > 0 ? '+' : ''}${diffBOH}`;
                                let style = Math.abs(diffBOH) >= 2 ? severeStyle : '';
                                bohMsg = `<span style="${style}">${txt}</span>`;
                            }

                            if (diffFOH === 0 && diffBOH === 0) {
                                suggestionHtml = `<div class="staff-suggestion staff-suggestion-at" style="${badgeStyle} color:#15803d;">Balanced</div>`;
                            } else {
                                // Construct the line
                                let parts = [];
                                if (fohMsg) parts.push(fohMsg);
                                if (bohMsg) parts.push(bohMsg);
                                
                                suggestionHtml = `<div class="staff-suggestion" style="display:flex; gap:4px; justify-content:center; font-size:10px; ${badgeStyle}">${parts.join('<span style="color:#cbd5e1; margin:0 2px;">|</span>')}</div>`;
                            }
                        }
                    }

                    // Fallback if no sales data or Logic didn't run
                    if (!staffClass) {
                         if (staffCount < 10) staffClass = 'understaffed';
                         else if (staffCount < 15) staffClass = 'low-staffed';
                         else if (staffCount < 20) staffClass = 'adequate-staffed'; // Note: adequate-staffed might not be defined in CSS, defaulting to none or well-staffed
                         else staffClass = 'well-staffed';
                    }
                    
                    // Calculate sales overlay height
                    const maxSales = 5000; 
                    const salesHeight = hasSalesData && rawSales > 0 ? Math.min((rawSales / maxSales) * 100, 100) : 0;

                    cell.innerHTML = `
                        <div class="staff-cell ${staffClass}" onclick="openStaffModal('${day}', '${hour}', event)">
                            ${hasSalesData ? `<div class="sales-overlay" style="height: ${salesHeight}%;"></div>` : ''}
                            <div class="staff-count">
                                ${staffCount}
                                <div class="staff-label">staff</div>
                                ${suggestionHtml}
                            </div>
                        </div>
                    `;
                    
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }

        function createChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const hasSalesData = Object.keys(salesData).length > 0;
            
            if (!hasSalesData) {
                // Show only staffing levels if no sales data
                const baseHours = ['5AM', '6AM', '7AM', '8AM', '9AM', '10AM', '11AM', '12PM', 
                              '1PM', '2PM', '3PM', '4PM', '5PM', '6PM', '7PM', '8PM', 
                              '9PM', '10PM', '11PM'];
                
                const hours = [];
                const avgStaffing = [];
                
                baseHours.forEach((hour, index) => {
                    const hourLabel = hour.replace('AM', ' AM').replace('PM', ' PM');
                    if (!isHourInCurrentDaypart(hourLabel)) return;
                    hours.push(hour);
                    let totalStaff = 0;
                    let dayCount = 0;
                    
                    Object.keys(scheduleData).forEach(day => {
                        if (scheduleData[day][hourLabel]) {
                            totalStaff += scheduleData[day][hourLabel];
                            dayCount++;
                        }
                    });
                    
                    avgStaffing.push(dayCount > 0 ? totalStaff / dayCount : 0);
                });
                
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: hours,
                        datasets: [
                            {
                                label: 'Average Staff Count',
                                data: avgStaffing,
                                borderColor: 'rgb(102, 126, 234)',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 3,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Staffing Levels Only (No Sales Data Uploaded)'
                            }
                        }
                    }
                });
                return;
            }
            
            // Full chart with sales data (All Days Average)
            const baseHours = ['5AM', '6AM', '7AM', '8AM', '9AM', '10AM', '11AM', '12PM', 
                          '1PM', '2PM', '3PM', '4PM', '5PM', '6PM', '7PM', '8PM', 
                          '9PM', '10PM', '11PM'];
            
            // Filter hours by current daypart
            const hours = [];
            const avgStaffing = [];
            const avgProductivity = [];
            
            baseHours.forEach((hour) => {
                const hourLabel = hour.replace('AM', ' AM').replace('PM', ' PM');
                if (!isHourInCurrentDaypart(hourLabel)) {
                    return;
                }
                hours.push(hour);
                let totalStaff = 0;
                let totalSPLH = 0;
                let dayCount = 0;
                const fractions = getSalesFractions();
                Object.keys(scheduleData).forEach(day => {
                    if (scheduleData[day][hourLabel] !== undefined) {
                        const staff = scheduleData[day][hourLabel];
                        totalStaff += staff;
                        if (salesData[day] && salesData[day][hourLabel] !== undefined) {
                            const rawSales = salesData[day][hourLabel];
                            let effectiveSales = rawSales;
                            if (currentDepartmentView === 'foh') {
                                effectiveSales = rawSales * fractions.fohFraction;
                            } else if (currentDepartmentView === 'boh') {
                                effectiveSales = rawSales * fractions.bohFraction;
                            }
                            if (staff > 0) totalSPLH += effectiveSales / staff;
                        }
                        dayCount++;
                    }
                });
                avgStaffing.push(dayCount > 0 ? totalStaff / dayCount : 0);
                avgProductivity.push(dayCount > 0 ? Math.round(totalSPLH / dayCount) : null);
            });
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: 'Average Staff Count',
                            data: avgStaffing,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3
                        },
                        {
                            label: 'Sales per Labor Hour ($)',
                            data: avgProductivity,
                            borderColor: 'rgb(251, 146, 60)',
                            backgroundColor: 'rgba(251, 146, 60, 0.1)',
                            yAxisID: 'y2',
                            tension: 0.3,
                            borderDash: [5, 5],
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Staff Count'
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (label.includes('Sales')) {
                                            label += '$' + context.parsed.y.toFixed(0);
                                        } else {
                                            label += context.parsed.y.toFixed(1);
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDayCharts() {
            const grid = document.getElementById('dayChartsGrid');
            if (!grid) return;
            // Clear previous canvases and destroy charts
            Object.values(dayChartInstances).forEach(inst => {
                if (inst && inst.destroy) inst.destroy();
            });
            dayChartInstances = {};
            grid.innerHTML = '';
            
            const desiredDays = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const daysToRender = desiredDays.filter(d => scheduleData[d]);
            if (daysToRender.length === 0) return;
            
            const baseHours = ['5AM', '6AM', '7AM', '8AM', '9AM', '10AM', '11AM', '12PM', 
                           '1PM', '2PM', '3PM', '4PM', '5PM', '6PM', '7PM', '8PM', 
                           '9PM', '10PM', '11PM'];
            
            daysToRender.forEach(day => {
                const card = document.createElement('div');
                card.className = 'day-chart-card';
                const title = document.createElement('div');
                title.className = 'day-chart-title';
                title.textContent = day;
                const canvas = document.createElement('canvas');
                card.appendChild(title);
                card.appendChild(canvas);
                grid.appendChild(card);
                
                // Build datasets for this day
                const dayHours = [];
                const staffSeries = [];
                const splhSeries = [];
                
                baseHours.forEach(h => {
                    const hourLabel = h.replace('AM', ' AM').replace('PM', ' PM');
                    if (!isHourInCurrentDaypart(hourLabel)) return;
                    dayHours.push(h);
                    const staff = scheduleData[day] && scheduleData[day][hourLabel] !== undefined ? scheduleData[day][hourLabel] : 0;
                    const rawSales = salesData[day] && salesData[day][hourLabel] !== undefined ? salesData[day][hourLabel] : null;
                    const fractions = getSalesFractions();
                    let effectiveSales = rawSales;
                    if (rawSales !== null) {
                        if (currentDepartmentView === 'foh') {
                            effectiveSales = rawSales * fractions.fohFraction;
                        } else if (currentDepartmentView === 'boh') {
                            effectiveSales = rawSales * fractions.bohFraction;
                        }
                    }
                    staffSeries.push(staff);
                    splhSeries.push(staff > 0 && effectiveSales !== null ? Math.round(effectiveSales / staff) : null);
                });
                
                const ctx = canvas.getContext('2d');
                dayChartInstances[day] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dayHours,
                        datasets: [
                            {
                                label: 'Staff Count',
                                data: staffSeries,
                                borderColor: 'rgb(102, 126, 234)',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                yAxisID: 'y',
                                tension: 0.3
                            },
                            {
                                label: 'Sales per Labor Hour ($)',
                                data: splhSeries,
                                borderColor: 'rgb(251, 146, 60)',
                                backgroundColor: 'rgba(251, 146, 60, 0.1)',
                                yAxisID: 'y2',
                                tension: 0.3,
                                borderDash: [5, 5],
                                spanGaps: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.2,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                ticks: { maxTicksLimit: 5 }
                            },
                            y2: {
                                type: 'linear',
                                display: false
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            });
        }

        function generateInsights() {
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = '';
            
            const insights = [];
            const hasSalesData = Object.keys(salesData).length > 0;
            const burnoutThreshold = document.getElementById('config-burnout') ? 
                                     (parseFloat(document.getElementById('config-burnout').value) || 150) : 150;

            // Containers for categorized plans
            const planCuts = [];
            const planAdds = [];
            const planBurnout = [];
            
            // Analyze staffing patterns
            Object.keys(scheduleData).forEach(day => {
                Object.keys(scheduleData[day]).forEach(hour => {
                    const staff = scheduleData[day][hour];
                    
                    if (!hasSalesData) {
                        // Insights based on staffing levels only
                        if (staff < 10 && (hour === '12 PM' || hour === '1 PM' || hour === '6 PM' || hour === '7 PM')) {
                            planAdds.push({
                                day, hour,
                                title: `Add Staff (Peak)`,
                                desc: `Only ${staff} scheduled for peak.`,
                                score: 30 - staff
                            });
                        }
                        
                        if (staff > 20 && (hour === '5 AM' || hour === '10 PM' || hour === '11 PM')) {
                            planCuts.push({
                                day, hour,
                                title: `Cut Staff (Off-Peak)`,
                                desc: `${staff} scheduled for off-peak.`,
                                score: staff - 15
                            });
                        }
                    } else {
                        // Full insights with sales data
                        const sales = salesData[day] && salesData[day][hour] ? salesData[day][hour] : 0;
                        const splh = staff > 0 ? sales / staff : 0;
                        const goal = getProductivityGoal();
                        
                        // Check for Burnout Risk
                        if (staff > 0 && splh > burnoutThreshold) {
                            planBurnout.push({
                                day, hour,
                                title: `Burnout Risk ($${splh.toFixed(0)}/hr)`,
                                desc: `${staff} staff handling $${sales.toFixed(0)} sales.`,
                                score: splh - burnoutThreshold
                            });
                        }

                        // Check for Understaffing (Needs Adds)
                        if (staff < 10 && sales > (goal * 10)) {
                            const needed = Math.ceil((sales/goal) - staff);
                            planAdds.push({
                                day, hour,
                                title: `Add ${needed} Staff`,
                                desc: `Missed sales potential ($${sales.toFixed(0)}). Goal: $${goal}.`,
                                score: Math.max(0, needed) * goal
                            });
                        } else if (splh > goal * 1.2 && splh <= burnoutThreshold) {
                             // High productivity but not burnout - maybe add 1 if very high?
                             const needed = Math.ceil((sales/goal) - staff);
                             if (needed > 0) {
                                 planAdds.push({
                                     day, hour,
                                     title: `Add ${needed} Staff`,
                                     desc: `High productivity ($${splh.toFixed(0)}).`,
                                     score: (splh - goal) * staff
                                 });
                             }
                        }
                        
                        // Check for Overstaffing (Needs Cuts)
                        if (staff > 2 && splh < goal * 0.75) {
                            const potentialReduction = Math.max(0, Math.floor(staff - (sales/goal)));
                            if (potentialReduction > 0) {
                            const dollarGap = goal - splh;
                                planCuts.push({
                                    day, hour,
                                    title: `Cut ${potentialReduction} Staff`,
                                    desc: `Productivity low ($${splh.toFixed(0)}). Goal: $${goal}.`,
                                    score: dollarGap * staff
                                });
                            }
                        }
                    }
                });
            });
            
            // Sort categories by urgency (score)
            const sortFn = (a, b) => b.score - a.score;
            planBurnout.sort(sortFn);
            planAdds.sort(sortFn);
            planCuts.sort(sortFn);

            // --- 1. CRITICAL ALERTS SECTION (Top 3 Across All Categories) ---
            // Merge all items to find the absolute worst problems
            const allItems = [
                ...planBurnout.map(i => ({...i, type: 'burnout', icon: 'üî•', label: 'BURNOUT RISK'})),
                ...planAdds.map(i => ({...i, type: 'add', icon: '‚ûï', label: 'UNDERSTAFFED'})),
                ...planCuts.map(i => ({...i, type: 'cut', icon: '‚úÇÔ∏è', label: 'OVERSTAFFED'}))
            ];
            allItems.sort((a, b) => b.score - a.score);
            const criticalItems = allItems.slice(0, 3);

            if (criticalItems.length > 0) {
                const critSection = document.createElement('div');
                critSection.className = 'critical-section';
                critSection.innerHTML = `
                    <div class="critical-header">
                        <span>üö® CRITICAL ACTIONS REQUIRED</span>
                    </div>
                    <div class="critical-grid">
                        ${criticalItems.map(item => `
                            <div class="plan-item ${item.type}" style="border-width:1px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);">
                                <div class="plan-item-top">
                                    <span class="plan-day-time">${item.day} ${item.hour}</span>
                                    <span class="plan-badge">${item.label}</span>
                                </div>
                                <div class="plan-title">${item.title}</div>
                                <div class="plan-desc">${item.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                insightsList.appendChild(critSection);
            }

            // --- 2. DETAILED SHIFT PLAN GRID ---
            const grid = document.createElement('div');
            grid.className = 'shift-plan-grid';

            // Helper to render a column
            const renderColumn = (title, items, typeClass) => {
                const col = document.createElement('div');
                col.className = 'plan-column';
                col.innerHTML = `
                    <div class="plan-column-header">
                        <h3>${title}</h3>
                        <span class="plan-badge">${items.length}</span>
                    </div>
                `;
                
                const list = document.createElement('div');
                list.className = 'plan-list';
                
                if (items.length === 0) {
                    list.innerHTML = `<div style="text-align:center; color:#94a3b8; padding:20px; font-size:13px;">No issues found.</div>`;
                } else {
                    // Function to render an item
                    const renderItem = (item) => `
                        <div class="plan-item ${typeClass}">
                            <div class="plan-item-top">
                                <span class="plan-day-time">${item.day} ${item.hour}</span>
                            </div>
                            <div class="plan-title">${item.title}</div>
                            <div class="plan-desc">${item.desc}</div>
                        </div>
                    `;

                    // Show top 20 items initially
                    items.slice(0, 20).forEach(item => {
                        list.innerHTML += renderItem(item);
                    });

                    if (items.length > 20) {
                        const remaining = items.slice(20);
                        const btnDiv = document.createElement('div');
                        btnDiv.style.textAlign = 'center';
                        btnDiv.style.padding = '12px';
                        btnDiv.style.borderTop = '1px solid #e2e8f0';
                        
                        const btn = document.createElement('button');
                        btn.className = 'btn-secondary';
                        btn.style.fontSize = '12px';
                        btn.style.width = '100%';
                        btn.textContent = `Show ${remaining.length} more hidden issues`;
                        
                        btn.onclick = function() {
                            // Remove the button container
                            btnDiv.remove();
                            // Append the rest
                            remaining.forEach(item => {
                                // Create a temporary container to turn string into DOM
                                const tmp = document.createElement('div');
                                tmp.innerHTML = renderItem(item);
                                list.appendChild(tmp.firstElementChild);
                            });
                        };
                        
                        btnDiv.appendChild(btn);
                        list.appendChild(btnDiv);
                    }
                }
                col.appendChild(list);
                return col;
            };

            grid.appendChild(renderColumn('üî• Burnout Risks', planBurnout, 'burnout'));
            grid.appendChild(renderColumn('‚ûï Hire / Add Staff', planAdds, 'add'));
            grid.appendChild(renderColumn('‚úÇÔ∏è Cut / Send Home', planCuts, 'cut'));

            insightsList.appendChild(grid);
        }

        function generateIdealSchedule() {
            const panel = document.getElementById('idealModelPanel');
            const tbody = document.getElementById('idealScheduleBody');
            const goalSpan = document.getElementById('idealModelGoal');
            
            if (!panel || !tbody) return;
            
            const hasSalesData = Object.keys(salesData).length > 0;
            if (!hasSalesData) {
                alert("Please enter daily sales estimates first to generate an ideal model.");
                return;
            }

            const goal = getProductivityGoal();
            const deptName = currentDepartmentView === 'foh' ? 'FOH' : currentDepartmentView === 'boh' ? 'BOH' : 'Overall';
            const headerTitle = document.querySelector('#idealModelPanel .chart-header span');
            if (headerTitle) headerTitle.textContent = `‚ú® Ideal Staffing Model (${deptName} Target)`;
            
            goalSpan.textContent = goal.toFixed(2);
            panel.style.display = 'block';
            tbody.innerHTML = '';

            // We need to generate data for all days based on the curve
            // If salesData is missing for a day (e.g. closed), we skip it or show 0
            // We'll use the standard days array
            const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const hours = HOURS.filter(h => isHourInCurrentDaypart(h));
            const fractions = getSalesFractions(); // Get the current split

            hours.forEach(hour => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="hour-label">${hour}</td>`;
                
                days.forEach(day => {
                    const cell = document.createElement('td');
                    
                    // Calculate ideal
                    let ideal = 0;
                    if (salesData[day] && salesData[day][hour]) {
                        const rawSales = salesData[day][hour];
                        
                        // Apply department share logic
                        let effectiveSales = rawSales;
                        if (currentDepartmentView === 'foh') {
                            effectiveSales = rawSales * fractions.fohFraction;
                        } else if (currentDepartmentView === 'boh') {
                            effectiveSales = rawSales * fractions.bohFraction;
                        }
                        
                        if (effectiveSales > 0) {
                            ideal = Math.ceil(effectiveSales / goal);
                            if (ideal < 1) ideal = 1; 
                        }
                    }

                    // Get current actual for comparison
                    const current = scheduleData[day] && scheduleData[day][hour] ? scheduleData[day][hour] : 0;
                    const diff = current - ideal;
                    
                    let diffHtml = '';
                    if (current > 0 || ideal > 0) {
                        if (diff === 0) {
                            diffHtml = '<span style="color:#22c55e; font-size:10px; display:block">Matched</span>';
                        } else if (diff < 0) {
                            diffHtml = `<span style="color:#ef4444; font-size:10px; display:block">Add ${Math.abs(diff)}</span>`;
                        } else {
                            diffHtml = `<span style="color:#f59e0b; font-size:10px; display:block">Cut ${diff}</span>`;
                        }
                    }

                    cell.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:8px;">
                            <div style="font-weight:700; font-size:16px; color:#1e293b;">${ideal}</div>
                            ${diffHtml}
                        </div>
                    `;
                    // Light background for the cell
                    cell.style.background = ideal > 0 ? '#fff' : '#f8fafc';
                    
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            
            // Scroll to panel
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadResults() {
            const hasSalesData = Object.keys(salesData).length > 0;
            const goal = getProductivityGoal();
            
            // Define all hours to ensure we export everything
            const allHours = ['5 AM', '6 AM', '7 AM', '8 AM', '9 AM', '10 AM', '11 AM', '12 PM', 
                              '1 PM', '2 PM', '3 PM', '4 PM', '5 PM', '6 PM', '7 PM', '8 PM', 
                              '9 PM', '10 PM', '11 PM'];
            
            let csv = hasSalesData ? 
                `Day,Hour,Staff Count,Sales,SPLH,vs Goal ($${goal}),Efficiency\n` :
                'Day,Hour,Staff Count\n';
            
            Object.keys(scheduleData).forEach(day => {
                allHours.forEach(hour => {
                    const staff = scheduleData[day][hour] || 0;
                    
                    if (hasSalesData) {
                        const sales = salesData[day] && salesData[day][hour] ? salesData[day][hour] : 0;
                        const splh = staff > 0 ? (sales / staff) : 0;
                        const vsGoal = splh - goal;
                        const efficiency = splh >= goal ? 'Meeting Goal' : splh >= goal * 0.9 ? 'Near Goal' : 'Below Goal';
                        csv += `${day},${hour},${staff},${sales.toFixed(2)},${splh.toFixed(2)},${vsGoal.toFixed(2)},${efficiency}\n`;
                    } else {
                        csv += `${day},${hour},${staff}\n`;
                    }
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Include department in filename
            const deptName = currentDepartmentView === 'foh' ? 'FOH' : currentDepartmentView === 'boh' ? 'BOH' : 'Overall';
            a.download = `schedule_analysis_${deptName}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function showFormatHelp() {
            const helpText = `üìã CSV FORMAT GUIDE

=== SCHEDULE FILES (REQUIRED) ===
Upload separate files for FOH and BOH staff.

Format for both:
Date,Time,Employee

Example:
Date,Time,Employee
11/10/2025,5:00 AM,JOHN SMITH
11/10/2025,5:00 AM,JANE DOE
11/10/2025,6:00 AM,JOHN SMITH

üìä FOH = Front of House (servers, hosts, cashiers)
üç≥ BOH = Back of House (cooks, prep, dishwashers)

=== SALES INPUTS ===
Enter estimated total sales per day (Mon‚ÄìSat) in the fields at the top.

These values are distributed across the day using the sales curve in the "Edit Sales Curve" panel.

=== PRODUCTIVITY GOALS BY DEPARTMENT ===
‚Ä¢ Default Overall: $90.00/hour (combined FOH + BOH)
‚Ä¢ Default FOH: $46.40/hour
‚Ä¢ Default BOH: $41.70/hour
You can adjust these values, along with FOH/BOH/Other labor mix, in the "Edit Sales Curve" panel.

üí° TIPS:
‚Ä¢ Upload at least one schedule file (FOH or BOH)
‚Ä¢ Daily sales estimates apply to all days
‚Ä¢ Switch views to see department-specific metrics
‚Ä¢ Export includes department in filename`;
            
            alert(helpText);
        }

        function initMetricTooltips() {
            try {
                const avgLabel = document.querySelector('#avgStaff')?.parentElement?.querySelector('.metric-label');
                if (avgLabel) {
                    avgLabel.setAttribute('data-tooltip', 'Total staff hours divided by total open hours in this view.');
                }
                const prodLabel = document.querySelector('#peakEfficiency')?.parentElement?.querySelector('.metric-label');
                if (prodLabel) {
                    prodLabel.setAttribute('data-tooltip', 'Productivity = Total sales divided by total labor hours ($/LH).');
                }
                const splhLabel = document.querySelector('#splh')?.parentElement?.querySelector('.metric-label');
                if (splhLabel) {
                    splhLabel.setAttribute('data-tooltip', 'Same productivity metric, compared against your configured goal.');
                }
                const laborLabel = document.querySelector('#laborCost')?.parentElement?.querySelector('.metric-label');
                if (laborLabel) {
                    laborLabel.setAttribute('data-tooltip', 'Sum of all scheduled staff hours in this view.');
                }
            } catch (e) {
                console.warn('Failed to initialize metric tooltips', e);
            }
        }

        // Initialize sales curve configuration and admin table on load
        loadSalesConfig();
        loadSalesInputs(); // Load persisted sales values
        buildCurveAdminTable();
        setupDragAndDrop(); // Initialize drag and drop
        updateViewBadge(); // Initialize badge
        initMetricTooltips(); // Attach metric tooltips

        // --- Persistence Logic ---
        function saveSalesInputs() {
            const inputs = {};
            const dayIds = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            dayIds.forEach(day => {
                const el = document.getElementById(`sales-${day}`);
                if (el) inputs[day] = el.value;
            });
            localStorage.setItem('scheduleCounter_salesInputs_v1', JSON.stringify(inputs));
        }

        function loadSalesInputs() {
            try {
                const stored = localStorage.getItem('scheduleCounter_salesInputs_v1');
                if (stored) {
                    const inputs = JSON.parse(stored);
                    Object.keys(inputs).forEach(day => {
                        const el = document.getElementById(`sales-${day}`);
                        if (el) el.value = inputs[day];
                    });
                }
            } catch (e) {
                console.warn('Failed to load sales inputs', e);
            }
            // Attach listeners for future changes
            const dayIds = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            dayIds.forEach(day => {
                const el = document.getElementById(`sales-${day}`);
                if (el) {
                    el.addEventListener('change', () => {
                        validateSalesInput(el);
                        saveSalesInputs();
                        // Also trigger data update if possible
                        if (Object.keys(scheduleData).length > 0) {
                            generateReport();
                        }
                    });
                }
            });
        }

        // --- Gentle Guardrails ---
        function setInputWarning(input, message) {
            if (!input) return;
            if (message) {
                input.classList.add('input-warning');
                input.title = message;
            } else {
                input.classList.remove('input-warning');
                input.title = '';
            }
        }

        function validateSalesInput(input) {
            const raw = input.value;
            if (!raw) {
                setInputWarning(input, '');
                return;
            }
            const val = parseFloat(raw);
            if (isNaN(val)) {
                setInputWarning(input, 'Please enter a number.');
                return;
            }
            if (val < 500 || val > 100000) {
                setInputWarning(input, 'Unusual daily sales value ‚Äì double-check this number.');
            } else {
                setInputWarning(input, '');
            }
        }

        // --- Demo Mode Logic ---
        function loadDemoData() {
            if (!confirm("This will overwrite any current schedule and sales data. Continue?")) return;

            // 1. Set Demo Sales
            const demoSales = {
                'Monday': 3500, 'Tuesday': 3200, 'Wednesday': 3800,
                'Thursday': 4200, 'Friday': 5800, 'Saturday': 6200
            };
            Object.keys(demoSales).forEach(day => {
                const el = document.getElementById(`sales-${day}`);
                if (el) el.value = demoSales[day];
            });
            saveSalesInputs(); // Persist them

            // 2. Generate Dummy Schedule Data (FOH & BOH)
            const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            
            // Demo employee names (some will get overtime)
            const fohEmployees = [
                'Sarah Johnson', 'Mike Chen', 'Emily Davis', 'Chris Wilson', 
                'Amanda Brown', 'David Martinez', 'Jessica Lee', 'Tyler Scott',
                'Rachel Kim', 'Brandon Taylor'
            ];
            const bohEmployees = [
                'Carlos Garcia', 'Maria Santos', 'Kevin O\'Brien', 'Lisa Wang',
                'James Miller', 'Ana Rodriguez', 'Derek Thompson', 'Priya Patel'
            ];
            
            // Clear existing
            fohScheduleData = {};
            bohScheduleData = {};
            fohStaffNames = {};
            bohStaffNames = {};
            days.forEach(d => { 
                fohScheduleData[d] = {}; 
                bohScheduleData[d] = {}; 
                fohStaffNames[d] = {};
                bohStaffNames[d] = {};
            });

            // Helper to fill hours with counts AND names
            const fillHours = (scheduleObj, namesObj, employees, day, startHourIdx, endHourIdx, count) => {
                for (let i = startHourIdx; i < endHourIdx; i++) {
                    scheduleObj[day][HOURS[i]] = count;
                    // Assign employees (rotating through the list, some will work many hours)
                    const assigned = [];
                    for (let j = 0; j < count; j++) {
                        assigned.push(employees[j % employees.length]);
                    }
                    namesObj[day][HOURS[i]] = assigned;
                }
            };

            days.forEach(day => {
                // Simple curve: slow morning, lunch peak, lull, dinner peak, taper
                // FOH
                fillHours(fohScheduleData, fohStaffNames, fohEmployees, day, 0, 5, 2);   // 5am-10am
                fillHours(fohScheduleData, fohStaffNames, fohEmployees, day, 5, 9, 6);   // 10am-2pm
                fillHours(fohScheduleData, fohStaffNames, fohEmployees, day, 9, 12, 3);  // 2pm-5pm
                fillHours(fohScheduleData, fohStaffNames, fohEmployees, day, 12, 16, 8); // 5pm-9pm
                fillHours(fohScheduleData, fohStaffNames, fohEmployees, day, 16, 19, 4); // 9pm-close

                // BOH
                fillHours(bohScheduleData, bohStaffNames, bohEmployees, day, 0, 4, 2);   // Prep
                fillHours(bohScheduleData, bohStaffNames, bohEmployees, day, 4, 9, 5);   // Lunch
                fillHours(bohScheduleData, bohStaffNames, bohEmployees, day, 9, 12, 3);  // Prep
                fillHours(bohScheduleData, bohStaffNames, bohEmployees, day, 12, 16, 6); // Dinner
                fillHours(bohScheduleData, bohStaffNames, bohEmployees, day, 16, 19, 2); // Close
            });

            // 3. Process
            alert("ü™Ñ Demo data loaded! Try switching views (FOH/BOH) or editing the sales curve.");
            combineScheduleData();
            generateReport();
        }

        // --- Drag and Drop Logic ---
        function setupDragAndDrop() {
            const dropzones = [
                { id: 'fileInput', labelClass: 'dropzone', type: 'converter' }, // Panel 1
                { id: 'fohScheduleFile', labelClass: 'control-group', type: 'foh' }, // Panel 2
                { id: 'bohScheduleFile', labelClass: 'control-group', type: 'boh' }  // Panel 2
            ];

            dropzones.forEach(zone => {
                const input = document.getElementById(zone.id);
                if (!input) return;

                // Find the visual container (closest parent with the class, or the label itself)
                let container = input.closest('.' + zone.labelClass);
                if (!container && zone.labelClass === 'control-group') {
                     // Fallback for the simple inputs in panel 2: wrap them or target parent
                     container = input.parentElement; 
                }
                
                if (!container) return;

                // Add drag-active class for styling
                // Ensure CSS exists for .control-group.drag-active if not already
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    container.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        container.classList.add('drag-active');
                    }, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    container.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        container.classList.remove('drag-active');
                    }, false);
                });

                container.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files && files.length > 0) {
                        input.files = files; // Update the input's file list
                        
                        // Trigger change event manually
                        const event = new Event('change', { bubbles: true });
                        input.dispatchEvent(event);
                        
                        // For converter specifically, we might want to update UI text immediately
                        if (zone.type === 'converter') {
                             // The existing change listener on fileInput doesn't update text, 
                             // but the converter logic checks input.files on click. 
                             // We can add a small visual cue here if needed.
                             const textMain = container.querySelector('.dropzone-text-main');
                             if(textMain) textMain.textContent = "Selected: " + files[0].name;
                        }
                    }
                }, false);
            });
        }

        // Add drag-active style for the standard control groups too
        const style = document.createElement('style');
        style.textContent = `
            .control-group.drag-active {
                background: #f0f9ff;
                border: 2px dashed #667eea;
                border-radius: 8px;
            }
            .control-group {
                transition: background 0.2s, border 0.2s;
                border: 2px solid transparent; /* Reserve space for border to avoid jump */
            }
        `;
        document.head.appendChild(style);

    </script>

    <!-- Embedded Schedule CSV Generator logic (from Python to Java MOST CURRENT.html) -->
    <script>
    function showInstructions() {
      const m = document.getElementById("instructionsModal");
      if (m) m.style.display = "flex";
    }
    function hideInstructions() {
      const m = document.getElementById("instructionsModal");
      if (m) m.style.display = "none";
    }
    // Local screenshot preview support
    (function () {
      const input = document.getElementById("instructionsScreenshotInput");
      if (!input) return;
      input.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.getElementById("instructionsScreenshot");
          const fallback = document.getElementById("screenshotFallback");
          if (img) {
            img.src = reader.result;
            img.style.display = "block";
          }
          if (fallback) fallback.style.display = "none";
        };
        reader.readAsDataURL(file);
      });
    })();
    function setError(message) {
      const el = document.getElementById("error");
      if (!el) return;
      if (!message) {
        el.textContent = "";
        el.classList.remove("visible");
        return;
      }
      el.textContent = message;
      el.classList.add("visible");
    }

    function setStatus(message) {
      const el = document.getElementById("status");
      if (!el) return;
      el.textContent = message || "";
    }

    function normalizeWhitespace(text) {
      return text.replace(/\s+/g, " ").trim();
    }

    function parseMmddyyToDate(mmddyy) {
      const value = mmddyy.trim();
      if (!value) return null;
      const parts = value.split("/");
      if (parts.length !== 3) return null;
      const [mStr, dStr, y2Str] = parts;
      const m = parseInt(mStr, 10);
      const d = parseInt(dStr, 10);
      const y2 = parseInt(y2Str, 10);
      if (!Number.isFinite(m) || !Number.isFinite(d) || !Number.isFinite(y2)) return null;
      const yearFull = 2000 + y2;
      return new Date(yearFull, m - 1, d);
    }

    function parseTime12hToDate(timeStr, baseDate) {
      const value = timeStr.trim();
      if (!value) return null;
      let hour, minute = 0, ampm;
      const parts = value.split(" ");
      if (parts.length === 2) {
        const [timePart, ampmPart] = parts;
        ampm = ampmPart.toUpperCase();
        const hm = timePart.split(":");
        if (hm.length === 2) {
          hour = parseInt(hm[0], 10);
          minute = parseInt(hm[1], 10);
        } else if (hm.length === 1) {
          hour = parseInt(hm[0], 10);
          minute = 0;
        } else {
          return null;
        }
      } else if (parts.length === 1) {
        const m = /(\d+)(?::(\d+))?\s*(AM|PM)/i.exec(value);
        if (!m) return null;
        hour = parseInt(m[1], 10);
        minute = m[2] ? parseInt(m[2], 10) : 0;
        ampm = m[3].toUpperCase();
      } else {
        return null;
      }
      if (!Number.isFinite(hour) || !Number.isFinite(minute)) return null;
      if (ampm === "PM" && hour !== 12) hour += 12;
      if (ampm === "AM" && hour === 12) hour = 0;
      return new Date(
        baseDate.getFullYear(),
        baseDate.getMonth(),
        baseDate.getDate(),
        hour,
        minute,
        0,
        0
      );
    }

    function timeRangesOverlap(slotStart, slotEnd, rangeStart, rangeEnd) {
      return slotStart < rangeEnd && slotEnd > rangeStart;
    }

    function parseShiftSegments(cellText) {
      let cleaned = (cellText || "").replace(/\u00a0/g, " ");
      cleaned = normalizeWhitespace(cleaned);
      if (!cleaned) return [];
      if (cleaned === "&nbsp;" || cleaned === "\u00a0" || cleaned === "-" || cleaned === "") {
        return [];
      }
      const segmentsRaw = cleaned.split(",").map((s) => s.trim()).filter(Boolean);
      const segments = [];
      for (const seg of segmentsRaw) {
        const parts = seg.split("-").map((p) => p.trim());
        let startTime = "";
        let endTime = "";
        if (parts.length >= 2) {
          startTime = parts[0];
          endTime = parts[1];
        }
        segments.push([seg, startTime, endTime]);
      }
      return segments;
    }

    function extractDayHeaders(headerCells) {
      // Mirror the Python behavior more closely:
      // - Day header cells look like "Mon <br>11/10/25" (sometimes with <b> tags)
      // - We want (day_name="Mon", date_str="11/10/25")
      const headers = [];
      for (const cell of headerCells) {
        const html = cell.innerHTML || "";
        let parts = [];

        if (/<br\s*\/?>/i.test(html)) {
          // Split explicitly on <br> tags
          parts = html
            .split(/<br\s*\/?>/i)
            .map((fragment) => {
              const tmp = document.createElement("div");
              tmp.innerHTML = fragment;
              return normalizeWhitespace(tmp.textContent || "");
            })
            .filter(Boolean);
        } else {
          const text = normalizeWhitespace(cell.textContent || "");
          // Try to split "Mon 11/10/25" into ["Mon", "11/10/25"]
          const m = /^([A-Za-z]{3,})\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/.exec(text);
          if (m) {
            parts = [m[1], m[2]];
          } else {
            parts = [text];
          }
        }

        if (parts.length >= 2) {
          const dayName = parts[0];
          const dateStr = parts[1];
          headers.push([dayName, dateStr]);
        } else {
          const whole = parts[0] || "";
          headers.push([whole, ""]);
        }
      }
      return headers;
    }

    function extractFlattenedAndHeaderDates(doc) {
      const tables = Array.from(doc.getElementsByTagName("table"));
      if (tables.length === 0) {
        throw new Error("No tables found in input file");
      }
      let mainTable = tables[0];
      let maxRows = 0;
      for (const t of tables) {
        const rowCount = t.getElementsByTagName("tr").length;
        if (rowCount > maxRows) {
          maxRows = rowCount;
          mainTable = t;
        }
      }
      const rows = Array.from(mainTable.getElementsByTagName("tr"));
      let currentSection = "";
      let dayHeaders = [];
      const headerDates = new Set();
      const flattenedRows = [];

      for (const tr of rows) {
        const tds = Array.from(tr.getElementsByTagName("td"));
        if (tds.length === 0) continue;

        const first = tds[0];
        const firstClass = first.className || "";

        if (firstClass.split(/\s+/).includes("highlight")) {
          let sectionText = normalizeWhitespace(first.textContent || "");
          sectionText = sectionText.replace(/^\W+|\W+$/g, "");
          currentSection = sectionText || currentSection;

          let headerCells = tds.slice(1);
          if (headerCells.length > 0) {
            const firstText = normalizeWhitespace(headerCells[0].textContent || "").toLowerCase();
            if (firstText === "total day") {
              headerCells = headerCells.slice(1);
            }
          }
          dayHeaders = extractDayHeaders(headerCells);
          for (const [, dateStr] of dayHeaders) {
            const parsed = dateStr ? parseMmddyyToDate(dateStr) : null;
            if (parsed) {
              headerDates.add(parsed.getTime());
            }
          }
          continue;
        }

        if (firstClass.split(/\s+/).includes("bold")) {
          const employeeName = normalizeWhitespace(first.textContent || "");
          let dayCells = tds.slice(1);
          if (dayCells.length > 0) {
            const firstText = normalizeWhitespace(dayCells[0].textContent || "").toLowerCase();
            if (firstText === "total day") {
              dayCells = dayCells.slice(1);
            }
          }
          if (dayHeaders.length === 0) {
            const inferred = [];
            for (let i = 0; i < dayCells.length; i++) {
              inferred.push(["Day" + (i + 1), ""]);
            }
            dayHeaders = inferred;
          }

          for (let idx = 0; idx < dayCells.length; idx++) {
            if (idx >= dayHeaders.length) break;
            const [dayName, dateStr] = dayHeaders[idx];
            const cell = dayCells[idx];
            const cellText = (cell.textContent || "").trim();
            const segments = parseShiftSegments(cellText);
            if (!segments.length) continue;

            for (let segIndex = 0; segIndex < segments.length; segIndex++) {
              const [segText, startStr, endStr] = segments[segIndex];
              flattenedRows.push([
                currentSection,
                employeeName,
                dayName,
                dateStr,
                String(segIndex + 1),
                startStr,
                endStr,
                segText
              ]);
            }
          }
        }
      }

      const headerDateObjects = Array.from(headerDates).map((ts) => new Date(ts));
      console.log("JS parser: flattenedRows=", flattenedRows.length, "headerDates=", headerDateObjects.length);
      return { flattenedRows, headerDates: headerDateObjects };
    }

    function buildHourlyFromFlattened(flattenedRows) {
      const hourly = new Map();

      for (const row of flattenedRows) {
        if (row.length < 7) continue;
        const employeeName = row[1];
        const dateStr = row[3];
        const startStr = row[5];
        const endStr = row[6];

        const parsedDate = dateStr ? parseMmddyyToDate(dateStr) : null;
               if (!parsedDate) continue;

        const startDt = parseTime12hToDate(startStr, parsedDate);
        const endDtInitial = parseTime12hToDate(endStr, parsedDate);
        if (!startDt || !endDtInitial) continue;

        let endDt = endDtInitial;
        if (endDt.getTime() <= startDt.getTime()) {
          endDt = new Date(endDt.getTime() + 24 * 60 * 60 * 1000);
        }

        const dayStart = new Date(
          parsedDate.getFullYear(),
          parsedDate.getMonth(),
          parsedDate.getDate(),
          0,
          0,
          0,
          0
        );

        for (let hour = 0; hour < 24; hour++) {
          const slotStart = new Date(dayStart.getTime() + hour * 60 * 60 * 1000);
          const slotEnd = new Date(slotStart.getTime() + 60 * 60 * 1000);
          if (timeRangesOverlap(slotStart, slotEnd, startDt, endDt)) {
            const dateKey = dayStart.getTime();
            if (!hourly.has(dateKey)) {
              hourly.set(dateKey, new Map());
            }
            const hoursMap = hourly.get(dateKey);
            if (!hoursMap.has(hour)) {
              hoursMap.set(hour, []);
            }
            hoursMap.get(hour).push(employeeName);
          }
        }
      }

      const rows = [];
      const sortedDateKeys = Array.from(hourly.keys()).sort((a, b) => a - b);
      for (const dateKey of sortedDateKeys) {
        const dateObj = new Date(dateKey);
        const hoursMap = hourly.get(dateKey);
        for (let hour = 0; hour < 24; hour++) {
          const employees = hoursMap.get(hour) || [];
          if (!employees.length) continue;
          const slotDate = new Date(
            dateObj.getFullYear(),
            dateObj.getMonth(),
            dateObj.getDate(),
            hour,
            0,
            0,
            0
          );
          const month = slotDate.getMonth() + 1;
          const day = slotDate.getDate();
          const year = slotDate.getFullYear();
          const dateStrOut = month + "/" + day + "/" + year;

          let h = slotDate.getHours();
          const ampm = h >= 12 ? "PM" : "AM";
          if (h === 0) h = 12;
          else if (h > 12) h -= 12;
          const timeStrOut = h + ":00 " + ampm;

          for (const emp of employees) {
            rows.push([dateStrOut, timeStrOut, emp]);
          }
        }
      }

      return rows;
    }

    function formatHoursWeekFilename(startDate, endDate) {
      const startStr = (startDate.getMonth() + 1) + "-" + startDate.getDate();
      const endStr = (endDate.getMonth() + 1) + "-" + endDate.getDate();
      return "schedule hours for " + startStr + "-" + endStr + ".csv";
    }

    function toCsv(headers, rows) {
      const escapeCell = (value) => {
        const str = value == null ? "" : String(value);
        if (/[",\n]/.test(str)) {
          return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
      };
      const lines = [];
      lines.push(headers.map(escapeCell).join(","));
      for (const row of rows) {
        lines.push(row.map(escapeCell).join(","));
      }
      return lines.join("\n");
    }

    function downloadCsv(filename, csvContent) {
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function handleProcess() {
      setError("");
      setStatus("");
      const input = document.getElementById("fileInput");
      const file = input && input.files && input.files[0];
      if (!file) {
        setError("Please choose a schedule file first.");
        return;
      }
      setStatus("Reading file and parsing schedule‚Ä¶");

      try {
        const text = await file.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/html");

        const { flattenedRows, headerDates } = extractFlattenedAndHeaderDates(doc);
        if (!flattenedRows.length) {
          setError("No schedule data was found in the selected file.");
          setStatus("");
          return;
        }

        const derivedDatesSet = new Set(headerDates.map((d) => d.getTime()));
        if (derivedDatesSet.size === 0) {
          for (const row of flattenedRows) {
            if (row.length < 4) continue;
            const dateStr = row[3];
            if (!dateStr) continue;
            const parsed = parseMmddyyToDate(dateStr);
            if (parsed) {
              derivedDatesSet.add(parsed.getTime());
            }
          }
        }

        let filenameHours = "schedule hours.csv";
        let startDate = null;
        let endDate = null;

        if (derivedDatesSet.size > 0) {
          const dateObjs = Array.from(derivedDatesSet).map((ts) => new Date(ts));
          dateObjs.sort((a, b) => a.getTime() - b.getTime());
          startDate = dateObjs[0];
          endDate = dateObjs[dateObjs.length - 1];
          filenameHours = formatHoursWeekFilename(startDate, endDate);
        }

        const hourlyRows = buildHourlyFromFlattened(flattenedRows);

        const hourlyCsv = toCsv(
          ["Date", "Time", "Employee"],
          hourlyRows
        );

        setStatus(`Generating download‚Ä¶ (${hourlyRows.length} rows)`);
        // Always trigger a download, even if there are 0 rows (you'll still get the header).
        downloadCsv(filenameHours, hourlyCsv);
        setStatus("Done. Your CSV file should be downloading now (check your Downloads folder). Next: go to Step 2 and upload your new hourly CSV into the Schedule Counter.");
      } catch (err) {
        console.error(err);
        setError("Something went wrong while parsing this file. Check that it's the same format used by the Python script.");
        setStatus("");
      }
    }

    // Hook up the event listener
    if (document.getElementById('processBtn')) {
        document.getElementById('processBtn').addEventListener('click', handleProcess);
    }


    // --- STAFF MODAL LOGIC ---
    function openStaffModal(day, hour, event) {
        // Prevent bubble up if needed, though not critical here
        if(event) event.stopPropagation();

        const panel = document.getElementById('staffSidePanel');
        const listEl = document.getElementById('staffList');
        const titleEl = document.getElementById('staffSidePanelTitle');
        
        // Set Title
        titleEl.textContent = `${day} @ ${hour}`;
        listEl.innerHTML = ''; // clear prev

        // Gather names based on current view
        let allStaff = [];

        // Helper to push staff with metadata
        const addStaff = (nameList, type) => {
            if (!nameList) return;
            nameList.forEach(name => {
                allStaff.push({ name, type });
            });
        };

        // Logic:
        // If View = Overall => Show FOH + BOH
        // If View = FOH => Show FOH only
        // If View = BOH => Show BOH only
        
        if (currentDepartmentView === 'foh' || currentDepartmentView === 'overall') {
            if (fohStaffNames[day] && fohStaffNames[day][hour]) {
                addStaff(fohStaffNames[day][hour], 'foh');
            }
        }
        
        if (currentDepartmentView === 'boh' || currentDepartmentView === 'overall') {
            if (bohStaffNames[day] && bohStaffNames[day][hour]) {
                addStaff(bohStaffNames[day][hour], 'boh');
            }
        }

        // If no staff
        if (allStaff.length === 0) {
            listEl.innerHTML = `<li class="staff-list-item" style="justify-content:center; color:#94a3b8;">No staff scheduled.</li>`;
        } else {
            // Sort alphabetically by name
            allStaff.sort((a, b) => a.name.localeCompare(b.name));

            // Build HTML
            allStaff.forEach(staff => {
                const initials = staff.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const badgeClass = staff.type === 'foh' ? 'badge-foh' : 'badge-boh';
                const badgeText = staff.type === 'foh' ? 'FOH' : 'BOH';
                
                const li = document.createElement('li');
                li.className = 'staff-list-item';
                li.innerHTML = `
                    <div class="staff-avatar">${initials}</div>
                    <span style="font-weight:500;">${staff.name}</span>
                    <span class="staff-dept-badge ${badgeClass}">${badgeText}</span>
                `;
                listEl.appendChild(li);
            });
        }

        // Show Panel (add class)
        panel.classList.add('open');
    }

    function closeStaffModal() {
        document.getElementById('staffSidePanel').classList.remove('open');
    }

    // Close on click outside (only if clicking outside the panel)
    window.onclick = function(event) {
        const panel = document.getElementById('staffSidePanel');
        // Only close if it's open and the click is NOT inside the panel AND NOT on a cell
        if (panel.classList.contains('open')) {
            if (!panel.contains(event.target) && !event.target.closest('.staff-cell')) {
                closeStaffModal();
            }
        }

        const wm = document.getElementById('walkthroughModal');
        if (event.target === wm) {
            wm.style.display = "none";
        }
    }

    // --- WALKTHROUGH MODAL LOGIC ---
    function showWalkthrough() {
        // Inject modal HTML if not exists
        if (!document.getElementById('walkthroughModal')) {
            const modalHtml = `
                <div id="walkthroughModal" class="modal" style="display:none; align-items:center; justify-content:center;">
                    <div class="modal-content" style="max-width:600px; position:relative;">
                        <span class="close" onclick="document.getElementById('walkthroughModal').style.display='none'">&times;</span>
                        
                        <div class="step-slide" id="step1">
                            <h2>üöÄ Welcome! How to use this tool</h2>
                            <p style="margin:16px 0; line-height:1.6;">This dashboard helps you optimize your schedule by combining your <strong>HotSchedules export</strong> with your <strong>Sales Forecast</strong>.</p>
                            <div style="background:#f8fafc; padding:16px; border-radius:8px; margin-bottom:20px; border:1px solid #e2e8f0;">
                                <strong>The 2-Step Process:</strong>
                                <ol style="margin-left:20px; margin-top:8px; display:flex; flex-direction:column; gap:8px;">
                                    <li><strong>Convert:</strong> Turn your raw HotSchedules file into data we can read.</li>
                                    <li><strong>Analyze:</strong> See where you are over/understaffed.</li>
                                </ol>
                            </div>
                            <div style="text-align:right;">
                                <button class="btn-primary" onclick="showStep(2)">Next: Step 1 ‚ûî</button>
                            </div>
                        </div>

                        <div class="step-slide" id="step2" style="display:none;">
                            <h2>Step 1: File Converter</h2>
                            <p>Go to the <span class="step-number" style="display:inline-flex; width:18px; height:18px; font-size:10px;">1</span> <strong>File Converter</strong> tab.</p>
                            <img src="https://placehold.co/550x150/f1f5f9/64748b?text=Upload+Export+->+Get+CSV" style="width:100%; border-radius:8px; margin:12px 0; border:1px solid #e2e8f0;">
                            <ul style="margin-left:20px; margin-bottom:20px; line-height:1.6;">
                                <li>Upload your raw export (HTML or CSV).</li>
                                <li>Click <strong>"Convert & Download"</strong>.</li>
                                <li>This saves a clean file called <code>hourly_schedule.csv</code> to your computer.</li>
                            </ul>
                            <div style="display:flex; justify-content:space-between;">
                                <button class="btn-secondary" onclick="showStep(1)">Back</button>
                                <button class="btn-primary" onclick="showStep(3)">Next: Step 2 ‚ûî</button>
                            </div>
                        </div>

                        <div class="step-slide" id="step3" style="display:none;">
                            <h2>Step 2: Schedule Counter</h2>
                            <p>Switch to the <span class="step-number" style="display:inline-flex; width:18px; height:18px; font-size:10px;">2</span> <strong>Schedule Counter</strong> tab.</p>
                            <ul style="margin-left:20px; margin-bottom:20px; line-height:1.6;">
                                <li>Upload your new <code>hourly_schedule.csv</code> into the FOH (or BOH) box.</li>
                                <li>Enter your <strong>Daily Sales Estimates</strong> for the week.</li>
                                <li><strong>CRITICAL:</strong> Click "‚öôÔ∏è Edit Sales Curve" to set your <strong>Productivity Goals</strong> ($/hr).</li>
                            </ul>
                            <div style="display:flex; justify-content:space-between;">
                                <button class="btn-secondary" onclick="showStep(2)">Back</button>
                                <button class="btn-primary" onclick="showStep(4)">Next: The Magic ‚ûî</button>
                            </div>
                        </div>

                        <div class="step-slide" id="step4" style="display:none;">
                            <h2>‚ú® See the Magic</h2>
                            <p>Once loaded, you get three powerful tools:</p>
                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:24px;">
                                <div style="background:#eff6ff; padding:12px; border-radius:8px; font-size:12px; text-align:center;">
                                    <div style="font-size:20px; margin-bottom:4px;">üìä</div>
                                    <strong>Visual Grid</strong><br>Red/Green heatmaps
                                </div>
                                <div style="background:#fef2f2; padding:12px; border-radius:8px; font-size:12px; text-align:center;">
                                    <div style="font-size:20px; margin-bottom:4px;">üö®</div>
                                    <strong>Action Plan</strong><br>"Cut 2 Staff"<br>"Burnout Risk"
                                </div>
                                <div style="background:#fffbeb; padding:12px; border-radius:8px; font-size:12px; text-align:center;">
                                    <div style="font-size:20px; margin-bottom:4px;">‚ú®</div>
                                    <strong>Ideal Model</strong><br>Target headcount vs Actual
                                </div>
                            </div>
                            <div style="text-align:center;">
                                <button class="btn-primary" style="width:100%;" onclick="document.getElementById('walkthroughModal').style.display='none'">Let's Go!</button>
                            </div>
                        </div>

                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // Show the modal
        document.getElementById('walkthroughModal').style.display = 'flex';
        showStep(1);
    }

    function showStep(n) {
        [1,2,3,4].forEach(i => {
            document.getElementById('step'+i).style.display = (i===n) ? 'block' : 'none';
        });
    }
    
    // Auto-show on first visit? (Optional)
    // if (!localStorage.getItem('seenWalkthrough')) { showWalkthrough(); localStorage.setItem('seenWalkthrough', 'true'); }

    </script>

</body></html>