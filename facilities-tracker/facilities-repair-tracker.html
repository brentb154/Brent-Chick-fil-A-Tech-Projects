<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facilities Repair Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #DD0031;
            --primary-dark: #B8002A;
            --primary-light: #FF1744;
            --bg-main: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-dark: #1A1A1A;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border: #E8E8E8;
            --border-light: #F0F0F0;
            --success: #00C853;
            --success-bg: #E8F5E9;
            --info: #2196F3;
            --info-bg: #E3F2FD;
            --warning: #FF9800;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px 32px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 13px;
            opacity: 0.85;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            background: #F5F5F5;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.25);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--bg-main);
            border-color: var(--text-secondary);
        }

        .btn-danger {
            background: #FEE2E2;
            color: #DC2626;
        }

        .btn-danger:hover {
            background: #FECACA;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Dashboard Section */
        .dashboard-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .view-toggle {
            display: flex;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 4px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .view-toggle button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .view-toggle button.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .view-toggle button:hover:not(.active) {
            background: var(--bg-main);
        }

        .date-filter {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-filter select,
        .date-filter input {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            background: var(--bg-card);
            cursor: pointer;
        }

        .date-filter select:focus,
        .date-filter input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .custom-dates {
            display: none;
            gap: 8px;
            align-items: center;
        }

        .custom-dates.visible {
            display: flex;
        }

        /* Hero Numbers */
        .hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .hero-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .hero-card.secondary {
            background: linear-gradient(135deg, #374151 0%, #1F2937 100%);
        }

        .hero-card.highlight {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .hero-label {
            font-size: 13px;
            font-weight: 500;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .hero-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -1px;
            font-family: 'JetBrains Mono', monospace;
        }

        .hero-subtext {
            font-size: 12px;
            opacity: 0.75;
            margin-top: 4px;
        }

        /* Dashboard Sections */
        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .chart-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-card h3::before {
            content: '';
            width: 4px;
            height: 18px;
            background: var(--primary);
            border-radius: 2px;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        .no-data-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Repair Log Section */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .filters-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            background: var(--bg-card);
            min-width: 150px;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Table */
        .table-wrapper {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .table-scroll {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: var(--bg-main);
            border-bottom: 2px solid var(--border);
        }

        th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-main);
        }

        .stars {
            color: #FFC107;
            font-size: 14px;
            letter-spacing: 1px;
        }

        .stars .empty {
            color: #E0E0E0;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success-bg);
            color: #2E7D32;
        }

        .badge-info {
            background: var(--info-bg);
            color: #1565C0;
        }

        .money {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .money.savings {
            color: #059669;
            font-weight: 600;
        }

        .actions-cell {
            display: flex;
            gap: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 700px;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-main);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 20px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 28px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px 28px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 32px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .form-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-label .required {
            color: var(--primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            background: var(--bg-card);
            transition: border-color 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input:disabled {
            background: var(--bg-main);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .char-counter {
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
        }

        .char-counter.error {
            color: var(--primary);
        }

        .char-counter.valid {
            color: var(--success);
        }

        /* Location Checkbox Group */
        .location-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-main);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .location-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .location-group .form-input {
            flex: 1;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 4px;
        }

        .star-rating .star {
            font-size: 28px;
            cursor: pointer;
            color: #E0E0E0;
            transition: color 0.15s ease, transform 0.15s ease;
        }

        .star-rating .star:hover {
            transform: scale(1.1);
        }

        .star-rating .star.active {
            color: #FFC107;
        }

        /* Searchable Dropdown */
        .dropdown-wrapper {
            position: relative;
        }

        .dropdown-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
        }

        .dropdown-options.active {
            display: block;
        }

        .dropdown-option {
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .dropdown-option:hover {
            background: var(--bg-main);
        }

        .dropdown-option.add-new {
            color: var(--primary);
            font-weight: 600;
            border-top: 1px solid var(--border);
        }

        /* Checkbox Toggle */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-main);
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-weight: 500;
        }

        .conditional-field {
            display: none;
            margin-top: 12px;
        }

        .conditional-field.visible {
            display: block;
        }

        /* Equipment List */
        .equipment-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
        }

        .category-group {
            border-bottom: 1px solid var(--border);
        }

        .category-group:last-child {
            border-bottom: none;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-main);
            font-weight: 600;
        }

        .category-items {
            padding: 8px 16px 16px 32px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .add-category-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--border);
            background: transparent;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s ease;
        }

        .add-category-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* CSV Actions */
        .csv-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header-actions {
                width: 100%;
            }

            .header-actions .btn {
                flex: 1;
                justify-content: center;
            }

            .main-content {
                padding: 20px;
            }

            .view-toggle {
                width: 100%;
            }

            .view-toggle button {
                flex: 1;
                padding: 10px 12px;
                font-size: 13px;
            }

            .hero-value {
                font-size: 28px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filters-bar {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .filter-input {
                width: 100%;
            }

            th, td {
                padding: 10px 12px;
                font-size: 12px;
            }

            .modal {
                margin: 10px;
            }

            .modal-body {
                padding: 20px;
            }
        }

        /* Print Styles */
        @media print {
            .header-actions,
            .filters-bar,
            .actions-cell,
            .modal-overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <h1 id="headerTitle">Facilities Repair Tracker</h1>
                <span class="header-subtitle" id="headerSubtitle">Track repairs, measure savings</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openRepairForm()">
                    <span>+</span> Log Repair
                </button>
                <button class="btn btn-secondary" onclick="openSettings()">
                    <span>⚙</span> Settings
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Controls -->
        <div class="dashboard-controls">
            <div class="view-toggle">
                <button class="active" onclick="toggleView('called')">Would Have Called</button>
                <button onclick="toggleView('notCalled')">Would NOT Have Called</button>
                <button onclick="toggleView('all')">All Repairs</button>
            </div>
            <div class="date-filter">
                <select id="dateRange" onchange="applyDateFilter()">
                    <option value="180">Last 6 Months</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="ytd">Year to Date</option>
                    <option value="all">All Time</option>
                    <option value="custom">Custom Range</option>
                </select>
                <div class="custom-dates" id="customDates">
                    <input type="date" id="startDate" onchange="applyDateFilter()">
                    <span>to</span>
                    <input type="date" id="endDate" onchange="applyDateFilter()">
                </div>
            </div>
        </div>

        <!-- Called Section -->
        <div class="dashboard-section active" id="calledSection">
            <div class="hero-grid" id="calledHero"></div>
            <div class="charts-grid" id="calledCharts"></div>
        </div>

        <!-- Not Called Section -->
        <div class="dashboard-section" id="notCalledSection">
            <div class="hero-grid" id="notCalledHero"></div>
            <div class="charts-grid" id="notCalledCharts"></div>
        </div>

        <!-- All Section -->
        <div class="dashboard-section" id="allSection">
            <div class="hero-grid" id="allHero"></div>
            <div class="charts-grid" id="allCharts"></div>
        </div>

        <!-- Repair Log -->
        <section class="repair-log">
            <div class="section-header">
                <h2 class="section-title">Repair Log</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-ghost btn-sm" onclick="exportCSV()">
                        <span>↓</span> Export CSV
                    </button>
                    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('importFile').click()">
                        <span>↑</span> Import CSV
                    </button>
                    <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importCSV(event)">
                </div>
            </div>

            <div class="filters-bar">
                <div class="filter-group">
                    <span class="filter-label">Search</span>
                    <input type="text" class="filter-input" id="searchFilter" placeholder="Keyword search..." oninput="filterRepairs()">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Category</span>
                    <select class="filter-input" id="categoryFilter" onchange="filterRepairs()">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-group" id="locationFilterGroup">
                    <span class="filter-label">Location</span>
                    <select class="filter-input" id="locationFilter" onchange="filterRepairs()">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Status</span>
                    <select class="filter-input" id="statusFilter" onchange="filterRepairs()">
                        <option value="">All</option>
                        <option value="called">Would Have Called</option>
                        <option value="notCalled">Would NOT Have Called</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Sort By</span>
                    <select class="filter-input" id="sortFilter" onchange="filterRepairs()">
                        <option value="date-desc">Date (Newest)</option>
                        <option value="date-asc">Date (Oldest)</option>
                        <option value="savings-desc">Savings (High-Low)</option>
                        <option value="savings-asc">Savings (Low-High)</option>
                        <option value="time-desc">Time (Most)</option>
                        <option value="time-asc">Time (Least)</option>
                    </select>
                </div>
            </div>

            <div class="table-wrapper">
                <div class="table-scroll">
                    <table id="repairTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th id="locationHeader">Location</th>
                                <th>Category</th>
                                <th>Item</th>
                                <th>Time</th>
                                <th>Confidence</th>
                                <th>Your Cost</th>
                                <th>Contractor</th>
                                <th>Savings</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="repairTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" id="settingsCloseBtn" onclick="closeSettings()">&times;</button>
            </div>
            <form id="settingsForm" onsubmit="saveSettings(event)">
                <div class="modal-body">
                    <!-- Business Info -->
                    <div class="form-section">
                        <h3 class="form-section-title">Business Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Team Name</label>
                                <input type="text" class="form-input" id="teamName" placeholder="e.g., Facilities Team" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-input" id="companyName" placeholder="e.g., Chick-fil-A" required>
                            </div>
                        </div>
                    </div>

                    <!-- Locations -->
                    <div class="form-section">
                        <h3 class="form-section-title">Locations</h3>
                        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Enable and name up to 3 locations to track.</p>
                        <div class="location-group">
                            <input type="checkbox" id="loc1Enabled" checked onchange="toggleLocationInput(1)">
                            <input type="text" class="form-input" id="loc1Name" placeholder="Location 1 name" required>
                        </div>
                        <div class="location-group">
                            <input type="checkbox" id="loc2Enabled" onchange="toggleLocationInput(2)">
                            <input type="text" class="form-input" id="loc2Name" placeholder="Location 2 name" disabled>
                        </div>
                        <div class="location-group">
                            <input type="checkbox" id="loc3Enabled" onchange="toggleLocationInput(3)">
                            <input type="text" class="form-input" id="loc3Name" placeholder="Location 3 name" disabled>
                        </div>
                    </div>

                    <!-- Cost Settings -->
                    <div class="form-section">
                        <h3 class="form-section-title">Cost Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Your Hourly Wage ($)</label>
                                <input type="number" class="form-input" id="yourHourlyWage" step="0.01" min="0" placeholder="25.00" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contractor Hourly Rate ($)</label>
                                <input type="number" class="form-input" id="contractorHourlyRate" step="0.01" min="0" placeholder="85.00" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contractor Call-out Charge ($)</label>
                                <input type="number" class="form-input" id="contractorCalloutCharge" step="0.01" min="0" placeholder="125.00" required>
                            </div>
                        </div>
                    </div>

                    <!-- Equipment Categories -->
                    <div class="form-section">
                        <h3 class="form-section-title">Equipment Categories</h3>
                        <div class="equipment-list" id="equipmentList">
                            <!-- Populated by JS -->
                        </div>
                        <button type="button" class="add-category-btn" onclick="addCategory()">+ Add Category</button>
                    </div>

                    <!-- CSV Actions -->
                    <div class="form-section">
                        <h3 class="form-section-title">Data Management</h3>
                        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Export or import your data for backup or transfer between devices.</p>
                        <div class="csv-actions">
                            <button type="button" class="btn btn-ghost" onclick="exportCSV()">
                                <span>↓</span> Export All Data (CSV)
                            </button>
                            <button type="button" class="btn btn-ghost" onclick="document.getElementById('importFile').click()">
                                <span>↑</span> Import Data (CSV)
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: var(--primary); color: white;">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Repair Form Modal -->
    <div class="modal-overlay" id="repairModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="repairModalTitle">Log Repair Entry</h2>
                <button class="modal-close" onclick="closeRepairForm()">&times;</button>
            </div>
            <form id="repairForm" onsubmit="saveRepair(event)">
                <div class="modal-body">
                    <!-- Basic Info -->
                    <div class="form-section">
                        <h3 class="form-section-title">Repair Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Date <span class="required">*</span></label>
                                <input type="date" class="form-input" id="repairDate" required>
                            </div>
                            <div class="form-group" id="repairLocationGroup">
                                <label class="form-label">Location <span class="required">*</span></label>
                                <select class="form-select" id="repairLocation" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Category <span class="required">*</span></label>
                                <div class="dropdown-wrapper">
                                    <input type="text" class="form-input" id="categoryInput" placeholder="Search or select category..." autocomplete="off" onfocus="showCategoryDropdown()" oninput="filterCategoryDropdown()">
                                    <div class="dropdown-options" id="categoryDropdown"></div>
                                </div>
                            </div>
                            <div class="form-group" id="itemGroup" style="display: none;">
                                <label class="form-label">Item <span class="required">*</span></label>
                                <div class="dropdown-wrapper">
                                    <input type="text" class="form-input" id="itemInput" placeholder="Search or select item..." autocomplete="off" onfocus="showItemDropdown()" oninput="filterItemDropdown()">
                                    <div class="dropdown-options" id="itemDropdown"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time -->
                    <div class="form-section">
                        <h3 class="form-section-title">Time Spent</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Hours</label>
                                <select class="form-select" id="repairHours" onchange="validateMinTime()">
                                    <option value="0">0 hours</option>
                                    <option value="1">1 hour</option>
                                    <option value="2">2 hours</option>
                                    <option value="3">3 hours</option>
                                    <option value="4">4 hours</option>
                                    <option value="5">5 hours</option>
                                    <option value="6">6 hours</option>
                                    <option value="7">7 hours</option>
                                    <option value="8">8 hours</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Minutes</label>
                                <select class="form-select" id="repairMinutes" onchange="validateMinTime()">
                                    <option value="0">0 min</option>
                                    <option value="15">15 min</option>
                                    <option value="30" selected>30 min</option>
                                    <option value="45">45 min</option>
                                </select>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Minimum 30 minutes</p>
                    </div>

                    <!-- Confidence -->
                    <div class="form-section">
                        <h3 class="form-section-title">Confidence Level</h3>
                        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">How confident are you that this repair was done correctly?</p>
                        <div class="star-rating" id="starRating">
                            <span class="star" data-value="1" onclick="setRating(1)">★</span>
                            <span class="star" data-value="2" onclick="setRating(2)">★</span>
                            <span class="star active" data-value="3" onclick="setRating(3)">★</span>
                            <span class="star" data-value="4" onclick="setRating(4)">★</span>
                            <span class="star" data-value="5" onclick="setRating(5)">★</span>
                        </div>
                        <input type="hidden" id="confidenceValue" value="3">
                    </div>

                    <!-- Would Have Called -->
                    <div class="form-section">
                        <h3 class="form-section-title">Contractor Assessment</h3>
                        <div class="checkbox-group">
                            <input type="checkbox" id="wouldHaveCalled" checked onchange="toggleNotCalledReason()">
                            <label for="wouldHaveCalled">I would have called a contractor for this repair</label>
                        </div>
                        <div class="conditional-field" id="notCalledReasonField">
                            <div class="form-group">
                                <label class="form-label">Why wouldn't you have called? <span class="required">*</span></label>
                                <textarea class="form-textarea" id="notCalledReason" placeholder="Explain why this repair wouldn't have warranted a contractor call..." oninput="updateCharCount('notCalledReason', 80)"></textarea>
                                <div class="char-counter" id="notCalledReasonCounter">0 / 80 characters minimum</div>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="form-section">
                        <h3 class="form-section-title">Description</h3>
                        <div class="form-group">
                            <label class="form-label">What was the issue and how did you fix it? <span class="required">*</span></label>
                            <textarea class="form-textarea" id="repairDescription" placeholder="Describe the problem encountered and the steps taken to repair it..." oninput="updateCharCount('repairDescription', 120)"></textarea>
                            <div class="char-counter" id="repairDescriptionCounter">0 / 120 characters minimum</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" onclick="closeRepairForm()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: var(--primary); color: white;">Save Repair</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        let settings = {
            locations: [
                { name: '', enabled: true },
                { name: '', enabled: false },
                { name: '', enabled: false }
            ],
            teamName: '',
            companyName: '',
            yourHourlyWage: 25,
            contractorHourlyRate: 85,
            contractorCalloutCharge: 125,
            categories: {},
            initialized: false
        };

        let repairs = [];
        let editingRepairId = null;
        let selectedCategory = null;
        let selectedItem = null;
        let currentView = 'called';
        let charts = {};

        // ===== DATA PERSISTENCE =====
        function saveData() {
            try {
                localStorage.setItem('facilitySettings', JSON.stringify(settings));
                localStorage.setItem('facilityRepairs', JSON.stringify(repairs));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                alert('Warning: Unable to save data. Your browser may be in private mode.');
            }
        }

        function loadData() {
            try {
                const savedSettings = localStorage.getItem('facilitySettings');
                const savedRepairs = localStorage.getItem('facilityRepairs');
                
                if (savedSettings) {
                    settings = JSON.parse(savedSettings);
                }
                if (savedRepairs) {
                    repairs = JSON.parse(savedRepairs);
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            if (!settings.initialized) {
                openSettings(true);
            } else {
                initializeApp();
            }
        });

        function initializeApp() {
            // Set default date to today
            document.getElementById('repairDate').value = new Date().toISOString().split('T')[0];
            
            // Update header
            if (settings.teamName) {
                document.getElementById('headerTitle').textContent = `${settings.teamName} Repair Tracker`;
            }
            if (settings.companyName) {
                document.getElementById('headerSubtitle').textContent = `${settings.companyName} • Track repairs, measure savings`;
            }
            
            // Populate dropdowns
            populateLocationDropdowns();
            populateCategoryFilters();
            
            // Initialize star rating display
            setRating(3);
            
            // Refresh dashboard
            refreshDashboard();
            filterRepairs();
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-wrapper')) {
                    document.querySelectorAll('.dropdown-options').forEach(d => d.classList.remove('active'));
                }
            });
        }

        // ===== SETTINGS MODAL =====
        function openSettings(forced = false) {
            const modal = document.getElementById('settingsModal');
            const closeBtn = document.getElementById('settingsCloseBtn');
            
            if (forced) {
                closeBtn.style.display = 'none';
            } else {
                closeBtn.style.display = 'flex';
            }
            
            // Populate form with current settings
            document.getElementById('teamName').value = settings.teamName;
            document.getElementById('companyName').value = settings.companyName;
            document.getElementById('yourHourlyWage').value = settings.yourHourlyWage;
            document.getElementById('contractorHourlyRate').value = settings.contractorHourlyRate;
            document.getElementById('contractorCalloutCharge').value = settings.contractorCalloutCharge;
            
            // Populate locations
            for (let i = 0; i < 3; i++) {
                const checkbox = document.getElementById(`loc${i+1}Enabled`);
                const input = document.getElementById(`loc${i+1}Name`);
                checkbox.checked = settings.locations[i].enabled;
                input.value = settings.locations[i].name;
                input.disabled = !settings.locations[i].enabled;
                input.required = settings.locations[i].enabled;
            }
            
            // Render equipment list
            renderEquipmentList();
            
            modal.classList.add('active');
        }

        function closeSettings() {
            if (!settings.initialized) {
                alert('Please complete the setup to continue.');
                return;
            }
            document.getElementById('settingsModal').classList.remove('active');
        }

        function toggleLocationInput(num) {
            const checkbox = document.getElementById(`loc${num}Enabled`);
            const input = document.getElementById(`loc${num}Name`);
            input.disabled = !checkbox.checked;
            input.required = checkbox.checked;
            if (!checkbox.checked) {
                input.value = '';
            }
        }

        function saveSettings(e) {
            e.preventDefault();
            
            // Validate enabled locations have names
            for (let i = 0; i < 3; i++) {
                const checkbox = document.getElementById(`loc${i+1}Enabled`);
                const input = document.getElementById(`loc${i+1}Name`);
                if (checkbox.checked && !input.value.trim()) {
                    alert(`Please enter a name for Location ${i+1} or disable it.`);
                    input.focus();
                    return;
                }
            }
            
            // Save values
            settings.teamName = document.getElementById('teamName').value.trim();
            settings.companyName = document.getElementById('companyName').value.trim();
            settings.yourHourlyWage = parseFloat(document.getElementById('yourHourlyWage').value) || 25;
            settings.contractorHourlyRate = parseFloat(document.getElementById('contractorHourlyRate').value) || 85;
            settings.contractorCalloutCharge = parseFloat(document.getElementById('contractorCalloutCharge').value) || 125;
            
            // Save locations
            for (let i = 0; i < 3; i++) {
                settings.locations[i] = {
                    enabled: document.getElementById(`loc${i+1}Enabled`).checked,
                    name: document.getElementById(`loc${i+1}Name`).value.trim()
                };
            }
            
            settings.initialized = true;
            saveData();
            
            alert('Settings saved successfully!');
            document.getElementById('settingsModal').classList.remove('active');
            initializeApp();
        }

        // ===== EQUIPMENT MANAGEMENT =====
        function renderEquipmentList() {
            const container = document.getElementById('equipmentList');
            const categories = Object.keys(settings.categories);
            
            if (categories.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No categories added yet. Add your first category below.</div>';
                return;
            }
            
            let html = '';
            categories.forEach(cat => {
                html += `
                    <div class="category-group">
                        <div class="category-header">
                            <span>${cat}</span>
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteCategory('${cat}')">Delete</button>
                        </div>
                        <div class="category-items">
                            ${settings.categories[cat].length === 0 
                                ? '<div style="color: var(--text-muted); font-size: 13px;">No items in this category</div>'
                                : settings.categories[cat].map(item => `
                                    <div class="category-item">
                                        <span>${item}</span>
                                        <button type="button" class="btn btn-ghost btn-sm" onclick="deleteItem('${cat}', '${item}')">&times;</button>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function addCategory() {
            const name = prompt('Enter category name:');
            if (!name || !name.trim()) return;
            
            const trimmed = name.trim();
            if (settings.categories[trimmed]) {
                alert('Category already exists.');
                return;
            }
            
            settings.categories[trimmed] = [];
            saveData();
            renderEquipmentList();
            populateCategoryFilters();
        }

        function deleteCategory(cat) {
            if (!confirm(`Delete category "${cat}" and all its items?`)) return;
            
            delete settings.categories[cat];
            saveData();
            renderEquipmentList();
            populateCategoryFilters();
        }

        function deleteItem(cat, item) {
            if (!confirm(`Delete item "${item}"?`)) return;
            
            settings.categories[cat] = settings.categories[cat].filter(i => i !== item);
            saveData();
            renderEquipmentList();
        }

        function addItemToCategory(cat, item) {
            if (!settings.categories[cat].includes(item)) {
                settings.categories[cat].push(item);
                saveData();
            }
        }

        // ===== REPAIR FORM =====
        function openRepairForm(repairId = null) {
            const modal = document.getElementById('repairModal');
            const form = document.getElementById('repairForm');
            const title = document.getElementById('repairModalTitle');
            
            form.reset();
            selectedCategory = null;
            selectedItem = null;
            document.getElementById('categoryInput').value = '';
            document.getElementById('itemInput').value = '';
            document.getElementById('itemGroup').style.display = 'none';
            document.getElementById('notCalledReasonField').classList.remove('visible');
            document.getElementById('wouldHaveCalled').checked = true;
            setRating(3);
            updateCharCount('repairDescription', 120);
            updateCharCount('notCalledReason', 80);
            
            // Set default date
            document.getElementById('repairDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('repairHours').value = '0';
            document.getElementById('repairMinutes').value = '30';
            
            // Handle location visibility
            const enabledLocations = settings.locations.filter(l => l.enabled);
            const locationGroup = document.getElementById('repairLocationGroup');
            const locationSelect = document.getElementById('repairLocation');
            
            if (enabledLocations.length === 1) {
                locationGroup.style.display = 'none';
                locationSelect.innerHTML = `<option value="${enabledLocations[0].name}">${enabledLocations[0].name}</option>`;
            } else {
                locationGroup.style.display = 'block';
                locationSelect.innerHTML = enabledLocations.map(l => 
                    `<option value="${l.name}">${l.name}</option>`
                ).join('');
            }
            
            if (repairId) {
                // Edit mode
                editingRepairId = repairId;
                title.textContent = 'Edit Repair Entry';
                
                const repair = repairs.find(r => r.id === repairId);
                if (repair) {
                    document.getElementById('repairDate').value = repair.date;
                    document.getElementById('repairLocation').value = repair.location;
                    document.getElementById('repairHours').value = repair.hours.toString();
                    document.getElementById('repairMinutes').value = repair.minutes.toString();
                    document.getElementById('wouldHaveCalled').checked = repair.wouldHaveCalled;
                    document.getElementById('repairDescription').value = repair.description;
                    
                    selectedCategory = repair.category;
                    selectedItem = repair.item;
                    document.getElementById('categoryInput').value = repair.category;
                    document.getElementById('itemInput').value = repair.item;
                    document.getElementById('itemGroup').style.display = 'block';
                    
                    setRating(repair.confidenceStars);
                    
                    if (!repair.wouldHaveCalled) {
                        document.getElementById('notCalledReasonField').classList.add('visible');
                        document.getElementById('notCalledReason').value = repair.notCalledReason || '';
                    }
                    
                    updateCharCount('repairDescription', 120);
                    updateCharCount('notCalledReason', 80);
                }
            } else {
                // New mode
                editingRepairId = null;
                title.textContent = 'Log Repair Entry';
            }
            
            modal.classList.add('active');
        }

        function closeRepairForm() {
            document.getElementById('repairModal').classList.remove('active');
            editingRepairId = null;
        }

        // ===== SEARCHABLE DROPDOWNS =====
        function showCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            const categories = Object.keys(settings.categories);
            
            let html = categories.map(cat => 
                `<div class="dropdown-option" onclick="selectCategory('${cat}')">${cat}</div>`
            ).join('');
            
            if (categories.length === 0) {
                html = '<div class="dropdown-option" style="color: var(--text-muted);">No categories. Add in Settings.</div>';
            }
            
            dropdown.innerHTML = html;
            dropdown.classList.add('active');
        }

        function filterCategoryDropdown() {
            const input = document.getElementById('categoryInput').value.toLowerCase();
            const dropdown = document.getElementById('categoryDropdown');
            const categories = Object.keys(settings.categories);
            
            const filtered = categories.filter(cat => cat.toLowerCase().includes(input));
            
            let html = filtered.map(cat => 
                `<div class="dropdown-option" onclick="selectCategory('${cat}')">${cat}</div>`
            ).join('');
            
            // Add "add new" option if no exact match
            if (input && !categories.some(cat => cat.toLowerCase() === input)) {
                html += `<div class="dropdown-option add-new" onclick="addAndSelectCategory('${input}')">+ Add "${input}"</div>`;
            }
            
            dropdown.innerHTML = html || '<div class="dropdown-option" style="color: var(--text-muted);">No matches</div>';
            dropdown.classList.add('active');
        }

        function selectCategory(cat) {
            selectedCategory = cat;
            document.getElementById('categoryInput').value = cat;
            document.getElementById('categoryDropdown').classList.remove('active');
            
            // Show item dropdown
            document.getElementById('itemGroup').style.display = 'block';
            document.getElementById('itemInput').value = '';
            selectedItem = null;
        }

        function addAndSelectCategory(name) {
            const trimmed = name.charAt(0).toUpperCase() + name.slice(1);
            settings.categories[trimmed] = [];
            saveData();
            selectCategory(trimmed);
            populateCategoryFilters();
        }

        function showItemDropdown() {
            if (!selectedCategory) {
                alert('Please select a category first.');
                document.getElementById('categoryInput').focus();
                return;
            }
            
            const dropdown = document.getElementById('itemDropdown');
            const items = settings.categories[selectedCategory] || [];
            
            let html = items.map(item => 
                `<div class="dropdown-option" onclick="selectItem('${item}')">${item}</div>`
            ).join('');
            
            if (items.length === 0) {
                html = '<div class="dropdown-option" style="color: var(--text-muted);">No items. Type to add.</div>';
            }
            
            dropdown.innerHTML = html;
            dropdown.classList.add('active');
        }

        function filterItemDropdown() {
            if (!selectedCategory) return;
            
            const input = document.getElementById('itemInput').value.toLowerCase();
            const dropdown = document.getElementById('itemDropdown');
            const items = settings.categories[selectedCategory] || [];
            
            const filtered = items.filter(item => item.toLowerCase().includes(input));
            
            let html = filtered.map(item => 
                `<div class="dropdown-option" onclick="selectItem('${item}')">${item}</div>`
            ).join('');
            
            // Add "add new" option if no exact match
            if (input && !items.some(item => item.toLowerCase() === input)) {
                html += `<div class="dropdown-option add-new" onclick="addAndSelectItem('${input}')">+ Add "${input}"</div>`;
            }
            
            dropdown.innerHTML = html || '<div class="dropdown-option" style="color: var(--text-muted);">No matches</div>';
            dropdown.classList.add('active');
        }

        function selectItem(item) {
            selectedItem = item;
            document.getElementById('itemInput').value = item;
            document.getElementById('itemDropdown').classList.remove('active');
        }

        function addAndSelectItem(name) {
            const trimmed = name.charAt(0).toUpperCase() + name.slice(1);
            addItemToCategory(selectedCategory, trimmed);
            selectItem(trimmed);
        }

        // ===== FORM VALIDATION =====
        function validateMinTime() {
            const hours = parseInt(document.getElementById('repairHours').value);
            const minutes = parseInt(document.getElementById('repairMinutes').value);
            const totalMinutes = (hours * 60) + minutes;
            
            if (totalMinutes < 30) {
                document.getElementById('repairMinutes').value = '30';
                alert('Minimum time is 30 minutes.');
            }
        }

        function updateCharCount(fieldId, minimum) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(fieldId + 'Counter');
            const count = field.value.length;
            
            counter.textContent = `${count} / ${minimum} characters minimum`;
            
            if (count >= minimum) {
                counter.className = 'char-counter valid';
            } else {
                counter.className = 'char-counter error';
            }
        }

        function setRating(value) {
            document.getElementById('confidenceValue').value = value;
            const stars = document.querySelectorAll('#starRating .star');
            stars.forEach((star, index) => {
                if (index < value) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function toggleNotCalledReason() {
            const checkbox = document.getElementById('wouldHaveCalled');
            const field = document.getElementById('notCalledReasonField');
            
            if (!checkbox.checked) {
                field.classList.add('visible');
            } else {
                field.classList.remove('visible');
            }
        }

        // ===== SAVE REPAIR =====
        function saveRepair(e) {
            e.preventDefault();
            
            // Validate
            const hours = parseInt(document.getElementById('repairHours').value);
            const minutes = parseInt(document.getElementById('repairMinutes').value);
            const totalMinutes = (hours * 60) + minutes;
            
            if (totalMinutes < 30) {
                alert('Minimum time is 30 minutes.');
                return;
            }
            
            if (!selectedCategory) {
                alert('Please select a category.');
                return;
            }
            
            if (!selectedItem) {
                alert('Please select or add an item.');
                return;
            }
            
            const description = document.getElementById('repairDescription').value;
            if (description.length < 120) {
                alert('Description must be at least 120 characters.');
                document.getElementById('repairDescription').focus();
                return;
            }
            
            const wouldHaveCalled = document.getElementById('wouldHaveCalled').checked;
            const notCalledReason = document.getElementById('notCalledReason').value;
            
            if (!wouldHaveCalled && notCalledReason.length < 80) {
                alert('Please explain why you wouldn\'t have called (at least 80 characters).');
                document.getElementById('notCalledReason').focus();
                return;
            }
            
            // Calculate values
            const totalHours = hours + (minutes / 60);
            const yourCost = settings.yourHourlyWage * totalHours;
            const contractorCost = settings.contractorCalloutCharge + (settings.contractorHourlyRate * totalHours * 0.7);
            const savings = contractorCost - yourCost;
            
            // Get location
            const enabledLocations = settings.locations.filter(l => l.enabled);
            let location;
            if (enabledLocations.length === 1) {
                location = enabledLocations[0].name;
            } else {
                location = document.getElementById('repairLocation').value;
            }
            
            // Build repair object
            const repair = {
                id: editingRepairId || Date.now(),
                date: document.getElementById('repairDate').value,
                location: location,
                category: selectedCategory,
                item: selectedItem,
                hours: hours,
                minutes: minutes,
                totalHours: totalHours,
                confidenceStars: parseInt(document.getElementById('confidenceValue').value),
                wouldHaveCalled: wouldHaveCalled,
                notCalledReason: wouldHaveCalled ? '' : notCalledReason,
                description: description,
                yourCost: yourCost,
                contractorCost: contractorCost,
                savings: savings
            };
            
            // Save or update
            if (editingRepairId) {
                const index = repairs.findIndex(r => r.id === editingRepairId);
                if (index !== -1) {
                    repairs[index] = repair;
                }
            } else {
                repairs.push(repair);
            }
            
            saveData();
            closeRepairForm();
            refreshDashboard();
            filterRepairs();
        }

        function deleteRepair(id) {
            if (!confirm('Are you sure you want to delete this repair entry?')) return;
            
            repairs = repairs.filter(r => r.id !== id);
            saveData();
            refreshDashboard();
            filterRepairs();
        }

        // ===== VIEW TOGGLE =====
        function toggleView(view) {
            currentView = view;
            
            // Update buttons
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update sections
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(view + 'Section').classList.add('active');
        }

        // ===== DATE FILTER =====
        function applyDateFilter() {
            const range = document.getElementById('dateRange').value;
            const customDates = document.getElementById('customDates');
            
            if (range === 'custom') {
                customDates.classList.add('visible');
            } else {
                customDates.classList.remove('visible');
            }
            
            refreshDashboard();
            filterRepairs();
        }

        function getFilteredRepairs() {
            const range = document.getElementById('dateRange').value;
            const today = new Date();
            let startDate;
            let endDate = new Date();
            
            switch(range) {
                case '30':
                    startDate = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                    break;
                case '90':
                    startDate = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
                    break;
                case '180':
                    startDate = new Date(today.getTime() - (180 * 24 * 60 * 60 * 1000));
                    break;
                case 'ytd':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    break;
                case 'all':
                    startDate = new Date(0);
                    break;
                case 'custom':
                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;
                    startDate = start ? new Date(start) : new Date(0);
                    endDate = end ? new Date(end) : new Date();
                    break;
                default:
                    startDate = new Date(today.getTime() - (180 * 24 * 60 * 60 * 1000));
            }
            
            return repairs.filter(r => {
                const repairDate = new Date(r.date);
                return repairDate >= startDate && repairDate <= endDate;
            });
        }

        // ===== DASHBOARD =====
        function refreshDashboard() {
            const filtered = getFilteredRepairs();
            const calledRepairs = filtered.filter(r => r.wouldHaveCalled);
            const notCalledRepairs = filtered.filter(r => !r.wouldHaveCalled);
            
            renderHeroCards('called', calledRepairs);
            renderHeroCards('notCalled', notCalledRepairs);
            renderHeroCards('all', filtered, calledRepairs);
            
            setTimeout(() => {
                renderCharts('called', calledRepairs);
                renderCharts('notCalled', notCalledRepairs);
                renderCharts('all', filtered);
            }, 100);
        }

        function renderHeroCards(type, data, calledData = null) {
            const container = document.getElementById(type + 'Hero');
            
            if (type === 'called') {
                const totalSavings = data.reduce((sum, r) => sum + r.savings, 0);
                const totalHours = data.reduce((sum, r) => sum + r.totalHours, 0);
                const callsAvoided = data.length;
                
                container.innerHTML = `
                    <div class="hero-card">
                        <div class="hero-label">Total Savings</div>
                        <div class="hero-value">$${totalSavings.toFixed(2)}</div>
                        <div class="hero-subtext">vs. contractor costs</div>
                    </div>
                    <div class="hero-card">
                        <div class="hero-label">Hours Invested</div>
                        <div class="hero-value">${totalHours.toFixed(1)}</div>
                        <div class="hero-subtext">by your team</div>
                    </div>
                    <div class="hero-card highlight">
                        <div class="hero-label">Calls Avoided</div>
                        <div class="hero-value">${callsAvoided}</div>
                        <div class="hero-subtext">contractor dispatches</div>
                    </div>
                `;
            } else if (type === 'notCalled') {
                const totalCost = data.reduce((sum, r) => sum + r.yourCost, 0);
                const totalHours = data.reduce((sum, r) => sum + r.totalHours, 0);
                const repairsCompleted = data.length;
                
                container.innerHTML = `
                    <div class="hero-card secondary">
                        <div class="hero-label">Labor Cost</div>
                        <div class="hero-value">$${totalCost.toFixed(2)}</div>
                        <div class="hero-subtext">your team's time</div>
                    </div>
                    <div class="hero-card secondary">
                        <div class="hero-label">Hours Spent</div>
                        <div class="hero-value">${totalHours.toFixed(1)}</div>
                        <div class="hero-subtext">on minor repairs</div>
                    </div>
                    <div class="hero-card secondary">
                        <div class="hero-label">Repairs Done</div>
                        <div class="hero-value">${repairsCompleted}</div>
                        <div class="hero-subtext">handled in-house</div>
                    </div>
                `;
            } else {
                // All
                const totalSavings = calledData ? calledData.reduce((sum, r) => sum + r.savings, 0) : 0;
                const totalHours = data.reduce((sum, r) => sum + r.totalHours, 0);
                const totalRepairs = data.length;
                const callsAvoided = calledData ? calledData.length : data.filter(r => r.wouldHaveCalled).length;
                
                container.innerHTML = `
                    <div class="hero-card">
                        <div class="hero-label">Total Savings</div>
                        <div class="hero-value">$${totalSavings.toFixed(2)}</div>
                        <div class="hero-subtext">from avoided calls</div>
                    </div>
                    <div class="hero-card secondary">
                        <div class="hero-label">Total Hours</div>
                        <div class="hero-value">${totalHours.toFixed(1)}</div>
                        <div class="hero-subtext">all repairs</div>
                    </div>
                    <div class="hero-card secondary">
                        <div class="hero-label">Total Repairs</div>
                        <div class="hero-value">${totalRepairs}</div>
                        <div class="hero-subtext">logged entries</div>
                    </div>
                    <div class="hero-card highlight">
                        <div class="hero-label">Calls Avoided</div>
                        <div class="hero-value">${callsAvoided}</div>
                        <div class="hero-subtext">contractor dispatches</div>
                    </div>
                `;
            }
        }

        function renderCharts(type, data) {
            const container = document.getElementById(type + 'Charts');
            
            // Destroy existing charts
            Object.keys(charts).forEach(key => {
                if (key.startsWith(type + '_')) {
                    charts[key].destroy();
                    delete charts[key];
                }
            });
            
            if (data.length === 0) {
                container.innerHTML = '<div class="chart-card"><div class="no-data-message">No repair data for this period</div></div>';
                return;
            }
            
            const metric = type === 'notCalled' ? 'yourCost' : 'savings';
            const metricLabel = type === 'notCalled' ? 'Cost' : 'Savings';
            
            // Generate chart containers
            let chartsHtml = `
                <div class="chart-card">
                    <h3>Cumulative ${metricLabel} Over Time</h3>
                    <div class="chart-container"><canvas id="${type}LineChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3>${metricLabel} by Category</h3>
                    <div class="chart-container"><canvas id="${type}BarChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3>Repairs by Category</h3>
                    <div class="chart-container"><canvas id="${type}PieChart"></canvas></div>
                </div>
            `;
            
            // Add location chart if multiple locations
            const enabledLocations = settings.locations.filter(l => l.enabled);
            if (enabledLocations.length > 1) {
                chartsHtml += `
                    <div class="chart-card">
                        <h3>${metricLabel} by Location</h3>
                        <div class="chart-container"><canvas id="${type}LocationChart"></canvas></div>
                    </div>
                `;
            }
            
            container.innerHTML = chartsHtml;
            
            // Create charts after DOM update
            setTimeout(() => {
                createLineChart(type, data, metric, metricLabel);
                createBarChart(type, data, metric, metricLabel);
                createPieChart(type, data);
                if (enabledLocations.length > 1) {
                    createLocationChart(type, data, metric, metricLabel);
                }
            }, 50);
        }

        function createLineChart(type, data, metric, label) {
            const ctx = document.getElementById(type + 'LineChart');
            if (!ctx) return;
            
            // Sort by date and calculate cumulative
            const sorted = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
            const dates = [];
            const values = [];
            let cumulative = 0;
            
            sorted.forEach(r => {
                cumulative += r[metric];
                dates.push(r.date);
                values.push(cumulative);
            });
            
            const color = type === 'notCalled' ? '#6B7280' : '#DD0031';
            
            charts[type + '_line'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: `Cumulative ${label}`,
                        data: values,
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + value.toFixed(0)
                            }
                        }
                    }
                }
            });
        }

        function createBarChart(type, data, metric, label) {
            const ctx = document.getElementById(type + 'BarChart');
            if (!ctx) return;
            
            // Aggregate by category
            const categoryData = {};
            data.forEach(r => {
                if (!categoryData[r.category]) categoryData[r.category] = 0;
                categoryData[r.category] += r[metric];
            });
            
            const color = type === 'notCalled' ? '#6B7280' : '#DD0031';
            
            charts[type + '_bar'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        label: label,
                        data: Object.values(categoryData),
                        backgroundColor: color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + value.toFixed(0)
                            }
                        }
                    }
                }
            });
        }

        function createPieChart(type, data) {
            const ctx = document.getElementById(type + 'PieChart');
            if (!ctx) return;
            
            // Count by category
            const categoryCount = {};
            data.forEach(r => {
                if (!categoryCount[r.category]) categoryCount[r.category] = 0;
                categoryCount[r.category]++;
            });
            
            const colors = [
                '#DD0031', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
                '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE'
            ];
            
            charts[type + '_pie'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categoryCount),
                    datasets: [{
                        data: Object.values(categoryCount),
                        backgroundColor: colors.slice(0, Object.keys(categoryCount).length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { boxWidth: 12 }
                        }
                    }
                }
            });
        }

        function createLocationChart(type, data, metric, label) {
            const ctx = document.getElementById(type + 'LocationChart');
            if (!ctx) return;
            
            // Aggregate by location
            const locationData = {};
            data.forEach(r => {
                if (!locationData[r.location]) locationData[r.location] = 0;
                locationData[r.location] += r[metric];
            });
            
            const color = type === 'notCalled' ? '#6B7280' : '#DD0031';
            
            charts[type + '_location'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(locationData),
                    datasets: [{
                        label: label,
                        data: Object.values(locationData),
                        backgroundColor: color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + value.toFixed(0)
                            }
                        }
                    }
                }
            });
        }

        // ===== REPAIR LOG =====
        function populateLocationDropdowns() {
            const enabledLocations = settings.locations.filter(l => l.enabled);
            
            // Filter dropdown
            const filterSelect = document.getElementById('locationFilter');
            filterSelect.innerHTML = '<option value="">All Locations</option>' +
                enabledLocations.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
            
            // Form dropdown
            const formSelect = document.getElementById('repairLocation');
            formSelect.innerHTML = enabledLocations.map(l => 
                `<option value="${l.name}">${l.name}</option>`
            ).join('');
            
            // Hide location column and filter if only one location
            const locationHeader = document.getElementById('locationHeader');
            const locationFilterGroup = document.getElementById('locationFilterGroup');
            
            if (enabledLocations.length <= 1) {
                locationHeader.style.display = 'none';
                locationFilterGroup.style.display = 'none';
            } else {
                locationHeader.style.display = 'table-cell';
                locationFilterGroup.style.display = 'flex';
            }
        }

        function populateCategoryFilters() {
            const categories = Object.keys(settings.categories);
            const filterSelect = document.getElementById('categoryFilter');
            
            filterSelect.innerHTML = '<option value="">All Categories</option>' +
                categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function filterRepairs() {
            let filtered = getFilteredRepairs();
            
            // Keyword filter
            const keyword = document.getElementById('searchFilter').value.toLowerCase();
            if (keyword) {
                filtered = filtered.filter(r => 
                    r.description.toLowerCase().includes(keyword) ||
                    r.category.toLowerCase().includes(keyword) ||
                    r.item.toLowerCase().includes(keyword) ||
                    (r.notCalledReason && r.notCalledReason.toLowerCase().includes(keyword))
                );
            }
            
            // Category filter
            const category = document.getElementById('categoryFilter').value;
            if (category) {
                filtered = filtered.filter(r => r.category === category);
            }
            
            // Location filter
            const location = document.getElementById('locationFilter').value;
            if (location) {
                filtered = filtered.filter(r => r.location === location);
            }
            
            // Status filter
            const status = document.getElementById('statusFilter').value;
            if (status === 'called') {
                filtered = filtered.filter(r => r.wouldHaveCalled);
            } else if (status === 'notCalled') {
                filtered = filtered.filter(r => !r.wouldHaveCalled);
            }
            
            // Sort
            const sort = document.getElementById('sortFilter').value;
            filtered.sort((a, b) => {
                switch(sort) {
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'savings-desc':
                        return b.savings - a.savings;
                    case 'savings-asc':
                        return a.savings - b.savings;
                    case 'time-desc':
                        return b.totalHours - a.totalHours;
                    case 'time-asc':
                        return a.totalHours - b.totalHours;
                    default:
                        return new Date(b.date) - new Date(a.date);
                }
            });
            
            renderRepairTable(filtered);
        }

        function renderRepairTable(data) {
            const tbody = document.getElementById('repairTableBody');
            const enabledLocations = settings.locations.filter(l => l.enabled);
            const showLocation = enabledLocations.length > 1;
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${showLocation ? 11 : 10}" class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <div>No repairs found matching your filters</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.map(r => {
                const stars = '★'.repeat(r.confidenceStars) + '<span class="empty">' + '☆'.repeat(5 - r.confidenceStars) + '</span>';
                const statusBadge = r.wouldHaveCalled 
                    ? '<span class="badge badge-success">Would Call</span>'
                    : '<span class="badge badge-info">Would NOT Call</span>';
                
                const formattedDate = new Date(r.date).toLocaleDateString();
                const time = `${r.hours}h ${r.minutes}m`;
                
                return `
                    <tr>
                        <td>${formattedDate}</td>
                        ${showLocation ? `<td>${r.location}</td>` : ''}
                        <td>${r.category}</td>
                        <td>${r.item}</td>
                        <td>${time}</td>
                        <td><span class="stars">${stars}</span></td>
                        <td class="money">$${r.yourCost.toFixed(2)}</td>
                        <td class="money">$${r.contractorCost.toFixed(2)}</td>
                        <td class="money savings">$${r.savings.toFixed(2)}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="actions-cell">
                                <button class="btn btn-ghost btn-sm" onclick="openRepairForm(${r.id})">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteRepair(${r.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ===== CSV EXPORT/IMPORT =====
        function exportCSV() {
            if (repairs.length === 0) {
                alert('No repairs to export.');
                return;
            }
            
            const headers = [
                'ID', 'Date', 'Location', 'Category', 'Item', 'Hours', 'Minutes',
                'Total Hours', 'Confidence', 'Would Have Called', 'Not Called Reason',
                'Description', 'Your Cost', 'Contractor Cost', 'Savings'
            ];
            
            let csv = headers.join(',') + '\n';
            
            repairs.forEach(r => {
                const row = [
                    r.id,
                    r.date,
                    `"${r.location.replace(/"/g, '""')}"`,
                    `"${r.category.replace(/"/g, '""')}"`,
                    `"${r.item.replace(/"/g, '""')}"`,
                    r.hours,
                    r.minutes,
                    r.totalHours.toFixed(2),
                    r.confidenceStars,
                    r.wouldHaveCalled,
                    `"${(r.notCalledReason || '').replace(/"/g, '""')}"`,
                    `"${r.description.replace(/"/g, '""')}"`,
                    r.yourCost.toFixed(2),
                    r.contractorCost.toFixed(2),
                    r.savings.toFixed(2)
                ];
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facility-repairs-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    
                    // Skip header
                    const imported = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Parse CSV line (handles quoted fields)
                        const values = parseCSVLine(line);
                        if (values.length < 15) continue;
                        
                        const repair = {
                            id: Date.now() + i,
                            date: values[1],
                            location: values[2],
                            category: values[3],
                            item: values[4],
                            hours: parseInt(values[5]) || 0,
                            minutes: parseInt(values[6]) || 0,
                            totalHours: parseFloat(values[7]) || 0,
                            confidenceStars: parseInt(values[8]) || 3,
                            wouldHaveCalled: values[9] === 'true',
                            notCalledReason: values[10] || '',
                            description: values[11] || '',
                            yourCost: parseFloat(values[12]) || 0,
                            contractorCost: parseFloat(values[13]) || 0,
                            savings: parseFloat(values[14]) || 0
                        };
                        
                        imported.push(repair);
                    }
                    
                    if (imported.length > 0) {
                        repairs = repairs.concat(imported);
                        saveData();
                        refreshDashboard();
                        filterRepairs();
                        alert(`Successfully imported ${imported.length} repairs.`);
                    } else {
                        alert('No valid repairs found in file.');
                    }
                } catch (err) {
                    console.error('Import error:', err);
                    alert('Error importing file. Please check the format.');
                }
                
                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);
            
            return values;
        }
    </script>
</body>
</html>
