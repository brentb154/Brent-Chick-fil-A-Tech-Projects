<!-- Uniform Orders View -->
<!-- Create Order Card -->
<div class="card">
  <div class="card-header">
    <h2><span class="material-icons-round">add_shopping_cart</span> Create New Order</h2>
  </div>
  <div class="card-body">
    <!-- Employee and Location Row -->
    <div class="form-row mb-lg">
      <div class="form-group" style="flex: 1;">
        <label>Employee</label>
        <select id="uniformEmployee" class="form-control form-select" onchange="handleEmployeeSelectChange()">
          <option value="">Select an employee...</option>
          <!-- Populated dynamically -->
          <option value="__new__">‚ûï New Employee (Not in list)</option>
        </select>
        
        <!-- New Employee Panel (hidden by default) -->
        <div id="newEmployeePanel" class="new-employee-panel" style="display: none;">
          
          <!-- Step 1: Search -->
          <div class="search-step" id="searchStep">
            <div class="step-header">
              <span class="step-number">1</span>
              <span>Search for employee first</span>
            </div>
            <div class="search-input-group">
              <input type="text" id="employeeSearchInput" class="form-control"
                     placeholder="Type name to search..."
                     oninput="handleEmployeeSearch()">
              <span class="search-icon material-icons-round">search</span>
            </div>
            
            <!-- Search Results -->
            <div id="searchResults" class="search-results" style="display: none;"></div>
            
            <!-- "None of these" option -->
            <div id="createNewOption" class="create-new-option" style="display: none;">
              <label class="create-new-label">
                <input type="checkbox" id="confirmNotInList" onchange="handleConfirmNotInList()">
                <span>None of these - this is a brand new employee not yet in Workstream/HR Payroll</span>
              </label>
              <p class="warning-text">
                <span class="material-icons-round" style="font-size: 14px;">warning</span>
                Only select this if you're CERTAIN this person hasn't worked yet
              </p>
            </div>
          </div>
          
          <!-- Step 2: Enter Name (hidden until Step 1 complete) -->
          <div class="name-step" id="nameStep" style="display: none;">
            <div class="step-header">
              <span class="step-number">2</span>
              <span>Enter employee name exactly as in Workstream/HR Payroll</span>
            </div>
            
            <input type="text" id="newEmployeeName" class="form-control"
                   placeholder="First Last (e.g., John Smith)"
                   oninput="handleNewNameInput()">
            
            <div class="name-help">
              <span class="material-icons-round" style="font-size: 14px;">info</span>
              Enter name EXACTLY as it appears on their paycheck. Spelling must match perfectly.
            </div>
            
            <div class="name-preview" id="namePreview" style="display: none;">
              <span>Will be saved as: </span>
              <strong id="normalizedNamePreview"></strong>
            </div>
            
            <!-- Similar name warning -->
            <div id="similarNameWarning" class="similar-warning" style="display: none;"></div>
          </div>
          
          <!-- Step 3: Confirm (hidden until Step 2 complete) -->
          <div class="confirm-step" id="confirmStep" style="display: none;">
            <div class="step-header">
              <span class="step-number">3</span>
              <span>Verify spelling</span>
            </div>
            
            <label class="verification-checkbox">
              <input type="checkbox" id="spellingVerified" onchange="handleSpellingVerified()">
              <span>I verify this name is spelled <strong>EXACTLY</strong> as it appears in 
                    Workstream/HR Payroll. I understand that misspellings will cause duplicate 
                    employee records and payroll issues.</span>
            </label>
          </div>
          
          <!-- Step 4: Manager Passcode (hidden until Step 3 complete) -->
          <div class="passcode-step" id="passcodeStep" style="display: none;">
            <div class="step-header">
              <span class="step-number">4</span>
              <span>Manager Authorization</span>
            </div>
            
            <p class="passcode-info">
              <span class="material-icons-round" style="font-size: 14px;">lock</span>
              Creating new employees requires manager approval
            </p>
            
            <div class="passcode-input-row">
              <input type="password" id="newEmployeePasscode" class="form-control" 
                     placeholder="Enter manager passcode"
                     maxlength="10"
                     onkeypress="if(event.key==='Enter') verifyNewEmployeePasscode()">
              <button type="button" class="btn btn-primary btn-sm" onclick="verifyNewEmployeePasscode()">
                <span class="material-icons-round" style="font-size: 16px;">check</span>
                Verify
              </button>
            </div>
            <div id="newEmployeePasscodeError" class="passcode-error-msg" style="display: none;">
              Incorrect passcode
            </div>
            <div id="newEmployeePasscodeSuccess" class="passcode-success-msg" style="display: none;">
              <span class="material-icons-round" style="font-size: 16px;">check_circle</span>
              Verified! You can now create the order.
            </div>
          </div>
          
          <!-- Cancel button -->
          <div class="new-employee-actions">
            <button type="button" class="btn btn-outline btn-sm" onclick="cancelNewEmployee()">
              <span class="material-icons-round" style="font-size: 16px;">close</span>
              Cancel
            </button>
          </div>
        </div>
      </div>
      <div class="form-group" style="flex: 0 0 180px;">
        <label>Location</label>
        <select id="uniformLocation" class="form-control form-select" onchange="updateOrderTotals(); loadLocationAverage();">
          <option value="">Select location...</option>
          <!-- Locations populated dynamically from settings -->
        </select>
      </div>
    </div>
    
    <!-- Smart Order Info (Chunk 10) -->
    <div id="orderSmartInfo" class="order-smart-info" style="display: none;">
      <div class="smart-info-content">
        <span class="material-icons-round">insights</span>
        <span id="avgOrderText">Average order at this location: $--</span>
      </div>
      <div id="orderValueWarning" class="order-value-warning" style="display: none;">
        <span class="material-icons-round">warning</span>
        <span>This order is significantly higher than average</span>
      </div>
    </div>
    
    <!-- Item Selection -->
    <div class="form-row mb-md">
      <div class="form-group" style="flex: 0 0 150px;">
        <label>Category</label>
        <select id="uniformCategory" class="form-control form-select" onchange="filterCatalogByCategory()">
          <option value="">All Categories</option>
        </select>
      </div>
      <div class="form-group" style="flex: 1;">
        <label>Item</label>
        <select id="uniformItem" class="form-control form-select" onchange="updateSizeOptions()">
          <option value="">Select an item...</option>
        </select>
      </div>
      <div class="form-group" style="flex: 0 0 100px; display: none;" id="genderGroup">
        <label>Gender</label>
        <select id="uniformGender" class="form-control form-select" onchange="updatePantsSizes()">
          <option value="">Select...</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
      <div class="form-group" style="flex: 0 0 100px;">
        <label id="sizeLabel">Size</label>
        <select id="uniformSize" class="form-control form-select">
          <option value="">Size...</option>
        </select>
      </div>
      <div class="form-group" style="flex: 0 0 90px; display: none;" id="inseamGroup">
        <label>Inseam</label>
        <select id="uniformInseam" class="form-control form-select">
          <option value="">Inseam...</option>
        </select>
      </div>
      <div class="form-group" style="flex: 0 0 60px;">
        <label>Qty</label>
        <input type="number" id="uniformQty" class="form-control" value="1" min="1" max="10">
      </div>
      <div class="form-group" style="flex: 0 0 auto; align-self: flex-end;">
        <label class="checkbox-label" style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.8rem; color: var(--gray-600); margin-bottom: 10px;">
          <input type="checkbox" id="uniformReplacement" style="width: 16px; height: 16px;">
          <span>Replacement</span>
        </label>
      </div>
      <div class="form-group" style="flex: 0 0 auto; align-self: flex-end;">
        <button type="button" class="btn btn-primary" onclick="addItemToOrder()">
          <span class="material-icons-round">add</span> Add
        </button>
      </div>
    </div>
    
    <!-- Order Items Table -->
    <div class="table-wrapper mb-lg">
      <table class="data-table">
        <thead>
          <tr>
            <th>Item</th>
            <th>Size</th>
            <th class="numeric">Qty</th>
            <th class="numeric">Price</th>
            <th class="numeric">Total</th>
            <th style="width: 50px;"></th>
          </tr>
        </thead>
        <tbody id="orderItemsBody">
          <tr id="emptyOrderRow">
            <td colspan="6" class="text-center" style="color: var(--gray-500); padding: 20px;">
              No items added yet. Select items above to build the order.
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr style="background: var(--gray-50);">
            <td colspan="4" class="text-right"><strong>Order Total:</strong></td>
            <td class="numeric"><strong id="orderTotal">$0.00</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
    
    <!-- Payment Plan -->
    <div class="form-row mb-lg">
      <div class="form-group" style="flex: 0 0 auto;">
        <label>Payment Plan</label>
        <div style="display: flex; gap: 6px;">
          <button type="button" class="btn btn-outline payment-btn active" data-plan="1" onclick="selectPaymentPlan(1)">1</button>
          <button type="button" class="btn btn-outline payment-btn" data-plan="2" onclick="selectPaymentPlan(2)">2</button>
          <button type="button" class="btn btn-outline payment-btn" data-plan="3" onclick="selectPaymentPlan(3)">3</button>
          <span style="align-self: center; margin-left: 4px; color: var(--gray-600); font-size: 0.85rem;">checks</span>
        </div>
      </div>
      <div class="form-group" style="flex: 0 0 120px;">
        <label>Per Check</label>
        <div style="font-size: 1.1rem; font-weight: 700; color: var(--cfa-red);" id="perPaycheckAmount">$0.00</div>
      </div>
      <div class="form-group" style="flex: 1;">
        <label>Order Status</label>
        <div id="deductionPreview" class="deduction-preview" style="background: var(--info-light); border-color: var(--info);">
          <span style="color: var(--info); font-size: 0.85rem;">
            <span class="material-icons-round" style="font-size: 16px; vertical-align: middle;">info</span>
            Order will be created as <strong>Pending</strong>. Deductions start when you mark items as received.
          </span>
        </div>
      </div>
    </div>
    
    <!-- Notes and Submit -->
    <div class="form-row">
      <div class="form-group" style="flex: 1;">
        <label>Notes (optional)</label>
        <input type="text" id="uniformNotes" class="form-control" placeholder="Size form link, special instructions, etc.">
      </div>
      <div class="form-group" style="flex: 0 0 auto; align-self: flex-end;">
        <button type="button" class="btn btn-primary" onclick="submitUniformOrder()" id="submitOrderBtn" disabled>
          <span class="material-icons-round">check_circle</span> Create Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Pending Orders Card -->
<div class="card">
  <div class="card-header">
    <h2><span class="material-icons-round">pending_actions</span> Uniform Orders</h2>
    <div class="form-row" style="gap: 8px;">
      <input type="text" id="orderSearchInput" class="form-control" placeholder="Search employee..." 
             style="width: 160px;" oninput="filterOrdersTable()">
      <select id="orderLocationFilter" class="form-control form-select" style="width: 140px;" onchange="filterOrdersTable()">
        <option value="">All Locations</option>
        <!-- Locations populated dynamically from settings -->
      </select>
      <select id="orderStatusFilter" class="form-control form-select" style="width: 140px;" onchange="loadUniformOrders()">
        <option value="Current" selected>üìã Current</option>
        <option value="Pending">‚è≥ Pending</option>
        <option value="Active">‚úÖ Active</option>
        <option value="Completed">‚úì Completed</option>
        <option value="Cancelled">‚úó Cancelled</option>
        <option value="Store Paid">üè™ Store Paid</option>
        <option value="">All Statuses</option>
      </select>
    </div>
  </div>
  <div class="card-body">
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Order #</th>
            <th>Employee</th>
            <th>Location</th>
            <th>Date</th>
            <th class="numeric">Total</th>
            <th class="numeric">Remaining</th>
            <th>Progress</th>
            <th>Status</th>
            <th style="width: 120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="uniformOrdersBody">
          <tr><td colspan="9"><div class="empty-state"><span class="material-icons-round">checkroom</span><h3>No Orders</h3><p>Create an order above to get started</p></div></td></tr>
        </tbody>
      </table>
    </div>
    <div id="ordersCount" style="margin-top: 12px; font-size: 0.85rem; color: var(--gray-500);"></div>
  </div>
</div>

<!-- Order Details Modal -->
<div id="orderDetailsModal" class="modal-overlay" style="display: none;">
  <div class="modal" style="max-width: 650px;">
    <div class="modal-header">
      <h3 id="orderDetailsTitle">Order Details</h3>
      <button class="btn btn-outline btn-sm" onclick="closeOrderDetailsModal()" style="padding: 4px 8px;">
        <span class="material-icons-round" style="font-size: 18px;">close</span>
      </button>
    </div>
    <div class="modal-body" id="orderDetailsBody">
      <!-- Populated by JavaScript -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeOrderDetailsModal()">Close</button>
      <button class="btn btn-danger" id="cancelOrderBtn" onclick="cancelOrderFromModal()" style="display: none;">
        <span class="material-icons-round">cancel</span> Cancel Order
      </button>
      <button class="btn btn-primary" id="markReceivedBtn" onclick="markOrderReceivedFromModal()" style="display: none;">
        <span class="material-icons-round">inventory</span> Mark Received
      </button>
      <button class="btn btn-primary" id="markPaymentBtn" onclick="markPaymentFromModal()" style="display: none;">
        <span class="material-icons-round">paid</span> Record Payment
      </button>
    </div>
  </div>
</div>

<style>
/* Deduction Preview Styles */
.deduction-preview {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 0.8rem;
  max-height: 100px;
  overflow-y: auto;
}
.deduction-item {
  display: flex;
  justify-content: space-between;
  padding: 3px 0;
  border-bottom: 1px dashed var(--gray-200);
}
.deduction-item:last-child {
  border-bottom: none;
}
.deduction-item.final {
  font-weight: 600;
  color: var(--cfa-red);
}

/* Replacement badge */
.badge-replacement {
  background: var(--info-light);
  color: var(--info);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: 600;
  margin-left: 6px;
}

/* Order details modal content */
.order-info-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}
.order-info-item {
  font-size: 0.9rem;
}
.order-info-item label {
  color: var(--gray-500);
  font-size: 0.75rem;
  display: block;
  margin-bottom: 2px;
}
.order-info-item strong {
  color: var(--gray-900);
}

/* Payment schedule in modal */
.payment-schedule {
  margin-top: 16px;
}
.payment-schedule-item {
  display: flex;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--gray-100);
}
.payment-schedule-item:last-child {
  border-bottom: none;
}
.payment-schedule-item .check-icon {
  width: 24px;
  margin-right: 8px;
  color: var(--gray-400);
}
.payment-schedule-item .check-icon.completed {
  color: var(--success);
}
.payment-schedule-item .check-icon.current {
  color: var(--warning);
}
.payment-schedule-item.completed {
  color: var(--gray-500);
}
.payment-schedule-item.current {
  background: var(--warning-light);
  margin: 0 -16px;
  padding: 8px 16px;
  border-radius: 6px;
}

/* Item receiving status badges */
.badge-item-status {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
}
.badge-item-status.received {
  background: var(--success-light);
  color: #059669;
}
.badge-item-status.pending {
  background: #FEF3C7;
  color: #D97706;
}
.badge-item-status.cancelled {
  background: var(--gray-200);
  color: var(--gray-600);
}
.item-cancelled-row {
  opacity: 0.6;
  text-decoration: line-through;
}

/* Small icon button for cancel */
.btn-icon-sm {
  background: none;
  border: none;
  padding: 4px;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.2s;
}
.btn-icon-sm:hover {
  background: var(--cfa-red-light);
}
.btn-icon-sm:hover .material-icons-round {
  color: var(--error) !important;
}

/* Smart Order Info (Chunk 10) */
.order-smart-info {
  background: #EEF2FF;
  border: 1px solid #C7D2FE;
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 16px;
}

.smart-info-content {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #4338CA;
  font-size: 0.9rem;
}

.smart-info-content .material-icons-round {
  font-size: 18px;
}

.order-value-warning {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #D97706;
  font-size: 0.85rem;
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #C7D2FE;
}

.order-value-warning .material-icons-round {
  font-size: 16px;
}

/* ===== New Employee Panel Styles ===== */
.new-employee-panel {
  margin-top: 12px;
  padding: 16px;
  background: var(--gray-50);
  border: 2px solid var(--gray-200);
  border-radius: 10px;
}

.step-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
  font-weight: 600;
  color: var(--gray-700);
}

.step-number {
  width: 26px;
  height: 26px;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  font-weight: 700;
}

.search-input-group {
  position: relative;
}

.search-input-group input {
  width: 100%;
  padding-right: 40px;
}

.search-input-group .search-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray-400);
  pointer-events: none;
}

.search-results {
  margin-top: 12px;
  max-height: 220px;
  overflow-y: auto;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  background: white;
}

.result-section-header {
  padding: 8px 12px;
  background: var(--gray-100);
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.search-result-item {
  padding: 10px 14px;
  cursor: pointer;
  border-bottom: 1px solid var(--gray-100);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.15s;
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-item:hover {
  background: var(--gray-50);
}

.search-result-item strong {
  color: var(--gray-800);
}

.result-location {
  font-size: 0.8rem;
  color: var(--gray-500);
  margin-left: 8px;
}

.similarity-badge {
  font-size: 0.7rem;
  padding: 2px 6px;
  background: #FEF3C7;
  color: #92400E;
  border-radius: 4px;
  margin-left: 8px;
}

.search-result-empty {
  padding: 24px;
  text-align: center;
  color: var(--gray-500);
}

.search-result-empty .material-icons-round {
  font-size: 32px;
  margin-bottom: 8px;
  opacity: 0.5;
}

.search-result-empty p {
  margin: 0;
  font-size: 0.9rem;
}

.create-new-option {
  margin-top: 16px;
  padding: 14px;
  background: var(--gray-100);
  border-radius: 8px;
  border: 1px solid var(--gray-200);
}

.create-new-label {
  display: flex;
  gap: 10px;
  cursor: pointer;
  font-weight: 500;
  color: var(--gray-700);
}

.create-new-label input {
  flex-shrink: 0;
  width: 18px;
  height: 18px;
  accent-color: var(--primary);
}

.warning-text {
  margin: 10px 0 0 28px;
  font-size: 0.8rem;
  color: var(--gray-600);
  display: flex;
  align-items: center;
  gap: 4px;
}

.warning-text .material-icons-round {
  color: #D97706;
}

.name-step, .confirm-step {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px dashed var(--gray-300);
}

.name-help {
  margin-top: 8px;
  font-size: 0.8rem;
  color: var(--gray-500);
  display: flex;
  align-items: center;
  gap: 6px;
}

.name-preview {
  margin-top: 10px;
  padding: 10px 12px;
  background: #ECFDF5;
  border: 1px solid #10B981;
  border-radius: 6px;
  font-size: 0.9rem;
  color: #065F46;
}

.similar-warning {
  margin-top: 14px;
  padding: 14px;
  background: #FEF3C7;
  border: 1px solid #F59E0B;
  border-radius: 8px;
}

.similar-warning h4 {
  color: #92400E;
  margin: 0 0 10px 0;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.similar-warning ul {
  margin: 0;
  padding: 0 0 0 20px;
}

.similar-warning li {
  margin: 8px 0;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.similar-warning .btn {
  padding: 4px 10px;
  font-size: 0.75rem;
}

.verification-checkbox {
  display: flex;
  gap: 12px;
  padding: 14px;
  background: #FEF2F2;
  border: 2px solid #DC2626;
  border-radius: 8px;
  cursor: pointer;
}

.verification-checkbox input {
  flex-shrink: 0;
  width: 20px;
  height: 20px;
  accent-color: #DC2626;
  margin-top: 2px;
}

.verification-checkbox span {
  font-size: 0.9rem;
  line-height: 1.5;
  color: #7F1D1D;
}

.new-employee-actions {
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px solid var(--gray-200);
  display: flex;
  justify-content: flex-end;
}

/* Passcode Step Styles */
.passcode-step {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px dashed var(--gray-300);
}

.passcode-info {
  font-size: 0.85rem;
  color: var(--gray-600);
  margin: 0 0 12px 0;
  display: flex;
  align-items: center;
  gap: 6px;
}

.passcode-input-row {
  display: flex;
  gap: 10px;
  align-items: center;
}

.passcode-input-row input {
  flex: 1;
  max-width: 200px;
}

.passcode-error-msg {
  color: #DC2626;
  font-size: 0.85rem;
  margin-top: 8px;
}

.passcode-success-msg {
  color: #059669;
  font-size: 0.9rem;
  margin-top: 10px;
  padding: 10px 12px;
  background: #ECFDF5;
  border: 1px solid #10B981;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}
</style>
